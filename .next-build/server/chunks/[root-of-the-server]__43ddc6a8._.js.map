{"version":3,"sources":["../../../errors/index.js","../../../utils/advancedUpscaler.js","../../../utils/upscale.js","../../../pages/api/upscale.js","../../../node_modules/next/src/build/templates/pages-api.ts"],"sourcesContent":["/**\r\n * Centralized error handling\r\n * Provides consistent error responses and error classes\r\n */\r\n\r\nexport class AppError extends Error {\r\n  constructor(message, statusCode = 500, code = null, details = null, originalError = null) {\r\n    super(message);\r\n    this.name = this.constructor.name;\r\n    this.statusCode = statusCode;\r\n    this.code = code;\r\n    this.details = details;\r\n    this.originalError = originalError;\r\n    this.timestamp = new Date().toISOString();\r\n    this.requestId = null; // Can be set by middleware\r\n    \r\n    // Capture stack trace\r\n    if (Error.captureStackTrace) {\r\n      Error.captureStackTrace(this, this.constructor);\r\n    } else {\r\n      this.stack = (new Error()).stack;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Convert error to plain object for logging\r\n   */\r\n  toJSON() {\r\n    return {\r\n      name: this.name,\r\n      message: this.message,\r\n      statusCode: this.statusCode,\r\n      code: this.code,\r\n      details: this.details,\r\n      timestamp: this.timestamp,\r\n      requestId: this.requestId,\r\n      stack: this.stack,\r\n    };\r\n  }\r\n}\r\n\r\nexport class ValidationError extends AppError {\r\n  constructor(message, details = null) {\r\n    super(message, 400, 'VALIDATION_ERROR', details);\r\n  }\r\n}\r\n\r\nexport class AuthenticationError extends AppError {\r\n  constructor(message = 'Authentication required') {\r\n    super(message, 401, 'AUTHENTICATION_ERROR');\r\n  }\r\n}\r\n\r\nexport class AuthorizationError extends AppError {\r\n  constructor(message = 'Insufficient permissions') {\r\n    super(message, 403, 'AUTHORIZATION_ERROR');\r\n  }\r\n}\r\n\r\nexport class NotFoundError extends AppError {\r\n  constructor(resource = 'Resource') {\r\n    super(`${resource} not found`, 404, 'NOT_FOUND');\r\n  }\r\n}\r\n\r\nexport class ConflictError extends AppError {\r\n  constructor(message) {\r\n    super(message, 409, 'CONFLICT');\r\n  }\r\n}\r\n\r\nexport class RateLimitError extends AppError {\r\n  constructor(message = 'Too many requests', retryAfter = null) {\r\n    super(message, 429, 'RATE_LIMIT_EXCEEDED', retryAfter ? { retryAfter } : null);\r\n  }\r\n}\r\n\r\nexport class DatabaseError extends AppError {\r\n  constructor(message, originalError = null) {\r\n    super(message, 500, 'DATABASE_ERROR', null, originalError);\r\n  }\r\n}\r\n\r\nexport class FileSystemError extends AppError {\r\n  constructor(message, originalError = null) {\r\n    super(message, 500, 'FILE_SYSTEM_ERROR', null, originalError);\r\n  }\r\n}\r\n\r\nexport class NetworkError extends AppError {\r\n  constructor(message, originalError = null) {\r\n    super(message, 503, 'NETWORK_ERROR', null, originalError);\r\n  }\r\n}\r\n\r\nexport class TimeoutError extends AppError {\r\n  constructor(message = 'Request timeout', timeoutMs = null) {\r\n    super(message, 408, 'TIMEOUT_ERROR', timeoutMs ? { timeoutMs } : null);\r\n  }\r\n}\r\n\r\nexport class FileTooLargeError extends AppError {\r\n  constructor(maxSize, actualSize = null) {\r\n    const message = `File too large. Maximum size is ${formatFileSize(maxSize)}`;\r\n    super(message, 413, 'FILE_TOO_LARGE', { maxSize, actualSize });\r\n  }\r\n}\r\n\r\nexport class InvalidFileTypeError extends AppError {\r\n  constructor(allowedTypes = null) {\r\n    const message = allowedTypes \r\n      ? `Invalid file type. Allowed types: ${allowedTypes.join(', ')}`\r\n      : 'Invalid file type';\r\n    super(message, 400, 'INVALID_FILE_TYPE', { allowedTypes });\r\n  }\r\n}\r\n\r\nexport class ProcessingError extends AppError {\r\n  constructor(message, originalError = null) {\r\n    super(message, 500, 'PROCESSING_ERROR', null, originalError);\r\n  }\r\n}\r\n\r\n/**\r\n * Format file size for human-readable display\r\n */\r\nfunction formatFileSize(bytes) {\r\n  if (bytes === 0) return '0 Bytes';\r\n  const k = 1024;\r\n  const sizes = ['Bytes', 'KB', 'MB', 'GB'];\r\n  const i = Math.floor(Math.log(bytes) / Math.log(k));\r\n  return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];\r\n}\r\n\r\n/**\r\n * Enhanced error logger with advanced tracking\r\n */\r\nasync function logError(error, context = {}) {\r\n  const errorInfo = {\r\n    timestamp: new Date().toISOString(),\r\n    error: error instanceof AppError ? error.toJSON() : {\r\n      name: error.name,\r\n      message: error.message,\r\n      stack: error.stack,\r\n    },\r\n    context,\r\n    environment: process.env.NODE_ENV,\r\n  };\r\n\r\n  // Log to console with appropriate level\r\n  if (error instanceof AppError && error.statusCode < 500) {\r\n    // Client errors (4xx) - log as warning\r\n    console.warn('Client Error:', JSON.stringify(errorInfo, null, 2));\r\n  } else {\r\n    // Server errors (5xx) - log as error\r\n    console.error('Server Error:', JSON.stringify(errorInfo, null, 2));\r\n  }\r\n\r\n  // Track error with advanced error tracker\r\n  try {\r\n    const { default: errorTracker } = await import('../lib/errorTracker.js');\r\n    const { log } = await import('../lib/logger.js');\r\n    await errorTracker.trackError(error, context);\r\n    log.error('Error logged', error, context);\r\n  } catch (importError) {\r\n    // Error tracker not available, continue with basic logging\r\n    console.warn('Error tracker not available:', importError.message);\r\n  }\r\n\r\n  // In production, you might want to send to error tracking service\r\n  // Example: Sentry, LogRocket, etc.\r\n  if (process.env.NODE_ENV === 'production' && process.env.ERROR_TRACKING_ENABLED === 'true') {\r\n    // TODO: Integrate with error tracking service\r\n    // trackError(errorInfo);\r\n  }\r\n\r\n  return errorInfo;\r\n}\r\n\r\n/**\r\n * Format error response for API\r\n */\r\nexport function formatErrorResponse(error, includeStack = false, includeDetails = true) {\r\n  const isDevelopment = process.env.NODE_ENV === 'development';\r\n  \r\n  const response = {\r\n    error: error.message || 'Internal server error',\r\n    code: error.code || 'INTERNAL_ERROR',\r\n  };\r\n\r\n  // Include details if available and allowed\r\n  if (includeDetails && error.details) {\r\n    response.details = error.details;\r\n  }\r\n\r\n  // Include stack trace only in development\r\n  if (includeStack || isDevelopment) {\r\n    response.stack = error.stack;\r\n  }\r\n\r\n  // Include request ID if available\r\n  if (error.requestId) {\r\n    response.requestId = error.requestId;\r\n  }\r\n\r\n  // Include timestamp\r\n  if (error.timestamp) {\r\n    response.timestamp = error.timestamp;\r\n  }\r\n\r\n  return response;\r\n}\r\n\r\n/**\r\n * Handle errors in API routes with improved error resolution\r\n */\r\nexport async function handleApiError(error, res, context = {}) {\r\n  // Log the error with context\r\n  await logError(error, context);\r\n\r\n  // If response already sent, just log\r\n  if (res.headersSent) {\r\n    return;\r\n  }\r\n\r\n  // Handle known error types\r\n  if (error instanceof AppError) {\r\n    return res.status(error.statusCode).json(\r\n      formatErrorResponse(error, false, true)\r\n    );\r\n  }\r\n\r\n  // Handle specific error types from libraries and Node.js\r\n  if (error.name === 'ValidationError' || error.name === 'CastError') {\r\n    return res.status(400).json(\r\n      formatErrorResponse(new ValidationError(error.message, error.errors), false)\r\n    );\r\n  }\r\n\r\n  // Handle database connection errors\r\n  if (error.code === 'ECONNREFUSED' || error.code === 'ETIMEDOUT') {\r\n    return res.status(503).json(\r\n      formatErrorResponse(\r\n        new NetworkError('Database connection failed', error),\r\n        false\r\n      )\r\n    );\r\n  }\r\n\r\n  // Handle file system errors\r\n  if (error.code === 'ENOENT' || error.code === 'EACCES' || error.code === 'EMFILE') {\r\n    return res.status(500).json(\r\n      formatErrorResponse(\r\n        new FileSystemError('File system operation failed', error),\r\n        false\r\n      )\r\n    );\r\n  }\r\n\r\n  // Handle timeout errors\r\n  if (error.message && (error.message.includes('timeout') || error.message.includes('ETIMEDOUT'))) {\r\n    return res.status(408).json(\r\n      formatErrorResponse(\r\n        new TimeoutError('Request timeout', error.timeout),\r\n        false\r\n      )\r\n    );\r\n  }\r\n\r\n  // Handle file size errors\r\n  if (error.code === 'LIMIT_FILE_SIZE' || error.message?.includes('too large')) {\r\n    return res.status(413).json(\r\n      formatErrorResponse(\r\n        new FileTooLargeError(),\r\n        false\r\n      )\r\n    );\r\n  }\r\n\r\n  // Default to 500 with safe error message\r\n  const isDevelopment = process.env.NODE_ENV === 'development';\r\n  const safeMessage = isDevelopment \r\n    ? error.message || 'Internal server error'\r\n    : 'Internal server error';\r\n  \r\n  res.status(500).json(\r\n    formatErrorResponse(\r\n      new AppError(safeMessage, 500, 'INTERNAL_ERROR', null, error),\r\n      isDevelopment\r\n    )\r\n  );\r\n}\r\n\r\n/**\r\n * Create error handler wrapper for async route handlers\r\n */\r\nexport function asyncHandler(handler) {\r\n  return async (req, res, next) => {\r\n    try {\r\n      await handler(req, res, next);\r\n    } catch (error) {\r\n      handleApiError(error, res, {\r\n        method: req.method,\r\n        url: req.url,\r\n        path: req.path,\r\n        query: req.query,\r\n        user: req.user?.id,\r\n      });\r\n    }\r\n  };\r\n}\r\n\r\n/**\r\n * Retry logic for operations that might fail temporarily\r\n */\r\nexport async function retryOperation(operation, maxRetries = 3, delay = 1000) {\r\n  let lastError;\r\n  \r\n  for (let attempt = 1; attempt <= maxRetries; attempt++) {\r\n    try {\r\n      return await operation();\r\n    } catch (error) {\r\n      lastError = error;\r\n      \r\n      // Don't retry on certain errors\r\n      if (error instanceof ValidationError || \r\n          error instanceof AuthenticationError ||\r\n          error instanceof AuthorizationError) {\r\n        throw error;\r\n      }\r\n      \r\n      // If last attempt, throw error\r\n      if (attempt === maxRetries) {\r\n        break;\r\n      }\r\n      \r\n      // Wait before retrying (exponential backoff)\r\n      const waitTime = delay * Math.pow(2, attempt - 1);\r\n      await new Promise(resolve => setTimeout(resolve, waitTime));\r\n    }\r\n  }\r\n  \r\n  throw lastError;\r\n}\r\n\r\n","import sharp from 'sharp';\r\n\r\n/**\r\n * Upscaler avanzato per immagini 4K/8K\r\n * Usa tecniche multi-pass, denoising e sharpening avanzato\r\n */\r\nclass AdvancedUpscaler {\r\n    constructor() {\r\n        this.maxDimension = 7680; // 8K\r\n    }\r\n\r\n    // Denoising avanzato prima dell'upscaling\r\n    async denoise(image) {\r\n        // Applica leggero blur per ridurre noise, poi sharpening mirato\r\n        return image\r\n            .blur(0.3) // Leggero blur per noise\r\n            .sharpen({\r\n                sigma: 0.5,\r\n                m1: 0.4,\r\n                m2: 0.2\r\n            });\r\n    }\r\n\r\n    // Upscaling multi-pass per qualità massima\r\n    async multiPassUpscale(image, targetWidth, targetHeight, passes = 3) {\r\n        const metadata = await image.metadata();\r\n        let currentWidth = metadata.width;\r\n        let currentHeight = metadata.height;\r\n        \r\n        let currentImage = image;\r\n        \r\n        // Calcola fattore di scala per passaggio\r\n        const totalScale = Math.max(\r\n            targetWidth / currentWidth,\r\n            targetHeight / currentHeight\r\n        );\r\n        const scalePerPass = Math.pow(totalScale, 1 / passes);\r\n        \r\n        for (let pass = 0; pass < passes; pass++) {\r\n            const nextWidth = Math.min(\r\n                Math.round(currentWidth * scalePerPass),\r\n                targetWidth\r\n            );\r\n            const nextHeight = Math.min(\r\n                Math.round(currentHeight * scalePerPass),\r\n                targetHeight\r\n            );\r\n            \r\n            // Usa kernel diverso per ogni passaggio\r\n            let kernel = sharp.kernel.lanczos3;\r\n            if (pass === 0) {\r\n                kernel = sharp.kernel.lanczos3; // Primo passaggio: massima qualità\r\n            } else if (pass === passes - 1) {\r\n                kernel = sharp.kernel.lanczos3; // Ultimo passaggio: massima qualità\r\n            } else {\r\n                kernel = sharp.kernel.lanczos2; // Passaggi intermedi: bilanciato\r\n            }\r\n            \r\n            // Resize con kernel ottimizzato\r\n            currentImage = currentImage.resize(nextWidth, nextHeight, {\r\n                kernel,\r\n                fit: 'fill',\r\n                withoutEnlargement: false\r\n            });\r\n            \r\n            // Sharpening progressivo (più aggressivo negli ultimi passaggi)\r\n            const sharpenIntensity = 0.3 + (pass / passes) * 0.4;\r\n            currentImage = currentImage.sharpen({\r\n                sigma: 0.4 + sharpenIntensity,\r\n                m1: 0.3 + (pass / passes) * 0.2,\r\n                m2: 0.15 + (pass / passes) * 0.15\r\n            });\r\n            \r\n            // Converti a buffer per il prossimo passaggio\r\n            if (pass < passes - 1) {\r\n                const buffer = await currentImage.toBuffer();\r\n                currentImage = sharp(buffer, { sequentialRead: true });\r\n            }\r\n            \r\n            currentWidth = nextWidth;\r\n            currentHeight = nextHeight;\r\n        }\r\n        \r\n        return currentImage;\r\n    }\r\n\r\n    // Applica enhancement finale\r\n    async applyFinalEnhancement(image, quality = 'high') {\r\n        let enhanced = image;\r\n        \r\n        // Contrasto leggero per chiarezza\r\n        enhanced = enhanced.linear(1.02, -(128 * 0.02));\r\n        \r\n        // Sharpening finale mirato\r\n        enhanced = enhanced.sharpen({\r\n            sigma: 1.2,\r\n            m1: 0.7,\r\n            m2: 0.4\r\n        });\r\n        \r\n        // Rimozione artefatti\r\n        enhanced = enhanced.png({\r\n            quality: 100,\r\n            compressionLevel: 6,\r\n            adaptiveFiltering: true\r\n        });\r\n        \r\n        return enhanced;\r\n    }\r\n\r\n    // Upscale principale con pipeline completa\r\n    async upscale(buffer, targetScale = 4, maxDimension = 7680) {\r\n        try {\r\n            const input = sharp(buffer, { sequentialRead: true }).rotate();\r\n            const metadata = await input.metadata();\r\n            \r\n            const originalWidth = metadata.width || 0;\r\n            const originalHeight = metadata.height || 0;\r\n            \r\n            if (originalWidth === 0 || originalHeight === 0) {\r\n                throw new Error('Dimensioni immagine non valide');\r\n            }\r\n            \r\n            // Calcola dimensioni target\r\n            let targetWidth = Math.round(originalWidth * targetScale);\r\n            let targetHeight = Math.round(originalHeight * targetScale);\r\n            \r\n            // Limita a maxDimension\r\n            if (targetWidth > maxDimension || targetHeight > maxDimension) {\r\n                const scale = maxDimension / Math.max(targetWidth, targetHeight);\r\n                targetWidth = Math.round(targetWidth * scale);\r\n                targetHeight = Math.round(targetHeight * scale);\r\n            }\r\n            \r\n            console.log(`Upscaling: ${originalWidth}x${originalHeight} -> ${targetWidth}x${targetHeight}`);\r\n            \r\n            // Step 1: Denoising (solo se immagine piccola o con noise evidente)\r\n            let processed = input;\r\n            const mp = (originalWidth * originalHeight) / 1e6;\r\n            if (mp < 2) {\r\n                processed = await this.denoise(processed);\r\n            }\r\n            \r\n            // Step 2: Multi-pass upscaling\r\n            const scaleFactor = Math.max(\r\n                targetWidth / originalWidth,\r\n                targetHeight / originalHeight\r\n            );\r\n            \r\n            // Determina numero di passaggi basato su scala\r\n            let passes = 2;\r\n            if (scaleFactor > 3) {\r\n                passes = 4;\r\n            } else if (scaleFactor > 2) {\r\n                passes = 3;\r\n            }\r\n            \r\n            processed = await this.multiPassUpscale(\r\n                processed,\r\n                targetWidth,\r\n                targetHeight,\r\n                passes\r\n            );\r\n            \r\n            // Step 3: Enhancement finale\r\n            processed = await this.applyFinalEnhancement(processed, 'high');\r\n            \r\n            // Converti a JPEG per output finale (migliore compressione)\r\n            const outputBuffer = await processed\r\n                .jpeg({\r\n                    quality: 98,\r\n                    chromaSubsampling: '4:4:4',\r\n                    mozjpeg: true,\r\n                    trellisQuantisation: true,\r\n                    overshootDeringing: true,\r\n                    optimiseScans: true\r\n                })\r\n                .toBuffer();\r\n            \r\n            console.log(`Upscale completato: ${(outputBuffer.length / 1024 / 1024).toFixed(2)} MB`);\r\n            \r\n            return outputBuffer;\r\n            \r\n        } catch (error) {\r\n            console.error('Errore upscaling avanzato:', error);\r\n            throw new Error(`Upscaling fallito: ${error.message}`);\r\n        }\r\n    }\r\n\r\n    // Upscale a 4K (3840x2160 o lato lungo 3840)\r\n    async upscaleTo4K(buffer) {\r\n        const input = sharp(buffer, { sequentialRead: true }).rotate();\r\n        const metadata = await input.metadata();\r\n        \r\n        const originalWidth = metadata.width || 0;\r\n        const originalHeight = metadata.height || 0;\r\n        \r\n        // Calcola dimensioni 4K mantenendo aspect ratio\r\n        const longSide = Math.max(originalWidth, originalHeight);\r\n        const scale = 3840 / longSide;\r\n        \r\n        const targetWidth = Math.round(originalWidth * scale);\r\n        const targetHeight = Math.round(originalHeight * scale);\r\n        \r\n        return this.upscale(buffer, scale, 3840);\r\n    }\r\n\r\n    // Upscale a 8K (7680x4320 o lato lungo 7680)\r\n    async upscaleTo8K(buffer) {\r\n        const input = sharp(buffer, { sequentialRead: true }).rotate();\r\n        const metadata = await input.metadata();\r\n        \r\n        const originalWidth = metadata.width || 0;\r\n        const originalHeight = metadata.height || 0;\r\n        \r\n        // Calcola dimensioni 8K mantenendo aspect ratio\r\n        const longSide = Math.max(originalWidth, originalHeight);\r\n        const scale = 7680 / longSide;\r\n        \r\n        const targetWidth = Math.round(originalWidth * scale);\r\n        const targetHeight = Math.round(originalHeight * scale);\r\n        \r\n        return this.upscale(buffer, scale, 7680);\r\n    }\r\n}\r\n\r\nexport default AdvancedUpscaler;\r\n\r\n","import sharp from 'sharp';\r\nimport AdvancedUpscaler from './advancedUpscaler.js';\r\n\r\n/**\r\n * Upscale immagine usando upscaler avanzato locale\r\n * Completamente gratuito, senza API esterne\r\n */\r\nexport default async function upscaleImage(fileBuffer, targetScale = 2) {\r\n  try {\r\n    const upscaler = new AdvancedUpscaler();\r\n    \r\n    // Usa upscaler avanzato per qualità 4K\r\n    // Se l'immagine è piccola, upscale a 4K, altrimenti 2x\r\n    const metadata = await sharp(fileBuffer, { sequentialRead: true }).metadata();\r\n    const mp = ((metadata.width || 0) * (metadata.height || 0)) / 1e6;\r\n    \r\n    let upscaled;\r\n    if (mp < 1) {\r\n      // Immagine molto piccola: upscale a 4K\r\n      upscaled = await upscaler.upscaleTo4K(fileBuffer);\r\n    } else {\r\n      // Immagine normale: upscale 2x o targetScale\r\n      upscaled = await upscaler.upscale(fileBuffer, targetScale, 7680);\r\n    }\r\n    \r\n    // Ritorna data URL (completamente locale, nessuna API esterna)\r\n    const base64 = upscaled.toString('base64');\r\n    return `data:image/jpeg;base64,${base64}`;\r\n  } catch (e) {\r\n    console.error('Upscale fallito:', e);\r\n    throw new Error(`Upscale failed: ${e?.message || e}`);\r\n  }\r\n}\r\n","import formidable from 'formidable';\r\nimport fs from 'fs/promises';\r\nimport upscaleImage from '../../utils/upscale.js';\r\nimport { \r\n  handleApiError, \r\n  ValidationError, \r\n  FileTooLargeError, \r\n  InvalidFileTypeError,\r\n  TimeoutError,\r\n  ProcessingError,\r\n  FileSystemError\r\n} from '../../errors';\r\n\r\nexport const config = {\r\n  api: {\r\n    bodyParser: false,\r\n  },\r\n};\r\n\r\nexport default async function handler(req, res) {\r\n  if (req.method !== 'POST') {\r\n    res.setHeader('Allow', 'POST');\r\n    return res.status(405).json({ error: 'Method not allowed', code: 'METHOD_NOT_ALLOWED' });\r\n  }\r\n\r\n  // Set timeout for long-running operations\r\n  const MAX_FILE_SIZE = 50 * 1024 * 1024; // 50MB\r\n  const TIMEOUT_MS = 120000; // 2 minutes\r\n\r\n  const form = formidable({ \r\n    multiples: false,\r\n    maxFileSize: MAX_FILE_SIZE,\r\n    keepExtensions: true,\r\n  });\r\n\r\n  let filePath = null;\r\n\r\n  try {\r\n    // Support both callback and promise styles robustly\r\n    const parsed = await Promise.race([\r\n      new Promise((resolve, reject) => {\r\n        form.parse(req, (err, fields, files) => {\r\n          if (err) {\r\n            // Handle formidable-specific errors\r\n            if (err.code === 'LIMIT_FILE_SIZE') {\r\n              return reject(new FileTooLargeError(MAX_FILE_SIZE));\r\n            }\r\n            return reject(new ValidationError('File upload failed: ' + err.message, err));\r\n          }\r\n          resolve({ fields, files });\r\n        });\r\n      }),\r\n      new Promise((_, reject) => \r\n        setTimeout(() => reject(new TimeoutError('Request timeout', TIMEOUT_MS)), TIMEOUT_MS)\r\n      )\r\n    ]);\r\n\r\n    const { files } = parsed;\r\n\r\n    // Accept 'image' or 'file' field names; normalize array/single\r\n    let file = files?.image ?? files?.file ?? null;\r\n    if (Array.isArray(file)) file = file[0];\r\n\r\n    if (!file) {\r\n      throw new ValidationError('No file uploaded');\r\n    }\r\n\r\n    // Validate file type\r\n    if (!file.mimetype?.startsWith('image/')) {\r\n      throw new InvalidFileTypeError(['image/jpeg', 'image/png', 'image/webp', 'image/gif']);\r\n    }\r\n\r\n    // Validate file size\r\n    if (file.size > MAX_FILE_SIZE) {\r\n      throw new FileTooLargeError(MAX_FILE_SIZE, file.size);\r\n    }\r\n\r\n    filePath = file.filepath || file.path; // v3 vs older\r\n    if (!filePath) {\r\n      throw new ValidationError('Uploaded file path missing');\r\n    }\r\n\r\n    let buffer;\r\n    try {\r\n      buffer = await fs.readFile(filePath);\r\n    } catch (readError) {\r\n      throw new FileSystemError('Failed to read uploaded file', readError);\r\n    }\r\n    \r\n    // Validate buffer is not empty\r\n    if (!buffer || buffer.length === 0) {\r\n      throw new ValidationError('File is empty or corrupted');\r\n    }\r\n\r\n    let url;\r\n    try {\r\n      url = await upscaleImage(buffer);\r\n    } catch (upscaleError) {\r\n      throw new ProcessingError('Failed to upscale image', upscaleError);\r\n    }\r\n\r\n    // Cleanup temp file\r\n    if (filePath) {\r\n      try { \r\n        await fs.unlink(filePath);\r\n        filePath = null;\r\n      } catch (cleanupError) {\r\n        // Log but don't fail the request\r\n        console.warn('Failed to cleanup temp file:', cleanupError);\r\n      }\r\n    }\r\n\r\n    return res.status(200).json({ url });\r\n\r\n  } catch (error) {\r\n    // Cleanup on error\r\n    if (filePath) {\r\n      try { \r\n        await fs.unlink(filePath);\r\n      } catch (cleanupError) {\r\n        console.warn('Failed to cleanup temp file on error:', cleanupError);\r\n      }\r\n    }\r\n\r\n    // Use centralized error handler\r\n    handleApiError(error, res, {\r\n      method: req.method,\r\n      url: req.url,\r\n      endpoint: '/api/upscale',\r\n    });\r\n  }\r\n}\r\n","import type { NextApiResponse } from '../../types'\nimport type { IncomingMessage, ServerResponse } from 'node:http'\n\nimport { sendError } from '../../server/api-utils'\nimport { RouteKind } from '../../server/route-kind'\nimport type { Span } from '../../server/lib/trace/tracer'\nimport { PagesAPIRouteModule } from '../../server/route-modules/pages-api/module.compiled'\n\nimport { hoist } from './helpers'\n\n// Import the userland code.\nimport * as userland from 'VAR_USERLAND'\nimport { getTracer, SpanKind } from '../../server/lib/trace/tracer'\nimport { BaseServerSpan } from '../../server/lib/trace/constants'\nimport type { InstrumentationOnRequestError } from '../../server/instrumentation/types'\nimport { addRequestMeta } from '../../server/request-meta'\n\n// Re-export the handler (should be the default export).\nexport default hoist(userland, 'default')\n\n// Re-export config.\nexport const config = hoist(userland, 'config')\n\n// Create and export the route module that will be consumed.\nconst routeModule = new PagesAPIRouteModule({\n  definition: {\n    kind: RouteKind.PAGES_API,\n    page: 'VAR_DEFINITION_PAGE',\n    pathname: 'VAR_DEFINITION_PATHNAME',\n    // The following aren't used in production.\n    bundlePath: '',\n    filename: '',\n  },\n  userland,\n  distDir: process.env.__NEXT_RELATIVE_DIST_DIR || '',\n  relativeProjectDir: process.env.__NEXT_RELATIVE_PROJECT_DIR || '',\n})\n\nexport async function handler(\n  req: IncomingMessage,\n  res: ServerResponse,\n  ctx: {\n    waitUntil?: (prom: Promise<void>) => void\n  }\n): Promise<void> {\n  if (routeModule.isDev) {\n    addRequestMeta(req, 'devRequestTimingInternalsEnd', process.hrtime.bigint())\n  }\n  let srcPage = 'VAR_DEFINITION_PAGE'\n\n  // turbopack doesn't normalize `/index` in the page name\n  // so we need to to process dynamic routes properly\n  // TODO: fix turbopack providing differing value from webpack\n  if (process.env.TURBOPACK) {\n    srcPage = srcPage.replace(/\\/index$/, '') || '/'\n  }\n\n  const prepareResult = await routeModule.prepare(req, res, { srcPage })\n\n  if (!prepareResult) {\n    res.statusCode = 400\n    res.end('Bad Request')\n    ctx.waitUntil?.(Promise.resolve())\n    return\n  }\n\n  const { query, params, prerenderManifest, routerServerContext } =\n    prepareResult\n\n  try {\n    const method = req.method || 'GET'\n    const tracer = getTracer()\n\n    const activeSpan = tracer.getActiveScopeSpan()\n    const onRequestError =\n      routeModule.instrumentationOnRequestError.bind(routeModule)\n\n    const invokeRouteModule = async (span?: Span) =>\n      routeModule\n        .render(req, res, {\n          query: {\n            ...query,\n            ...params,\n          },\n          params,\n          allowedRevalidateHeaderKeys: process.env\n            .__NEXT_ALLOWED_REVALIDATE_HEADERS as any as string[],\n          multiZoneDraftMode: Boolean(process.env.__NEXT_MULTI_ZONE_DRAFT_MODE),\n          trustHostHeader: process.env\n            .__NEXT_TRUST_HOST_HEADER as any as boolean,\n          // TODO: get this from from runtime env so manifest\n          // doesn't need to load\n          previewProps: prerenderManifest.preview,\n          propagateError: false,\n          dev: routeModule.isDev,\n          page: 'VAR_DEFINITION_PAGE',\n\n          internalRevalidate: routerServerContext?.revalidate,\n\n          onError: (...args: Parameters<InstrumentationOnRequestError>) =>\n            onRequestError(req, ...args),\n        })\n        .finally(() => {\n          if (!span) return\n\n          span.setAttributes({\n            'http.status_code': res.statusCode,\n            'next.rsc': false,\n          })\n\n          const rootSpanAttributes = tracer.getRootSpanAttributes()\n          // We were unable to get attributes, probably OTEL is not enabled\n          if (!rootSpanAttributes) {\n            return\n          }\n\n          if (\n            rootSpanAttributes.get('next.span_type') !==\n            BaseServerSpan.handleRequest\n          ) {\n            console.warn(\n              `Unexpected root span type '${rootSpanAttributes.get(\n                'next.span_type'\n              )}'. Please report this Next.js issue https://github.com/vercel/next.js`\n            )\n            return\n          }\n\n          const route = rootSpanAttributes.get('next.route')\n          if (route) {\n            const name = `${method} ${route}`\n\n            span.setAttributes({\n              'next.route': route,\n              'http.route': route,\n              'next.span_name': name,\n            })\n            span.updateName(name)\n          } else {\n            span.updateName(`${method} ${srcPage}`)\n          }\n        })\n\n    // TODO: activeSpan code path is for when wrapped by\n    // next-server can be removed when this is no longer used\n    if (activeSpan) {\n      await invokeRouteModule(activeSpan)\n    } else {\n      await tracer.withPropagatedContext(req.headers, () =>\n        tracer.trace(\n          BaseServerSpan.handleRequest,\n          {\n            spanName: `${method} ${srcPage}`,\n            kind: SpanKind.SERVER,\n            attributes: {\n              'http.method': method,\n              'http.target': req.url,\n            },\n          },\n          invokeRouteModule\n        )\n      )\n    }\n  } catch (err) {\n    // we re-throw in dev to show the error overlay\n    if (routeModule.isDev) {\n      throw err\n    }\n    // this is technically an invariant as error handling\n    // should be done inside of api-resolver onError\n    sendError(res as NextApiResponse, 500, 'Internal Server Error')\n  } finally {\n    // We don't allow any waitUntil work in pages API routes currently\n    // so if callback is present return with resolved promise since no\n    // pending work\n    ctx.waitUntil?.(Promise.resolve())\n  }\n}\n"],"names":["sendError","RouteKind","PagesAPIRouteModule","hoist","userland","getTracer","SpanKind","BaseServerSpan","addRequestMeta","config","routeModule","definition","kind","PAGES_API","page","pathname","bundlePath","filename","distDir","process","env","__NEXT_RELATIVE_DIST_DIR","relativeProjectDir","__NEXT_RELATIVE_PROJECT_DIR","handler","req","res","ctx","isDev","hrtime","bigint","srcPage","TURBOPACK","replace","prepareResult","prepare","statusCode","end","waitUntil","Promise","resolve","query","params","prerenderManifest","routerServerContext","method","tracer","activeSpan","getActiveScopeSpan","onRequestError","instrumentationOnRequestError","bind","invokeRouteModule","span","render","allowedRevalidateHeaderKeys","__NEXT_ALLOWED_REVALIDATE_HEADERS","multiZoneDraftMode","Boolean","__NEXT_MULTI_ZONE_DRAFT_MODE","trustHostHeader","__NEXT_TRUST_HOST_HEADER","previewProps","preview","propagateError","dev","internalRevalidate","revalidate","onError","args","finally","setAttributes","rootSpanAttributes","getRootSpanAttributes","get","handleRequest","console","warn","route","name","updateName","withPropagatedContext","headers","trace","spanName","SERVER","attributes","url","err"],"mappings":"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","ignoreList":[4]}