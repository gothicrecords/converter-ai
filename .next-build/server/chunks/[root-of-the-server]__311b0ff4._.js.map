{"version":3,"sources":["../../../errors/index.js","../../../lib/openai.js","../../../lib/usage-limits.js","../../../lib/usage-tracker.js"],"sourcesContent":["/**\r\n * Centralized error handling\r\n * Provides consistent error responses and error classes\r\n */\r\n\r\nexport class AppError extends Error {\r\n  constructor(message, statusCode = 500, code = null, details = null, originalError = null) {\r\n    super(message);\r\n    this.name = this.constructor.name;\r\n    this.statusCode = statusCode;\r\n    this.code = code;\r\n    this.details = details;\r\n    this.originalError = originalError;\r\n    this.timestamp = new Date().toISOString();\r\n    this.requestId = null; // Can be set by middleware\r\n    \r\n    // Capture stack trace\r\n    if (Error.captureStackTrace) {\r\n      Error.captureStackTrace(this, this.constructor);\r\n    } else {\r\n      this.stack = (new Error()).stack;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Convert error to plain object for logging\r\n   */\r\n  toJSON() {\r\n    return {\r\n      name: this.name,\r\n      message: this.message,\r\n      statusCode: this.statusCode,\r\n      code: this.code,\r\n      details: this.details,\r\n      timestamp: this.timestamp,\r\n      requestId: this.requestId,\r\n      stack: this.stack,\r\n    };\r\n  }\r\n}\r\n\r\nexport class ValidationError extends AppError {\r\n  constructor(message, details = null) {\r\n    super(message, 400, 'VALIDATION_ERROR', details);\r\n  }\r\n}\r\n\r\nexport class AuthenticationError extends AppError {\r\n  constructor(message = 'Authentication required') {\r\n    super(message, 401, 'AUTHENTICATION_ERROR');\r\n  }\r\n}\r\n\r\nexport class AuthorizationError extends AppError {\r\n  constructor(message = 'Insufficient permissions') {\r\n    super(message, 403, 'AUTHORIZATION_ERROR');\r\n  }\r\n}\r\n\r\nexport class NotFoundError extends AppError {\r\n  constructor(resource = 'Resource') {\r\n    super(`${resource} not found`, 404, 'NOT_FOUND');\r\n  }\r\n}\r\n\r\nexport class ConflictError extends AppError {\r\n  constructor(message) {\r\n    super(message, 409, 'CONFLICT');\r\n  }\r\n}\r\n\r\nexport class RateLimitError extends AppError {\r\n  constructor(message = 'Too many requests', retryAfter = null) {\r\n    super(message, 429, 'RATE_LIMIT_EXCEEDED', retryAfter ? { retryAfter } : null);\r\n  }\r\n}\r\n\r\nexport class DatabaseError extends AppError {\r\n  constructor(message, originalError = null) {\r\n    super(message, 500, 'DATABASE_ERROR', null, originalError);\r\n  }\r\n}\r\n\r\nexport class FileSystemError extends AppError {\r\n  constructor(message, originalError = null) {\r\n    super(message, 500, 'FILE_SYSTEM_ERROR', null, originalError);\r\n  }\r\n}\r\n\r\nexport class NetworkError extends AppError {\r\n  constructor(message, originalError = null) {\r\n    super(message, 503, 'NETWORK_ERROR', null, originalError);\r\n  }\r\n}\r\n\r\nexport class TimeoutError extends AppError {\r\n  constructor(message = 'Request timeout', timeoutMs = null) {\r\n    super(message, 408, 'TIMEOUT_ERROR', timeoutMs ? { timeoutMs } : null);\r\n  }\r\n}\r\n\r\nexport class FileTooLargeError extends AppError {\r\n  constructor(maxSize, actualSize = null) {\r\n    const message = `File too large. Maximum size is ${formatFileSize(maxSize)}`;\r\n    super(message, 413, 'FILE_TOO_LARGE', { maxSize, actualSize });\r\n  }\r\n}\r\n\r\nexport class InvalidFileTypeError extends AppError {\r\n  constructor(allowedTypes = null) {\r\n    const message = allowedTypes \r\n      ? `Invalid file type. Allowed types: ${allowedTypes.join(', ')}`\r\n      : 'Invalid file type';\r\n    super(message, 400, 'INVALID_FILE_TYPE', { allowedTypes });\r\n  }\r\n}\r\n\r\nexport class ProcessingError extends AppError {\r\n  constructor(message, originalError = null) {\r\n    super(message, 500, 'PROCESSING_ERROR', null, originalError);\r\n  }\r\n}\r\n\r\n/**\r\n * Format file size for human-readable display\r\n */\r\nfunction formatFileSize(bytes) {\r\n  if (bytes === 0) return '0 Bytes';\r\n  const k = 1024;\r\n  const sizes = ['Bytes', 'KB', 'MB', 'GB'];\r\n  const i = Math.floor(Math.log(bytes) / Math.log(k));\r\n  return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];\r\n}\r\n\r\n/**\r\n * Enhanced error logger with advanced tracking\r\n */\r\nasync function logError(error, context = {}) {\r\n  const errorInfo = {\r\n    timestamp: new Date().toISOString(),\r\n    error: error instanceof AppError ? error.toJSON() : {\r\n      name: error.name,\r\n      message: error.message,\r\n      stack: error.stack,\r\n    },\r\n    context,\r\n    environment: process.env.NODE_ENV,\r\n  };\r\n\r\n  // Log to console with appropriate level\r\n  if (error instanceof AppError && error.statusCode < 500) {\r\n    // Client errors (4xx) - log as warning\r\n    console.warn('Client Error:', JSON.stringify(errorInfo, null, 2));\r\n  } else {\r\n    // Server errors (5xx) - log as error\r\n    console.error('Server Error:', JSON.stringify(errorInfo, null, 2));\r\n  }\r\n\r\n  // Track error with advanced error tracker\r\n  try {\r\n    const { default: errorTracker } = await import('../lib/errorTracker.js');\r\n    const { log } = await import('../lib/logger.js');\r\n    await errorTracker.trackError(error, context);\r\n    log.error('Error logged', error, context);\r\n  } catch (importError) {\r\n    // Error tracker not available, continue with basic logging\r\n    console.warn('Error tracker not available:', importError.message);\r\n  }\r\n\r\n  // In production, you might want to send to error tracking service\r\n  // Example: Sentry, LogRocket, etc.\r\n  if (process.env.NODE_ENV === 'production' && process.env.ERROR_TRACKING_ENABLED === 'true') {\r\n    // TODO: Integrate with error tracking service\r\n    // trackError(errorInfo);\r\n  }\r\n\r\n  return errorInfo;\r\n}\r\n\r\n/**\r\n * Format error response for API\r\n */\r\nexport function formatErrorResponse(error, includeStack = false, includeDetails = true) {\r\n  const isDevelopment = process.env.NODE_ENV === 'development';\r\n  \r\n  const response = {\r\n    error: error.message || 'Internal server error',\r\n    code: error.code || 'INTERNAL_ERROR',\r\n  };\r\n\r\n  // Include details if available and allowed\r\n  if (includeDetails && error.details) {\r\n    response.details = error.details;\r\n  }\r\n\r\n  // Include stack trace only in development\r\n  if (includeStack || isDevelopment) {\r\n    response.stack = error.stack;\r\n  }\r\n\r\n  // Include request ID if available\r\n  if (error.requestId) {\r\n    response.requestId = error.requestId;\r\n  }\r\n\r\n  // Include timestamp\r\n  if (error.timestamp) {\r\n    response.timestamp = error.timestamp;\r\n  }\r\n\r\n  return response;\r\n}\r\n\r\n/**\r\n * Handle errors in API routes with improved error resolution\r\n */\r\nexport async function handleApiError(error, res, context = {}) {\r\n  // Log the error with context\r\n  await logError(error, context);\r\n\r\n  // If response already sent, just log\r\n  if (res.headersSent) {\r\n    return;\r\n  }\r\n\r\n  // Handle known error types\r\n  if (error instanceof AppError) {\r\n    return res.status(error.statusCode).json(\r\n      formatErrorResponse(error, false, true)\r\n    );\r\n  }\r\n\r\n  // Handle specific error types from libraries and Node.js\r\n  if (error.name === 'ValidationError' || error.name === 'CastError') {\r\n    return res.status(400).json(\r\n      formatErrorResponse(new ValidationError(error.message, error.errors), false)\r\n    );\r\n  }\r\n\r\n  // Handle database connection errors\r\n  if (error.code === 'ECONNREFUSED' || error.code === 'ETIMEDOUT') {\r\n    return res.status(503).json(\r\n      formatErrorResponse(\r\n        new NetworkError('Database connection failed', error),\r\n        false\r\n      )\r\n    );\r\n  }\r\n\r\n  // Handle file system errors\r\n  if (error.code === 'ENOENT' || error.code === 'EACCES' || error.code === 'EMFILE') {\r\n    return res.status(500).json(\r\n      formatErrorResponse(\r\n        new FileSystemError('File system operation failed', error),\r\n        false\r\n      )\r\n    );\r\n  }\r\n\r\n  // Handle timeout errors\r\n  if (error.message && (error.message.includes('timeout') || error.message.includes('ETIMEDOUT'))) {\r\n    return res.status(408).json(\r\n      formatErrorResponse(\r\n        new TimeoutError('Request timeout', error.timeout),\r\n        false\r\n      )\r\n    );\r\n  }\r\n\r\n  // Handle file size errors\r\n  if (error.code === 'LIMIT_FILE_SIZE' || error.message?.includes('too large')) {\r\n    return res.status(413).json(\r\n      formatErrorResponse(\r\n        new FileTooLargeError(),\r\n        false\r\n      )\r\n    );\r\n  }\r\n\r\n  // Default to 500 with safe error message\r\n  const isDevelopment = process.env.NODE_ENV === 'development';\r\n  const safeMessage = isDevelopment \r\n    ? error.message || 'Internal server error'\r\n    : 'Internal server error';\r\n  \r\n  res.status(500).json(\r\n    formatErrorResponse(\r\n      new AppError(safeMessage, 500, 'INTERNAL_ERROR', null, error),\r\n      isDevelopment\r\n    )\r\n  );\r\n}\r\n\r\n/**\r\n * Create error handler wrapper for async route handlers\r\n */\r\nexport function asyncHandler(handler) {\r\n  return async (req, res, next) => {\r\n    try {\r\n      await handler(req, res, next);\r\n    } catch (error) {\r\n      handleApiError(error, res, {\r\n        method: req.method,\r\n        url: req.url,\r\n        path: req.path,\r\n        query: req.query,\r\n        user: req.user?.id,\r\n      });\r\n    }\r\n  };\r\n}\r\n\r\n/**\r\n * Retry logic for operations that might fail temporarily\r\n */\r\nexport async function retryOperation(operation, maxRetries = 3, delay = 1000) {\r\n  let lastError;\r\n  \r\n  for (let attempt = 1; attempt <= maxRetries; attempt++) {\r\n    try {\r\n      return await operation();\r\n    } catch (error) {\r\n      lastError = error;\r\n      \r\n      // Don't retry on certain errors\r\n      if (error instanceof ValidationError || \r\n          error instanceof AuthenticationError ||\r\n          error instanceof AuthorizationError) {\r\n        throw error;\r\n      }\r\n      \r\n      // If last attempt, throw error\r\n      if (attempt === maxRetries) {\r\n        break;\r\n      }\r\n      \r\n      // Wait before retrying (exponential backoff)\r\n      const waitTime = delay * Math.pow(2, attempt - 1);\r\n      await new Promise(resolve => setTimeout(resolve, waitTime));\r\n    }\r\n  }\r\n  \r\n  throw lastError;\r\n}\r\n\r\n","// OpenAI API integration with official SDK\r\nimport OpenAI from 'openai';\r\n\r\nconst openai = new OpenAI({\r\n  apiKey: process.env.OPENAI_API_KEY,\r\n});\r\n\r\n// Generate embeddings for text\r\nexport async function generateEmbedding(text) {\r\n  if (!process.env.OPENAI_API_KEY) {\r\n    throw new Error('OPENAI_API_KEY is not configured. Please set it in your environment variables.');\r\n  }\r\n\r\n  try {\r\n    const response = await openai.embeddings.create({\r\n      model: 'text-embedding-3-small',\r\n      input: text.substring(0, 8000), // Limit input size\r\n    });\r\n\r\n    return response.data[0].embedding;\r\n  } catch (error) {\r\n    console.error('Error generating embedding:', error);\r\n    throw new Error(`Failed to generate embedding: ${error.message}`);\r\n  }\r\n}\r\n\r\n// Generate embeddings in batch for an array of texts\r\nexport async function generateEmbeddingsBatch(texts) {\r\n  if (!process.env.OPENAI_API_KEY) {\r\n    throw new Error('OPENAI_API_KEY is not configured. Please set it in your environment variables.');\r\n  }\r\n\r\n  if (!Array.isArray(texts) || texts.length === 0) return [];\r\n\r\n  try {\r\n    const response = await openai.embeddings.create({\r\n      model: 'text-embedding-3-small',\r\n      input: texts.map(t => (t || '').toString().substring(0, 8000)),\r\n    });\r\n\r\n    return response.data.map(d => d.embedding);\r\n  } catch (error) {\r\n    console.error('Error generating batch embeddings:', error);\r\n    throw new Error(`Failed to generate batch embeddings: ${error.message}`);\r\n  }\r\n}\r\n\r\n// Chat completion using OpenAI GPT models\r\nexport async function chatCompletion(messages, options = {}) {\r\n  if (!process.env.OPENAI_API_KEY) {\r\n    throw new Error('OPENAI_API_KEY is not configured. Please set it in your environment variables.');\r\n  }\r\n\r\n  try {\r\n    const response = await openai.chat.completions.create({\r\n      model: options.model || 'gpt-4o-mini', // Fast and affordable\r\n      messages: messages,\r\n      temperature: options.temperature || 0.7,\r\n      max_tokens: options.max_tokens || 1000,\r\n      top_p: options.top_p || 1,\r\n      frequency_penalty: options.frequency_penalty || 0,\r\n      presence_penalty: options.presence_penalty || 0,\r\n    });\r\n\r\n    return response.choices[0].message.content;\r\n  } catch (error) {\r\n    console.error('Error in chat completion:', error);\r\n    \r\n    // Handle specific OpenAI errors\r\n    if (error.status === 401) {\r\n      throw new Error('Chiave API OpenAI non valida. Verifica la configurazione.');\r\n    } else if (error.status === 429) {\r\n      throw new Error('Limite di rate raggiunto. Riprova tra qualche secondo.');\r\n    } else if (error.status === 500) {\r\n      throw new Error('Errore del server OpenAI. Riprova più tardi.');\r\n    }\r\n    \r\n    throw new Error(`Errore nella comunicazione con OpenAI: ${error.message}`);\r\n  }\r\n}\r\n\r\n// Generate summary\r\nexport async function generateSummary(text, maxLength = 200) {\r\n  const messages = [\r\n    {\r\n      role: 'system',\r\n      content: 'You are a helpful assistant that creates concise summaries.',\r\n    },\r\n    {\r\n      role: 'user',\r\n      content: `Summarize the following text in ${maxLength} words or less:\\n\\n${text}`,\r\n    },\r\n  ];\r\n\r\n  return await chatCompletion(messages, { temperature: 0.5, max_tokens: 300 });\r\n}\r\n\r\n// Generate tags\r\nexport async function generateTags(text, count = 5) {\r\n  const messages = [\r\n    {\r\n      role: 'system',\r\n      content: 'You are a helpful assistant that generates relevant tags for documents. Return only comma-separated tags, no explanations.',\r\n    },\r\n    {\r\n      role: 'user',\r\n      content: `Generate ${count} relevant tags for this document:\\n\\n${text.substring(0, 2000)}`,\r\n    },\r\n  ];\r\n\r\n  const response = await chatCompletion(messages, { temperature: 0.3, max_tokens: 100 });\r\n  \r\n  return response\r\n    .split(',')\r\n    .map(tag => tag.trim().toLowerCase())\r\n    .filter(tag => tag.length > 0)\r\n    .slice(0, count);\r\n}\r\n\r\n// Classify document\r\nexport async function classifyDocument(text) {\r\n  const categories = [\r\n    'contract', 'invoice', 'report', 'presentation', \r\n    'spreadsheet', 'image', 'code', 'email', 'article', 'other'\r\n  ];\r\n\r\n  const messages = [\r\n    {\r\n      role: 'system',\r\n      content: `You are a document classifier. Classify the document into one or more of these categories: ${categories.join(', ')}. Return only category names, comma-separated.`,\r\n    },\r\n    {\r\n      role: 'user',\r\n      content: `Classify this document:\\n\\n${text.substring(0, 1000)}`,\r\n    },\r\n  ];\r\n\r\n  const response = await chatCompletion(messages, { temperature: 0.2, max_tokens: 50 });\r\n  \r\n  return response\r\n    .split(',')\r\n    .map(cat => cat.trim().toLowerCase())\r\n    .filter(cat => categories.includes(cat));\r\n}\r\n\r\n// Vision API - Analizza immagini come ChatGPT\r\nexport async function analyzeImageWithVision(imageBuffer, imageMimeType, query = 'Cosa contiene questa immagine? Descrivi tutto ciò che vedi.') {\r\n  if (!process.env.OPENAI_API_KEY) {\r\n    throw new Error('OPENAI_API_KEY is not configured. Please set it in your environment variables.');\r\n  }\r\n\r\n  try {\r\n    // Converti il buffer in base64\r\n    const base64Image = imageBuffer.toString('base64');\r\n    \r\n    const response = await openai.chat.completions.create({\r\n      model: 'gpt-4o', // GPT-4o supporta vision\r\n      messages: [\r\n        {\r\n          role: 'system',\r\n          content: 'Sei un assistente AI esperto nell\\'analisi di immagini. Descrivi in dettaglio tutto ciò che vedi nell\\'immagine, inclusi testo, oggetti, persone, scene, colori e qualsiasi altro dettaglio rilevante. Rispondi sempre in italiano.'\r\n        },\r\n        {\r\n          role: 'user',\r\n          content: [\r\n            {\r\n              type: 'text',\r\n              text: query\r\n            },\r\n            {\r\n              type: 'image_url',\r\n              image_url: {\r\n                url: `data:${imageMimeType};base64,${base64Image}`,\r\n                detail: 'high'\r\n              }\r\n            }\r\n          ]\r\n        }\r\n      ],\r\n      max_tokens: 2000,\r\n      temperature: 0.2\r\n    });\r\n\r\n    return response.choices[0].message.content;\r\n  } catch (error) {\r\n    console.error('Error in vision API:', error);\r\n    \r\n    if (error.status === 401) {\r\n      throw new Error('Chiave API OpenAI non valida. Verifica la configurazione.');\r\n    } else if (error.status === 429) {\r\n      throw new Error('Limite di rate raggiunto. Riprova tra qualche secondo.');\r\n    } else if (error.status === 400 && error.message?.includes('image')) {\r\n      throw new Error('Formato immagine non supportato o immagine troppo grande.');\r\n    }\r\n    \r\n    throw new Error(`Errore nell'analisi dell'immagine: ${error.message}`);\r\n  }\r\n}\r\n\r\n// Estrazione testo da PDF con OpenAI Responses API (gpt-4o) usando input_file\r\n// Ritorna SOLO la stringa di testo estratto (no IDs, no oggetti)\r\nexport async function extractTextFromPdfWithOpenAI(filePath) {\r\n  if (!process.env.OPENAI_API_KEY) {\r\n    throw new Error('OPENAI_API_KEY is not configured. Please set it in your environment variables.');\r\n  }\r\n\r\n  const fs = await import('fs');\r\n  \r\n  let uploadedFile = null;\r\n  try {\r\n    console.log('Caricamento PDF su OpenAI (Responses API):', filePath);\r\n    \r\n    // 1) Carica il file su OpenAI come user_data\r\n    uploadedFile = await openai.files.create({\r\n      file: fs.createReadStream(filePath),\r\n      purpose: 'user_data'\r\n    });\r\n\r\n    console.log('File caricato su OpenAI:', uploadedFile.id);\r\n\r\n    // 2) Richiesta al modello GPT-4o per estrazione testo dal file caricato\r\n    const response = await openai.responses.create({\r\n      model: 'gpt-4o',\r\n      input: [\r\n        {\r\n          role: 'user',\r\n          content: [\r\n            { type: 'input_text', text: 'Estrai tutto il testo e le informazioni rilevanti da questo documento. Rispondi SOLO con il testo estratto, senza commenti.' },\r\n            { type: 'input_file', file_id: uploadedFile.id }\r\n          ]\r\n        }\r\n      ],\r\n      max_output_tokens: 8000,\r\n      temperature: 0.1\r\n    });\r\n\r\n    // 3) Prendi solo testo\r\n    const extractedText = (response.output_text || '').toString().trim();\r\n    console.log(`Testo estratto da PDF: ${extractedText.length} caratteri`);\r\n    \r\n    if (!extractedText) {\r\n      throw new Error('Nessun testo estratto dal PDF');\r\n    }\r\n\r\n    return extractedText;\r\n\r\n  } catch (error) {\r\n    console.error('Error in PDF text extraction (Responses API):', error);\r\n    \r\n    if (error.status === 401) {\r\n      throw new Error('Chiave API OpenAI non valida. Verifica la configurazione.');\r\n    } else if (error.status === 429) {\r\n      throw new Error('Limite di rate raggiunto. Riprova tra qualche secondo.');\r\n    } else if (error.status === 400) {\r\n      throw new Error('Errore nell\\'analisi del PDF con Responses API. Il file potrebbe essere troppo grande o danneggiato.');\r\n    }\r\n    \r\n    throw new Error(`Errore nell'estrazione del testo PDF: ${error.message}`);\r\n  } finally {\r\n    // 4) Prova a rimuovere il file caricato (se l'SDK lo supporta)\r\n    try {\r\n      if (uploadedFile && uploadedFile.id) {\r\n        if (openai.files?.delete) {\r\n          await openai.files.delete(uploadedFile.id);\r\n        } else if (openai.files?.del) {\r\n          await openai.files.del(uploadedFile.id);\r\n        }\r\n        console.log('File rimosso da OpenAI:', uploadedFile.id);\r\n      }\r\n    } catch (delError) {\r\n      console.warn('Errore rimozione file da OpenAI (ignorato):', delError?.message || delError);\r\n    }\r\n  }\r\n}\r\n\r\n// DALL-E 3 - Get image URL only (faster, for streaming)\r\nexport async function getImageUrlFromDALLE(prompt, options = {}) {\r\n  if (!process.env.OPENAI_API_KEY) {\r\n    throw new Error('OPENAI_API_KEY is not configured. Please set it in your environment variables.');\r\n  }\r\n\r\n  try {\r\n    const size = options.size || '1024x1024';\r\n    const quality = options.quality || 'standard';\r\n    const style = options.style || 'vivid';\r\n\r\n    const response = await openai.images.generate({\r\n      model: 'dall-e-3',\r\n      prompt: prompt,\r\n      size: size,\r\n      quality: quality,\r\n      style: style,\r\n      n: 1,\r\n    });\r\n\r\n    const imageUrl = response.data[0]?.url;\r\n    if (!imageUrl) {\r\n      throw new Error('Nessuna immagine generata da DALL-E');\r\n    }\r\n\r\n    return imageUrl;\r\n  } catch (error) {\r\n    console.error('Error getting image URL from DALL-E:', error);\r\n    console.error('Error details:', {\r\n      status: error.status,\r\n      statusText: error.statusText,\r\n      message: error.message,\r\n      code: error.code,\r\n      response: error.response?.data || error.response\r\n    });\r\n    \r\n    if (error.status === 401) {\r\n      throw new Error('Chiave API OpenAI non valida. Verifica la configurazione.');\r\n    } else if (error.status === 429) {\r\n      throw new Error('Limite di rate raggiunto. Riprova tra qualche secondo.');\r\n    } else if (error.status === 400) {\r\n      const errorMessage = error.message || error.response?.data?.error?.message || 'Prompt non valido o contenuto non consentito';\r\n      throw new Error(`Errore nella generazione: ${errorMessage}`);\r\n    } else if (error.code === 'ENOTFOUND' || error.code === 'ECONNREFUSED') {\r\n      throw new Error('Errore di connessione con OpenAI. Verifica la tua connessione internet.');\r\n    }\r\n    \r\n    throw new Error(`Errore nella generazione dell'immagine: ${error.message || 'Errore sconosciuto'}`);\r\n  }\r\n}\r\n\r\n// DALL-E 3 - Generazione immagini (download completo, per backward compatibility)\r\nexport async function generateImageWithDALLE(prompt, options = {}) {\r\n  if (!process.env.OPENAI_API_KEY) {\r\n    throw new Error('OPENAI_API_KEY is not configured. Please set it in your environment variables.');\r\n  }\r\n\r\n  try {\r\n    const imageUrl = await getImageUrlFromDALLE(prompt, options);\r\n\r\n    // Download the image and return as buffer\r\n    const imageResponse = await fetch(imageUrl);\r\n    if (!imageResponse.ok) {\r\n      const errorText = await imageResponse.text().catch(() => 'Unknown error');\r\n      throw new Error(`Errore nel download dell'immagine generata: ${imageResponse.status} ${imageResponse.statusText}. ${errorText}`);\r\n    }\r\n\r\n    const arrayBuffer = await imageResponse.arrayBuffer();\r\n    return Buffer.from(arrayBuffer);\r\n  } catch (error) {\r\n    // Re-throw errors from getImageUrlFromDALLE\r\n    throw error;\r\n  }\r\n}\r\n\r\n// DALL-E 3 - Upscale/Miglioramento immagine usando variante\r\nexport async function upscaleImageWithDALLE(imageBuffer, imageMimeType, enhancementPrompt = null) {\r\n  if (!process.env.OPENAI_API_KEY) {\r\n    throw new Error('OPENAI_API_KEY is not configured. Please set it in your environment variables.');\r\n  }\r\n\r\n  try {\r\n    // 1. Analizza l'immagine con Vision API per creare un prompt descrittivo\r\n    const analysisPrompt = enhancementPrompt || 'Descrivi in dettaglio questa immagine, includendo tutti i dettagli visivi, colori, composizione, stile e qualità. La descrizione sarà usata per creare una versione migliorata ad alta risoluzione.';\r\n    \r\n    const imageDescription = await analyzeImageWithVision(\r\n      imageBuffer, \r\n      imageMimeType, \r\n      analysisPrompt\r\n    );\r\n\r\n    // 2. Crea un prompt per DALL-E che migliora l'immagine\r\n    const enhancementPromptText = `Crea una versione migliorata e ad alta risoluzione di questa immagine: ${imageDescription}. Mantieni fedeltà ai dettagli originali ma migliora la qualità, la nitidezza e la risoluzione.`;\r\n\r\n    // 3. Genera immagine migliorata con DALL-E 3 in alta risoluzione\r\n    const enhancedImageBuffer = await generateImageWithDALLE(enhancementPromptText, {\r\n      size: '1792x1024', // Formato landscape per alta risoluzione\r\n      quality: 'hd',\r\n      style: 'natural'\r\n    });\r\n\r\n    return enhancedImageBuffer;\r\n  } catch (error) {\r\n    console.error('Error upscaling image with DALL-E:', error);\r\n    throw new Error(`Errore nel miglioramento dell'immagine: ${error.message}`);\r\n  }\r\n}\r\n\r\n// Enhance existing image quality using AI analysis + sharp processing\r\nexport async function enhanceImageQualityWithAI(imageBuffer, imageMimeType) {\r\n  if (!process.env.OPENAI_API_KEY) {\r\n    throw new Error('OPENAI_API_KEY is not configured. Please set it in your environment variables.');\r\n  }\r\n\r\n  try {\r\n    // Use Vision API to analyze image quality issues\r\n    const analysisPrompt = `Analyze this image and identify specific quality issues that need improvement. Focus on:\r\n1. Noise level (low/medium/high)\r\n2. Sharpness (blurry/sharp)\r\n3. Color accuracy (washed out/vibrant)\r\n4. Artifacts (compression artifacts, pixelation)\r\n5. Overall quality issues\r\n\r\nRespond with a JSON object: {\"noise\": \"low|medium|high\", \"sharpness\": \"blurry|moderate|sharp\", \"color\": \"washed|normal|vibrant\", \"artifacts\": \"none|minor|major\", \"recommendations\": \"brief description\"}`;\r\n    \r\n    const analysisResult = await analyzeImageWithVision(\r\n      imageBuffer, \r\n      imageMimeType, \r\n      analysisPrompt\r\n    );\r\n\r\n    // Parse analysis result\r\n    let analysis = {\r\n      noise: 'medium',\r\n      sharpness: 'moderate',\r\n      color: 'normal',\r\n      artifacts: 'none'\r\n    };\r\n\r\n    try {\r\n      // Try to parse JSON from analysis\r\n      const jsonMatch = analysisResult.match(/\\{[\\s\\S]*\\}/);\r\n      if (jsonMatch) {\r\n        const parsed = JSON.parse(jsonMatch[0]);\r\n        analysis = { ...analysis, ...parsed };\r\n      }\r\n    } catch (parseError) {\r\n      console.warn('Could not parse AI analysis, using defaults');\r\n    }\r\n\r\n    // Apply targeted enhancements using sharp based on AI analysis\r\n    const sharp = (await import('sharp')).default;\r\n    let enhanced = sharp(imageBuffer, { sequentialRead: true });\r\n\r\n    // Apply denoising if needed\r\n    if (analysis.noise === 'high' || analysis.noise === 'medium') {\r\n      enhanced = enhanced.median(analysis.noise === 'high' ? 3 : 2);\r\n    }\r\n\r\n    // Apply sharpening based on analysis\r\n    if (analysis.sharpness === 'blurry') {\r\n      enhanced = enhanced.sharpen({\r\n        sigma: 2.0,\r\n        m1: 1.0,\r\n        m2: 0.5,\r\n        x1: 3,\r\n        y2: 3,\r\n        y3: 3\r\n      });\r\n    } else if (analysis.sharpness === 'moderate') {\r\n      enhanced = enhanced.sharpen({\r\n        sigma: 1.0,\r\n        m1: 0.7,\r\n        m2: 0.4\r\n      });\r\n    }\r\n\r\n    // Enhance color if needed\r\n    if (analysis.color === 'washed') {\r\n      enhanced = enhanced.modulate({\r\n        saturation: 1.15,\r\n        brightness: 1.05\r\n      }).linear(1.05, -(128 * 0.05)); // Slight contrast boost\r\n    }\r\n\r\n    // Remove compression artifacts\r\n    if (analysis.artifacts === 'major' || analysis.artifacts === 'minor') {\r\n      enhanced = enhanced.png({\r\n        quality: 100,\r\n        compressionLevel: 6,\r\n        adaptiveFiltering: true\r\n      });\r\n    } else {\r\n      // Keep original format but with high quality\r\n      if (imageMimeType === 'image/jpeg' || imageMimeType === 'image/jpg') {\r\n        enhanced = enhanced.jpeg({\r\n          quality: 98,\r\n          mozjpeg: true,\r\n          trellisQuantisation: true,\r\n          overshootDeringing: true\r\n        });\r\n      } else {\r\n        enhanced = enhanced.png({\r\n          quality: 100,\r\n          compressionLevel: 6\r\n        });\r\n      }\r\n    }\r\n\r\n    const enhancedBuffer = await enhanced.toBuffer();\r\n    return enhancedBuffer;\r\n  } catch (error) {\r\n    console.error('Error enhancing image quality with AI:', error);\r\n    // Return original buffer if enhancement fails\r\n    return imageBuffer;\r\n  }\r\n}\r\n","// Sistema di limiti d'uso per tool gratuiti e PRO\r\n// Piano gratuito senza registrazione: molto generoso per convincere a registrarsi\r\n\r\nexport const USAGE_LIMITS = {\r\n    // Piano gratuito SENZA registrazione (generoso ma limitato per incentivare registrazione)\r\n    GUEST: {\r\n        // Tool PRO - 5 utilizzi al giorno per tutti (generoso ma limitato)\r\n        'rimozione-sfondo-ai': {\r\n            daily: 5, // 5 immagini al giorno\r\n            monthly: 50, // 50 immagini al mese\r\n            fileSize: 5 * 1024 * 1024, // 5MB max\r\n        },\r\n        'generazione-immagini-ai': {\r\n            daily: 5, // 5 immagini al giorno\r\n            monthly: 50, // 50 immagini al mese\r\n        },\r\n        'clean-noise-ai': {\r\n            daily: 5, // 5 audio al giorno\r\n            monthly: 50, // 50 audio al mese\r\n            fileSize: 10 * 1024 * 1024, // 10MB max\r\n        },\r\n        'ocr-avanzato-ai': {\r\n            daily: 5, // 5 documenti al giorno\r\n            monthly: 50, // 50 documenti al mese\r\n            fileSize: 10 * 1024 * 1024, // 10MB max\r\n        },\r\n        'traduzione-documenti-ai': {\r\n            daily: 5, // 5 documenti al giorno\r\n            monthly: 50, // 50 documenti al mese\r\n            fileSize: 10 * 1024 * 1024, // 10MB max\r\n        },\r\n        'elabora-e-riassumi': {\r\n            daily: 5, // 5 testi al giorno\r\n            monthly: 50, // 50 testi al mese\r\n            maxLength: 5000, // 5000 caratteri max\r\n        },\r\n        'thumbnail-generator': {\r\n            daily: 5, // 5 thumbnail al giorno\r\n            monthly: 50, // 50 thumbnail al mese\r\n        },\r\n        'upscaler-ai': {\r\n            daily: 5, // 5 immagini al giorno\r\n            monthly: 50, // 50 immagini al mese\r\n            fileSize: 5 * 1024 * 1024, // 5MB max\r\n        },\r\n        // Tool gratuiti - limiti molto generosi\r\n        'trascrizione-audio': {\r\n            daily: 10, // 10 audio al giorno\r\n            monthly: 200, // 200 audio al mese\r\n            fileSize: 25 * 1024 * 1024, // 25MB max\r\n        },\r\n        'riassunto-testo': {\r\n            daily: 20, // 20 testi al giorno\r\n            monthly: 500, // 500 testi al mese\r\n            maxLength: 10000, // 10000 caratteri max\r\n        },\r\n        'traduci-testo': {\r\n            daily: 50, // 50 traduzioni al giorno\r\n            monthly: 1000, // 1000 traduzioni al mese\r\n            maxLength: 5000, // 5000 caratteri max\r\n        },\r\n        'correttore-grammaticale': {\r\n            daily: 30, // 30 testi al giorno\r\n            monthly: 500, // 500 testi al mese\r\n            maxLength: 5000, // 5000 caratteri max\r\n        },\r\n        'combina-splitta-pdf': {\r\n            daily: 20, // 20 operazioni al giorno\r\n            monthly: 300, // 300 operazioni al mese\r\n            fileSize: 50 * 1024 * 1024, // 50MB max\r\n        },\r\n    },\r\n    \r\n    // Piano gratuito CON registrazione (ancora più generoso)\r\n    FREE: {\r\n        'rimozione-sfondo-ai': {\r\n            daily: 50, // 50 immagini al giorno\r\n            monthly: 1000, // 1000 immagini al mese\r\n            fileSize: 10 * 1024 * 1024, // 10MB max\r\n        },\r\n        'generazione-immagini-ai': {\r\n            daily: 20, // 20 immagini al giorno\r\n            monthly: 300, // 300 immagini al mese\r\n        },\r\n        'clean-noise-ai': {\r\n            daily: 20, // 20 audio al giorno\r\n            monthly: 400, // 400 audio al mese\r\n            fileSize: 25 * 1024 * 1024, // 25MB max\r\n        },\r\n        'ocr-avanzato-ai': {\r\n            daily: 50, // 50 documenti al giorno\r\n            monthly: 1000, // 1000 documenti al mese\r\n            fileSize: 25 * 1024 * 1024, // 25MB max\r\n        },\r\n        'traduzione-documenti-ai': {\r\n            daily: 20, // 20 documenti al giorno\r\n            monthly: 400, // 400 documenti al mese\r\n            fileSize: 25 * 1024 * 1024, // 25MB max\r\n        },\r\n        'elabora-e-riassumi': {\r\n            daily: 50, // 50 testi al giorno\r\n            monthly: 1000, // 1000 testi al mese\r\n            maxLength: 20000, // 20000 caratteri max\r\n        },\r\n        'thumbnail-generator': {\r\n            daily: 50, // 50 thumbnail al giorno\r\n            monthly: 1000, // 1000 thumbnail al mese\r\n        },\r\n        'upscaler-ai': {\r\n            daily: 100, // 100 immagini al giorno\r\n            monthly: 2000, // 2000 immagini al mese\r\n            fileSize: 25 * 1024 * 1024, // 25MB max\r\n        },\r\n        'trascrizione-audio': {\r\n            daily: 50, // 50 audio al giorno\r\n            monthly: 1000, // 1000 audio al mese\r\n            fileSize: 50 * 1024 * 1024, // 50MB max\r\n        },\r\n        'riassunto-testo': {\r\n            daily: 100, // 100 testi al giorno\r\n            monthly: 2000, // 2000 testi al mese\r\n            maxLength: 50000, // 50000 caratteri max\r\n        },\r\n        'traduci-testo': {\r\n            daily: 200, // 200 traduzioni al giorno\r\n            monthly: 5000, // 5000 traduzioni al mese\r\n            maxLength: 20000, // 20000 caratteri max\r\n        },\r\n        'correttore-grammaticale': {\r\n            daily: 100, // 100 testi al giorno\r\n            monthly: 2000, // 2000 testi al mese\r\n            maxLength: 20000, // 20000 caratteri max\r\n        },\r\n        'combina-splitta-pdf': {\r\n            daily: 100, // 100 operazioni al giorno\r\n            monthly: 2000, // 2000 operazioni al mese\r\n            fileSize: 100 * 1024 * 1024, // 100MB max\r\n        },\r\n    },\r\n    \r\n    // Piano PRO (illimitato o limiti molto alti)\r\n    PRO: {\r\n        'rimozione-sfondo-ai': {\r\n            daily: -1, // Illimitato\r\n            monthly: -1, // Illimitato\r\n            fileSize: 50 * 1024 * 1024, // 50MB max\r\n        },\r\n        'generazione-immagini-ai': {\r\n            daily: 100, // 100 immagini al giorno\r\n            monthly: 2000, // 2000 immagini al mese\r\n        },\r\n        'clean-noise-ai': {\r\n            daily: -1, // Illimitato\r\n            monthly: -1, // Illimitato\r\n            fileSize: 100 * 1024 * 1024, // 100MB max\r\n        },\r\n        'ocr-avanzato-ai': {\r\n            daily: -1, // Illimitato\r\n            monthly: -1, // Illimitato\r\n            fileSize: 100 * 1024 * 1024, // 100MB max\r\n        },\r\n        'traduzione-documenti-ai': {\r\n            daily: -1, // Illimitato\r\n            monthly: -1, // Illimitato\r\n            fileSize: 100 * 1024 * 1024, // 100MB max\r\n        },\r\n        'elabora-e-riassumi': {\r\n            daily: -1, // Illimitato\r\n            monthly: -1, // Illimitato\r\n            maxLength: -1, // Illimitato\r\n        },\r\n        'thumbnail-generator': {\r\n            daily: -1, // Illimitato\r\n            monthly: -1, // Illimitato\r\n        },\r\n        'upscaler-ai': {\r\n            daily: -1, // Illimitato\r\n            monthly: -1, // Illimitato\r\n            fileSize: 100 * 1024 * 1024, // 100MB max\r\n        },\r\n        'trascrizione-audio': {\r\n            daily: -1, // Illimitato\r\n            monthly: -1, // Illimitato\r\n            fileSize: 200 * 1024 * 1024, // 200MB max\r\n        },\r\n        'riassunto-testo': {\r\n            daily: -1, // Illimitato\r\n            monthly: -1, // Illimitato\r\n            maxLength: -1, // Illimitato\r\n        },\r\n        'traduci-testo': {\r\n            daily: -1, // Illimitato\r\n            monthly: -1, // Illimitato\r\n            maxLength: -1, // Illimitato\r\n        },\r\n        'correttore-grammaticale': {\r\n            daily: -1, // Illimitato\r\n            monthly: -1, // Illimitato\r\n            maxLength: -1, // Illimitato\r\n        },\r\n        'combina-splitta-pdf': {\r\n            daily: -1, // Illimitato\r\n            monthly: -1, // Illimitato\r\n            fileSize: 500 * 1024 * 1024, // 500MB max\r\n        },\r\n    },\r\n};\r\n\r\n/**\r\n * Ottiene i limiti per un tool specifico in base al piano utente\r\n * @param {string} toolSlug - Slug del tool\r\n * @param {string} userPlan - Piano utente: 'GUEST', 'FREE', 'PRO'\r\n * @returns {Object|null} Limiti del tool o null se non trovato\r\n */\r\nexport function getToolLimits(toolSlug, userPlan = 'GUEST') {\r\n    const planLimits = USAGE_LIMITS[userPlan] || USAGE_LIMITS.GUEST;\r\n    return planLimits[toolSlug] || null;\r\n}\r\n\r\n/**\r\n * Verifica se un utente può usare un tool\r\n * @param {string} toolSlug - Slug del tool\r\n * @param {string} userPlan - Piano utente\r\n * @param {Object} usageStats - Statistiche uso corrente (daily, monthly)\r\n * @param {Object} fileInfo - Info file (size, length, etc.)\r\n * @returns {Object} { allowed: boolean, reason: string }\r\n */\r\nexport function canUseTool(toolSlug, userPlan = 'GUEST', usageStats = {}, fileInfo = {}) {\r\n    const limits = getToolLimits(toolSlug, userPlan);\r\n    \r\n    if (!limits) {\r\n        return { allowed: true, reason: 'Nessun limite configurato' };\r\n    }\r\n    \r\n    // Verifica limite giornaliero\r\n    if (limits.daily !== -1 && usageStats.daily >= limits.daily) {\r\n        return {\r\n            allowed: false,\r\n            reason: `Hai raggiunto il limite giornaliero di ${limits.daily} utilizzi. Riprova domani o passa a PRO per limiti più alti.`,\r\n            limitType: 'daily',\r\n            current: usageStats.daily,\r\n            max: limits.daily,\r\n        };\r\n    }\r\n    \r\n    // Verifica limite mensile\r\n    if (limits.monthly !== -1 && usageStats.monthly >= limits.monthly) {\r\n        return {\r\n            allowed: false,\r\n            reason: `Hai raggiunto il limite mensile di ${limits.monthly} utilizzi. Passa a PRO per limiti più alti.`,\r\n            limitType: 'monthly',\r\n            current: usageStats.monthly,\r\n            max: limits.monthly,\r\n        };\r\n    }\r\n    \r\n    // Verifica dimensione file\r\n    if (limits.fileSize && fileInfo.size && fileInfo.size > limits.fileSize) {\r\n        const maxMB = (limits.fileSize / (1024 * 1024)).toFixed(0);\r\n        return {\r\n            allowed: false,\r\n            reason: `File troppo grande. Dimensione massima: ${maxMB}MB. Passa a PRO per file più grandi.`,\r\n            limitType: 'fileSize',\r\n            current: fileInfo.size,\r\n            max: limits.fileSize,\r\n        };\r\n    }\r\n    \r\n    // Verifica lunghezza testo\r\n    if (limits.maxLength && fileInfo.length && fileInfo.length > limits.maxLength) {\r\n        return {\r\n            allowed: false,\r\n            reason: `Testo troppo lungo. Lunghezza massima: ${limits.maxLength} caratteri. Passa a PRO per testi più lunghi.`,\r\n            limitType: 'maxLength',\r\n            current: fileInfo.length,\r\n            max: limits.maxLength,\r\n        };\r\n    }\r\n    \r\n    return { allowed: true, reason: 'OK' };\r\n}\r\n\r\n/**\r\n * Ottiene il messaggio di upgrade per un tool\r\n * @param {string} toolSlug - Slug del tool\r\n * @param {string} currentPlan - Piano corrente\r\n * @returns {string} Messaggio di upgrade\r\n */\r\nexport function getUpgradeMessage(toolSlug, currentPlan = 'GUEST') {\r\n    const limits = getToolLimits(toolSlug, currentPlan);\r\n    const proLimits = getToolLimits(toolSlug, 'PRO');\r\n    \r\n    if (!limits || !proLimits) {\r\n        return 'Passa a PRO per funzionalità avanzate!';\r\n    }\r\n    \r\n    const messages = [];\r\n    \r\n    if (limits.daily !== -1 && proLimits.daily === -1) {\r\n        messages.push('utilizzi illimitati');\r\n    } else if (limits.daily < proLimits.daily) {\r\n        messages.push(`${proLimits.daily} utilizzi al giorno`);\r\n    }\r\n    \r\n    if (limits.fileSize && proLimits.fileSize && limits.fileSize < proLimits.fileSize) {\r\n        const maxMB = (proLimits.fileSize / (1024 * 1024)).toFixed(0);\r\n        messages.push(`file fino a ${maxMB}MB`);\r\n    }\r\n    \r\n    if (limits.maxLength && proLimits.maxLength === -1) {\r\n        messages.push('testi di lunghezza illimitata');\r\n    }\r\n    \r\n    if (messages.length === 0) {\r\n        return 'Passa a PRO per funzionalità avanzate!';\r\n    }\r\n    \r\n    return `Passa a PRO per ${messages.join(', ')} e molto altro!`;\r\n}\r\n\r\nexport default {\r\n    USAGE_LIMITS,\r\n    getToolLimits,\r\n    canUseTool,\r\n    getUpgradeMessage,\r\n};\r\n\r\n","// Sistema di tracking degli usi per limiti gratuiti/PRO\r\n// Usa storage in-memory (in produzione si può usare database)\r\n\r\nconst usageStore = new Map(); // { userId: { toolSlug: { daily: count, monthly: count, lastReset: date } } }\r\n\r\n/**\r\n * Ottiene le statistiche di uso per un utente e tool\r\n * @param {string} userId - ID utente (o 'guest' per utenti non registrati)\r\n * @param {string} toolSlug - Slug del tool\r\n * @returns {Object} { daily: number, monthly: number }\r\n */\r\nexport function getUsageStats(userId = 'guest', toolSlug) {\r\n    const userKey = userId || 'guest';\r\n    \r\n    if (!usageStore.has(userKey)) {\r\n        usageStore.set(userKey, {});\r\n    }\r\n    \r\n    const userUsage = usageStore.get(userKey);\r\n    \r\n    if (!userUsage[toolSlug]) {\r\n        userUsage[toolSlug] = {\r\n            daily: 0,\r\n            monthly: 0,\r\n            lastDailyReset: new Date().toDateString(),\r\n            lastMonthlyReset: new Date().getMonth(),\r\n        };\r\n    }\r\n    \r\n    const toolUsage = userUsage[toolSlug];\r\n    const today = new Date().toDateString();\r\n    const thisMonth = new Date().getMonth();\r\n    \r\n    // Reset giornaliero se necessario\r\n    if (toolUsage.lastDailyReset !== today) {\r\n        toolUsage.daily = 0;\r\n        toolUsage.lastDailyReset = today;\r\n    }\r\n    \r\n    // Reset mensile se necessario\r\n    if (toolUsage.lastMonthlyReset !== thisMonth) {\r\n        toolUsage.monthly = 0;\r\n        toolUsage.lastMonthlyReset = thisMonth;\r\n    }\r\n    \r\n    return {\r\n        daily: toolUsage.daily || 0,\r\n        monthly: toolUsage.monthly || 0,\r\n    };\r\n}\r\n\r\n/**\r\n * Incrementa il contatore di uso per un tool\r\n * @param {string} userId - ID utente\r\n * @param {string} toolSlug - Slug del tool\r\n */\r\nexport function incrementUsage(userId = 'guest', toolSlug) {\r\n    const userKey = userId || 'guest';\r\n    \r\n    if (!usageStore.has(userKey)) {\r\n        usageStore.set(userKey, {});\r\n    }\r\n    \r\n    const userUsage = usageStore.get(userKey);\r\n    \r\n    if (!userUsage[toolSlug]) {\r\n        userUsage[toolSlug] = {\r\n            daily: 0,\r\n            monthly: 0,\r\n            lastDailyReset: new Date().toDateString(),\r\n            lastMonthlyReset: new Date().getMonth(),\r\n        };\r\n    }\r\n    \r\n    const toolUsage = userUsage[toolSlug];\r\n    const today = new Date().toDateString();\r\n    const thisMonth = new Date().getMonth();\r\n    \r\n    // Reset se necessario\r\n    if (toolUsage.lastDailyReset !== today) {\r\n        toolUsage.daily = 0;\r\n        toolUsage.lastDailyReset = today;\r\n    }\r\n    \r\n    if (toolUsage.lastMonthlyReset !== thisMonth) {\r\n        toolUsage.monthly = 0;\r\n        toolUsage.lastMonthlyReset = thisMonth;\r\n    }\r\n    \r\n    // Incrementa contatori\r\n    toolUsage.daily = (toolUsage.daily || 0) + 1;\r\n    toolUsage.monthly = (toolUsage.monthly || 0) + 1;\r\n}\r\n\r\n/**\r\n * Ottiene il piano utente (per ora semplificato, in produzione si legge dal database)\r\n * @param {Object} req - Request object (opzionale)\r\n * @returns {string} Piano utente: 'GUEST', 'FREE', 'PRO'\r\n */\r\nexport function getUserPlan(req = null) {\r\n    // TODO: In produzione, leggere dal database o dalla sessione\r\n    // Per ora ritorna sempre 'GUEST' (utente non registrato)\r\n    \r\n    if (req && req.headers && req.headers['x-user-id']) {\r\n        // Se c'è un user ID, potresti controllare il piano dal database\r\n        // Per ora assumiamo FREE se registrato\r\n        return 'FREE';\r\n    }\r\n    \r\n    return 'GUEST';\r\n}\r\n\r\n/**\r\n * Ottiene l'ID utente dalla richiesta\r\n * @param {Object} req - Request object\r\n * @returns {string} User ID o 'guest'\r\n */\r\nexport function getUserId(req = null) {\r\n    if (req && req.headers && req.headers['x-user-id']) {\r\n        return req.headers['x-user-id'];\r\n    }\r\n    \r\n    // In produzione, potresti usare session/cookie\r\n    return 'guest';\r\n}\r\n\r\nexport default {\r\n    getUsageStats,\r\n    incrementUsage,\r\n    getUserPlan,\r\n    getUserId,\r\n};\r\n\r\n"],"names":[],"mappings":"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"}