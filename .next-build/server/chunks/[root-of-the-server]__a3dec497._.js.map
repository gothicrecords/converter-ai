{"version":3,"sources":["../../../lib/openai.js","../../../pages/api/tools/remove-background.js","../../../node_modules/next/src/build/templates/pages-api.ts"],"sourcesContent":["// OpenAI API integration with official SDK\r\nimport OpenAI from 'openai';\r\n\r\nconst openai = new OpenAI({\r\n  apiKey: process.env.OPENAI_API_KEY,\r\n});\r\n\r\n// Generate embeddings for text\r\nexport async function generateEmbedding(text) {\r\n  if (!process.env.OPENAI_API_KEY) {\r\n    throw new Error('OPENAI_API_KEY is not configured. Please set it in your environment variables.');\r\n  }\r\n\r\n  try {\r\n    const response = await openai.embeddings.create({\r\n      model: 'text-embedding-3-small',\r\n      input: text.substring(0, 8000), // Limit input size\r\n    });\r\n\r\n    return response.data[0].embedding;\r\n  } catch (error) {\r\n    console.error('Error generating embedding:', error);\r\n    throw new Error(`Failed to generate embedding: ${error.message}`);\r\n  }\r\n}\r\n\r\n// Generate embeddings in batch for an array of texts\r\nexport async function generateEmbeddingsBatch(texts) {\r\n  if (!process.env.OPENAI_API_KEY) {\r\n    throw new Error('OPENAI_API_KEY is not configured. Please set it in your environment variables.');\r\n  }\r\n\r\n  if (!Array.isArray(texts) || texts.length === 0) return [];\r\n\r\n  try {\r\n    const response = await openai.embeddings.create({\r\n      model: 'text-embedding-3-small',\r\n      input: texts.map(t => (t || '').toString().substring(0, 8000)),\r\n    });\r\n\r\n    return response.data.map(d => d.embedding);\r\n  } catch (error) {\r\n    console.error('Error generating batch embeddings:', error);\r\n    throw new Error(`Failed to generate batch embeddings: ${error.message}`);\r\n  }\r\n}\r\n\r\n// Chat completion using OpenAI GPT models\r\nexport async function chatCompletion(messages, options = {}) {\r\n  if (!process.env.OPENAI_API_KEY) {\r\n    throw new Error('OPENAI_API_KEY is not configured. Please set it in your environment variables.');\r\n  }\r\n\r\n  try {\r\n    const response = await openai.chat.completions.create({\r\n      model: options.model || 'gpt-4o-mini', // Fast and affordable\r\n      messages: messages,\r\n      temperature: options.temperature || 0.7,\r\n      max_tokens: options.max_tokens || 1000,\r\n      top_p: options.top_p || 1,\r\n      frequency_penalty: options.frequency_penalty || 0,\r\n      presence_penalty: options.presence_penalty || 0,\r\n    });\r\n\r\n    return response.choices[0].message.content;\r\n  } catch (error) {\r\n    console.error('Error in chat completion:', error);\r\n    \r\n    // Handle specific OpenAI errors\r\n    if (error.status === 401) {\r\n      throw new Error('Chiave API OpenAI non valida. Verifica la configurazione.');\r\n    } else if (error.status === 429) {\r\n      throw new Error('Limite di rate raggiunto. Riprova tra qualche secondo.');\r\n    } else if (error.status === 500) {\r\n      throw new Error('Errore del server OpenAI. Riprova più tardi.');\r\n    }\r\n    \r\n    throw new Error(`Errore nella comunicazione con OpenAI: ${error.message}`);\r\n  }\r\n}\r\n\r\n// Generate summary\r\nexport async function generateSummary(text, maxLength = 200) {\r\n  const messages = [\r\n    {\r\n      role: 'system',\r\n      content: 'You are a helpful assistant that creates concise summaries.',\r\n    },\r\n    {\r\n      role: 'user',\r\n      content: `Summarize the following text in ${maxLength} words or less:\\n\\n${text}`,\r\n    },\r\n  ];\r\n\r\n  return await chatCompletion(messages, { temperature: 0.5, max_tokens: 300 });\r\n}\r\n\r\n// Generate tags\r\nexport async function generateTags(text, count = 5) {\r\n  const messages = [\r\n    {\r\n      role: 'system',\r\n      content: 'You are a helpful assistant that generates relevant tags for documents. Return only comma-separated tags, no explanations.',\r\n    },\r\n    {\r\n      role: 'user',\r\n      content: `Generate ${count} relevant tags for this document:\\n\\n${text.substring(0, 2000)}`,\r\n    },\r\n  ];\r\n\r\n  const response = await chatCompletion(messages, { temperature: 0.3, max_tokens: 100 });\r\n  \r\n  return response\r\n    .split(',')\r\n    .map(tag => tag.trim().toLowerCase())\r\n    .filter(tag => tag.length > 0)\r\n    .slice(0, count);\r\n}\r\n\r\n// Classify document\r\nexport async function classifyDocument(text) {\r\n  const categories = [\r\n    'contract', 'invoice', 'report', 'presentation', \r\n    'spreadsheet', 'image', 'code', 'email', 'article', 'other'\r\n  ];\r\n\r\n  const messages = [\r\n    {\r\n      role: 'system',\r\n      content: `You are a document classifier. Classify the document into one or more of these categories: ${categories.join(', ')}. Return only category names, comma-separated.`,\r\n    },\r\n    {\r\n      role: 'user',\r\n      content: `Classify this document:\\n\\n${text.substring(0, 1000)}`,\r\n    },\r\n  ];\r\n\r\n  const response = await chatCompletion(messages, { temperature: 0.2, max_tokens: 50 });\r\n  \r\n  return response\r\n    .split(',')\r\n    .map(cat => cat.trim().toLowerCase())\r\n    .filter(cat => categories.includes(cat));\r\n}\r\n\r\n// Vision API - Analizza immagini come ChatGPT\r\nexport async function analyzeImageWithVision(imageBuffer, imageMimeType, query = 'Cosa contiene questa immagine? Descrivi tutto ciò che vedi.') {\r\n  if (!process.env.OPENAI_API_KEY) {\r\n    throw new Error('OPENAI_API_KEY is not configured. Please set it in your environment variables.');\r\n  }\r\n\r\n  try {\r\n    // Converti il buffer in base64\r\n    const base64Image = imageBuffer.toString('base64');\r\n    \r\n    const response = await openai.chat.completions.create({\r\n      model: 'gpt-4o', // GPT-4o supporta vision\r\n      messages: [\r\n        {\r\n          role: 'system',\r\n          content: 'Sei un assistente AI esperto nell\\'analisi di immagini. Descrivi in dettaglio tutto ciò che vedi nell\\'immagine, inclusi testo, oggetti, persone, scene, colori e qualsiasi altro dettaglio rilevante. Rispondi sempre in italiano.'\r\n        },\r\n        {\r\n          role: 'user',\r\n          content: [\r\n            {\r\n              type: 'text',\r\n              text: query\r\n            },\r\n            {\r\n              type: 'image_url',\r\n              image_url: {\r\n                url: `data:${imageMimeType};base64,${base64Image}`,\r\n                detail: 'high'\r\n              }\r\n            }\r\n          ]\r\n        }\r\n      ],\r\n      max_tokens: 2000,\r\n      temperature: 0.2\r\n    });\r\n\r\n    return response.choices[0].message.content;\r\n  } catch (error) {\r\n    console.error('Error in vision API:', error);\r\n    \r\n    if (error.status === 401) {\r\n      throw new Error('Chiave API OpenAI non valida. Verifica la configurazione.');\r\n    } else if (error.status === 429) {\r\n      throw new Error('Limite di rate raggiunto. Riprova tra qualche secondo.');\r\n    } else if (error.status === 400 && error.message?.includes('image')) {\r\n      throw new Error('Formato immagine non supportato o immagine troppo grande.');\r\n    }\r\n    \r\n    throw new Error(`Errore nell'analisi dell'immagine: ${error.message}`);\r\n  }\r\n}\r\n\r\n// Estrazione testo da PDF con OpenAI Responses API (gpt-4o) usando input_file\r\n// Ritorna SOLO la stringa di testo estratto (no IDs, no oggetti)\r\nexport async function extractTextFromPdfWithOpenAI(filePath) {\r\n  if (!process.env.OPENAI_API_KEY) {\r\n    throw new Error('OPENAI_API_KEY is not configured. Please set it in your environment variables.');\r\n  }\r\n\r\n  const fs = await import('fs');\r\n  \r\n  let uploadedFile = null;\r\n  try {\r\n    console.log('Caricamento PDF su OpenAI (Responses API):', filePath);\r\n    \r\n    // 1) Carica il file su OpenAI come user_data\r\n    uploadedFile = await openai.files.create({\r\n      file: fs.createReadStream(filePath),\r\n      purpose: 'user_data'\r\n    });\r\n\r\n    console.log('File caricato su OpenAI:', uploadedFile.id);\r\n\r\n    // 2) Richiesta al modello GPT-4o per estrazione testo dal file caricato\r\n    const response = await openai.responses.create({\r\n      model: 'gpt-4o',\r\n      input: [\r\n        {\r\n          role: 'user',\r\n          content: [\r\n            { type: 'input_text', text: 'Estrai tutto il testo e le informazioni rilevanti da questo documento. Rispondi SOLO con il testo estratto, senza commenti.' },\r\n            { type: 'input_file', file_id: uploadedFile.id }\r\n          ]\r\n        }\r\n      ],\r\n      max_output_tokens: 8000,\r\n      temperature: 0.1\r\n    });\r\n\r\n    // 3) Prendi solo testo\r\n    const extractedText = (response.output_text || '').toString().trim();\r\n    console.log(`Testo estratto da PDF: ${extractedText.length} caratteri`);\r\n    \r\n    if (!extractedText) {\r\n      throw new Error('Nessun testo estratto dal PDF');\r\n    }\r\n\r\n    return extractedText;\r\n\r\n  } catch (error) {\r\n    console.error('Error in PDF text extraction (Responses API):', error);\r\n    \r\n    if (error.status === 401) {\r\n      throw new Error('Chiave API OpenAI non valida. Verifica la configurazione.');\r\n    } else if (error.status === 429) {\r\n      throw new Error('Limite di rate raggiunto. Riprova tra qualche secondo.');\r\n    } else if (error.status === 400) {\r\n      throw new Error('Errore nell\\'analisi del PDF con Responses API. Il file potrebbe essere troppo grande o danneggiato.');\r\n    }\r\n    \r\n    throw new Error(`Errore nell'estrazione del testo PDF: ${error.message}`);\r\n  } finally {\r\n    // 4) Prova a rimuovere il file caricato (se l'SDK lo supporta)\r\n    try {\r\n      if (uploadedFile && uploadedFile.id) {\r\n        if (openai.files?.delete) {\r\n          await openai.files.delete(uploadedFile.id);\r\n        } else if (openai.files?.del) {\r\n          await openai.files.del(uploadedFile.id);\r\n        }\r\n        console.log('File rimosso da OpenAI:', uploadedFile.id);\r\n      }\r\n    } catch (delError) {\r\n      console.warn('Errore rimozione file da OpenAI (ignorato):', delError?.message || delError);\r\n    }\r\n  }\r\n}\r\n\r\n// DALL-E 3 - Get image URL only (faster, for streaming)\r\nexport async function getImageUrlFromDALLE(prompt, options = {}) {\r\n  if (!process.env.OPENAI_API_KEY) {\r\n    throw new Error('OPENAI_API_KEY is not configured. Please set it in your environment variables.');\r\n  }\r\n\r\n  try {\r\n    const size = options.size || '1024x1024';\r\n    const quality = options.quality || 'standard';\r\n    const style = options.style || 'vivid';\r\n\r\n    const response = await openai.images.generate({\r\n      model: 'dall-e-3',\r\n      prompt: prompt,\r\n      size: size,\r\n      quality: quality,\r\n      style: style,\r\n      n: 1,\r\n    });\r\n\r\n    const imageUrl = response.data[0]?.url;\r\n    if (!imageUrl) {\r\n      throw new Error('Nessuna immagine generata da DALL-E');\r\n    }\r\n\r\n    return imageUrl;\r\n  } catch (error) {\r\n    console.error('Error getting image URL from DALL-E:', error);\r\n    console.error('Error details:', {\r\n      status: error.status,\r\n      statusText: error.statusText,\r\n      message: error.message,\r\n      code: error.code,\r\n      response: error.response?.data || error.response\r\n    });\r\n    \r\n    if (error.status === 401) {\r\n      throw new Error('Chiave API OpenAI non valida. Verifica la configurazione.');\r\n    } else if (error.status === 429) {\r\n      throw new Error('Limite di rate raggiunto. Riprova tra qualche secondo.');\r\n    } else if (error.status === 400) {\r\n      const errorMessage = error.message || error.response?.data?.error?.message || 'Prompt non valido o contenuto non consentito';\r\n      throw new Error(`Errore nella generazione: ${errorMessage}`);\r\n    } else if (error.code === 'ENOTFOUND' || error.code === 'ECONNREFUSED') {\r\n      throw new Error('Errore di connessione con OpenAI. Verifica la tua connessione internet.');\r\n    }\r\n    \r\n    throw new Error(`Errore nella generazione dell'immagine: ${error.message || 'Errore sconosciuto'}`);\r\n  }\r\n}\r\n\r\n// DALL-E 3 - Generazione immagini (download completo, per backward compatibility)\r\nexport async function generateImageWithDALLE(prompt, options = {}) {\r\n  if (!process.env.OPENAI_API_KEY) {\r\n    throw new Error('OPENAI_API_KEY is not configured. Please set it in your environment variables.');\r\n  }\r\n\r\n  try {\r\n    const imageUrl = await getImageUrlFromDALLE(prompt, options);\r\n\r\n    // Download the image and return as buffer\r\n    const imageResponse = await fetch(imageUrl);\r\n    if (!imageResponse.ok) {\r\n      const errorText = await imageResponse.text().catch(() => 'Unknown error');\r\n      throw new Error(`Errore nel download dell'immagine generata: ${imageResponse.status} ${imageResponse.statusText}. ${errorText}`);\r\n    }\r\n\r\n    const arrayBuffer = await imageResponse.arrayBuffer();\r\n    return Buffer.from(arrayBuffer);\r\n  } catch (error) {\r\n    // Re-throw errors from getImageUrlFromDALLE\r\n    throw error;\r\n  }\r\n}\r\n\r\n// DALL-E 3 - Upscale/Miglioramento immagine usando variante\r\nexport async function upscaleImageWithDALLE(imageBuffer, imageMimeType, enhancementPrompt = null) {\r\n  if (!process.env.OPENAI_API_KEY) {\r\n    throw new Error('OPENAI_API_KEY is not configured. Please set it in your environment variables.');\r\n  }\r\n\r\n  try {\r\n    // 1. Analizza l'immagine con Vision API per creare un prompt descrittivo\r\n    const analysisPrompt = enhancementPrompt || 'Descrivi in dettaglio questa immagine, includendo tutti i dettagli visivi, colori, composizione, stile e qualità. La descrizione sarà usata per creare una versione migliorata ad alta risoluzione.';\r\n    \r\n    const imageDescription = await analyzeImageWithVision(\r\n      imageBuffer, \r\n      imageMimeType, \r\n      analysisPrompt\r\n    );\r\n\r\n    // 2. Crea un prompt per DALL-E che migliora l'immagine\r\n    const enhancementPromptText = `Crea una versione migliorata e ad alta risoluzione di questa immagine: ${imageDescription}. Mantieni fedeltà ai dettagli originali ma migliora la qualità, la nitidezza e la risoluzione.`;\r\n\r\n    // 3. Genera immagine migliorata con DALL-E 3 in alta risoluzione\r\n    const enhancedImageBuffer = await generateImageWithDALLE(enhancementPromptText, {\r\n      size: '1792x1024', // Formato landscape per alta risoluzione\r\n      quality: 'hd',\r\n      style: 'natural'\r\n    });\r\n\r\n    return enhancedImageBuffer;\r\n  } catch (error) {\r\n    console.error('Error upscaling image with DALL-E:', error);\r\n    throw new Error(`Errore nel miglioramento dell'immagine: ${error.message}`);\r\n  }\r\n}\r\n\r\n// Enhance existing image quality using AI analysis + sharp processing\r\nexport async function enhanceImageQualityWithAI(imageBuffer, imageMimeType) {\r\n  if (!process.env.OPENAI_API_KEY) {\r\n    throw new Error('OPENAI_API_KEY is not configured. Please set it in your environment variables.');\r\n  }\r\n\r\n  try {\r\n    // Use Vision API to analyze image quality issues\r\n    const analysisPrompt = `Analyze this image and identify specific quality issues that need improvement. Focus on:\r\n1. Noise level (low/medium/high)\r\n2. Sharpness (blurry/sharp)\r\n3. Color accuracy (washed out/vibrant)\r\n4. Artifacts (compression artifacts, pixelation)\r\n5. Overall quality issues\r\n\r\nRespond with a JSON object: {\"noise\": \"low|medium|high\", \"sharpness\": \"blurry|moderate|sharp\", \"color\": \"washed|normal|vibrant\", \"artifacts\": \"none|minor|major\", \"recommendations\": \"brief description\"}`;\r\n    \r\n    const analysisResult = await analyzeImageWithVision(\r\n      imageBuffer, \r\n      imageMimeType, \r\n      analysisPrompt\r\n    );\r\n\r\n    // Parse analysis result\r\n    let analysis = {\r\n      noise: 'medium',\r\n      sharpness: 'moderate',\r\n      color: 'normal',\r\n      artifacts: 'none'\r\n    };\r\n\r\n    try {\r\n      // Try to parse JSON from analysis\r\n      const jsonMatch = analysisResult.match(/\\{[\\s\\S]*\\}/);\r\n      if (jsonMatch) {\r\n        const parsed = JSON.parse(jsonMatch[0]);\r\n        analysis = { ...analysis, ...parsed };\r\n      }\r\n    } catch (parseError) {\r\n      console.warn('Could not parse AI analysis, using defaults');\r\n    }\r\n\r\n    // Apply targeted enhancements using sharp based on AI analysis\r\n    const sharp = (await import('sharp')).default;\r\n    let enhanced = sharp(imageBuffer, { sequentialRead: true });\r\n\r\n    // Apply denoising if needed\r\n    if (analysis.noise === 'high' || analysis.noise === 'medium') {\r\n      enhanced = enhanced.median(analysis.noise === 'high' ? 3 : 2);\r\n    }\r\n\r\n    // Apply sharpening based on analysis\r\n    if (analysis.sharpness === 'blurry') {\r\n      enhanced = enhanced.sharpen({\r\n        sigma: 2.0,\r\n        m1: 1.0,\r\n        m2: 0.5,\r\n        x1: 3,\r\n        y2: 3,\r\n        y3: 3\r\n      });\r\n    } else if (analysis.sharpness === 'moderate') {\r\n      enhanced = enhanced.sharpen({\r\n        sigma: 1.0,\r\n        m1: 0.7,\r\n        m2: 0.4\r\n      });\r\n    }\r\n\r\n    // Enhance color if needed\r\n    if (analysis.color === 'washed') {\r\n      enhanced = enhanced.modulate({\r\n        saturation: 1.15,\r\n        brightness: 1.05\r\n      }).linear(1.05, -(128 * 0.05)); // Slight contrast boost\r\n    }\r\n\r\n    // Remove compression artifacts\r\n    if (analysis.artifacts === 'major' || analysis.artifacts === 'minor') {\r\n      enhanced = enhanced.png({\r\n        quality: 100,\r\n        compressionLevel: 6,\r\n        adaptiveFiltering: true\r\n      });\r\n    } else {\r\n      // Keep original format but with high quality\r\n      if (imageMimeType === 'image/jpeg' || imageMimeType === 'image/jpg') {\r\n        enhanced = enhanced.jpeg({\r\n          quality: 98,\r\n          mozjpeg: true,\r\n          trellisQuantisation: true,\r\n          overshootDeringing: true\r\n        });\r\n      } else {\r\n        enhanced = enhanced.png({\r\n          quality: 100,\r\n          compressionLevel: 6\r\n        });\r\n      }\r\n    }\r\n\r\n    const enhancedBuffer = await enhanced.toBuffer();\r\n    return enhancedBuffer;\r\n  } catch (error) {\r\n    console.error('Error enhancing image quality with AI:', error);\r\n    // Return original buffer if enhancement fails\r\n    return imageBuffer;\r\n  }\r\n}\r\n","import formidable from 'formidable';\r\nimport fs from 'fs';\r\nimport fsPromises from 'fs/promises';\r\nimport sharp from 'sharp';\r\nimport { analyzeImageWithVision } from '../../../lib/openai.js';\r\n\r\nexport const config = {\r\n    api: {\r\n        bodyParser: false,\r\n    },\r\n};\r\n\r\nexport default async function handler(req, res) {\r\n    console.log('=== Remove Background API Handler Called ===');\r\n    console.log('Method:', req.method);\r\n    console.log('URL:', req.url);\r\n    console.log('Headers:', {\r\n        'content-type': req.headers['content-type'],\r\n        'content-length': req.headers['content-length']\r\n    });\r\n    \r\n    // Handle CORS preflight\r\n    if (req.method === 'OPTIONS') {\r\n        res.setHeader('Access-Control-Allow-Origin', '*');\r\n        res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');\r\n        res.setHeader('Access-Control-Allow-Headers', 'Content-Type');\r\n        res.status(200).end();\r\n        return;\r\n    }\r\n    \r\n    if (req.method !== 'POST') {\r\n        console.log('Method not allowed:', req.method);\r\n        return res.status(405).json({ error: 'Method not allowed' });\r\n    }\r\n\r\n    // Try OpenAI first if available for subject detection\r\n    const useOpenAI = Boolean(process.env.OPENAI_API_KEY);\r\n\r\n    // Assicurati che la directory tmp esista\r\n    const tmpDir = './tmp';\r\n    try {\r\n        await fsPromises.mkdir(tmpDir, { recursive: true });\r\n    } catch (mkdirError) {\r\n        console.warn('Failed to create tmp directory:', mkdirError);\r\n    }\r\n\r\n    const form = formidable({\r\n        multiples: false, // Non permettere file multipli\r\n        allowEmptyFiles: false, // Non permettere file vuoti\r\n        uploadDir: tmpDir, // Directory temporanea per i file\r\n        keepExtensions: true,\r\n        maxFileSize: 50 * 1024 * 1024 // 50MB max\r\n    });\r\n\r\n    let imageFilePath = null; // Dichiarata qui per essere accessibile nel catch\r\n\r\n    try {\r\n        console.log('=== Remove Background API Request ===');\r\n        console.log('Method:', req.method);\r\n        console.log('Content-Type:', req.headers['content-type']);\r\n        console.log('Content-Length:', req.headers['content-length']);\r\n        \r\n        const [fields, files] = await new Promise((resolve, reject) => {\r\n            form.parse(req, (err, fields, files) => {\r\n                if (err) {\r\n                    console.error('Formidable parse error:', err);\r\n                    // Gestisci errori specifici di formidable\r\n                    if (err.message && err.message.includes('file size should be greater than 0')) {\r\n                        return reject(new Error('Il file è vuoto. Carica un file valido.'));\r\n                    }\r\n                    if (err.message && err.message.includes('options.allowEmptyFiles')) {\r\n                        return reject(new Error('Il file caricato è vuoto. Carica un file con contenuto.'));\r\n                    }\r\n                    return reject(err);\r\n                }\r\n                console.log('Formidable parsed successfully');\r\n                console.log('Fields keys:', Object.keys(fields || {}));\r\n                console.log('Files keys:', Object.keys(files || {}));\r\n                resolve([fields, files]);\r\n            });\r\n        });\r\n        \r\n        // Gestisci sia array che singolo oggetto - formidable v3 restituisce array, v2 oggetto singolo\r\n        // Supporta sia 'file' che 'image' come nome campo\r\n        let imageFile = files?.file ?? files?.image ?? null;\r\n        if (Array.isArray(imageFile)) {\r\n            imageFile = imageFile[0];\r\n        }\r\n        \r\n        if (!imageFile) {\r\n            console.error('No file found. Available fields:', Object.keys(files || {}));\r\n            return res.status(400).json({ \r\n                error: 'Nessun file caricato. Assicurati di selezionare un file immagine valido.'\r\n            });\r\n        }\r\n        \r\n        // Valida che il file non sia vuoto\r\n        if (!imageFile.size || imageFile.size === 0) {\r\n            return res.status(400).json({ error: 'Il file è vuoto. Carica un file valido.' });\r\n        }\r\n\r\n        // Verifica che filepath esista\r\n        imageFilePath = imageFile.filepath || imageFile.path;\r\n        if (!imageFilePath) {\r\n            console.error('File object:', JSON.stringify(Object.keys(imageFile || {})));\r\n            return res.status(400).json({ error: 'Errore nel caricamento del file. Path mancante.' });\r\n        }\r\n\r\n        // Leggi il file come buffer\r\n        const imageBuffer = await fsPromises.readFile(imageFilePath);\r\n        const mimeType = imageFile.mimetype || 'image/jpeg';\r\n\r\n        // Se OpenAI è disponibile, usa Vision API per identificare il tipo di soggetto\r\n        let detectedType = 'auto';\r\n        if (useOpenAI) {\r\n            try {\r\n                console.log('Using OpenAI Vision API to detect subject type');\r\n                const analysisPrompt = 'Analizza questa immagine e identifica il tipo principale di soggetto. Rispondi con una sola parola: \"person\", \"product\", \"car\", \"animal\", o \"other\".';\r\n                const analysis = await analyzeImageWithVision(imageBuffer, mimeType, analysisPrompt);\r\n                const lowerAnalysis = analysis.toLowerCase();\r\n                if (lowerAnalysis.includes('person') || lowerAnalysis.includes('persona') || lowerAnalysis.includes('uomo') || lowerAnalysis.includes('donna')) {\r\n                    detectedType = 'person';\r\n                } else if (lowerAnalysis.includes('product') || lowerAnalysis.includes('prodotto') || lowerAnalysis.includes('oggetto')) {\r\n                    detectedType = 'product';\r\n                } else if (lowerAnalysis.includes('car') || lowerAnalysis.includes('auto') || lowerAnalysis.includes('veicolo')) {\r\n                    detectedType = 'car';\r\n                } else if (lowerAnalysis.includes('animal') || lowerAnalysis.includes('animale') || lowerAnalysis.includes('cane') || lowerAnalysis.includes('gatto')) {\r\n                    detectedType = 'animal';\r\n                }\r\n                console.log('Detected subject type:', detectedType);\r\n            } catch (visionError) {\r\n                console.warn('OpenAI Vision API failed, using default type:', visionError.message);\r\n            }\r\n        }\r\n\r\n        // Opzioni aggiuntive dal client per migliorare il risultato\r\n        // Supportate da remove.bg: type, size, crop, crop_margin, bg_color, channels, format\r\n        const type = (fields.type?.[0] || detectedType).toString(); // Usa il tipo rilevato da OpenAI se disponibile\r\n        const size = (fields.size?.[0] || 'full').toString(); // preview | small | regular | medium | full | auto\r\n        const crop = (fields.crop?.[0] || 'false').toString(); // 'true' | 'false'\r\n        const cropMargin = (fields.crop_margin?.[0] || '0').toString(); // e.g. '10%'\r\n        const bgColor = (fields.bg_color?.[0] || '').toString(); // e.g. 'ffffff'\r\n\r\n        // Usa un servizio API gratuito per la rimozione dello sfondo\r\n        // Usiamo remove.bg API gratuita (50 immagini/mese) o un'alternativa\r\n        console.log('Processing image for background removal');\r\n        console.log('Image details:', {\r\n            size: imageFile.size,\r\n            mimeType: mimeType,\r\n            path: imageFilePath\r\n        });\r\n\r\n        try {\r\n            // Algoritmo avanzato di rimozione sfondo usando sharp\r\n            // Usa tecniche di edge detection, color clustering e background subtraction\r\n            \r\n            const image = sharp(imageBuffer);\r\n            const metadata = await image.metadata();\r\n            \r\n            console.log('Image metadata:', {\r\n                width: metadata.width,\r\n                height: metadata.height,\r\n                format: metadata.format,\r\n                hasAlpha: metadata.hasAlpha\r\n            });\r\n            \r\n            let result;\r\n            \r\n            if (metadata.hasAlpha) {\r\n                // L'immagine ha già trasparenza, mantienila e migliorala\r\n                result = await image\r\n                    .png({ quality: 100, compressionLevel: 9 })\r\n                    .toBuffer();\r\n            } else {\r\n                // Algoritmo avanzato di rimozione sfondo\r\n                const { data, info } = await image\r\n                    .raw()\r\n                    .ensureAlpha()\r\n                    .toBuffer({ resolveWithObject: true });\r\n                \r\n                const width = info.width;\r\n                const height = info.height;\r\n                const channels = info.channels;\r\n                const newData = Buffer.alloc(width * height * 4);\r\n                \r\n                // Step 1: Analizza i bordi dell'immagine per identificare lo sfondo\r\n                // Gli angoli e i bordi sono spesso sfondo\r\n                const cornerSamples = [];\r\n                const sampleSize = Math.min(50, Math.floor(width * 0.1), Math.floor(height * 0.1));\r\n                \r\n                // Campiona gli angoli\r\n                for (let y = 0; y < sampleSize; y++) {\r\n                    for (let x = 0; x < sampleSize; x++) {\r\n                        // Angolo in alto a sinistra\r\n                        const idx1 = (y * width + x) * channels;\r\n                        // Angolo in alto a destra\r\n                        const idx2 = (y * width + (width - 1 - x)) * channels;\r\n                        // Angolo in basso a sinistra\r\n                        const idx3 = ((height - 1 - y) * width + x) * channels;\r\n                        // Angolo in basso a destra\r\n                        const idx4 = ((height - 1 - y) * width + (width - 1 - x)) * channels;\r\n                        \r\n                        [idx1, idx2, idx3, idx4].forEach(idx => {\r\n                            if (idx < data.length) {\r\n                                cornerSamples.push({\r\n                                    r: data[idx],\r\n                                    g: data[idx + 1],\r\n                                    b: data[idx + 2]\r\n                                });\r\n                            }\r\n                        });\r\n                    }\r\n                }\r\n                \r\n                // Calcola il colore medio dello sfondo dai campioni degli angoli\r\n                const avgBg = cornerSamples.reduce((acc, pixel) => ({\r\n                    r: acc.r + pixel.r,\r\n                    g: acc.g + pixel.g,\r\n                    b: acc.b + pixel.b\r\n                }), { r: 0, g: 0, b: 0 });\r\n                \r\n                const bgColor = {\r\n                    r: avgBg.r / cornerSamples.length,\r\n                    g: avgBg.g / cornerSamples.length,\r\n                    b: avgBg.b / cornerSamples.length\r\n                };\r\n                \r\n                // Step 2: Crea maschera basata sulla distanza dal colore di sfondo\r\n                for (let i = 0; i < data.length; i += channels) {\r\n                    const r = data[i];\r\n                    const g = data[i + 1];\r\n                    const b = data[i + 2];\r\n                    \r\n                    // Calcola distanza euclidea dal colore di sfondo\r\n                    const distR = Math.abs(r - bgColor.r);\r\n                    const distG = Math.abs(g - bgColor.g);\r\n                    const distB = Math.abs(b - bgColor.b);\r\n                    const colorDistance = Math.sqrt(distR * distR + distG * distG + distB * distB);\r\n                    \r\n                    // Calcola anche la luminosità\r\n                    const brightness = (r * 0.299 + g * 0.587 + b * 0.114) / 255;\r\n                    \r\n                    // Combina distanza colore e luminosità per determinare alpha\r\n                    // Pixel molto simili allo sfondo = trasparenti\r\n                    // Pixel diversi dallo sfondo = opachi\r\n                    const colorSimilarity = 1 - Math.min(colorDistance / 255, 1);\r\n                    const brightnessFactor = brightness > 0.9 ? 0.3 : 1; // Sfondi chiari più facili da rimuovere\r\n                    \r\n                    // Alpha: 0 = trasparente, 255 = opaco\r\n                    let alpha = 255;\r\n                    \r\n                    // Se il pixel è molto simile allo sfondo, rendilo trasparente\r\n                    if (colorDistance < 30) {\r\n                        alpha = Math.max(0, Math.round(255 * (colorDistance / 30) * 0.3));\r\n                    } else if (colorDistance < 60) {\r\n                        alpha = Math.max(50, Math.round(255 * ((colorDistance - 30) / 30) * 0.7 + 0.3));\r\n                    } else {\r\n                        // Pixel molto diversi dallo sfondo = probabilmente soggetto\r\n                        alpha = 255;\r\n                    }\r\n                    \r\n                    // Applica fattore di luminosità\r\n                    alpha = Math.round(alpha * brightnessFactor);\r\n                    \r\n                    // Edge detection: i bordi sono sempre soggetto\r\n                    const x = (i / channels) % width;\r\n                    const y = Math.floor((i / channels) / width);\r\n                    const isEdge = x < 5 || x > width - 5 || y < 5 || y > height - 5;\r\n                    if (isEdge && colorDistance > 40) {\r\n                        alpha = 255; // I bordi sono sempre opachi se diversi dallo sfondo\r\n                    }\r\n                    \r\n                    const pixelIndex = (i / channels) * 4;\r\n                    newData[pixelIndex] = r;\r\n                    newData[pixelIndex + 1] = g;\r\n                    newData[pixelIndex + 2] = b;\r\n                    newData[pixelIndex + 3] = alpha;\r\n                }\r\n                \r\n                // Step 3: Applica smoothing alla maschera per bordi più morbidi\r\n                const smoothedData = Buffer.from(newData);\r\n                for (let y = 1; y < height - 1; y++) {\r\n                    for (let x = 1; x < width - 1; x++) {\r\n                        const idx = (y * width + x) * 4;\r\n                        const alpha = newData[idx + 3];\r\n                        \r\n                        // Media con i pixel circostanti per smoothing\r\n                        let alphaSum = alpha;\r\n                        for (let dy = -1; dy <= 1; dy++) {\r\n                            for (let dx = -1; dx <= 1; dx++) {\r\n                                if (dx === 0 && dy === 0) continue;\r\n                                const neighborIdx = ((y + dy) * width + (x + dx)) * 4;\r\n                                alphaSum += newData[neighborIdx + 3];\r\n                            }\r\n                        }\r\n                        const avgAlpha = Math.round(alphaSum / 9);\r\n                        smoothedData[idx + 3] = avgAlpha;\r\n                    }\r\n                }\r\n                \r\n                result = await sharp(smoothedData, {\r\n                    raw: {\r\n                        width: width,\r\n                        height: height,\r\n                        channels: 4\r\n                    }\r\n                })\r\n                .png({ quality: 100, compressionLevel: 9 })\r\n                .toBuffer();\r\n            }\r\n\r\n            res.setHeader('Content-Type', 'image/png');\r\n            res.setHeader('Cache-Control', 'no-cache, no-store, must-revalidate');\r\n            res.setHeader('Pragma', 'no-cache');\r\n            res.setHeader('Expires', '0');\r\n            \r\n            // Cleanup temp file\r\n            try {\r\n                await fsPromises.unlink(imageFilePath);\r\n            } catch (cleanupError) {\r\n                console.warn('Failed to cleanup temp file:', cleanupError);\r\n            }\r\n            \r\n            res.status(200).send(result);\r\n        } catch (processingError) {\r\n            console.error('Image processing failed:', processingError);\r\n            throw new Error(`Errore durante la rimozione dello sfondo: ${processingError.message}`);\r\n        }\r\n\r\n    } catch (error) {\r\n        // Cleanup temp file on error\r\n        if (imageFilePath) {\r\n            try {\r\n                await fsPromises.unlink(imageFilePath);\r\n            } catch (cleanupError) {\r\n                console.warn('Failed to cleanup temp file on error:', cleanupError);\r\n            }\r\n        }\r\n        console.error(\"=== Errore durante l'elaborazione dell'immagine ===\");\r\n        console.error(\"Error name:\", error.name);\r\n        console.error(\"Error message:\", error.message);\r\n        console.error(\"Error stack:\", error.stack);\r\n        \r\n        // Gestisci errori specifici\r\n        let statusCode = 500;\r\n        let errorMessage = \"Errore interno del server durante l'elaborazione dell'immagine.\";\r\n        \r\n        if (error.message && error.message.includes('file size should be greater than 0')) {\r\n            statusCode = 400;\r\n            errorMessage = 'Il file è vuoto. Carica un file valido.';\r\n        } else if (error.message && error.message.includes('options.allowEmptyFiles')) {\r\n            statusCode = 400;\r\n            errorMessage = 'Il file caricato è vuoto. Carica un file con contenuto.';\r\n        } else if (error.message && error.message.includes('Nessun file caricato')) {\r\n            statusCode = 400;\r\n            errorMessage = error.message;\r\n        } else if (error.message) {\r\n            errorMessage = error.message;\r\n        }\r\n        \r\n        res.status(statusCode).json({ \r\n            error: errorMessage,\r\n            debug: process.env.NODE_ENV === 'development' ? {\r\n                errorName: error.name,\r\n                errorMessage: error.message\r\n            } : undefined\r\n        });\r\n    }\r\n}\r\n","import type { NextApiResponse } from '../../types'\nimport type { IncomingMessage, ServerResponse } from 'node:http'\n\nimport { sendError } from '../../server/api-utils'\nimport { RouteKind } from '../../server/route-kind'\nimport type { Span } from '../../server/lib/trace/tracer'\nimport { PagesAPIRouteModule } from '../../server/route-modules/pages-api/module.compiled'\n\nimport { hoist } from './helpers'\n\n// Import the userland code.\nimport * as userland from 'VAR_USERLAND'\nimport { getTracer, SpanKind } from '../../server/lib/trace/tracer'\nimport { BaseServerSpan } from '../../server/lib/trace/constants'\nimport type { InstrumentationOnRequestError } from '../../server/instrumentation/types'\nimport { addRequestMeta } from '../../server/request-meta'\n\n// Re-export the handler (should be the default export).\nexport default hoist(userland, 'default')\n\n// Re-export config.\nexport const config = hoist(userland, 'config')\n\n// Create and export the route module that will be consumed.\nconst routeModule = new PagesAPIRouteModule({\n  definition: {\n    kind: RouteKind.PAGES_API,\n    page: 'VAR_DEFINITION_PAGE',\n    pathname: 'VAR_DEFINITION_PATHNAME',\n    // The following aren't used in production.\n    bundlePath: '',\n    filename: '',\n  },\n  userland,\n  distDir: process.env.__NEXT_RELATIVE_DIST_DIR || '',\n  relativeProjectDir: process.env.__NEXT_RELATIVE_PROJECT_DIR || '',\n})\n\nexport async function handler(\n  req: IncomingMessage,\n  res: ServerResponse,\n  ctx: {\n    waitUntil?: (prom: Promise<void>) => void\n  }\n): Promise<void> {\n  if (routeModule.isDev) {\n    addRequestMeta(req, 'devRequestTimingInternalsEnd', process.hrtime.bigint())\n  }\n  let srcPage = 'VAR_DEFINITION_PAGE'\n\n  // turbopack doesn't normalize `/index` in the page name\n  // so we need to to process dynamic routes properly\n  // TODO: fix turbopack providing differing value from webpack\n  if (process.env.TURBOPACK) {\n    srcPage = srcPage.replace(/\\/index$/, '') || '/'\n  }\n\n  const prepareResult = await routeModule.prepare(req, res, { srcPage })\n\n  if (!prepareResult) {\n    res.statusCode = 400\n    res.end('Bad Request')\n    ctx.waitUntil?.(Promise.resolve())\n    return\n  }\n\n  const { query, params, prerenderManifest, routerServerContext } =\n    prepareResult\n\n  try {\n    const method = req.method || 'GET'\n    const tracer = getTracer()\n\n    const activeSpan = tracer.getActiveScopeSpan()\n    const onRequestError =\n      routeModule.instrumentationOnRequestError.bind(routeModule)\n\n    const invokeRouteModule = async (span?: Span) =>\n      routeModule\n        .render(req, res, {\n          query: {\n            ...query,\n            ...params,\n          },\n          params,\n          allowedRevalidateHeaderKeys: process.env\n            .__NEXT_ALLOWED_REVALIDATE_HEADERS as any as string[],\n          multiZoneDraftMode: Boolean(process.env.__NEXT_MULTI_ZONE_DRAFT_MODE),\n          trustHostHeader: process.env\n            .__NEXT_TRUST_HOST_HEADER as any as boolean,\n          // TODO: get this from from runtime env so manifest\n          // doesn't need to load\n          previewProps: prerenderManifest.preview,\n          propagateError: false,\n          dev: routeModule.isDev,\n          page: 'VAR_DEFINITION_PAGE',\n\n          internalRevalidate: routerServerContext?.revalidate,\n\n          onError: (...args: Parameters<InstrumentationOnRequestError>) =>\n            onRequestError(req, ...args),\n        })\n        .finally(() => {\n          if (!span) return\n\n          span.setAttributes({\n            'http.status_code': res.statusCode,\n            'next.rsc': false,\n          })\n\n          const rootSpanAttributes = tracer.getRootSpanAttributes()\n          // We were unable to get attributes, probably OTEL is not enabled\n          if (!rootSpanAttributes) {\n            return\n          }\n\n          if (\n            rootSpanAttributes.get('next.span_type') !==\n            BaseServerSpan.handleRequest\n          ) {\n            console.warn(\n              `Unexpected root span type '${rootSpanAttributes.get(\n                'next.span_type'\n              )}'. Please report this Next.js issue https://github.com/vercel/next.js`\n            )\n            return\n          }\n\n          const route = rootSpanAttributes.get('next.route')\n          if (route) {\n            const name = `${method} ${route}`\n\n            span.setAttributes({\n              'next.route': route,\n              'http.route': route,\n              'next.span_name': name,\n            })\n            span.updateName(name)\n          } else {\n            span.updateName(`${method} ${srcPage}`)\n          }\n        })\n\n    // TODO: activeSpan code path is for when wrapped by\n    // next-server can be removed when this is no longer used\n    if (activeSpan) {\n      await invokeRouteModule(activeSpan)\n    } else {\n      await tracer.withPropagatedContext(req.headers, () =>\n        tracer.trace(\n          BaseServerSpan.handleRequest,\n          {\n            spanName: `${method} ${srcPage}`,\n            kind: SpanKind.SERVER,\n            attributes: {\n              'http.method': method,\n              'http.target': req.url,\n            },\n          },\n          invokeRouteModule\n        )\n      )\n    }\n  } catch (err) {\n    // we re-throw in dev to show the error overlay\n    if (routeModule.isDev) {\n      throw err\n    }\n    // this is technically an invariant as error handling\n    // should be done inside of api-resolver onError\n    sendError(res as NextApiResponse, 500, 'Internal Server Error')\n  } finally {\n    // We don't allow any waitUntil work in pages API routes currently\n    // so if callback is present return with resolved promise since no\n    // pending work\n    ctx.waitUntil?.(Promise.resolve())\n  }\n}\n"],"names":["sendError","RouteKind","PagesAPIRouteModule","hoist","userland","getTracer","SpanKind","BaseServerSpan","addRequestMeta","config","routeModule","definition","kind","PAGES_API","page","pathname","bundlePath","filename","distDir","process","env","__NEXT_RELATIVE_DIST_DIR","relativeProjectDir","__NEXT_RELATIVE_PROJECT_DIR","handler","req","res","ctx","isDev","hrtime","bigint","srcPage","TURBOPACK","replace","prepareResult","prepare","statusCode","end","waitUntil","Promise","resolve","query","params","prerenderManifest","routerServerContext","method","tracer","activeSpan","getActiveScopeSpan","onRequestError","instrumentationOnRequestError","bind","invokeRouteModule","span","render","allowedRevalidateHeaderKeys","__NEXT_ALLOWED_REVALIDATE_HEADERS","multiZoneDraftMode","Boolean","__NEXT_MULTI_ZONE_DRAFT_MODE","trustHostHeader","__NEXT_TRUST_HOST_HEADER","previewProps","preview","propagateError","dev","internalRevalidate","revalidate","onError","args","finally","setAttributes","rootSpanAttributes","getRootSpanAttributes","get","handleRequest","console","warn","route","name","updateName","withPropagatedContext","headers","trace","spanName","SERVER","attributes","url","err"],"mappings":"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","ignoreList":[2]}