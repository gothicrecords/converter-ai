module.exports=[270406,(e,r,t)=>{r.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},522734,(e,r,t)=>{r.exports=e.x("fs",()=>require("fs"))},293635,e=>e.a(async(r,t)=>{try{let r=await e.y("formidable");e.n(r),t()}catch(e){t(e)}},!0),871815,(e,r,t)=>{r.exports=e.x("sharp",()=>require("sharp"))},74538,e=>e.a(async(r,t)=>{try{let r=await e.y("openai");e.n(r),t()}catch(e){t(e)}},!0),267370,e=>e.a(async(r,t)=>{try{var a=e.i(74538),o=r([a]);[a]=o.then?(await o)():o;let E=new a.default({apiKey:process.env.OPENAI_API_KEY});async function i(e){if(!process.env.OPENAI_API_KEY)throw Error("OPENAI_API_KEY is not configured. Please set it in your environment variables.");try{return(await E.embeddings.create({model:"text-embedding-3-small",input:e.substring(0,8e3)})).data[0].embedding}catch(e){throw console.error("Error generating embedding:",e),Error(`Failed to generate embedding: ${e.message}`)}}async function n(e){if(!process.env.OPENAI_API_KEY)throw Error("OPENAI_API_KEY is not configured. Please set it in your environment variables.");if(!Array.isArray(e)||0===e.length)return[];try{return(await E.embeddings.create({model:"text-embedding-3-small",input:e.map(e=>(e||"").toString().substring(0,8e3))})).data.map(e=>e.embedding)}catch(e){throw console.error("Error generating batch embeddings:",e),Error(`Failed to generate batch embeddings: ${e.message}`)}}async function s(e,r={}){if(!process.env.OPENAI_API_KEY)throw Error("OPENAI_API_KEY is not configured. Please set it in your environment variables.");try{return(await E.chat.completions.create({model:r.model||"gpt-4o-mini",messages:e,temperature:r.temperature||.7,max_tokens:r.max_tokens||1e3,top_p:r.top_p||1,frequency_penalty:r.frequency_penalty||0,presence_penalty:r.presence_penalty||0})).choices[0].message.content}catch(e){if(console.error("Error in chat completion:",e),401===e.status)throw Error("Chiave API OpenAI non valida. Verifica la configurazione.");if(429===e.status)throw Error("Limite di rate raggiunto. Riprova tra qualche secondo.");if(500===e.status)throw Error("Errore del server OpenAI. Riprova più tardi.");throw Error(`Errore nella comunicazione con OpenAI: ${e.message}`)}}async function l(e,r=200){let t=[{role:"system",content:"You are a helpful assistant that creates concise summaries."},{role:"user",content:`Summarize the following text in ${r} words or less:

${e}`}];return await s(t,{temperature:.5,max_tokens:300})}async function c(e,r=5){let t=[{role:"system",content:"You are a helpful assistant that generates relevant tags for documents. Return only comma-separated tags, no explanations."},{role:"user",content:`Generate ${r} relevant tags for this document:

${e.substring(0,2e3)}`}];return(await s(t,{temperature:.3,max_tokens:100})).split(",").map(e=>e.trim().toLowerCase()).filter(e=>e.length>0).slice(0,r)}async function u(e){let r=["contract","invoice","report","presentation","spreadsheet","image","code","email","article","other"],t=[{role:"system",content:`You are a document classifier. Classify the document into one or more of these categories: ${r.join(", ")}. Return only category names, comma-separated.`},{role:"user",content:`Classify this document:

${e.substring(0,1e3)}`}];return(await s(t,{temperature:.2,max_tokens:50})).split(",").map(e=>e.trim().toLowerCase()).filter(e=>r.includes(e))}async function d(e,r,t="Cosa contiene questa immagine? Descrivi tutto ciò che vedi."){if(!process.env.OPENAI_API_KEY)throw Error("OPENAI_API_KEY is not configured. Please set it in your environment variables.");try{let a=e.toString("base64");return(await E.chat.completions.create({model:"gpt-4o",messages:[{role:"system",content:"Sei un assistente AI esperto nell'analisi di immagini. Descrivi in dettaglio tutto ciò che vedi nell'immagine, inclusi testo, oggetti, persone, scene, colori e qualsiasi altro dettaglio rilevante. Rispondi sempre in italiano."},{role:"user",content:[{type:"text",text:t},{type:"image_url",image_url:{url:`data:${r};base64,${a}`,detail:"high"}}]}],max_tokens:2e3,temperature:.2})).choices[0].message.content}catch(e){if(console.error("Error in vision API:",e),401===e.status)throw Error("Chiave API OpenAI non valida. Verifica la configurazione.");if(429===e.status)throw Error("Limite di rate raggiunto. Riprova tra qualche secondo.");if(400===e.status&&e.message?.includes("image"))throw Error("Formato immagine non supportato o immagine troppo grande.");throw Error(`Errore nell'analisi dell'immagine: ${e.message}`)}}async function m(r){if(!process.env.OPENAI_API_KEY)throw Error("OPENAI_API_KEY is not configured. Please set it in your environment variables.");let t=await e.A(323970),a=null;try{a=await E.files.create({file:t.createReadStream(r),purpose:"user_data"});let e=((await E.responses.create({model:"gpt-4o",input:[{role:"user",content:[{type:"input_text",text:"Estrai tutto il testo e le informazioni rilevanti da questo documento. Rispondi SOLO con il testo estratto, senza commenti."},{type:"input_file",file_id:a.id}]}],max_output_tokens:8e3,temperature:.1})).output_text||"").toString().trim();if(!e)throw Error("Nessun testo estratto dal PDF");return e}catch(e){if(console.error("Error in PDF text extraction (Responses API):",e),401===e.status)throw Error("Chiave API OpenAI non valida. Verifica la configurazione.");if(429===e.status)throw Error("Limite di rate raggiunto. Riprova tra qualche secondo.");if(400===e.status)throw Error("Errore nell'analisi del PDF con Responses API. Il file potrebbe essere troppo grande o danneggiato.");throw Error(`Errore nell'estrazione del testo PDF: ${e.message}`)}finally{try{a&&a.id&&(E.files?.delete?await E.files.delete(a.id):E.files?.del&&await E.files.del(a.id))}catch(e){console.warn("Errore rimozione file da OpenAI (ignorato):",e?.message||e)}}}async function g(e,r={}){if(!process.env.OPENAI_API_KEY)throw Error("OPENAI_API_KEY is not configured. Please set it in your environment variables.");try{let t=r.size||"1024x1024",a=r.quality||"standard",o=r.style||"vivid",i=await E.images.generate({model:"dall-e-3",prompt:e,size:t,quality:a,style:o,n:1}),n=i.data[0]?.url;if(!n)throw Error("Nessuna immagine generata da DALL-E");return n}catch(e){if(console.error("Error getting image URL from DALL-E:",e),console.error("Error details:",{status:e.status,statusText:e.statusText,message:e.message,code:e.code,response:e.response?.data||e.response}),401===e.status)throw Error("Chiave API OpenAI non valida. Verifica la configurazione.");if(429===e.status)throw Error("Limite di rate raggiunto. Riprova tra qualche secondo.");if(400===e.status){let r=e.message||e.response?.data?.error?.message||"Prompt non valido o contenuto non consentito";throw Error(`Errore nella generazione: ${r}`)}else if("ENOTFOUND"===e.code||"ECONNREFUSED"===e.code)throw Error("Errore di connessione con OpenAI. Verifica la tua connessione internet.");throw Error(`Errore nella generazione dell'immagine: ${e.message||"Errore sconosciuto"}`)}}async function p(e,r={}){if(!process.env.OPENAI_API_KEY)throw Error("OPENAI_API_KEY is not configured. Please set it in your environment variables.");try{let t=await g(e,r),a=await fetch(t);if(!a.ok){let e=await a.text().catch(()=>"Unknown error");throw Error(`Errore nel download dell'immagine generata: ${a.status} ${a.statusText}. ${e}`)}let o=await a.arrayBuffer();return Buffer.from(o)}catch(e){throw e}}async function h(e,r,t=null){if(!process.env.OPENAI_API_KEY)throw Error("OPENAI_API_KEY is not configured. Please set it in your environment variables.");try{let a=await d(e,r,t||"Descrivi in dettaglio questa immagine, includendo tutti i dettagli visivi, colori, composizione, stile e qualità. La descrizione sarà usata per creare una versione migliorata ad alta risoluzione."),o=`Crea una versione migliorata e ad alta risoluzione di questa immagine: ${a}. Mantieni fedelt\xe0 ai dettagli originali ma migliora la qualit\xe0, la nitidezza e la risoluzione.`;return await p(o,{size:"1792x1024",quality:"hd",style:"natural"})}catch(e){throw console.error("Error upscaling image with DALL-E:",e),Error(`Errore nel miglioramento dell'immagine: ${e.message}`)}}async function f(r,t){if(!process.env.OPENAI_API_KEY)throw Error("OPENAI_API_KEY is not configured. Please set it in your environment variables.");try{let a=`Analyze this image and identify specific quality issues that need improvement. Focus on:
1. Noise level (low/medium/high)
2. Sharpness (blurry/sharp)
3. Color accuracy (washed out/vibrant)
4. Artifacts (compression artifacts, pixelation)
5. Overall quality issues

Respond with a JSON object: {"noise": "low|medium|high", "sharpness": "blurry|moderate|sharp", "color": "washed|normal|vibrant", "artifacts": "none|minor|major", "recommendations": "brief description"}`,o=await d(r,t,a),i={noise:"medium",sharpness:"moderate",color:"normal",artifacts:"none"};try{let e=o.match(/\{[\s\S]*\}/);if(e){let r=JSON.parse(e[0]);i={...i,...r}}}catch(e){console.warn("Could not parse AI analysis, using defaults")}let n=(0,(await e.A(752039)).default)(r,{sequentialRead:!0});return("high"===i.noise||"medium"===i.noise)&&(n=n.median("high"===i.noise?3:2)),"blurry"===i.sharpness?n=n.sharpen({sigma:2,m1:1,m2:.5,x1:3,y2:3,y3:3}):"moderate"===i.sharpness&&(n=n.sharpen({sigma:1,m1:.7,m2:.4})),"washed"===i.color&&(n=n.modulate({saturation:1.15,brightness:1.05}).linear(1.05,-6.4)),n="major"===i.artifacts||"minor"===i.artifacts?n.png({quality:100,compressionLevel:6,adaptiveFiltering:!0}):"image/jpeg"===t||"image/jpg"===t?n.jpeg({quality:98,mozjpeg:!0,trellisQuantisation:!0,overshootDeringing:!0}):n.png({quality:100,compressionLevel:6}),await n.toBuffer()}catch(e){return console.error("Error enhancing image quality with AI:",e),r}}e.s(["analyzeImageWithVision",()=>d,"chatCompletion",()=>s,"classifyDocument",()=>u,"enhanceImageQualityWithAI",()=>f,"extractTextFromPdfWithOpenAI",()=>m,"generateEmbedding",()=>i,"generateEmbeddingsBatch",()=>n,"generateImageWithDALLE",()=>p,"generateSummary",()=>l,"generateTags",()=>c,"getImageUrlFromDALLE",()=>g,"upscaleImageWithDALLE",()=>h]),t()}catch(e){t(e)}},!1),924868,(e,r,t)=>{r.exports=e.x("fs/promises",()=>require("fs/promises"))},753300,e=>e.a(async(r,t)=>{try{var a=e.i(293635);e.i(522734);var o=e.i(924868),i=e.i(871815),n=e.i(267370),s=r([a,n]);async function l(e,r){if("OPTIONS"===e.method){r.setHeader("Access-Control-Allow-Origin","*"),r.setHeader("Access-Control-Allow-Methods","POST, OPTIONS"),r.setHeader("Access-Control-Allow-Headers","Content-Type"),r.status(200).end();return}if("POST"!==e.method)return r.status(405).json({error:"Method not allowed"});let t=!!process.env.OPENAI_API_KEY,s="./tmp";try{await o.default.mkdir(s,{recursive:!0})}catch(e){console.warn("Failed to create tmp directory:",e)}let l=(0,a.default)({multiples:!1,allowEmptyFiles:!1,uploadDir:s,keepExtensions:!0,maxFileSize:0x3200000}),c=null;try{let[a,s]=await new Promise((r,t)=>{l.parse(e,(e,a,o)=>{if(e)return(console.error("Formidable parse error:",e),e.message&&e.message.includes("file size should be greater than 0"))?t(Error("Il file è vuoto. Carica un file valido.")):e.message&&e.message.includes("options.allowEmptyFiles")?t(Error("Il file caricato è vuoto. Carica un file con contenuto.")):t(e);r([a,o])})}),u=s?.file??s?.image??null;if(Array.isArray(u)&&(u=u[0]),!u)return console.error("No file found. Available fields:",Object.keys(s||{})),r.status(400).json({error:"Nessun file caricato. Assicurati di selezionare un file immagine valido."});if(!u.size||0===u.size)return r.status(400).json({error:"Il file è vuoto. Carica un file valido."});if(!(c=u.filepath||u.path))return console.error("File object:",JSON.stringify(Object.keys(u||{}))),r.status(400).json({error:"Errore nel caricamento del file. Path mancante."});let d=await o.default.readFile(c),m=u.mimetype||"image/jpeg",g="auto";if(t)try{let e=(await (0,n.analyzeImageWithVision)(d,m,'Analizza questa immagine e identifica il tipo principale di soggetto. Rispondi con una sola parola: "person", "product", "car", "animal", o "other".')).toLowerCase();e.includes("person")||e.includes("persona")||e.includes("uomo")||e.includes("donna")?g="person":e.includes("product")||e.includes("prodotto")||e.includes("oggetto")?g="product":e.includes("car")||e.includes("auto")||e.includes("veicolo")?g="car":(e.includes("animal")||e.includes("animale")||e.includes("cane")||e.includes("gatto"))&&(g="animal")}catch(e){console.warn("OpenAI Vision API failed, using default type:",e.message)}(a.type?.[0]||g).toString(),(a.size?.[0]||"full").toString(),(a.crop?.[0]||"false").toString(),(a.crop_margin?.[0]||"0").toString(),(a.bg_color?.[0]||"").toString();try{let e,t=(0,i.default)(d);if((await t.metadata()).hasAlpha)e=await t.png({quality:100,compressionLevel:9}).toBuffer();else{let{data:r,info:a}=await t.raw().ensureAlpha().toBuffer({resolveWithObject:!0}),o=a.width,n=a.height,s=a.channels,l=Buffer.alloc(o*n*4),c=[],u=Math.min(50,Math.floor(.1*o),Math.floor(.1*n));for(let e=0;e<u;e++)for(let t=0;t<u;t++){let a=(e*o+t)*s,i=(e*o+(o-1-t))*s,l=((n-1-e)*o+t)*s,u=((n-1-e)*o+(o-1-t))*s;[a,i,l,u].forEach(e=>{e<r.length&&c.push({r:r[e],g:r[e+1],b:r[e+2]})})}let d=c.reduce((e,r)=>({r:e.r+r.r,g:e.g+r.g,b:e.b+r.b}),{r:0,g:0,b:0}),m={r:d.r/c.length,g:d.g/c.length,b:d.b/c.length};for(let e=0;e<r.length;e+=s){let t=r[e],a=r[e+1],i=r[e+2],c=Math.abs(t-m.r),u=Math.abs(a-m.g),d=Math.abs(i-m.b),g=Math.sqrt(c*c+u*u+d*d),p=(.299*t+.587*a+.114*i)/255>.9?.3:1,h=255;h=g<30?Math.max(0,Math.round(g/30*76.5)):g<60?Math.max(50,Math.round((g-30)/30*178.5+.3)):255,h=Math.round(h*p);let f=e/s%o,E=Math.floor(e/s/o);(f<5||f>o-5||E<5||E>n-5)&&g>40&&(h=255);let y=e/s*4;l[y]=t,l[y+1]=a,l[y+2]=i,l[y+3]=h}let g=Buffer.from(l);for(let e=1;e<n-1;e++)for(let r=1;r<o-1;r++){let t=(e*o+r)*4,a=l[t+3];for(let t=-1;t<=1;t++)for(let i=-1;i<=1;i++){if(0===i&&0===t)continue;let n=((e+t)*o+(r+i))*4;a+=l[n+3]}let i=Math.round(a/9);g[t+3]=i}e=await (0,i.default)(g,{raw:{width:o,height:n,channels:4}}).png({quality:100,compressionLevel:9}).toBuffer()}r.setHeader("Content-Type","image/png"),r.setHeader("Cache-Control","no-cache, no-store, must-revalidate"),r.setHeader("Pragma","no-cache"),r.setHeader("Expires","0");try{await o.default.unlink(c)}catch(e){console.warn("Failed to cleanup temp file:",e)}r.status(200).send(e)}catch(e){throw console.error("Image processing failed:",e),Error(`Errore durante la rimozione dello sfondo: ${e.message}`)}}catch(a){if(c)try{await o.default.unlink(c)}catch(e){console.warn("Failed to cleanup temp file on error:",e)}console.error("=== Errore durante l'elaborazione dell'immagine ==="),console.error("Error name:",a.name),console.error("Error message:",a.message),console.error("Error stack:",a.stack);let e=500,t="Errore interno del server durante l'elaborazione dell'immagine.";a.message&&a.message.includes("file size should be greater than 0")?(e=400,t="Il file è vuoto. Carica un file valido."):a.message&&a.message.includes("options.allowEmptyFiles")?(e=400,t="Il file caricato è vuoto. Carica un file con contenuto."):a.message&&a.message.includes("Nessun file caricato")?(e=400,t=a.message):a.message&&(t=a.message),r.status(e).json({error:t,debug:void 0})}}[a,n]=s.then?(await s)():s,e.s(["config",0,{api:{bodyParser:!1}},"default",()=>l]),t()}catch(e){t(e)}},!1),54932,e=>e.a(async(r,t)=>{try{var a=e.i(926747),o=e.i(190406),i=e.i(244898),n=e.i(262950),s=e.i(753300),l=e.i(7031),c=e.i(181927),u=e.i(846432),d=r([s]);[s]=d.then?(await d)():d;let g=(0,n.hoist)(s,"default"),p=(0,n.hoist)(s,"config"),h=new i.PagesAPIRouteModule({definition:{kind:o.RouteKind.PAGES_API,page:"/api/tools/remove-background",pathname:"/api/tools/remove-background",bundlePath:"",filename:""},userland:s,distDir:".next-build",relativeProjectDir:""});async function m(e,r,t){h.isDev&&(0,u.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let o="/api/tools/remove-background";o=o.replace(/\/index$/,"")||"/";let i=await h.prepare(e,r,{srcPage:o});if(!i){r.statusCode=400,r.end("Bad Request"),null==t.waitUntil||t.waitUntil.call(t,Promise.resolve());return}let{query:n,params:s,prerenderManifest:d,routerServerContext:m}=i;try{let t=e.method||"GET",a=(0,l.getTracer)(),i=a.getActiveScopeSpan(),u=h.instrumentationOnRequestError.bind(h),g=async i=>h.render(e,r,{query:{...n,...s},params:s,allowedRevalidateHeaderKeys:[],multiZoneDraftMode:!1,trustHostHeader:!1,previewProps:d.preview,propagateError:!1,dev:h.isDev,page:"/api/tools/remove-background",internalRevalidate:null==m?void 0:m.revalidate,onError:(...r)=>u(e,...r)}).finally(()=>{if(!i)return;i.setAttributes({"http.status_code":r.statusCode,"next.rsc":!1});let e=a.getRootSpanAttributes();if(!e)return;if(e.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${e.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=e.get("next.route");if(n){let e=`${t} ${n}`;i.setAttributes({"next.route":n,"http.route":n,"next.span_name":e}),i.updateName(e)}else i.updateName(`${t} ${o}`)});i?await g(i):await a.withPropagatedContext(e.headers,()=>a.trace(c.BaseServerSpan.handleRequest,{spanName:`${t} ${o}`,kind:l.SpanKind.SERVER,attributes:{"http.method":t,"http.target":e.url}},g))}catch(e){if(h.isDev)throw e;(0,a.sendError)(r,500,"Internal Server Error")}finally{null==t.waitUntil||t.waitUntil.call(t,Promise.resolve())}}e.s(["config",0,p,"default",0,g,"handler",()=>m]),t()}catch(e){t(e)}},!1),323970,e=>{e.v(e=>Promise.resolve().then(()=>e(522734)))},752039,e=>{e.v(e=>Promise.resolve().then(()=>e(871815)))}];

//# sourceMappingURL=%5Broot-of-the-server%5D__a3dec497._.js.map