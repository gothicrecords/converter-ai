module.exports=[46810,(e,t,a)=>{t.exports=e.x("svg-to-pdfkit",()=>require("svg-to-pdfkit"))},36072,(e,t,a)=>{t.exports=e.x("tar-stream",()=>require("tar-stream"))},60864,(e,t,a)=>{t.exports=e.x("ttf2woff",()=>require("ttf2woff"))},33816,(e,t,a)=>{t.exports=e.x("ttf2woff2",()=>require("ttf2woff2"))},49541,(e,t,a)=>{t.exports=e.x("epub-gen",()=>require("epub-gen"))},33984,(e,t,a)=>{t.exports=e.x("ttf2eot",()=>require("ttf2eot"))},47826,(e,t,a)=>{t.exports=e.x("7zip-bin",()=>require("7zip-bin"))},33405,(e,t,a)=>{t.exports=e.x("child_process",()=>require("child_process"))},47583,(e,t,a)=>{t.exports=e.x("node-unrar-js",()=>require("node-unrar-js"))},97392,e=>e.a(async(t,a)=>{try{var r=e.i(93635),i=e.i(22734),o=e.i(14747),l=e.i(71815),n=e.i(94543),f=e.i(60656),p=e.i(16969),c=e.i(77390);e.i(63975);var s=e.i(46810),d=e.i(6461),u=e.i(36072),m=e.i(60864),g=e.i(33816),h=e.i(79809),x=e.i(4964),w=e.i(29211),v=e.i(31128),y=e.i(49541),b=e.i(33984),S=e.i(47826),B=e.i(33405),P=e.i(47583),$=e.i(24361),z=e.i(15954),E=t([r,c,v]);[r,c,v]=E.then?(await E)():E;let D=(0,$.promisify)(B.exec);async function O(e){process.platform;let t=`where ${e} 2>nul`;try{let{stdout:e}=await D(t);return e.trim().length>0}catch{return!1}}async function j(e,t,a){process.platform;let r=null;if(!(r=function(){for(let e of[process.env.PROGRAMFILES+"\\LibreOffice\\program\\soffice.exe",process.env["PROGRAMFILES(X86)"]+"\\LibreOffice\\program\\soffice.exe","C:\\Program Files\\LibreOffice\\program\\soffice.exe","C:\\Program Files (x86)\\LibreOffice\\program\\soffice.exe",process.env.LOCALAPPDATA+"\\Programs\\LibreOffice\\program\\soffice.exe"])if(e&&i.default.existsSync(e))return e;return null}()))try{await O("soffice.exe")&&(r="soffice.exe")}catch{}if(!r)return console.warn("LibreOffice non trovato. Per installarlo: https://www.libreoffice.org/download/"),null;try{let l=`"${r}" --headless --convert-to ${a} --outdir "${t}" "${e}"`;await D(l,{timeout:6e4});let n=o.default.basename(e,o.default.extname(e)),f=o.default.join(t,`${n}.${a}`);if(i.default.existsSync(f))return i.default.readFileSync(f);try{let e=i.default.readdirSync(t).find(e=>e.endsWith(".pdf")||e.endsWith(`.${a}`));if(e){let a=o.default.join(t,e);return i.default.readFileSync(a)}}catch{}return null}catch(e){return console.error("Errore conversione LibreOffice:",e),null}}async function k(e,t,a,r){process.platform;let o=null;if(!(o=function(){for(let e of["C:\\Program Files\\Pandoc\\pandoc.exe",process.env.PROGRAMFILES+"\\Pandoc\\pandoc.exe",process.env.LOCALAPPDATA+"\\Pandoc\\pandoc.exe","C:\\Users\\"+process.env.USERNAME+"\\AppData\\Local\\Pandoc\\pandoc.exe"])if(e&&i.default.existsSync(e))return e;return null}())&&await O("pandoc.exe")&&(o="pandoc.exe"),!o)return console.warn("Pandoc non trovato. Per installarlo: https://pandoc.org/installing.html"),null;try{let l=`"${o}" -f ${a} -t ${r} -o "${t}" "${e}"`;if(await D(l,{timeout:6e4}),i.default.existsSync(t))return i.default.readFileSync(t);return null}catch(e){return console.error("Errore conversione Pandoc:",e),null}}async function F(e,t){process.platform;let a=null;if(!(a=function(){for(let e of["C:\\Program Files\\djvulibre\\bin\\ddjvu.exe","C:\\Program Files (x86)\\djvulibre\\bin\\ddjvu.exe",process.env.PROGRAMFILES+"\\djvulibre\\bin\\ddjvu.exe",process.env["PROGRAMFILES(X86)"]+"\\djvulibre\\bin\\ddjvu.exe"])if(e&&i.default.existsSync(e))return e;return null}())&&await O("ddjvu.exe")&&(a="ddjvu.exe"),!a)return console.warn("djvulibre non trovato. Per installarlo: https://sourceforge.net/projects/djvu/files/"),null;try{let r=`"${a}" -format=pdf "${e}" "${t}"`;if(await D(r,{timeout:6e4}),i.default.existsSync(t))return i.default.readFileSync(t);return null}catch(e){return console.error("Errore conversione DJVU:",e),null}}function A(e,t){e&&0!==e.length||(e=Buffer.from(""));let a=e.toString("base64");return`data:${t};base64,${a}`}async function C(t,a){if("POST"!==t.method)return a.status(405).json({error:"Method not allowed",code:"METHOD_NOT_ALLOWED"});let{target:$}=t.query;if(!$)return(0,z.handleApiError)(new z.ValidationError("Target format is required"),a,{method:t.method,url:t.url,endpoint:"/api/convert/[target]"});(0,r.default)({multiples:!1,keepExtensions:!0,allowEmptyFiles:!1,maxFileSize:524288e3,maxTotalFileSize:524288e3}).parse(t,async(r,E,O)=>{if(r){let e=r.message||"File upload failed";return r.message&&r.message.includes("file size should be greater than 0")?e="Il file è vuoto. Carica un file valido.":r.message&&r.message.includes("options.allowEmptyFiles")&&(e="Il file caricato è vuoto. Carica un file con contenuto."),(0,z.handleApiError)(new z.ValidationError(e,r),a,{method:t.method,url:t.url,endpoint:"/api/convert/[target]"})}let C=O.file;if(Array.isArray(C)&&(C=C[0]),!C)return(0,z.handleApiError)(new z.ValidationError("File missing"),a,{method:t.method,url:t.url,endpoint:"/api/convert/[target]"});let D=C.filepath||C.path;if(!D)return(0,z.handleApiError)(new z.ValidationError("File path non valido - il file potrebbe non essere stato caricato correttamente"),a,{method:t.method,url:t.url,endpoint:"/api/convert/[target]"});if(0===C.size)return(0,z.handleApiError)(new z.ValidationError("Il file è vuoto. Carica un file valido."),a,{method:t.method,url:t.url,endpoint:"/api/convert/[target]"});let T="";try{let r=C.originalFilename||C.name||"file",O=i.default.readFileSync(D);T=(o.default.extname(r)||"").replace(".","").toLowerCase();let _=String($).toLowerCase();function L(e){let t=`.${_}`;if(e.toLowerCase().endsWith(t))return e;let a=e.replace(/\.[^/.]+$/,t);return a.toLowerCase().endsWith(t)?a:e+t}let M=null,I="application/octet-stream",q=E.width?parseInt(String(E.width)):void 0,R=E.height?parseInt(String(E.height)):void 0,U=E.quality?parseInt(String(E.quality)):80,W=E.vwidth?parseInt(String(E.vwidth)):void 0,H=E.vheight?parseInt(String(E.vheight)):void 0,X=E.vbitrate?String(E.vbitrate):void 0,V=E.abitrate?String(E.abitrate):void 0,N=E.page?parseInt(String(E.page)):0;if(["png","jpg","jpeg","webp","tiff","bmp","avif","heif","gif"].includes(_)){let e;if("pdf"===T){let t=Number.isFinite(N)&&N>=0?N:0;e=(0,l.default)(O,{density:150,page:t})}else e=(0,l.default)(O,{failOn:"none"});(q||R)&&(e=e.resize({width:q,height:R,fit:"inside"})),"jpg"===_||"jpeg"===_?(M=await e.jpeg({quality:U}).toBuffer(),I="image/jpeg"):"png"===_?(M=await e.png({compressionLevel:9}).toBuffer(),I="image/png"):"webp"===_?(M=await e.webp({quality:U}).toBuffer(),I="image/webp"):"avif"===_?(M=await e.avif({quality:U}).toBuffer(),I="image/avif"):"heif"===_?(M=await e.heif({quality:U}).toBuffer(),I="image/heif"):"tiff"===_?(M=await e.tiff().toBuffer(),I="image/tiff"):"bmp"===_?(M=await e.bmp().toBuffer(),I="image/bmp"):"gif"===_&&(M=await e.gif().toBuffer(),I="image/gif")}let G=["mp3","wav","aac","flac","ogg","m4a","weba","opus","ac3","aif","aiff","aifc","amr","au","caf","dss","oga","voc","wma"],Y=["mp4","avi","mov","mkv","webm","flv","3gp","3g2","3gpp","cavs","dv","dvr","m2ts","m4v","mod","mpeg","mpg","mts","mxf","ogg","ogv","rm","rmvb","swf","ts","vob","wmv","wtv"];if(!M&&(G.includes(_)||Y.includes(_)))try{h.default&&x.default.setFfmpegPath(h.default);let t=e.r(46786).cpus().length,a=o.default.dirname(D),r=`output_${Date.now()}.${_}`,l=o.default.join(a,r);if(await new Promise((e,a)=>{let r=(0,x.default)(D);if(r=r.outputOptions(["-threads",t.toString()]),G.includes(_)){if(r=r.noVideo(),V)r=r.audioBitrate(V);else{let e={mp3:"160k",aac:"160k",m4a:"160k",flac:"1411k",wav:"1411k",ogg:"160k",opus:"128k",weba:"128k"}[_]||"160k";r=r.audioBitrate(e)}let e={mp3:"libmp3lame",aac:"aac",m4a:"aac",flac:"flac",wav:"pcm_s16le",ogg:"libvorbis",opus:"libopus",weba:"libopus",ac3:"ac3",wma:"wmav2"};e[_]&&(r=r.audioCodec(e[_])),r=(r=r.audioFrequency(44100)).audioChannels(2),"mp3"===_?r=r.outputOptions(["-q:a","3"]):"aac"===_||"m4a"===_?r=r.outputOptions(["-profile:a","aac_low","-movflags","+faststart"]):("opus"===_||"weba"===_)&&(r=r.outputOptions(["-compression_level","5"]))}if(Y.includes(_)){let e={mp4:"libx264",webm:"libvpx",mkv:"libx264",avi:"libxvid",mov:"libx264",flv:"flv",ogv:"libtheora","3gp":"h263",wmv:"wmv2"};e[_]&&(r=r.videoCodec(e[_])),r=X?r.videoBitrate(X):r.videoBitrate("1800k"),W&&H?r=r.size(`${W}x${H}`):W?r=r.size(`${W}x?`):H&&(r=r.size(`?x${H}`));let t={mp4:"aac",webm:"libvorbis",mkv:"aac",avi:"libmp3lame",mov:"aac",flv:"libmp3lame",ogv:"libvorbis","3gp":"aac",wmv:"wmav2"};t[_]&&(r=r.audioCodec(t[_])),r=(r=V?r.audioBitrate(V):r.audioBitrate("160k")).fps(30),"mp4"===_?r=(r=r.format("mp4")).outputOptions(["-movflags","faststart","-preset","veryfast","-crf","24","-tune","fastdecode"]):"webm"===_?r=(r=r.format("webm")).outputOptions(["-deadline","good","-cpu-used","5","-row-mt","1"]):"mkv"===_?r=(r=r.format("matroska")).outputOptions(["-preset","veryfast","-crf","24","-tune","fastdecode"]):"avi"===_?r=(r=r.format("avi")).outputOptions(["-q:v","6"]):"mov"===_?r=(r=r.format("mov")).outputOptions(["-preset","veryfast","-crf","24","-tune","fastdecode"]):"flv"===_&&(r=r.format("flv"))}r.output(l).on("end",()=>e()).on("error",e=>a(e)).run()}),i.default.existsSync(l)){M=i.default.readFileSync(l),I=({mp3:"audio/mpeg",wav:"audio/wav",aac:"audio/aac",m4a:"audio/mp4",flac:"audio/flac",ogg:"audio/ogg",oga:"audio/ogg",opus:"audio/opus",weba:"audio/webm",wma:"audio/x-ms-wma",ac3:"audio/ac3",mp4:"video/mp4",webm:"video/webm",mkv:"video/x-matroska",avi:"video/x-msvideo",mov:"video/quicktime",flv:"video/x-flv",ogv:"video/ogg","3gp":"video/3gpp",wmv:"video/x-ms-wmv",mpeg:"video/mpeg",mpg:"video/mpeg"})[_]||"application/octet-stream";try{i.default.unlinkSync(l)}catch(e){console.warn("Failed to delete temp output file:",e)}}}catch(e){console.error("FFmpeg conversion error:",e)}if(!M&&"pdf"===_)if("html"===T||"htm"===T){let e=O.toString("utf8").replace(/<script[^>]*>[\s\S]*?<\/script>/gi,"").replace(/<style[^>]*>[\s\S]*?<\/style>/gi,"").replace(/<[^>]+>/g," ").replace(/&nbsp;/g," ").replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#39;/g,"'").replace(/\s+/g," ").trim(),t=new n.default({margin:48}),a=[];t.on("data",e=>a.push(e)),t.on("end",()=>{}),t.fontSize(12).text(e),t.end(),await new Promise(e=>t.on("end",e)),M=Buffer.concat(a),I="application/pdf"}else if("csv"===T){let e=new n.default({margin:36}),t=[];e.on("data",e=>t.push(e)),e.on("error",()=>{});let a=O.toString("utf8").split(/\r?\n/).filter(Boolean).map(e=>e.split(",")),r=[],i=a.reduce((e,t)=>Math.max(e,t.length),0);for(let t=0;t<i;t++)r[t]=Math.floor((e.page.width-e.page.margins.left-e.page.margins.right)/i);let o=e.y;a.forEach((t,a)=>{let i=e.page.margins.left;t.forEach((t,a)=>{let l=r[a]||80;e.rect(i,o,l,20).strokeOpacity(.3).stroke(),e.fontSize(10).fillColor("#000").text(t,i+4,o+4,{width:l-8,height:12,ellipsis:!0}),i+=l}),(o+=20)+20>e.page.height-e.page.margins.bottom&&(e.addPage(),o=e.y)}),e.end(),await new Promise(t=>e.on("end",t)),M=Buffer.concat(t),I="application/pdf"}else if("svg"===T){let e=new n.default({autoFirstPage:!1}),t=[];e.on("data",e=>t.push(e)),e.on("error",()=>{}),e.addPage({size:"A4"});let a=O.toString("utf8");(0,s.default)(e,a,0,0,{preserveAspectRatio:"xMidYMid meet"}),e.end(),await new Promise(t=>e.on("end",t)),M=Buffer.concat(t),I="application/pdf"}else if(["png","jpg","jpeg","webp","bmp","gif","tiff"].includes(T)){let e=new n.default({autoFirstPage:!1}),t=[];e.on("data",e=>t.push(e)),e.on("error",()=>{});let a=(0,l.default)(O),r=await a.metadata(),o=r.width||800,f=r.height||600;e.addPage({size:[o,f]});let p=D+".tmpimg";i.default.writeFileSync(p,O),e.image(p,0,0,{width:o,height:f}),e.end(),await new Promise(t=>e.on("end",t)),M=Buffer.concat(t),i.default.unlinkSync(p),I="application/pdf"}else{let e=new n.default({margin:48}),t=[];e.on("data",e=>t.push(e)),e.on("error",()=>{});let a=O.toString("utf8");e.fontSize(12).text(a),e.end(),await new Promise(t=>e.on("end",t)),M=Buffer.concat(t),I="application/pdf"}if(!M&&"pdf"===_&&"ai"===T){let e=O.toString("binary"),t=e.indexOf("%PDF-"),a=e.lastIndexOf("%%EOF");if(-1!==t&&-1!==a&&a>t){let r=e.substring(t,a+5);M=Buffer.from(r,"binary"),I="application/pdf"}}if(!M&&"pdf"===_&&"djvu"===T){let e=o.default.join(o.default.dirname(D),`djvu_${Date.now()}.pdf`),t=await F(D,e);if(t){M=t,I="application/pdf";try{i.default.unlinkSync(e)}catch{}}}if(!M&&"pdf"===_&&["pub","xps","abw","zabw","doc","docm","dot","dotx","hwp","lwp","wpd","wps","pages","odt","ods","odp","odg","rtf","rst"].includes(T)){let e=o.default.dirname(D),r=await j(D,e,"pdf");if(!r)return(0,z.handleApiError)(new z.ProcessingError(`Conversione ${T.toUpperCase()} → PDF richiede LibreOffice. Per favore, installa LibreOffice per usare questa funzionalit\xe0. Download: https://www.libreoffice.org/download/`),a,{method:t.method,url:t.url,endpoint:"/api/convert/[target]",target:$,inputExt:T,hint:"LibreOffice non è installato sul server"});M=r,I="application/pdf"}if(!M&&"txt"===_){if("txt"===T)try{M=Buffer.from(O.toString("utf8"),"utf8"),I="text/plain"}catch(e){M=Buffer.from(O.toString("binary"),"utf8"),I="text/plain"}else if("pdf"===T)try{let e=await (0,c.default)(O);M=Buffer.from(e.text||"","utf8"),I="text/plain"}catch(e){M=Buffer.from("","utf8"),I="text/plain"}else if("docx"===T||"docm"===T||"dotx"===T)try{let{value:e}=await w.default.extractRawText({buffer:O});M=Buffer.from(e||"","utf8"),I="text/plain"}catch{M=Buffer.from("","utf8"),I="text/plain"}else if("doc"===T||"dot"===T)try{let{value:e}=await w.default.extractRawText({buffer:O});M=Buffer.from(e||"","utf8"),I="text/plain"}catch(t){let e=O.toString("utf8",0,Math.min(5e4,O.length)).replace(/[\x00-\x08\x0B-\x0C\x0E-\x1F\x7F]/g," ").trim();M=Buffer.from(e||"Contenuto non estraibile da formato DOC legacy","utf8"),I="text/plain"}else if("html"===T||"htm"===T)try{let e=O.toString("utf8").replace(/<script[^>]*>[\s\S]*?<\/script>/gi,"");e=(e=(e=(e=(e=(e=(e=(e=(e=e.replace(/<style[^>]*>[\s\S]*?<\/style>/gi,"")).replace(/<[^>]+>/g," ")).replace(/&nbsp;/g," ")).replace(/&amp;/g,"&")).replace(/&lt;/g,"<")).replace(/&gt;/g,">")).replace(/&quot;/g,'"')).replace(/&#39;/g,"'")).replace(/\s+/g," ").trim(),M=Buffer.from(e,"utf8")}catch(e){M=Buffer.from(O.toString("utf8"),"utf8")}else if("md"===T)try{let e=O.toString("utf8");e=(e=(e=(e=(e=(e=e.replace(/#{1,6}\s+/g,"")).replace(/\*\*([^*]+)\*\*/g,"$1")).replace(/\*([^*]+)\*/g,"$1")).replace(/\[([^\]]+)\]\([^\)]+\)/g,"$1")).replace(/`([^`]+)`/g,"$1")).replace(/```[\s\S]*?```/g,""),M=Buffer.from(e,"utf8")}catch(e){M=Buffer.from(O.toString("utf8"),"utf8")}else if("rtf"===T)try{let e=O.toString("utf8");e=(e=(e=(e=e.replace(/\\[a-z]+\d*\s?/gi," ")).replace(/\{[^}]*\}/g,"")).replace(/\\[{}]/g,"")).replace(/\s+/g," ").trim(),M=Buffer.from(e,"utf8"),I="text/plain"}catch(e){M=Buffer.from("","utf8"),I="text/plain"}else if("odt"===T)try{let e=await f.default.loadAsync(O),t="";if(e.files["content.xml"]){let a=await e.files["content.xml"].async("string");(t=(a.match(/<text:[^>]*>([^<]*)<\/text:[^>]*>/gi)||[]).map(e=>{let t=e.match(/>([^<]+)</i);return t?t[1]:""}).filter(e=>e.trim().length>0).join("\n"))||(t=a.replace(/<[^>]+>/g," ").replace(/\s+/g," ").trim())}M=Buffer.from(t||"Contenuto non estraibile","utf8"),I="text/plain"}catch(e){M=Buffer.from("","utf8"),I="text/plain"}else if("abw"===T||"zabw"===T)try{let e="";if("zabw"===T){let t=await f.default.loadAsync(O),a=t.files["content.xml"]||t.files.AbiWord;a&&(e=(await a.async("string")).replace(/<[^>]+>/g," ").replace(/\s+/g," ").trim())}else e=O.toString("utf8").replace(/<[^>]+>/g," ").replace(/\s+/g," ").trim();M=Buffer.from(e||"Contenuto non estraibile","utf8"),I="text/plain"}catch(e){M=Buffer.from("","utf8"),I="text/plain"}else if("tex"===T||"rst"===T)try{let e=O.toString("utf8");M=Buffer.from(e,"utf8"),I="text/plain"}catch(e){M=Buffer.from("","utf8"),I="text/plain"}else if(["pub","xps","hwp","lwp","pages","wpd","wps"].includes(T))try{if("xps"===T||"pages"===T)try{let e=await f.default.loadAsync(O),t="";for(let[a,r]of Object.entries(e.files))if(a.endsWith(".xml")||a.endsWith(".txt")){let e=await r.async("string");t+=e.replace(/<[^>]+>/g," ").replace(/\s+/g," ").trim()+"\n"}M=Buffer.from(t||"Contenuto non estraibile","utf8"),I="text/plain"}catch(t){let e=O.toString("utf8",0,Math.min(1e4,O.length)).replace(/[\x00-\x08\x0B-\x0C\x0E-\x1F\x7F]/g," ").trim();M=Buffer.from(e||"Contenuto non estraibile","utf8"),I="text/plain"}else{let e=O.toString("utf8",0,Math.min(1e4,O.length)).replace(/[\x00-\x08\x0B-\x0C\x0E-\x1F\x7F]/g," ").trim();M=Buffer.from(e||`Formato ${T.toUpperCase()} richiede tool specializzati per estrazione completa`,"utf8"),I="text/plain"}}catch(e){M=Buffer.from("","utf8"),I="text/plain"}else if("djvu"===T)M=Buffer.from("DJVU è un formato binario complesso. Per estrarre testo serve djvulibre.","utf8"),I="text/plain";else try{M=Buffer.from(O.toString("utf8"),"utf8")}catch(e){M=Buffer.from(O.toString("binary"),"utf8")}I="text/plain"}if(!M&&"html"===_){if("html"===T||"htm"===T)try{M=Buffer.from(O.toString("utf8"),"utf8"),I="text/html"}catch(e){M=Buffer.from(O.toString("binary"),"utf8"),I="text/html"}else if("md"===T)try{let e=v.marked.parse(O.toString("utf8"));M=Buffer.from(e,"utf8"),I="text/html"}catch(t){let e=O.toString("utf8").replace(/</g,"&lt;").replace(/>/g,"&gt;");M=Buffer.from(`<!DOCTYPE html>
<html><head><meta charset="UTF-8"></head><body><pre>${e}</pre></body></html>`,"utf8"),I="text/html"}else if("txt"===T)try{let e=O.toString("utf8").split(/\r?\n/),t='<!DOCTYPE html>\n<html lang="it">\n<head>\n<meta charset="UTF-8">\n<meta name="viewport" content="width=device-width, initial-scale=1.0">\n<title>Documento convertito</title>\n<style>\nbody { font-family: Arial, sans-serif; line-height: 1.6; max-width: 800px; margin: 0 auto; padding: 20px; }\np { margin-bottom: 1em; }\n</style>\n</head>\n<body>\n',a="";e.forEach(e=>{let r=e.trim();""===r?a&&(t+=`<p>${a.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</p>
`,a=""):(a&&(a+=" "),a+=r)}),a&&(t+=`<p>${a.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</p>
`),t+="</body>\n</html>",M=Buffer.from(t,"utf8"),I="text/html"}catch(a){let e=O.toString("utf8").replace(/</g,"&lt;").replace(/>/g,"&gt;"),t=`<!DOCTYPE html>
<html><head><meta charset="UTF-8"></head><body><pre>${e}</pre></body></html>`;M=Buffer.from(t,"utf8"),I="text/html"}else if("docx"===T)try{let{value:e}=await w.default.convertToHtml({buffer:O});M=Buffer.from(e,"utf8"),I="text/html"}catch(e){M=Buffer.from("<html><body><p>Errore nella conversione DOCX</p></body></html>","utf8"),I="text/html"}}if(!M&&"md"===_){if("md"===T)try{M=Buffer.from(O.toString("utf8"),"utf8"),I="text/markdown"}catch(e){M=Buffer.from(O.toString("binary"),"utf8"),I="text/markdown"}else if("html"===T||"htm"===T)try{let e=O.toString("utf8");e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=e.replace(/<script[^>]*>[\s\S]*?<\/script>/gi,"")).replace(/<style[^>]*>[\s\S]*?<\/style>/gi,"")).replace(/<h1[^>]*>(.*?)<\/h1>/gi,"# $1\n\n")).replace(/<h2[^>]*>(.*?)<\/h2>/gi,"## $1\n\n")).replace(/<h3[^>]*>(.*?)<\/h3>/gi,"### $1\n\n")).replace(/<h4[^>]*>(.*?)<\/h4>/gi,"#### $1\n\n")).replace(/<h5[^>]*>(.*?)<\/h5>/gi,"##### $1\n\n")).replace(/<h6[^>]*>(.*?)<\/h6>/gi,"###### $1\n\n")).replace(/<a[^>]*href=["']([^"']+)["'][^>]*>(.*?)<\/a>/gi,"[$2]($1)")).replace(/<strong[^>]*>(.*?)<\/strong>/gi,"**$1**")).replace(/<b[^>]*>(.*?)<\/b>/gi,"**$1**")).replace(/<em[^>]*>(.*?)<\/em>/gi,"*$1*")).replace(/<i[^>]*>(.*?)<\/i>/gi,"*$1*")).replace(/<p[^>]*>(.*?)<\/p>/gi,"$1\n\n")).replace(/<[^>]+>/g,"")).replace(/&nbsp;/g," ")).replace(/&amp;/g,"&")).replace(/&lt;/g,"<")).replace(/&gt;/g,">")).replace(/&quot;/g,'"')).replace(/&#39;/g,"'")).replace(/\n{3,}/g,"\n\n").trim(),M=Buffer.from(e,"utf8"),I="text/markdown"}catch(t){let e=O.toString("utf8").replace(/<[^>]+>/g," ").replace(/\s+/g," ").trim();M=Buffer.from(e,"utf8"),I="text/markdown"}else if("txt"===T)try{let e=O.toString("utf8");M=Buffer.from(e,"utf8"),I="text/markdown"}catch(e){M=Buffer.from(O.toString("utf8"),"utf8"),I="text/markdown"}else if("docx"===T)try{let{value:e}=await w.default.convertToHtml({buffer:O}),t=e;t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=t.replace(/<script[^>]*>[\s\S]*?<\/script>/gi,"")).replace(/<style[^>]*>[\s\S]*?<\/style>/gi,"")).replace(/<h1[^>]*>(.*?)<\/h1>/gi,"# $1\n\n")).replace(/<h2[^>]*>(.*?)<\/h2>/gi,"## $1\n\n")).replace(/<h3[^>]*>(.*?)<\/h3>/gi,"### $1\n\n")).replace(/<a[^>]*href=["']([^"']+)["'][^>]*>(.*?)<\/a>/gi,"[$2]($1)")).replace(/<strong[^>]*>(.*?)<\/strong>/gi,"**$1**")).replace(/<b[^>]*>(.*?)<\/b>/gi,"**$1**")).replace(/<em[^>]*>(.*?)<\/em>/gi,"*$1*")).replace(/<i[^>]*>(.*?)<\/i>/gi,"*$1*")).replace(/<p[^>]*>(.*?)<\/p>/gi,"$1\n\n")).replace(/<[^>]+>/g,"")).replace(/&nbsp;/g," ")).replace(/&amp;/g,"&")).replace(/&lt;/g,"<")).replace(/&gt;/g,">")).replace(/&quot;/g,'"')).replace(/&#39;/g,"'")).replace(/\n{3,}/g,"\n\n").trim(),M=Buffer.from(t,"utf8"),I="text/markdown"}catch(e){try{let{value:e}=await w.default.extractRawText({buffer:O});M=Buffer.from(e||"","utf8"),I="text/markdown"}catch{M=Buffer.from("","utf8"),I="text/markdown"}}}if(!M&&"csv"===_&&["xlsx","xls","ods"].includes(T)){let e=p.read(O,{type:"buffer"}),t=e.SheetNames[0],a=p.utils.sheet_to_csv(e.Sheets[t]);M=Buffer.from(a,"utf8"),I="text/csv"}if(!M&&"xlsx"===_&&["csv","txt","ods","xls"].includes(T)){if("csv"===T||"txt"===T){let e=O.toString("utf8").split(/\r?\n/).filter(Boolean).map(e=>e.split(",")),t=p.utils.aoa_to_sheet(e),a=p.utils.book_new();p.utils.book_append_sheet(a,t,"Sheet1"),M=Buffer.from(p.write(a,{type:"buffer",bookType:"xlsx"}))}else{let e=p.read(O,{type:"buffer"});M=Buffer.from(p.write(e,{type:"buffer",bookType:"xlsx"}))}I="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}if(!M&&"pdf"===_&&"docx"===T)try{let{value:e}=await w.default.convertToHtml({buffer:O}),t=e.replace(/<script[^>]*>[\s\S]*?<\/script>/gi,"").replace(/<style[^>]*>[\s\S]*?<\/style>/gi,"").replace(/<[^>]+>/g," ").replace(/&nbsp;/g," ").replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#39;/g,"'").replace(/\s+/g," ").trim(),a=new n.default({margin:48}),r=[];a.on("data",e=>r.push(e)),a.on("end",()=>{}),a.fontSize(12).text(t),a.end(),await new Promise(e=>a.on("end",e)),M=Buffer.concat(r),I="application/pdf"}catch{}if(!M&&["doc","docm","dot","dotx"].includes(T))try{if("docm"===T||"dotx"===T){if("txt"===_){let{value:e}=await w.default.extractRawText({buffer:O});M=Buffer.from(e||"","utf8"),I="text/plain"}else if("html"===_){let{value:e}=await w.default.convertToHtml({buffer:O});M=Buffer.from(e,"utf8"),I="text/html"}else if("pdf"===_){let{value:e}=await w.default.convertToHtml({buffer:O}),t=e.replace(/<[^>]+>/g," ").replace(/\s+/g," ").trim(),a=new n.default({margin:48}),r=[];a.on("data",e=>r.push(e)),a.on("end",()=>{}),a.fontSize(12).text(t),a.end(),await new Promise(e=>a.on("end",e)),M=Buffer.concat(r),I="application/pdf"}}else if("doc"===T||"dot"===T){if("txt"===_)try{let{value:e}=await w.default.extractRawText({buffer:O});M=Buffer.from(e||"","utf8"),I="text/plain"}catch(t){let e=O.toString("utf8",0,Math.min(5e4,O.length)).replace(/[\x00-\x08\x0B-\x0C\x0E-\x1F\x7F]/g," ").trim();M=Buffer.from(e||"Contenuto non estraibile da formato DOC legacy","utf8"),I="text/plain"}else if("pdf"===_)try{let e=o.default.dirname(D),t=o.default.basename(r,o.default.extname(r))+".pdf",a=o.default.join(e,`lo_${Date.now()}_${t}`),l=await j(D,a,"pdf");if(l){M=l,I="application/pdf";try{i.default.unlinkSync(a)}catch{}}else try{let{value:e}=await w.default.convertToHtml({buffer:O}),t=[],a=new n.default({size:"A4",margin:50});a.on("data",e=>t.push(e)),a.on("end",()=>{});let r=e.replace(/<[^>]+>/g," ").replace(/\s+/g," ").trim();a.fontSize(12).text(r),a.end(),await new Promise(e=>a.on("end",e)),M=Buffer.concat(t),I="application/pdf"}catch(e){M=Buffer.from("I formati DOC e DOT (Word legacy) richiedono LibreOffice installato. Installa LibreOffice e riprova.","utf8"),I="text/plain"}}catch(e){console.error("Errore conversione DOC/DOT:",e);try{let{value:e}=await w.default.convertToHtml({buffer:O}),t=[],a=new n.default({size:"A4",margin:50});a.on("data",e=>t.push(e)),a.on("end",()=>{});let r=e.replace(/<[^>]+>/g," ").replace(/\s+/g," ").trim();a.fontSize(12).text(r),a.end(),await new Promise(e=>a.on("end",e)),M=Buffer.concat(t),I="application/pdf"}catch(e){M=Buffer.from("I formati DOC e DOT (Word legacy) richiedono LibreOffice installato.","utf8"),I="text/plain"}}}}catch(e){console.error("Errore conversione Word:",e)}if(!M&&"rtf"===T&&("pdf"===_||"txt"===_||"html"===_))try{let e=O.toString("utf8");if(e=(e=(e=e.replace(/\\[a-z]+\d*\s?/gi," ")).replace(/\{[^}]*\}/g,"")).replace(/\s+/g," ").trim(),"txt"===_)M=Buffer.from(e,"utf8"),I="text/plain";else if("html"===_){let t=`<!DOCTYPE html>
<html><head><meta charset="UTF-8"></head><body><pre>${e.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</pre></body></html>`;M=Buffer.from(t,"utf8"),I="text/html"}else if("pdf"===_){let t=new n.default({margin:48}),a=[];t.on("data",e=>a.push(e)),t.on("end",()=>{}),t.fontSize(12).text(e),t.end(),await new Promise(e=>t.on("end",e)),M=Buffer.concat(a),I="application/pdf"}}catch(e){console.error("Errore conversione RTF:",e)}if(!M&&"odt"===T&&("pdf"===_||"txt"===_||"html"===_))try{let e=await f.default.loadAsync(O),t="";if(t=e.files["content.xml"]?(await e.files["content.xml"].async("string")).replace(/<[^>]+>/g," ").replace(/\s+/g," ").trim():"Impossibile estrarre contenuto da ODT.","txt"===_)M=Buffer.from(t,"utf8"),I="text/plain";else if("html"===_){let e=`<!DOCTYPE html>
<html><head><meta charset="UTF-8"></head><body><p>${t.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</p></body></html>`;M=Buffer.from(e,"utf8"),I="text/html"}else if("pdf"===_){let e=new n.default({margin:48}),a=[];e.on("data",e=>a.push(e)),e.on("end",()=>{}),e.fontSize(12).text(t),e.end(),await new Promise(t=>e.on("end",t)),M=Buffer.concat(a),I="application/pdf"}}catch(e){console.error("Errore conversione ODT:",e)}if(!M&&("abw"===T||"zabw"===T)&&("pdf"===_||"txt"===_||"html"===_))try{let e="";if("zabw"===T){let t=await f.default.loadAsync(O),a=t.files["content.xml"]||t.files.AbiWord;a&&(e=(await a.async("string")).replace(/<[^>]+>/g," ").replace(/\s+/g," ").trim())}else e=(e=O.toString("utf8")).replace(/<[^>]+>/g," ").replace(/\s+/g," ").trim();if(e||(e="Impossibile estrarre contenuto dal file."),"txt"===_)M=Buffer.from(e,"utf8"),I="text/plain";else if("html"===_){let t=`<!DOCTYPE html>
<html><head><meta charset="UTF-8"></head><body><p>${e.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</p></body></html>`;M=Buffer.from(t,"utf8"),I="text/html"}else if("pdf"===_){let t=new n.default({margin:48}),a=[];t.on("data",e=>a.push(e)),t.on("end",()=>{}),t.fontSize(12).text(e),t.end(),await new Promise(e=>t.on("end",e)),M=Buffer.concat(a),I="application/pdf"}}catch(e){console.error("Errore conversione ABW/ZABW:",e)}if(!M&&"djvu"===T&&"pdf"===_)try{let e=o.default.dirname(D),t=o.default.basename(r,o.default.extname(r))+".pdf",a=o.default.join(e,`djvu_${Date.now()}_${t}`),l=await F(D,a);if(l){M=l,I="application/pdf";try{i.default.unlinkSync(a)}catch{}}else M=Buffer.from("DJVU richiede djvulibre installato. Installa djvulibre e riprova.","utf8"),I="text/plain"}catch(e){console.error("Errore conversione DJVU:",e),M=Buffer.from("DJVU richiede djvulibre installato. Errore: "+e.message,"utf8"),I="text/plain"}let J={pub:{tool:"libreoffice",format:"pdf",msg:"Microsoft Publisher richiede LibreOffice installato."},xps:{tool:"libreoffice",format:"pdf",msg:"XPS richiede LibreOffice installato."},hwp:{tool:"libreoffice",format:"pdf",msg:"HWP (Hancom Word) richiede LibreOffice installato."},lwp:{tool:"libreoffice",format:"pdf",msg:"LWP (Lotus Word Pro) richiede LibreOffice installato."},pages:{tool:"libreoffice",format:"pdf",msg:"Apple Pages richiede LibreOffice installato."},wpd:{tool:"libreoffice",format:"pdf",msg:"WordPerfect richiede LibreOffice installato."},wps:{tool:"libreoffice",format:"pdf",msg:"WPS richiede LibreOffice installato."},tex:{tool:"pandoc",format:"pdf",msg:"LaTeX richiede Pandoc o pdflatex installato."},rst:{tool:"pandoc",format:"pdf",msg:"reStructuredText richiede Pandoc installato."}};if(!M&&J[T]&&"pdf"===_){let e=J[T];try{if("libreoffice"===e.tool){let e=o.default.dirname(D),t=o.default.join(e,`lo_output_${Date.now()}`);i.default.existsSync(t)||i.default.mkdirSync(t,{recursive:!0});let a=await j(D,t,"pdf");if(a){M=a,I="application/pdf";try{i.default.readdirSync(t).forEach(e=>{try{i.default.unlinkSync(o.default.join(t,e))}catch{}}),i.default.rmdirSync(t)}catch{}}}if(!M&&"pandoc"===e.tool){let e=o.default.dirname(D),t=o.default.basename(r,o.default.extname(r))+".pdf",a=o.default.join(e,`pandoc_${Date.now()}_${t}`),l=await k(D,a,T,"pdf");if(l){M=l,I="application/pdf";try{i.default.unlinkSync(a)}catch{}}}M||(M=Buffer.from(`${e.msg} Installa ${e.tool} e riprova.`,"utf8"),I="text/plain")}catch(t){console.error(`Errore conversione ${T}:`,t),M=Buffer.from(`${e.msg} Errore: ${t.message}`,"utf8"),I="text/plain"}}if(!M&&"pdf"===_&&["xls","xlsx","ods"].includes(T))try{let e=p.read(O,{type:"buffer"}),t=new n.default({margin:36}),a=[];t.on("data",e=>a.push(e)),t.on("error",()=>{}),e.SheetNames.forEach((a,r)=>{r>0&&t.addPage();let i=e.Sheets[a],o=p.utils.sheet_to_json(i,{header:1,defval:""});if(t.fontSize(16).text(a,{align:"center"}),t.moveDown(),o.length>0){let e=[],a=o.reduce((e,t)=>Math.max(e,t.length),0),r=t.page.width-t.page.margins.left-t.page.margins.right;for(let t=0;t<a;t++)e[t]=Math.floor(r/a);let i=t.y;o.forEach((a,r)=>{i+20>t.page.height-t.page.margins.bottom&&(t.addPage(),i=t.y);let o=t.page.margins.left;a.forEach((a,r)=>{let l=e[r]||80;t.rect(o,i,l,20).strokeOpacity(.3).stroke(),t.fontSize(9).fillColor("#000").text(String(a||""),o+4,i+4,{width:l-8,height:12,ellipsis:!0}),o+=l}),i+=20})}}),t.end(),await new Promise(e=>t.on("end",e)),M=Buffer.concat(a),I="application/pdf"}catch{}if(!M&&"pptx"===_&&"pdf"===T)try{let t=await (0,c.default)(O),a=t.text||"",r=t.numpages||1,i=await e.A(98200),o=new(i.default||i),l=a.split("\n").filter(e=>e.trim()),n=Math.max(1,Math.ceil(l.length/r));for(let e=0;e<r;e++){let t=o.addSlide(),a=l.slice(e*n,(e+1)*n).join("\n")||`Slide ${e+1}`;t.addText(a,{x:.5,y:.5,w:9,h:5,fontSize:14,color:"000000"})}M=await o.write({outputType:"nodebuffer"}),M=Buffer.isBuffer(M)?M:Buffer.from(M),I="application/vnd.openxmlformats-officedocument.presentationml.presentation"}catch{}if(!M&&"xlsx"===_&&"pdf"===T)try{let e=((await (0,c.default)(O)).text||"").split("\n").filter(e=>e.trim()).map(e=>e.includes("	")?e.split("	"):e.includes(",")?e.split(",").map(e=>e.trim()):e.split(/\s{2,}/).filter(e=>e.trim())),t=p.utils.aoa_to_sheet(e),a=p.utils.book_new();p.utils.book_append_sheet(a,t,"Sheet1"),M=Buffer.from(p.write(a,{type:"buffer",bookType:"xlsx"})),I="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}catch{}if(!M&&("pdfa"===_||"pdf-a"===_)&&"pdf"===T)try{let e=new n.default({autoFirstPage:!1}),t=[];e.on("data",e=>t.push(e)),e.on("error",()=>{}),e.info({Title:"PDF/A Document",Author:"MegaPixelAI",Subject:"PDF/A compliant document",Keywords:"PDF/A",Creator:"MegaPixelAI Converter",Producer:"MegaPixelAI PDF/A Converter"}),M=O,I="application/pdf"}catch{}if(!M&&"docx"===_){if("docx"===T)try{M=O,I="application/vnd.openxmlformats-officedocument.wordprocessingml.document"}catch(e){M=O,I="application/vnd.openxmlformats-officedocument.wordprocessingml.document"}else if("txt"===T)try{O.toString("utf8").replace(/\n/g,"</p><p>").replace(/</g,"&lt;").replace(/>/g,"&gt;"),M=Buffer.from("Conversione TXT → DOCX richiede una libreria dedicata. Per ora, usa TXT → HTML → DOCX tramite altri tool.","utf8"),I="text/plain"}catch(e){M=Buffer.from("Errore nella conversione TXT → DOCX","utf8"),I="text/plain"}else if("html"===T||"htm"===T)M=Buffer.from("Conversione HTML → DOCX richiede una libreria dedicata (es. docx o officegen).","utf8"),I="text/plain";else if("md"===T)try{v.marked.parse(O.toString("utf8")),M=Buffer.from("Conversione MD → DOCX richiede una libreria dedicata. Converti prima in HTML.","utf8"),I="text/plain"}catch(e){M=Buffer.from("Errore nella conversione MD → DOCX","utf8"),I="text/plain"}}if(!M&&("html"===_||"pdf"===_)&&"md"===T){let e=v.marked.parse(O.toString("utf8"));if("html"===_)M=Buffer.from(e,"utf8"),I="text/html";else{let t=e.replace(/<script[^>]*>[\s\S]*?<\/script>/gi,"").replace(/<style[^>]*>[\s\S]*?<\/style>/gi,"").replace(/<[^>]+>/g," ").replace(/&nbsp;/g," ").replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#39;/g,"'").replace(/\s+/g," ").trim(),a=new n.default({margin:48}),r=[];a.on("data",e=>r.push(e)),a.on("end",()=>{}),a.fontSize(12).text(t),a.end(),await new Promise(e=>a.on("end",e)),M=Buffer.concat(r),I="application/pdf"}}if(!M&&"zip"===_){let e=new f.default;e.file(r,O),M=await e.generateAsync({type:"nodebuffer"}),I="application/zip"}if(!M&&("tgz"===_||"tar"===_||"gz"===_)&&"zip"===T){let e=await f.default.loadAsync(O),t=u.default.pack(),a=[],r=async()=>{for await(let e of(t.finalize(),t))a.push(e);return Buffer.concat(a)};for(let a of Object.keys(e.files)){let r=e.files[a];if(r.dir)continue;let i=await r.async("nodebuffer");t.entry({name:a,size:i.length},i)}let i=await r();"tar"===_?(M=i,I="application/x-tar"):("gz"===_||"tgz"===_)&&(M=d.default.gzipSync(i),I="application/gzip")}if(!M&&"7z"===_){let e=o.default.dirname(D),t=o.default.join(e,`in_${Date.now()}_${r}`);i.default.writeFileSync(t,O);let a=o.default.join(e,`out_${Date.now()}.7z`);await new Promise((e,r)=>{(0,B.execFile)(S.path7za,["a",a,t],t=>{t?r(t):e()})}),M=i.default.readFileSync(a);try{i.default.unlinkSync(t),i.default.unlinkSync(a)}catch{}I="application/x-7z-compressed"}if(!M&&["7z","rar","tar","gz","tgz","zip","bz2","xz"].includes(T)&&("zip"===_||"tgz"===_)){let e=o.default.dirname(D),t=o.default.join(e,`in_${Date.now()}.${T}`);i.default.writeFileSync(t,O);let a=o.default.join(e,`ext_${Date.now()}`);i.default.mkdirSync(a);let r=!1;try{await new Promise((e,r)=>{(0,B.execFile)(S.path7za,["x",t,`-o${a}`,"-y"],t=>{t?r(t):e()})}),r=!0}catch{}if(!r&&"rar"===T)try{for(let e of(await (0,P.createExtractorFromData)({data:O})).extract().files)if("file"===e.type){let t=o.default.join(a,e.fileHeader.name),r=o.default.dirname(t);i.default.mkdirSync(r,{recursive:!0}),i.default.writeFileSync(t,Buffer.from(e.extract()))}r=!0}catch{}if(r)if("zip"===_){let e=new f.default,t=(a,r="")=>{for(let l of i.default.readdirSync(a,{withFileTypes:!0})){let n=o.default.join(a,l.name),f=o.default.join(r,l.name);l.isDirectory()?t(n,f):e.file(f.replace(/\\/g,"/"),i.default.readFileSync(n))}};t(a),M=await e.generateAsync({type:"nodebuffer"}),I="application/zip"}else{let e=u.default.pack(),t=[],r=(t,a="")=>{for(let l of i.default.readdirSync(t,{withFileTypes:!0})){let n=o.default.join(t,l.name),f=o.default.join(a,l.name);l.isDirectory()?r(n,f):e.entry({name:f.replace(/\\/g,"/"),size:i.default.statSync(n).size},i.default.readFileSync(n))}};for await(let i of(r(a),e.finalize(),e))t.push(i);let l=Buffer.concat(t);M=d.default.gzipSync(l),I="application/gzip"}try{i.default.rmSync(a,{recursive:!0,force:!0}),i.default.unlinkSync(t)}catch{}}if(!M&&"tar"===_){let e=u.default.pack(),t=[];for await(let a of(e.entry({name:r,size:O.length},O),e.finalize(),e))t.push(a);M=Buffer.concat(t),I="application/x-tar"}if(!M&&("gz"===_||"tgz"===_)){let e,t,a="tgz"===_?(e=u.default.pack(),t=[],e.entry({name:r,size:O.length},O),e.finalize(),new Promise(async a=>{for await(let a of e)t.push(a);a(Buffer.concat(t))})):Promise.resolve(O),i=await a;M=d.default.gzipSync(i),I="application/gzip"}if(!M&&("woff"===_||"woff2"===_)&&"ttf"===T)if("woff"===_){let{buffer:e}=(0,m.default)(new Uint8Array(O));M=Buffer.from(e),I="font/woff"}else{let e=(0,g.default)(O);M=Buffer.from(e),I="font/woff2"}if(!M&&"eot"===_&&"ttf"===T){let e=(0,b.default)(new Uint8Array(O)).buffer;M=Buffer.from(e),I="application/vnd.ms-fontobject"}if(M||"png"!==_||"svg"!==T||(M=await (0,l.default)(O).png().toBuffer(),I="image/png"),!M&&("png"===_||"jpg"===_||"jpeg"===_)&&"pdf"===T)try{let e=Number.isFinite(N)&&N>=0?N:0,t=(0,l.default)(O,{density:150,page:e});"png"===_?(M=await t.png().toBuffer(),I="image/png"):(M=await t.jpeg({quality:U}).toBuffer(),I="image/jpeg")}catch{}if(M||"svg"!==_||"svgz"!==T||(M=d.default.gunzipSync(O),I="image/svg+xml"),!M&&("cbz"===_||"htmlz"===_||"txtz"===_)){let e=new f.default;if("cbz"===_)e.file("page01"+(o.default.extname(r)||".jpg"),O);else if("htmlz"===_){let t="md"===T?v.marked.parse(O.toString("utf8")):O.toString("utf8");e.file("index.html",t)}else if("txtz"===_){let t=O.toString("utf8");e.file("index.txt",t)}M=await e.generateAsync({type:"nodebuffer"}),I="application/zip"}if(!M&&"jar"===_){let e=new f.default;e.file(r,O),M=await e.generateAsync({type:"nodebuffer"}),I="application/java-archive"}if(!M&&"epub"===_&&["html","htm","md","txt"].includes(T)){let e="md"===T?v.marked.parse(O.toString("utf8")):"txt"===T?`<pre>${O.toString("utf8")}</pre>`:O.toString("utf8"),t=o.default.join(o.default.dirname(D),`out_${Date.now()}.epub`);await new y.default({title:o.default.basename(r,o.default.extname(r)),author:"MegaPixelAI",content:[{title:"Chapter 1",data:e}]},t).promise,M=i.default.readFileSync(t);try{i.default.unlinkSync(t)}catch{}I="application/epub+zip"}if(!M&&!O)return(0,z.handleApiError)(new z.ProcessingError("Nessun buffer disponibile per la conversione"),a,{method:t.method,url:t.url,endpoint:"/api/convert/[target]",target:$,inputExt:T});let K=M||O;if(!M&&K===O)if(T!==_)return console.warn(`Conversione non supportata: ${T} → ${_}`),(0,z.handleApiError)(new z.ProcessingError(`Conversione non supportata: ${T} → ${_}. Questo formato non pu\xf2 essere convertito in ${_}.`),a,{method:t.method,url:t.url,endpoint:"/api/convert/[target]",target:$,inputExt:T});else{let e=L(r),t={txt:"text/plain",html:"text/html",htm:"text/html",md:"text/markdown",docx:"application/vnd.openxmlformats-officedocument.wordprocessingml.document",pdf:"application/pdf",xlsx:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",pptx:"application/vnd.openxmlformats-officedocument.presentationml.presentation"}[_]||I||"application/octet-stream",i=A(K,t);return a.status(200).json({name:e,dataUrl:i})}let Z=L(r);if(!K||0===K.length)return(0,z.handleApiError)(new z.ProcessingError("Il file risultante è vuoto. Il formato potrebbe non essere supportato."),a,{method:t.method,url:t.url,endpoint:"/api/convert/[target]",target:$,inputExt:T});let Q=A(K,I);return a.status(200).json({name:Z,dataUrl:Q})}catch(e){return(0,z.handleApiError)(new z.ProcessingError("Conversion failed: "+(e.message||"Unknown error"),e),a,{method:t.method,url:t.url,endpoint:"/api/convert/[target]",target:$,inputExt:T})}})}e.s(["config",0,{api:{bodyParser:!1}},"default",()=>C]),a()}catch(e){a(e)}},!1),53385,e=>e.a(async(t,a)=>{try{var r=e.i(26747),i=e.i(90406),o=e.i(44898),l=e.i(62950),n=e.i(97392),f=e.i(7031),p=e.i(81927),c=e.i(46432),s=t([n]);[n]=s.then?(await s)():s;let u=(0,l.hoist)(n,"default"),m=(0,l.hoist)(n,"config"),g=new o.PagesAPIRouteModule({definition:{kind:i.RouteKind.PAGES_API,page:"/api/convert/[target]",pathname:"/api/convert/[target]",bundlePath:"",filename:""},userland:n,distDir:".next-build",relativeProjectDir:""});async function d(e,t,a){g.isDev&&(0,c.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let i="/api/convert/[target]";i=i.replace(/\/index$/,"")||"/";let o=await g.prepare(e,t,{srcPage:i});if(!o){t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve());return}let{query:l,params:n,prerenderManifest:s,routerServerContext:d}=o;try{let a=e.method||"GET",r=(0,f.getTracer)(),o=r.getActiveScopeSpan(),c=g.instrumentationOnRequestError.bind(g),u=async o=>g.render(e,t,{query:{...l,...n},params:n,allowedRevalidateHeaderKeys:[],multiZoneDraftMode:!1,trustHostHeader:!1,previewProps:s.preview,propagateError:!1,dev:g.isDev,page:"/api/convert/[target]",internalRevalidate:null==d?void 0:d.revalidate,onError:(...t)=>c(e,...t)}).finally(()=>{if(!o)return;o.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let e=r.getRootSpanAttributes();if(!e)return;if(e.get("next.span_type")!==p.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${e.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let l=e.get("next.route");if(l){let e=`${a} ${l}`;o.setAttributes({"next.route":l,"http.route":l,"next.span_name":e}),o.updateName(e)}else o.updateName(`${a} ${i}`)});o?await u(o):await r.withPropagatedContext(e.headers,()=>r.trace(p.BaseServerSpan.handleRequest,{spanName:`${a} ${i}`,kind:f.SpanKind.SERVER,attributes:{"http.method":a,"http.target":e.url}},u))}catch(e){if(g.isDev)throw e;(0,r.sendError)(t,500,"Internal Server Error")}finally{null==a.waitUntil||a.waitUntil.call(a,Promise.resolve())}}e.s(["config",0,m,"default",0,u,"handler",()=>d]),a()}catch(e){a(e)}},!1)];

//# sourceMappingURL=%5Broot-of-the-server%5D__64175d78._.js.map