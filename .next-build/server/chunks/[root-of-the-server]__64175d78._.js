module.exports=[46810,(e,t,r)=>{t.exports=e.x("svg-to-pdfkit",()=>require("svg-to-pdfkit"))},436072,(e,t,r)=>{t.exports=e.x("tar-stream",()=>require("tar-stream"))},760864,(e,t,r)=>{t.exports=e.x("ttf2woff",()=>require("ttf2woff"))},433816,(e,t,r)=>{t.exports=e.x("ttf2woff2",()=>require("ttf2woff2"))},49541,(e,t,r)=>{t.exports=e.x("epub-gen",()=>require("epub-gen"))},33984,(e,t,r)=>{t.exports=e.x("ttf2eot",()=>require("ttf2eot"))},247826,(e,t,r)=>{t.exports=e.x("7zip-bin",()=>require("7zip-bin"))},233405,(e,t,r)=>{t.exports=e.x("child_process",()=>require("child_process"))},47583,(e,t,r)=>{t.exports=e.x("node-unrar-js",()=>require("node-unrar-js"))},233984,e=>e.a(async(t,r)=>{try{var a=e.i(293635),i=e.i(522734),o=e.i(814747),l=e.i(871815),n=e.i(294543),f=e.i(760656),s=e.i(516969),p=e.i(277390);e.i(763975);var c=e.i(46810),d=e.i(406461),u=e.i(436072),m=e.i(760864),g=e.i(433816),h=e.i(479809),x=e.i(204964),w=e.i(829211),v=e.i(131128),y=e.i(49541),b=e.i(33984),S=e.i(247826),B=e.i(233405),E=e.i(47583),P=e.i(224361),$=e.i(446786),F=e.i(515954),z=t([a,p,v]);[a,p,v]=z.then?(await z)():z;let T=(0,P.promisify)(B.exec);async function O(e){process.platform;let t=`where ${e} 2>nul`;try{let{stdout:e}=await T(t);return e.trim().length>0}catch{return!1}}async function A(e,t,r){process.platform;let a=null;if(!(a=function(){for(let e of[process.env.PROGRAMFILES+"\\LibreOffice\\program\\soffice.exe",process.env["PROGRAMFILES(X86)"]+"\\LibreOffice\\program\\soffice.exe","C:\\Program Files\\LibreOffice\\program\\soffice.exe","C:\\Program Files (x86)\\LibreOffice\\program\\soffice.exe",process.env.LOCALAPPDATA+"\\Programs\\LibreOffice\\program\\soffice.exe"])if(e&&i.default.existsSync(e))return e;return null}()))try{await O("soffice.exe")&&(a="soffice.exe")}catch{}if(!a)return console.warn("LibreOffice non trovato. Per installarlo: https://www.libreoffice.org/download/"),null;try{let l=`"${a}" --headless --convert-to ${r} --outdir "${t}" "${e}"`;await T(l,{timeout:6e4});let n=o.default.basename(e,o.default.extname(e)),f=o.default.join(t,`${n}.${r}`);if(i.default.existsSync(f))return i.default.readFileSync(f);try{let e=i.default.readdirSync(t).find(e=>e.endsWith(".pdf")||e.endsWith(`.${r}`));if(e){let r=o.default.join(t,e);return i.default.readFileSync(r)}}catch{}return null}catch(e){return console.error("Errore conversione LibreOffice:",e),null}}async function C(e,t,r,a){process.platform;let o=null;if(!(o=function(){for(let e of["C:\\Program Files\\Pandoc\\pandoc.exe",process.env.PROGRAMFILES+"\\Pandoc\\pandoc.exe",process.env.LOCALAPPDATA+"\\Pandoc\\pandoc.exe","C:\\Users\\"+process.env.USERNAME+"\\AppData\\Local\\Pandoc\\pandoc.exe"])if(e&&i.default.existsSync(e))return e;return null}())&&await O("pandoc.exe")&&(o="pandoc.exe"),!o)return console.warn("Pandoc non trovato. Per installarlo: https://pandoc.org/installing.html"),null;try{let l=`"${o}" -f ${r} -t ${a} -o "${t}" "${e}"`;if(await T(l,{timeout:6e4}),i.default.existsSync(t))return i.default.readFileSync(t);return null}catch(e){return console.error("Errore conversione Pandoc:",e),null}}async function k(e,t){process.platform;let r=null;if(!(r=function(){for(let e of["C:\\Program Files\\djvulibre\\bin\\ddjvu.exe","C:\\Program Files (x86)\\djvulibre\\bin\\ddjvu.exe",process.env.PROGRAMFILES+"\\djvulibre\\bin\\ddjvu.exe",process.env["PROGRAMFILES(X86)"]+"\\djvulibre\\bin\\ddjvu.exe"])if(e&&i.default.existsSync(e))return e;return null}())&&await O("ddjvu.exe")&&(r="ddjvu.exe"),!r)return console.warn("djvulibre non trovato. Per installarlo: https://sourceforge.net/projects/djvu/files/"),null;try{let a=`"${r}" -format=pdf "${e}" "${t}"`;if(await T(a,{timeout:6e4}),i.default.existsSync(t))return i.default.readFileSync(t);return null}catch(e){return console.error("Errore conversione DJVU:",e),null}}function j(e,t){e&&0!==e.length||(e=Buffer.from(""));let r=e.toString("base64");return`data:${t};base64,${r}`}async function D(t,r){if(r.setHeader("Access-Control-Allow-Origin","*"),r.setHeader("Access-Control-Allow-Methods","POST, OPTIONS"),r.setHeader("Access-Control-Allow-Headers","Content-Type"),r.setHeader("Access-Control-Max-Age","86400"),"OPTIONS"===t.method)return void r.status(200).end();if("POST"!==t.method)return r.status(405).json({error:"Method not allowed",code:"METHOD_NOT_ALLOWED"});let{target:P}=t.query;if(!P)return(0,F.handleApiError)(new F.ValidationError("Target format is required"),r,{method:t.method,url:t.url,endpoint:"/api/convert/[target]"});let z=process.env.VERCEL?"/tmp":$.default.tmpdir(),O=(0,a.default)({multiples:!1,keepExtensions:!0,allowEmptyFiles:!1,maxFileSize:524288e3,maxTotalFileSize:524288e3,uploadDir:z});try{O.parse(t,async(a,z,O)=>{try{if(a){let e=a.message||"File upload failed";return a.message&&a.message.includes("file size should be greater than 0")?e="Il file è vuoto. Carica un file valido.":a.message&&a.message.includes("options.allowEmptyFiles")?e="Il file caricato è vuoto. Carica un file con contenuto.":a.message&&a.message.includes("maxTotalFileSize")?e="File troppo grande. Dimensione massima: 500MB per file video/audio, 50MB per altri formati":a.message&&a.message.includes("maxFileSize")&&(e="File troppo grande. Dimensione massima: 500MB per file video/audio, 50MB per altri formati"),(0,F.handleApiError)(new F.ValidationError(e,a),r,{method:t.method,url:t.url,endpoint:"/api/convert/[target]"})}let T=O.file;if(Array.isArray(T)&&(T=T[0]),!T)return(0,F.handleApiError)(new F.ValidationError("File missing"),r,{method:t.method,url:t.url,endpoint:"/api/convert/[target]"});let L=T.filepath||T.path;if(!L)return(0,F.handleApiError)(new F.ValidationError("File path non valido - il file potrebbe non essere stato caricato correttamente"),r,{method:t.method,url:t.url,endpoint:"/api/convert/[target]"});if(0===T.size)return(0,F.handleApiError)(new F.ValidationError("Il file è vuoto. Carica un file valido."),r,{method:t.method,url:t.url,endpoint:"/api/convert/[target]"});let _="";try{if(!L||"string"!=typeof L)throw Error("File path non valido - il file potrebbe non essere stato caricato correttamente");if(!i.default.existsSync(L))throw Error("Il file caricato non esiste più o è stato rimosso");let a=T.originalFilename||T.name||"file",O=i.default.readFileSync(L);_=(o.default.extname(a)||"").replace(".","").toLowerCase();let M=String(P).toLowerCase();function D(e){let t=`.${M}`;if(e.toLowerCase().endsWith(t))return e;let r=e.replace(/\.[^/.]+$/,t);return r.toLowerCase().endsWith(t)?r:e+t}let I=null,R="application/octet-stream",q=z.width?parseInt(String(z.width)):void 0,U=z.height?parseInt(String(z.height)):void 0,H=z.quality?parseInt(String(z.quality)):80,W=z.vwidth?parseInt(String(z.vwidth)):void 0,N=z.vheight?parseInt(String(z.vheight)):void 0,V=z.vbitrate?String(z.vbitrate):void 0,X=z.abitrate?String(z.abitrate):void 0,G=z.page?parseInt(String(z.page)):0;if(["png","jpg","jpeg","webp","tiff","bmp","avif","heif","gif"].includes(M)){let e;if("pdf"===_){let t=Number.isFinite(G)&&G>=0?G:0;e=(0,l.default)(O,{density:150,page:t})}else e=(0,l.default)(O,{failOn:"none"});(q||U)&&(e=e.resize({width:q,height:U,fit:"inside"})),"jpg"===M||"jpeg"===M?(I=await e.jpeg({quality:H}).toBuffer(),R="image/jpeg"):"png"===M?(I=await e.png({compressionLevel:9}).toBuffer(),R="image/png"):"webp"===M?(I=await e.webp({quality:H}).toBuffer(),R="image/webp"):"avif"===M?(I=await e.avif({quality:H}).toBuffer(),R="image/avif"):"heif"===M?(I=await e.heif({quality:H}).toBuffer(),R="image/heif"):"tiff"===M?(I=await e.tiff().toBuffer(),R="image/tiff"):"bmp"===M?(I=await e.bmp().toBuffer(),R="image/bmp"):"gif"===M&&(I=await e.gif().toBuffer(),R="image/gif")}let Y=["mp3","wav","aac","flac","ogg","m4a","weba","opus","ac3","aif","aiff","aifc","amr","au","caf","dss","oga","voc","wma"],J=["mp4","avi","mov","mkv","webm","flv","3gp","3g2","3gpp","cavs","dv","dvr","m2ts","m4v","mod","mpeg","mpg","mts","mxf","ogg","ogv","rm","rmvb","swf","ts","vob","wmv","wtv"];if(!I&&(Y.includes(M)||J.includes(M)))try{if(h.default)x.default.setFfmpegPath(h.default);else{let t=await e.A(619420),r=t.default||t;if(r)x.default.setFfmpegPath(r);else throw Error("FFmpeg non disponibile")}let t=$.default.cpus().length,r=process.env.VERCEL?"/tmp":o.default.dirname(L),a=`output_${Date.now()}.${M}`,l=o.default.join(r,a);if(await new Promise((e,r)=>{let a=(0,x.default)(L);if(a=a.outputOptions(["-threads",t.toString()]),Y.includes(M)){if(a=a.noVideo(),X)a=a.audioBitrate(X);else{let e={mp3:"160k",aac:"160k",m4a:"160k",flac:"1411k",wav:"1411k",ogg:"160k",opus:"128k",weba:"128k"}[M]||"160k";a=a.audioBitrate(e)}let e={mp3:"libmp3lame",aac:"aac",m4a:"aac",flac:"flac",wav:"pcm_s16le",ogg:"libvorbis",opus:"libopus",weba:"libopus",ac3:"ac3",wma:"wmav2"};e[M]&&(a=a.audioCodec(e[M])),a=(a=a.audioFrequency(44100)).audioChannels(2),"mp3"===M?a=a.outputOptions(["-q:a","3"]):"aac"===M||"m4a"===M?a=a.outputOptions(["-profile:a","aac_low","-movflags","+faststart"]):("opus"===M||"weba"===M)&&(a=a.outputOptions(["-compression_level","5"]))}if(J.includes(M)){let e={mp4:"libx264",webm:"libvpx",mkv:"libx264",avi:"libxvid",mov:"libx264",flv:"flv",ogv:"libtheora","3gp":"h263",wmv:"wmv2"};e[M]&&(a=a.videoCodec(e[M])),a=V?a.videoBitrate(V):a.videoBitrate("1800k"),W&&N?a=a.size(`${W}x${N}`):W?a=a.size(`${W}x?`):N&&(a=a.size(`?x${N}`));let t={mp4:"aac",webm:"libvorbis",mkv:"aac",avi:"libmp3lame",mov:"aac",flv:"libmp3lame",ogv:"libvorbis","3gp":"aac",wmv:"wmav2"};t[M]&&(a=a.audioCodec(t[M])),a=(a=X?a.audioBitrate(X):a.audioBitrate("160k")).fps(30),"mp4"===M?a=(a=a.format("mp4")).outputOptions(["-movflags","faststart","-preset","veryfast","-crf","24","-tune","fastdecode"]):"webm"===M?a=(a=a.format("webm")).outputOptions(["-deadline","good","-cpu-used","5","-row-mt","1"]):"mkv"===M?a=(a=a.format("matroska")).outputOptions(["-preset","veryfast","-crf","24","-tune","fastdecode"]):"avi"===M?a=(a=a.format("avi")).outputOptions(["-q:v","6"]):"mov"===M?a=(a=a.format("mov")).outputOptions(["-preset","veryfast","-crf","24","-tune","fastdecode"]):"flv"===M&&(a=a.format("flv"))}a.output(l).on("end",()=>e()).on("error",e=>r(e)).run()}),i.default.existsSync(l)){I=i.default.readFileSync(l),R=({mp3:"audio/mpeg",wav:"audio/wav",aac:"audio/aac",m4a:"audio/mp4",flac:"audio/flac",ogg:"audio/ogg",oga:"audio/ogg",opus:"audio/opus",weba:"audio/webm",wma:"audio/x-ms-wma",ac3:"audio/ac3",mp4:"video/mp4",webm:"video/webm",mkv:"video/x-matroska",avi:"video/x-msvideo",mov:"video/quicktime",flv:"video/x-flv",ogv:"video/ogg","3gp":"video/3gpp",wmv:"video/x-ms-wmv",mpeg:"video/mpeg",mpg:"video/mpeg"})[M]||"application/octet-stream";try{i.default.unlinkSync(l)}catch(e){console.warn("Failed to delete temp output file:",e)}}}catch(t){if(console.error("FFmpeg conversion error:",t),console.error("FFmpeg path:",h.default),console.error("FFmpeg error details:",{message:t.message,code:t.code,errno:t.errno,syscall:t.syscall}),!h.default||"ENOENT"===t.code||t.message?.includes("ENOENT")||t.message?.includes("not found"))try{let t=await e.A(619420),r=t.default||t;if(r&&i.default.existsSync(r)){try{i.default.accessSync(r,i.default.constants.X_OK)}catch(e){try{i.default.chmodSync(r,493)}catch(e){console.warn("Impossibile modificare permessi FFmpeg:",e)}}throw x.default.setFfmpegPath(r),new F.ProcessingError("FFmpeg trovato, riprova la conversione")}throw new F.ProcessingError(`FFmpeg non trovato nel percorso: ${r||"undefined"}`)}catch(e){throw console.error("Errore reimport FFmpeg:",e),new F.ProcessingError(`FFmpeg non disponibile: ${t.message||e.message||"Errore sconosciuto"}`)}throw new F.ProcessingError(`Conversione audio/video fallita: ${t.message||"Errore durante la conversione con FFmpeg"}`)}if(!I&&"pdf"===M)if("html"===_||"htm"===_){let e=O.toString("utf8").replace(/<script[^>]*>[\s\S]*?<\/script>/gi,"").replace(/<style[^>]*>[\s\S]*?<\/style>/gi,"").replace(/<[^>]+>/g," ").replace(/&nbsp;/g," ").replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#39;/g,"'").replace(/\s+/g," ").trim(),t=new n.default({margin:48}),r=[];t.on("data",e=>r.push(e)),t.on("end",()=>{}),t.fontSize(12).text(e),t.end(),await new Promise(e=>t.on("end",e)),I=Buffer.concat(r),R="application/pdf"}else if("csv"===_){let e=new n.default({margin:36}),t=[];e.on("data",e=>t.push(e)),e.on("error",()=>{});let r=O.toString("utf8").split(/\r?\n/).filter(Boolean).map(e=>e.split(",")),a=[],i=r.reduce((e,t)=>Math.max(e,t.length),0);for(let t=0;t<i;t++)a[t]=Math.floor((e.page.width-e.page.margins.left-e.page.margins.right)/i);let o=e.y;r.forEach((t,r)=>{let i=e.page.margins.left;t.forEach((t,r)=>{let l=a[r]||80;e.rect(i,o,l,20).strokeOpacity(.3).stroke(),e.fontSize(10).fillColor("#000").text(t,i+4,o+4,{width:l-8,height:12,ellipsis:!0}),i+=l}),(o+=20)+20>e.page.height-e.page.margins.bottom&&(e.addPage(),o=e.y)}),e.end(),await new Promise(t=>e.on("end",t)),I=Buffer.concat(t),R="application/pdf"}else if("svg"===_){let e=new n.default({autoFirstPage:!1}),t=[];e.on("data",e=>t.push(e)),e.on("error",()=>{}),e.addPage({size:"A4"});let r=O.toString("utf8");(0,c.default)(e,r,0,0,{preserveAspectRatio:"xMidYMid meet"}),e.end(),await new Promise(t=>e.on("end",t)),I=Buffer.concat(t),R="application/pdf"}else if(["png","jpg","jpeg","webp","bmp","gif","tiff"].includes(_)){let e=new n.default({autoFirstPage:!1}),t=[];e.on("data",e=>t.push(e)),e.on("error",()=>{});let r=(0,l.default)(O),a=await r.metadata(),o=a.width||800,f=a.height||600;e.addPage({size:[o,f]});let s=L+".tmpimg";i.default.writeFileSync(s,O),e.image(s,0,0,{width:o,height:f}),e.end(),await new Promise(t=>e.on("end",t)),I=Buffer.concat(t),i.default.unlinkSync(s),R="application/pdf"}else{let e=new n.default({margin:48}),t=[];e.on("data",e=>t.push(e)),e.on("error",()=>{});let r=O.toString("utf8");e.fontSize(12).text(r),e.end(),await new Promise(t=>e.on("end",t)),I=Buffer.concat(t),R="application/pdf"}if(!I&&"pdf"===M&&"ai"===_){let e=O.toString("binary"),t=e.indexOf("%PDF-"),r=e.lastIndexOf("%%EOF");if(-1!==t&&-1!==r&&r>t){let a=e.substring(t,r+5);I=Buffer.from(a,"binary"),R="application/pdf"}}if(!I&&"pdf"===M&&"djvu"===_){let e=o.default.join(o.default.dirname(L),`djvu_${Date.now()}.pdf`),t=await k(L,e);if(t){I=t,R="application/pdf";try{i.default.unlinkSync(e)}catch{}}}if(!I&&"pdf"===M&&["pub","xps","abw","zabw","doc","docm","dot","dotx","hwp","lwp","wpd","wps","pages","odt","ods","odp","odg","rtf","rst"].includes(_)){let e=process.env.VERCEL?"/tmp":o.default.dirname(L),a=await A(L,e,"pdf");if(!a)return(0,F.handleApiError)(new F.ProcessingError(`Conversione ${_.toUpperCase()} → PDF richiede LibreOffice. Per favore, installa LibreOffice per usare questa funzionalit\xe0. Download: https://www.libreoffice.org/download/`),r,{method:t.method,url:t.url,endpoint:"/api/convert/[target]",target:P,inputExt:_,hint:"LibreOffice non è installato sul server"});I=a,R="application/pdf"}if(!I&&"txt"===M){if("txt"===_)try{I=Buffer.from(O.toString("utf8"),"utf8"),R="text/plain"}catch(e){I=Buffer.from(O.toString("binary"),"utf8"),R="text/plain"}else if("pdf"===_)try{let e=await (0,p.default)(O);I=Buffer.from(e.text||"","utf8"),R="text/plain"}catch(e){I=Buffer.from("","utf8"),R="text/plain"}else if("docx"===_||"docm"===_||"dotx"===_)try{let{value:e}=await w.default.extractRawText({buffer:O});I=Buffer.from(e||"","utf8"),R="text/plain"}catch{I=Buffer.from("","utf8"),R="text/plain"}else if("doc"===_||"dot"===_)try{let{value:e}=await w.default.extractRawText({buffer:O});I=Buffer.from(e||"","utf8"),R="text/plain"}catch(t){let e=O.toString("utf8",0,Math.min(5e4,O.length)).replace(/[\x00-\x08\x0B-\x0C\x0E-\x1F\x7F]/g," ").trim();I=Buffer.from(e||"Contenuto non estraibile da formato DOC legacy","utf8"),R="text/plain"}else if("html"===_||"htm"===_)try{let e=O.toString("utf8").replace(/<script[^>]*>[\s\S]*?<\/script>/gi,"");e=(e=(e=(e=(e=(e=(e=(e=(e=e.replace(/<style[^>]*>[\s\S]*?<\/style>/gi,"")).replace(/<[^>]+>/g," ")).replace(/&nbsp;/g," ")).replace(/&amp;/g,"&")).replace(/&lt;/g,"<")).replace(/&gt;/g,">")).replace(/&quot;/g,'"')).replace(/&#39;/g,"'")).replace(/\s+/g," ").trim(),I=Buffer.from(e,"utf8")}catch(e){I=Buffer.from(O.toString("utf8"),"utf8")}else if("md"===_)try{let e=O.toString("utf8");e=(e=(e=(e=(e=(e=e.replace(/#{1,6}\s+/g,"")).replace(/\*\*([^*]+)\*\*/g,"$1")).replace(/\*([^*]+)\*/g,"$1")).replace(/\[([^\]]+)\]\([^\)]+\)/g,"$1")).replace(/`([^`]+)`/g,"$1")).replace(/```[\s\S]*?```/g,""),I=Buffer.from(e,"utf8")}catch(e){I=Buffer.from(O.toString("utf8"),"utf8")}else if("rtf"===_)try{let e=O.toString("utf8");e=(e=(e=(e=e.replace(/\\[a-z]+\d*\s?/gi," ")).replace(/\{[^}]*\}/g,"")).replace(/\\[{}]/g,"")).replace(/\s+/g," ").trim(),I=Buffer.from(e,"utf8"),R="text/plain"}catch(e){I=Buffer.from("","utf8"),R="text/plain"}else if("odt"===_)try{let e=await f.default.loadAsync(O),t="";if(e.files["content.xml"]){let r=await e.files["content.xml"].async("string");(t=(r.match(/<text:[^>]*>([^<]*)<\/text:[^>]*>/gi)||[]).map(e=>{let t=e.match(/>([^<]+)</i);return t?t[1]:""}).filter(e=>e.trim().length>0).join("\n"))||(t=r.replace(/<[^>]+>/g," ").replace(/\s+/g," ").trim())}I=Buffer.from(t||"Contenuto non estraibile","utf8"),R="text/plain"}catch(e){I=Buffer.from("","utf8"),R="text/plain"}else if("abw"===_||"zabw"===_)try{let e="";if("zabw"===_){let t=await f.default.loadAsync(O),r=t.files["content.xml"]||t.files.AbiWord;r&&(e=(await r.async("string")).replace(/<[^>]+>/g," ").replace(/\s+/g," ").trim())}else e=O.toString("utf8").replace(/<[^>]+>/g," ").replace(/\s+/g," ").trim();I=Buffer.from(e||"Contenuto non estraibile","utf8"),R="text/plain"}catch(e){I=Buffer.from("","utf8"),R="text/plain"}else if("tex"===_||"rst"===_)try{let e=O.toString("utf8");I=Buffer.from(e,"utf8"),R="text/plain"}catch(e){I=Buffer.from("","utf8"),R="text/plain"}else if(["pub","xps","hwp","lwp","pages","wpd","wps"].includes(_))try{if("xps"===_||"pages"===_)try{let e=await f.default.loadAsync(O),t="";for(let[r,a]of Object.entries(e.files))if(r.endsWith(".xml")||r.endsWith(".txt")){let e=await a.async("string");t+=e.replace(/<[^>]+>/g," ").replace(/\s+/g," ").trim()+"\n"}I=Buffer.from(t||"Contenuto non estraibile","utf8"),R="text/plain"}catch(t){let e=O.toString("utf8",0,Math.min(1e4,O.length)).replace(/[\x00-\x08\x0B-\x0C\x0E-\x1F\x7F]/g," ").trim();I=Buffer.from(e||"Contenuto non estraibile","utf8"),R="text/plain"}else{let e=O.toString("utf8",0,Math.min(1e4,O.length)).replace(/[\x00-\x08\x0B-\x0C\x0E-\x1F\x7F]/g," ").trim();I=Buffer.from(e||`Formato ${_.toUpperCase()} richiede tool specializzati per estrazione completa`,"utf8"),R="text/plain"}}catch(e){I=Buffer.from("","utf8"),R="text/plain"}else if("djvu"===_)I=Buffer.from("DJVU è un formato binario complesso. Per estrarre testo serve djvulibre.","utf8"),R="text/plain";else try{I=Buffer.from(O.toString("utf8"),"utf8")}catch(e){I=Buffer.from(O.toString("binary"),"utf8")}R="text/plain"}if(!I&&"html"===M){if("html"===_||"htm"===_)try{I=Buffer.from(O.toString("utf8"),"utf8"),R="text/html"}catch(e){I=Buffer.from(O.toString("binary"),"utf8"),R="text/html"}else if("md"===_)try{let e=v.marked.parse(O.toString("utf8"));I=Buffer.from(e,"utf8"),R="text/html"}catch(t){let e=O.toString("utf8").replace(/</g,"&lt;").replace(/>/g,"&gt;");I=Buffer.from(`<!DOCTYPE html>
<html><head><meta charset="UTF-8"></head><body><pre>${e}</pre></body></html>`,"utf8"),R="text/html"}else if("txt"===_)try{let e=O.toString("utf8").split(/\r?\n/),t='<!DOCTYPE html>\n<html lang="it">\n<head>\n<meta charset="UTF-8">\n<meta name="viewport" content="width=device-width, initial-scale=1.0">\n<title>Documento convertito</title>\n<style>\nbody { font-family: Arial, sans-serif; line-height: 1.6; max-width: 800px; margin: 0 auto; padding: 20px; }\np { margin-bottom: 1em; }\n</style>\n</head>\n<body>\n',r="";e.forEach(e=>{let a=e.trim();""===a?r&&(t+=`<p>${r.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</p>
`,r=""):(r&&(r+=" "),r+=a)}),r&&(t+=`<p>${r.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</p>
`),t+="</body>\n</html>",I=Buffer.from(t,"utf8"),R="text/html"}catch(r){let e=O.toString("utf8").replace(/</g,"&lt;").replace(/>/g,"&gt;"),t=`<!DOCTYPE html>
<html><head><meta charset="UTF-8"></head><body><pre>${e}</pre></body></html>`;I=Buffer.from(t,"utf8"),R="text/html"}else if("docx"===_)try{let{value:e}=await w.default.convertToHtml({buffer:O});I=Buffer.from(e,"utf8"),R="text/html"}catch(e){I=Buffer.from("<html><body><p>Errore nella conversione DOCX</p></body></html>","utf8"),R="text/html"}}if(!I&&"md"===M){if("md"===_)try{I=Buffer.from(O.toString("utf8"),"utf8"),R="text/markdown"}catch(e){I=Buffer.from(O.toString("binary"),"utf8"),R="text/markdown"}else if("html"===_||"htm"===_)try{let e=O.toString("utf8");e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=e.replace(/<script[^>]*>[\s\S]*?<\/script>/gi,"")).replace(/<style[^>]*>[\s\S]*?<\/style>/gi,"")).replace(/<h1[^>]*>(.*?)<\/h1>/gi,"# $1\n\n")).replace(/<h2[^>]*>(.*?)<\/h2>/gi,"## $1\n\n")).replace(/<h3[^>]*>(.*?)<\/h3>/gi,"### $1\n\n")).replace(/<h4[^>]*>(.*?)<\/h4>/gi,"#### $1\n\n")).replace(/<h5[^>]*>(.*?)<\/h5>/gi,"##### $1\n\n")).replace(/<h6[^>]*>(.*?)<\/h6>/gi,"###### $1\n\n")).replace(/<a[^>]*href=["']([^"']+)["'][^>]*>(.*?)<\/a>/gi,"[$2]($1)")).replace(/<strong[^>]*>(.*?)<\/strong>/gi,"**$1**")).replace(/<b[^>]*>(.*?)<\/b>/gi,"**$1**")).replace(/<em[^>]*>(.*?)<\/em>/gi,"*$1*")).replace(/<i[^>]*>(.*?)<\/i>/gi,"*$1*")).replace(/<p[^>]*>(.*?)<\/p>/gi,"$1\n\n")).replace(/<[^>]+>/g,"")).replace(/&nbsp;/g," ")).replace(/&amp;/g,"&")).replace(/&lt;/g,"<")).replace(/&gt;/g,">")).replace(/&quot;/g,'"')).replace(/&#39;/g,"'")).replace(/\n{3,}/g,"\n\n").trim(),I=Buffer.from(e,"utf8"),R="text/markdown"}catch(t){let e=O.toString("utf8").replace(/<[^>]+>/g," ").replace(/\s+/g," ").trim();I=Buffer.from(e,"utf8"),R="text/markdown"}else if("txt"===_)try{let e=O.toString("utf8");I=Buffer.from(e,"utf8"),R="text/markdown"}catch(e){I=Buffer.from(O.toString("utf8"),"utf8"),R="text/markdown"}else if("docx"===_)try{let{value:e}=await w.default.convertToHtml({buffer:O}),t=e;t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=t.replace(/<script[^>]*>[\s\S]*?<\/script>/gi,"")).replace(/<style[^>]*>[\s\S]*?<\/style>/gi,"")).replace(/<h1[^>]*>(.*?)<\/h1>/gi,"# $1\n\n")).replace(/<h2[^>]*>(.*?)<\/h2>/gi,"## $1\n\n")).replace(/<h3[^>]*>(.*?)<\/h3>/gi,"### $1\n\n")).replace(/<a[^>]*href=["']([^"']+)["'][^>]*>(.*?)<\/a>/gi,"[$2]($1)")).replace(/<strong[^>]*>(.*?)<\/strong>/gi,"**$1**")).replace(/<b[^>]*>(.*?)<\/b>/gi,"**$1**")).replace(/<em[^>]*>(.*?)<\/em>/gi,"*$1*")).replace(/<i[^>]*>(.*?)<\/i>/gi,"*$1*")).replace(/<p[^>]*>(.*?)<\/p>/gi,"$1\n\n")).replace(/<[^>]+>/g,"")).replace(/&nbsp;/g," ")).replace(/&amp;/g,"&")).replace(/&lt;/g,"<")).replace(/&gt;/g,">")).replace(/&quot;/g,'"')).replace(/&#39;/g,"'")).replace(/\n{3,}/g,"\n\n").trim(),I=Buffer.from(t,"utf8"),R="text/markdown"}catch(e){try{let{value:e}=await w.default.extractRawText({buffer:O});I=Buffer.from(e||"","utf8"),R="text/markdown"}catch{I=Buffer.from("","utf8"),R="text/markdown"}}}if(!I&&"csv"===M&&["xlsx","xls","ods"].includes(_)){let e=s.read(O,{type:"buffer"}),t=e.SheetNames[0],r=s.utils.sheet_to_csv(e.Sheets[t]);I=Buffer.from(r,"utf8"),R="text/csv"}if(!I&&"xlsx"===M&&["csv","txt","ods","xls"].includes(_)){if("csv"===_||"txt"===_){let e=O.toString("utf8").split(/\r?\n/).filter(Boolean).map(e=>e.split(",")),t=s.utils.aoa_to_sheet(e),r=s.utils.book_new();s.utils.book_append_sheet(r,t,"Sheet1"),I=Buffer.from(s.write(r,{type:"buffer",bookType:"xlsx"}))}else{let e=s.read(O,{type:"buffer"});I=Buffer.from(s.write(e,{type:"buffer",bookType:"xlsx"}))}R="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}if(!I&&"pdf"===M&&"docx"===_)try{let{value:e}=await w.default.convertToHtml({buffer:O}),t=e.replace(/<script[^>]*>[\s\S]*?<\/script>/gi,"").replace(/<style[^>]*>[\s\S]*?<\/style>/gi,"").replace(/<[^>]+>/g," ").replace(/&nbsp;/g," ").replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#39;/g,"'").replace(/\s+/g," ").trim(),r=new n.default({margin:48}),a=[];r.on("data",e=>a.push(e)),r.on("end",()=>{}),r.fontSize(12).text(t),r.end(),await new Promise(e=>r.on("end",e)),I=Buffer.concat(a),R="application/pdf"}catch{}if(!I&&["doc","docm","dot","dotx"].includes(_))try{if("docm"===_||"dotx"===_){if("txt"===M){let{value:e}=await w.default.extractRawText({buffer:O});I=Buffer.from(e||"","utf8"),R="text/plain"}else if("html"===M){let{value:e}=await w.default.convertToHtml({buffer:O});I=Buffer.from(e,"utf8"),R="text/html"}else if("pdf"===M){let{value:e}=await w.default.convertToHtml({buffer:O}),t=e.replace(/<[^>]+>/g," ").replace(/\s+/g," ").trim(),r=new n.default({margin:48}),a=[];r.on("data",e=>a.push(e)),r.on("end",()=>{}),r.fontSize(12).text(t),r.end(),await new Promise(e=>r.on("end",e)),I=Buffer.concat(a),R="application/pdf"}}else if("doc"===_||"dot"===_){if("txt"===M)try{let{value:e}=await w.default.extractRawText({buffer:O});I=Buffer.from(e||"","utf8"),R="text/plain"}catch(t){let e=O.toString("utf8",0,Math.min(5e4,O.length)).replace(/[\x00-\x08\x0B-\x0C\x0E-\x1F\x7F]/g," ").trim();I=Buffer.from(e||"Contenuto non estraibile da formato DOC legacy","utf8"),R="text/plain"}else if("pdf"===M)try{let e=o.default.dirname(L),t=o.default.basename(a,o.default.extname(a))+".pdf",r=o.default.join(e,`lo_${Date.now()}_${t}`),l=await A(L,r,"pdf");if(l){I=l,R="application/pdf";try{i.default.unlinkSync(r)}catch{}}else try{let{value:e}=await w.default.convertToHtml({buffer:O}),t=[],r=new n.default({size:"A4",margin:50});r.on("data",e=>t.push(e)),r.on("end",()=>{});let a=e.replace(/<[^>]+>/g," ").replace(/\s+/g," ").trim();r.fontSize(12).text(a),r.end(),await new Promise(e=>r.on("end",e)),I=Buffer.concat(t),R="application/pdf"}catch(e){I=Buffer.from("I formati DOC e DOT (Word legacy) richiedono LibreOffice installato. Installa LibreOffice e riprova.","utf8"),R="text/plain"}}catch(e){console.error("Errore conversione DOC/DOT:",e);try{let{value:e}=await w.default.convertToHtml({buffer:O}),t=[],r=new n.default({size:"A4",margin:50});r.on("data",e=>t.push(e)),r.on("end",()=>{});let a=e.replace(/<[^>]+>/g," ").replace(/\s+/g," ").trim();r.fontSize(12).text(a),r.end(),await new Promise(e=>r.on("end",e)),I=Buffer.concat(t),R="application/pdf"}catch(e){I=Buffer.from("I formati DOC e DOT (Word legacy) richiedono LibreOffice installato.","utf8"),R="text/plain"}}}}catch(e){console.error("Errore conversione Word:",e)}if(!I&&"rtf"===_&&("pdf"===M||"txt"===M||"html"===M))try{let e=O.toString("utf8");if(e=(e=(e=e.replace(/\\[a-z]+\d*\s?/gi," ")).replace(/\{[^}]*\}/g,"")).replace(/\s+/g," ").trim(),"txt"===M)I=Buffer.from(e,"utf8"),R="text/plain";else if("html"===M){let t=`<!DOCTYPE html>
<html><head><meta charset="UTF-8"></head><body><pre>${e.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</pre></body></html>`;I=Buffer.from(t,"utf8"),R="text/html"}else if("pdf"===M){let t=new n.default({margin:48}),r=[];t.on("data",e=>r.push(e)),t.on("end",()=>{}),t.fontSize(12).text(e),t.end(),await new Promise(e=>t.on("end",e)),I=Buffer.concat(r),R="application/pdf"}}catch(e){console.error("Errore conversione RTF:",e)}if(!I&&"odt"===_&&("pdf"===M||"txt"===M||"html"===M))try{let e=await f.default.loadAsync(O),t="";if(t=e.files["content.xml"]?(await e.files["content.xml"].async("string")).replace(/<[^>]+>/g," ").replace(/\s+/g," ").trim():"Impossibile estrarre contenuto da ODT.","txt"===M)I=Buffer.from(t,"utf8"),R="text/plain";else if("html"===M){let e=`<!DOCTYPE html>
<html><head><meta charset="UTF-8"></head><body><p>${t.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</p></body></html>`;I=Buffer.from(e,"utf8"),R="text/html"}else if("pdf"===M){let e=new n.default({margin:48}),r=[];e.on("data",e=>r.push(e)),e.on("end",()=>{}),e.fontSize(12).text(t),e.end(),await new Promise(t=>e.on("end",t)),I=Buffer.concat(r),R="application/pdf"}}catch(e){console.error("Errore conversione ODT:",e)}if(!I&&("abw"===_||"zabw"===_)&&("pdf"===M||"txt"===M||"html"===M))try{let e="";if("zabw"===_){let t=await f.default.loadAsync(O),r=t.files["content.xml"]||t.files.AbiWord;r&&(e=(await r.async("string")).replace(/<[^>]+>/g," ").replace(/\s+/g," ").trim())}else e=(e=O.toString("utf8")).replace(/<[^>]+>/g," ").replace(/\s+/g," ").trim();if(e||(e="Impossibile estrarre contenuto dal file."),"txt"===M)I=Buffer.from(e,"utf8"),R="text/plain";else if("html"===M){let t=`<!DOCTYPE html>
<html><head><meta charset="UTF-8"></head><body><p>${e.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</p></body></html>`;I=Buffer.from(t,"utf8"),R="text/html"}else if("pdf"===M){let t=new n.default({margin:48}),r=[];t.on("data",e=>r.push(e)),t.on("end",()=>{}),t.fontSize(12).text(e),t.end(),await new Promise(e=>t.on("end",e)),I=Buffer.concat(r),R="application/pdf"}}catch(e){console.error("Errore conversione ABW/ZABW:",e)}if(!I&&"djvu"===_&&"pdf"===M)try{let e=o.default.dirname(L),t=o.default.basename(a,o.default.extname(a))+".pdf",r=o.default.join(e,`djvu_${Date.now()}_${t}`),l=await k(L,r);if(l){I=l,R="application/pdf";try{i.default.unlinkSync(r)}catch{}}else I=Buffer.from("DJVU richiede djvulibre installato. Installa djvulibre e riprova.","utf8"),R="text/plain"}catch(e){console.error("Errore conversione DJVU:",e),I=Buffer.from("DJVU richiede djvulibre installato. Errore: "+e.message,"utf8"),R="text/plain"}let K={pub:{tool:"libreoffice",format:"pdf",msg:"Microsoft Publisher richiede LibreOffice installato."},xps:{tool:"libreoffice",format:"pdf",msg:"XPS richiede LibreOffice installato."},hwp:{tool:"libreoffice",format:"pdf",msg:"HWP (Hancom Word) richiede LibreOffice installato."},lwp:{tool:"libreoffice",format:"pdf",msg:"LWP (Lotus Word Pro) richiede LibreOffice installato."},pages:{tool:"libreoffice",format:"pdf",msg:"Apple Pages richiede LibreOffice installato."},wpd:{tool:"libreoffice",format:"pdf",msg:"WordPerfect richiede LibreOffice installato."},wps:{tool:"libreoffice",format:"pdf",msg:"WPS richiede LibreOffice installato."},tex:{tool:"pandoc",format:"pdf",msg:"LaTeX richiede Pandoc o pdflatex installato."},rst:{tool:"pandoc",format:"pdf",msg:"reStructuredText richiede Pandoc installato."}};if(!I&&K[_]&&"pdf"===M){let e=K[_];try{if("libreoffice"===e.tool){let e=o.default.dirname(L),t=o.default.join(e,`lo_output_${Date.now()}`);i.default.existsSync(t)||i.default.mkdirSync(t,{recursive:!0});let r=await A(L,t,"pdf");if(r){I=r,R="application/pdf";try{i.default.readdirSync(t).forEach(e=>{try{i.default.unlinkSync(o.default.join(t,e))}catch{}}),i.default.rmdirSync(t)}catch{}}}if(!I&&"pandoc"===e.tool){let e=o.default.dirname(L),t=o.default.basename(a,o.default.extname(a))+".pdf",r=o.default.join(e,`pandoc_${Date.now()}_${t}`),l=await C(L,r,_,"pdf");if(l){I=l,R="application/pdf";try{i.default.unlinkSync(r)}catch{}}}I||(I=Buffer.from(`${e.msg} Installa ${e.tool} e riprova.`,"utf8"),R="text/plain")}catch(t){console.error(`Errore conversione ${_}:`,t),I=Buffer.from(`${e.msg} Errore: ${t.message}`,"utf8"),R="text/plain"}}if(!I&&"pdf"===M&&["xls","xlsx","ods"].includes(_))try{let e=s.read(O,{type:"buffer"}),t=new n.default({margin:36}),r=[];t.on("data",e=>r.push(e)),t.on("error",()=>{}),e.SheetNames.forEach((r,a)=>{a>0&&t.addPage();let i=e.Sheets[r],o=s.utils.sheet_to_json(i,{header:1,defval:""});if(t.fontSize(16).text(r,{align:"center"}),t.moveDown(),o.length>0){let e=[],r=o.reduce((e,t)=>Math.max(e,t.length),0),a=t.page.width-t.page.margins.left-t.page.margins.right;for(let t=0;t<r;t++)e[t]=Math.floor(a/r);let i=t.y;o.forEach((r,a)=>{i+20>t.page.height-t.page.margins.bottom&&(t.addPage(),i=t.y);let o=t.page.margins.left;r.forEach((r,a)=>{let l=e[a]||80;t.rect(o,i,l,20).strokeOpacity(.3).stroke(),t.fontSize(9).fillColor("#000").text(String(r||""),o+4,i+4,{width:l-8,height:12,ellipsis:!0}),o+=l}),i+=20})}}),t.end(),await new Promise(e=>t.on("end",e)),I=Buffer.concat(r),R="application/pdf"}catch{}if(!I&&"pptx"===M&&"pdf"===_)try{let t=await (0,p.default)(O),r=t.text||"",a=t.numpages||1,i=await e.A(998200),o=new(i.default||i),l=r.split("\n").filter(e=>e.trim()),n=Math.max(1,Math.ceil(l.length/a));for(let e=0;e<a;e++){let t=o.addSlide(),r=l.slice(e*n,(e+1)*n).join("\n")||`Slide ${e+1}`;t.addText(r,{x:.5,y:.5,w:9,h:5,fontSize:14,color:"000000"})}I=await o.write({outputType:"nodebuffer"}),I=Buffer.isBuffer(I)?I:Buffer.from(I),R="application/vnd.openxmlformats-officedocument.presentationml.presentation"}catch{}if(!I&&"xlsx"===M&&"pdf"===_)try{let e=((await (0,p.default)(O)).text||"").split("\n").filter(e=>e.trim()).map(e=>e.includes("	")?e.split("	"):e.includes(",")?e.split(",").map(e=>e.trim()):e.split(/\s{2,}/).filter(e=>e.trim())),t=s.utils.aoa_to_sheet(e),r=s.utils.book_new();s.utils.book_append_sheet(r,t,"Sheet1"),I=Buffer.from(s.write(r,{type:"buffer",bookType:"xlsx"})),R="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}catch{}if(!I&&("pdfa"===M||"pdf-a"===M)&&"pdf"===_)try{let e=new n.default({autoFirstPage:!1}),t=[];e.on("data",e=>t.push(e)),e.on("error",()=>{}),e.info({Title:"PDF/A Document",Author:"MegaPixelAI",Subject:"PDF/A compliant document",Keywords:"PDF/A",Creator:"MegaPixelAI Converter",Producer:"MegaPixelAI PDF/A Converter"}),I=O,R="application/pdf"}catch{}if(!I&&"docx"===M){if("docx"===_)try{I=O,R="application/vnd.openxmlformats-officedocument.wordprocessingml.document"}catch(e){I=O,R="application/vnd.openxmlformats-officedocument.wordprocessingml.document"}else if("txt"===_)try{O.toString("utf8").replace(/\n/g,"</p><p>").replace(/</g,"&lt;").replace(/>/g,"&gt;"),I=Buffer.from("Conversione TXT → DOCX richiede una libreria dedicata. Per ora, usa TXT → HTML → DOCX tramite altri tool.","utf8"),R="text/plain"}catch(e){I=Buffer.from("Errore nella conversione TXT → DOCX","utf8"),R="text/plain"}else if("html"===_||"htm"===_)I=Buffer.from("Conversione HTML → DOCX richiede una libreria dedicata (es. docx o officegen).","utf8"),R="text/plain";else if("md"===_)try{v.marked.parse(O.toString("utf8")),I=Buffer.from("Conversione MD → DOCX richiede una libreria dedicata. Converti prima in HTML.","utf8"),R="text/plain"}catch(e){I=Buffer.from("Errore nella conversione MD → DOCX","utf8"),R="text/plain"}}if(!I&&("html"===M||"pdf"===M)&&"md"===_){let e=v.marked.parse(O.toString("utf8"));if("html"===M)I=Buffer.from(e,"utf8"),R="text/html";else{let t=e.replace(/<script[^>]*>[\s\S]*?<\/script>/gi,"").replace(/<style[^>]*>[\s\S]*?<\/style>/gi,"").replace(/<[^>]+>/g," ").replace(/&nbsp;/g," ").replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#39;/g,"'").replace(/\s+/g," ").trim(),r=new n.default({margin:48}),a=[];r.on("data",e=>a.push(e)),r.on("end",()=>{}),r.fontSize(12).text(t),r.end(),await new Promise(e=>r.on("end",e)),I=Buffer.concat(a),R="application/pdf"}}if(!I&&"zip"===M){let e=new f.default;e.file(a,O),I=await e.generateAsync({type:"nodebuffer"}),R="application/zip"}if(!I&&("tgz"===M||"tar"===M||"gz"===M)&&"zip"===_){let e=await f.default.loadAsync(O),t=u.default.pack(),r=[],a=async()=>{for await(let e of(t.finalize(),t))r.push(e);return Buffer.concat(r)};for(let r of Object.keys(e.files)){let a=e.files[r];if(a.dir)continue;let i=await a.async("nodebuffer");t.entry({name:r,size:i.length},i)}let i=await a();"tar"===M?(I=i,R="application/x-tar"):("gz"===M||"tgz"===M)&&(I=d.default.gzipSync(i),R="application/gzip")}if(!I&&"7z"===M){let e=o.default.dirname(L),t=o.default.join(e,`in_${Date.now()}_${a}`);i.default.writeFileSync(t,O);let r=o.default.join(e,`out_${Date.now()}.7z`);await new Promise((e,a)=>{(0,B.execFile)(S.path7za,["a",r,t],t=>{t?a(t):e()})}),I=i.default.readFileSync(r);try{i.default.unlinkSync(t),i.default.unlinkSync(r)}catch{}R="application/x-7z-compressed"}if(!I&&["7z","rar","tar","gz","tgz","zip","bz2","xz"].includes(_)&&("zip"===M||"tgz"===M)){let e=o.default.dirname(L),t=o.default.join(e,`in_${Date.now()}.${_}`);i.default.writeFileSync(t,O);let r=o.default.join(e,`ext_${Date.now()}`);i.default.mkdirSync(r);let a=!1;try{await new Promise((e,a)=>{(0,B.execFile)(S.path7za,["x",t,`-o${r}`,"-y"],t=>{t?a(t):e()})}),a=!0}catch{}if(!a&&"rar"===_)try{for(let e of(await (0,E.createExtractorFromData)({data:O})).extract().files)if("file"===e.type){let t=o.default.join(r,e.fileHeader.name),a=o.default.dirname(t);i.default.mkdirSync(a,{recursive:!0}),i.default.writeFileSync(t,Buffer.from(e.extract()))}a=!0}catch{}if(a)if("zip"===M){let e=new f.default,t=(r,a="")=>{for(let l of i.default.readdirSync(r,{withFileTypes:!0})){let n=o.default.join(r,l.name),f=o.default.join(a,l.name);l.isDirectory()?t(n,f):e.file(f.replace(/\\/g,"/"),i.default.readFileSync(n))}};t(r),I=await e.generateAsync({type:"nodebuffer"}),R="application/zip"}else{let e=u.default.pack(),t=[],a=(t,r="")=>{for(let l of i.default.readdirSync(t,{withFileTypes:!0})){let n=o.default.join(t,l.name),f=o.default.join(r,l.name);l.isDirectory()?a(n,f):e.entry({name:f.replace(/\\/g,"/"),size:i.default.statSync(n).size},i.default.readFileSync(n))}};for await(let i of(a(r),e.finalize(),e))t.push(i);let l=Buffer.concat(t);I=d.default.gzipSync(l),R="application/gzip"}try{i.default.rmSync(r,{recursive:!0,force:!0}),i.default.unlinkSync(t)}catch{}}if(!I&&"tar"===M){let e=u.default.pack(),t=[];for await(let r of(e.entry({name:a,size:O.length},O),e.finalize(),e))t.push(r);I=Buffer.concat(t),R="application/x-tar"}if(!I&&("gz"===M||"tgz"===M)){let e,t,r="tgz"===M?(e=u.default.pack(),t=[],e.entry({name:a,size:O.length},O),e.finalize(),new Promise(async r=>{for await(let r of e)t.push(r);r(Buffer.concat(t))})):Promise.resolve(O),i=await r;I=d.default.gzipSync(i),R="application/gzip"}if(!I&&("woff"===M||"woff2"===M)&&"ttf"===_)if("woff"===M){let{buffer:e}=(0,m.default)(new Uint8Array(O));I=Buffer.from(e),R="font/woff"}else{let e=(0,g.default)(O);I=Buffer.from(e),R="font/woff2"}if(!I&&"eot"===M&&"ttf"===_){let e=(0,b.default)(new Uint8Array(O)).buffer;I=Buffer.from(e),R="application/vnd.ms-fontobject"}if(I||"png"!==M||"svg"!==_||(I=await (0,l.default)(O).png().toBuffer(),R="image/png"),!I&&("png"===M||"jpg"===M||"jpeg"===M)&&"pdf"===_)try{let e=Number.isFinite(G)&&G>=0?G:0,t=(0,l.default)(O,{density:150,page:e});"png"===M?(I=await t.png().toBuffer(),R="image/png"):(I=await t.jpeg({quality:H}).toBuffer(),R="image/jpeg")}catch{}if(I||"svg"!==M||"svgz"!==_||(I=d.default.gunzipSync(O),R="image/svg+xml"),!I&&("cbz"===M||"htmlz"===M||"txtz"===M)){let e=new f.default;if("cbz"===M)e.file("page01"+(o.default.extname(a)||".jpg"),O);else if("htmlz"===M){let t="md"===_?v.marked.parse(O.toString("utf8")):O.toString("utf8");e.file("index.html",t)}else if("txtz"===M){let t=O.toString("utf8");e.file("index.txt",t)}I=await e.generateAsync({type:"nodebuffer"}),R="application/zip"}if(!I&&"jar"===M){let e=new f.default;e.file(a,O),I=await e.generateAsync({type:"nodebuffer"}),R="application/java-archive"}if(!I&&"epub"===M&&["html","htm","md","txt"].includes(_)){let e="md"===_?v.marked.parse(O.toString("utf8")):"txt"===_?`<pre>${O.toString("utf8")}</pre>`:O.toString("utf8"),t=o.default.join(o.default.dirname(L),`out_${Date.now()}.epub`);await new y.default({title:o.default.basename(a,o.default.extname(a)),author:"MegaPixelAI",content:[{title:"Chapter 1",data:e}]},t).promise,I=i.default.readFileSync(t);try{i.default.unlinkSync(t)}catch{}R="application/epub+zip"}if(!I&&!O)return(0,F.handleApiError)(new F.ProcessingError("Nessun buffer disponibile per la conversione"),r,{method:t.method,url:t.url,endpoint:"/api/convert/[target]",target:P,inputExt:_});let Z=I||O;if(!I&&Z===O)if(_!==M)return console.warn(`Conversione non supportata: ${_} → ${M}`),(0,F.handleApiError)(new F.ProcessingError(`Conversione non supportata: ${_} → ${M}. Questo formato non pu\xf2 essere convertito in ${M}.`),r,{method:t.method,url:t.url,endpoint:"/api/convert/[target]",target:P,inputExt:_});else{let e=D(a),t={txt:"text/plain",html:"text/html",htm:"text/html",md:"text/markdown",docx:"application/vnd.openxmlformats-officedocument.wordprocessingml.document",pdf:"application/pdf",xlsx:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",pptx:"application/vnd.openxmlformats-officedocument.presentationml.presentation"}[M]||R||"application/octet-stream",i=j(Z,t);return r.status(200).json({name:e,dataUrl:i})}let Q=D(a);if(!Z||0===Z.length)return(0,F.handleApiError)(new F.ProcessingError("Il file risultante è vuoto. Il formato potrebbe non essere supportato."),r,{method:t.method,url:t.url,endpoint:"/api/convert/[target]",target:P,inputExt:_});let ee=j(Z,R);return r.status(200).json({name:Q,dataUrl:ee})}catch(a){let e=_||(T?.originalFilename?o.default.extname(T.originalFilename).replace(".","").toLowerCase():"")||"";if(!r.headersSent)return(0,F.handleApiError)(new F.ProcessingError("Conversion failed: "+(a.message||"Unknown error"),a),r,{method:t.method,url:t.url,endpoint:"/api/convert/[target]",target:P,inputExt:e});console.error("Error after response sent in convert API:",a)}}catch(e){if(console.error("Unhandled error in form.parse callback:",e),!r.headersSent){let a=inputExt||(file?.originalFilename?o.default.extname(file.originalFilename).replace(".","").toLowerCase():"")||"";return(0,F.handleApiError)(new F.ProcessingError("Error processing file: "+(e.message||"Unknown error"),e),r,{method:t.method,url:t.url,endpoint:"/api/convert/[target]",target:P,inputExt:a})}}})}catch(e){if(console.error("Error in form.parse setup:",e),!r.headersSent)return(0,F.handleApiError)(new F.ProcessingError("File upload setup failed: "+(e.message||"Unknown error"),e),r,{method:t.method,url:t.url,endpoint:"/api/convert/[target]"})}}e.s(["config",0,{api:{bodyParser:!1}},"default",()=>D]),r()}catch(e){r(e)}},!1),953385,e=>e.a(async(t,r)=>{try{var a=e.i(926747),i=e.i(190406),o=e.i(244898),l=e.i(262950),n=e.i(233984),f=e.i(7031),s=e.i(181927),p=e.i(846432),c=t([n]);[n]=c.then?(await c)():c;let u=(0,l.hoist)(n,"default"),m=(0,l.hoist)(n,"config"),g=new o.PagesAPIRouteModule({definition:{kind:i.RouteKind.PAGES_API,page:"/api/convert/[target]",pathname:"/api/convert/[target]",bundlePath:"",filename:""},userland:n,distDir:".next-build",relativeProjectDir:""});async function d(e,t,r){g.isDev&&(0,p.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let i="/api/convert/[target]";i=i.replace(/\/index$/,"")||"/";let o=await g.prepare(e,t,{srcPage:i});if(!o){t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve());return}let{query:l,params:n,prerenderManifest:c,routerServerContext:d}=o;try{let r=e.method||"GET",a=(0,f.getTracer)(),o=a.getActiveScopeSpan(),p=g.instrumentationOnRequestError.bind(g),u=async o=>g.render(e,t,{query:{...l,...n},params:n,allowedRevalidateHeaderKeys:[],multiZoneDraftMode:!1,trustHostHeader:!1,previewProps:c.preview,propagateError:!1,dev:g.isDev,page:"/api/convert/[target]",internalRevalidate:null==d?void 0:d.revalidate,onError:(...t)=>p(e,...t)}).finally(()=>{if(!o)return;o.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let e=a.getRootSpanAttributes();if(!e)return;if(e.get("next.span_type")!==s.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${e.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let l=e.get("next.route");if(l){let e=`${r} ${l}`;o.setAttributes({"next.route":l,"http.route":l,"next.span_name":e}),o.updateName(e)}else o.updateName(`${r} ${i}`)});o?await u(o):await a.withPropagatedContext(e.headers,()=>a.trace(s.BaseServerSpan.handleRequest,{spanName:`${r} ${i}`,kind:f.SpanKind.SERVER,attributes:{"http.method":r,"http.target":e.url}},u))}catch(e){if(g.isDev)throw e;(0,a.sendError)(t,500,"Internal Server Error")}finally{null==r.waitUntil||r.waitUntil.call(r,Promise.resolve())}}e.s(["config",0,m,"default",0,u,"handler",()=>d]),r()}catch(e){r(e)}},!1)];

//# sourceMappingURL=%5Broot-of-the-server%5D__64175d78._.js.map