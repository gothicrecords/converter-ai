module.exports=[270406,(e,t,r)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},196115,e=>{"use strict";let t,r={app:{name:process.env.APP_NAME||"Tool Suite",env:"production",port:parseInt(process.env.PORT||"3000",10),url:(t=process.env.APP_URL||"http://localhost:3000").startsWith("http://")?t.replace("http://","https://"):t},database:{url:process.env.DATABASE_URL,pool:{max:parseInt(process.env.DB_POOL_MAX||"20",10),idleTimeout:parseInt(process.env.DB_IDLE_TIMEOUT||"30000",10),connectionTimeout:parseInt(process.env.DB_CONNECTION_TIMEOUT||"5000",10)}},supabase:{url:"https://ckctyvebrkcemcgllpbc.supabase.co",anonKey:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNrY3R5dmVicWtjZW1jZ2xscGJjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzNDYzMzksImV4cCI6MjA3ODkyMjMzOX0.kGyjcR9D8vLD5xYsEvHA5qAQ08OvoOC4mgajSmnh0jM",serviceRoleKey:process.env.SUPABASE_SERVICE_ROLE_KEY},stripe:{secretKey:process.env.STRIPE_SECRET_KEY,publishableKey:"pk_test_51SUZp0AYkkHFHNFuDK9bY1iN8xNUFPeBVZTSLgTBq5SxSo7bBeyaMYSTaaLfJ2g5oxOCXOO1bAAefqa5I9StJwF9001XRLRFQf",webhookSecret:process.env.STRIPE_WEBHOOK_SECRET,productId:process.env.STRIPE_PRODUCT_ID||"prod_TTkHuBeh8iAAht"},cloudinary:{cloudName:process.env.CLOUDINARY_CLOUD_NAME,apiKey:process.env.CLOUDINARY_API_KEY,apiSecret:process.env.CLOUDINARY_API_SECRET},openai:{apiKey:process.env.OPENAI_API_KEY},upload:{maxFileSize:parseInt(process.env.MAX_FILE_SIZE||"52428800",10),allowedMimeTypes:{image:["image/jpeg","image/png","image/webp","image/gif","image/svg+xml"],document:["application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document"],video:["video/mp4","video/webm","video/ogg"],audio:["audio/mpeg","audio/wav","audio/ogg"]},tempDir:process.env.TEMP_DIR||"/tmp"},session:{cookieName:"megapixelai_session",maxAge:6048e5,secret:process.env.SESSION_SECRET||"change-me-in-production"},security:{bcryptRounds:parseInt(process.env.BCRYPT_ROUNDS||"10",10),rateLimit:{windowMs:parseInt(process.env.RATE_LIMIT_WINDOW||"900000",10),max:parseInt(process.env.RATE_LIMIT_MAX||"100",10)}},analytics:{gaTrackingId:process.env.NEXT_PUBLIC_GA_TRACKING_ID},oauth:{google:{clientId:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET},facebook:{appId:process.env.FACEBOOK_APP_ID,appSecret:process.env.FACEBOOK_APP_SECRET},redirectBaseUrl:"production"===process.env.VERCEL_ENV?process.env.APP_URL||"https://megapixelsuite.com":process.env.APP_URL||(process.env.VERCEL_URL?`https://${process.env.VERCEL_URL}`:"http://localhost:3000")}};if("production"===r.app.env){let e="true"===process.env.STRICT_CONFIG;try{let e=[{key:"database.url",value:r.database.url},{key:"supabase.url",value:r.supabase.url},{key:"supabase.anonKey",value:r.supabase.anonKey}].filter(({value:e})=>!e);if(e.length>0)throw Error(`Missing required configuration: ${e.map(({key:e})=>e).join(", ")}`)}catch(t){if(e)throw t;console.error("[Config Warning] Missing required configuration:",t.message)}}e.s(["config",0,r])},230056,e=>e.a(async(t,r)=>{try{let t=await e.y("pg");e.n(t),r()}catch(e){r(e)}},!0),132692,e=>e.a(async(t,r)=>{try{var s=e.i(230056),a=e.i(196115),i=t([s]);[s]=i.then?(await i)():i;let{Pool:I}=s.default;if(!a.config.database.url)throw Error("DATABASE_URL environment variable is not set");let g=new I({connectionString:a.config.database.url,ssl:{rejectUnauthorized:!1},max:a.config.database.pool.max,idleTimeoutMillis:a.config.database.pool.idleTimeout,connectionTimeoutMillis:a.config.database.pool.connectionTimeout,keepAlive:!0,keepAliveInitialDelayMillis:1e4});async function o(e,t=[]){let r=Date.now();try{let s=await g.query(e,t),a=Date.now()-r;return a>1e3&&console.warn(`Slow query (${a}ms): ${e.substring(0,100)}`),s.rows}catch(e){throw console.error("Database query error:",e),e}}async function n(e){return(await o("SELECT * FROM users WHERE email = $1 LIMIT 1",[e]))[0]}async function c(e,t,r){return(await o(`INSERT INTO users (email, name, password_hash)
     VALUES ($1, $2, $3)
     RETURNING id, email, name, created_at, images_processed, tools_used, has_discount, plan`,[e,t,r]))[0]}async function u(e,t){return(await o("SELECT * FROM users WHERE auth_provider = $1 AND provider_id = $2 LIMIT 1",[e,t]))[0]}async function p({email:e,name:t,provider:r,providerId:s,providerEmail:a,avatarUrl:i}){try{let n=await o(`INSERT INTO users (email, name, auth_provider, provider_id, provider_email, avatar_url, password_hash)
       VALUES ($1, $2, $3, $4, $5, $6, NULL)
       RETURNING id, email, name, created_at, images_processed, tools_used, has_discount, plan, auth_provider, avatar_url`,[e,t,r,s,a||e,i]);if(!n||0===n.length)throw Error("Failed to create OAuth user: no data returned");return n[0]}catch(t){if(console.error("Error creating OAuth user:",{error:t.message,code:t.code,detail:t.detail,email:e,provider:r}),t.message&&t.message.includes("column")&&t.message.includes("does not exist"))throw Error("Database schema error: OAuth fields missing. Please run the migration: migrations/add-oauth-fields.sql");throw t}}async function d(e,{provider:t,providerId:r,providerEmail:s,avatarUrl:a}){return(await o(`UPDATE users
     SET auth_provider = $2,
         provider_id = $3,
         provider_email = $4,
         avatar_url = COALESCE($5, avatar_url),
         updated_at = NOW()
     WHERE id = $1
     RETURNING id, email, name, created_at, images_processed, tools_used, has_discount, plan, auth_provider, avatar_url`,[e,t,r,s,a]))[0]}async function l(e,t,r){return(await o(`INSERT INTO user_sessions (user_id, session_token, expires_at)
     VALUES ($1, $2, $3)
     RETURNING *`,[e,t,r]))[0]}async function E(e){return(await o(`SELECT s.*, u.email, u.name, u.images_processed, u.tools_used, u.has_discount, u.plan
     FROM user_sessions s
     JOIN users u ON s.user_id = u.id
     WHERE s.session_token = $1
     AND s.expires_at > NOW()
     LIMIT 1`,[e]))[0]}async function _(e){await o("DELETE FROM user_sessions WHERE session_token = $1",[e])}async function m(e,t){return(await o(`UPDATE users
     SET stripe_customer_id = $2,
         updated_at = NOW()
     WHERE id = $1
     RETURNING *`,[e,t]))[0]}async function h(e,t,r,s){return(await o(`UPDATE users
     SET stripe_subscription_id = $2,
         stripe_subscription_status = $3,
         subscription_expires_at = $4,
         plan = CASE WHEN $3 = 'active' THEN 'pro' ELSE 'free' END,
         updated_at = NOW()
     WHERE id = $1
     RETURNING *`,[e,t,r,s]))[0]}async function v(e){return(await o("SELECT * FROM users WHERE stripe_customer_id = $1 LIMIT 1",[e]))[0]}g.on("error",e=>{console.error("Unexpected database pool error",e)}),e.s(["createOAuthUser",()=>p,"createSession",()=>l,"createUser",()=>c,"deleteSession",()=>_,"getSession",()=>E,"getUser",()=>n,"getUserByProvider",()=>u,"getUserByStripeCustomerId",()=>v,"updateUserProvider",()=>d,"updateUserStripeCustomer",()=>m,"updateUserSubscription",()=>h]),r()}catch(e){r(e)}},!1),878830,e=>e.a(async(t,r)=>{try{let t=await e.y("stripe");e.n(t),r()}catch(e){r(e)}},!0),66382,e=>e.a(async(t,r)=>{try{var s=e.i(878830),a=t([s]);[s]=a.then?(await a)():a;let i=new s.default(process.env.STRIPE_SECRET_KEY,{apiVersion:"2023-10-16"});e.s(["default",0,i]),r()}catch(e){r(e)}},!1),450751,(e,t,r)=>{t.exports=e.x("micro",()=>require("micro"))},530986,e=>e.a(async(t,r)=>{try{var s=e.i(66382),a=e.i(450751),i=e.i(132692),o=t([s,i]);async function n(e,t){let r;if("POST"!==e.method)return t.status(405).json({error:"Method not allowed"});let o=e.headers["stripe-signature"],n=process.env.STRIPE_WEBHOOK_SECRET;try{let t=await (0,a.buffer)(e);r=s.default.webhooks.constructEvent(t,o,n)}catch(e){return console.error("Webhook signature verification failed:",e.message),t.status(400).send(`Webhook Error: ${e.message}`)}try{switch(r.type){case"checkout.session.completed":{let e=r.data.object,t=e.metadata.userId,a=e.customer,o=e.subscription;if(t&&a&&await (0,i.updateUserStripeCustomer)(t,a),t&&o){let e=await s.default.subscriptions.retrieve(o);await (0,i.updateUserSubscription)(t,o,e.status,new Date(1e3*e.current_period_end))}break}case"customer.subscription.updated":{let e=r.data.object,t=e.customer,s=await (0,i.getUserByStripeCustomerId)(t);s&&await (0,i.updateUserSubscription)(s.id,e.id,e.status,new Date(1e3*e.current_period_end));break}case"customer.subscription.deleted":{let e=r.data.object.customer,t=await (0,i.getUserByStripeCustomerId)(e);t&&await (0,i.updateUserSubscription)(t.id,null,"canceled",null);break}case"invoice.payment_failed":{let e=r.data.object.customer,t=await (0,i.getUserByStripeCustomerId)(e);t&&console.error("Payment failed for user:",t.id)}}t.status(200).json({received:!0})}catch(e){console.error("Webhook handler error:",e),t.status(500).json({error:"Webhook handler failed"})}}[s,i]=o.then?(await o)():o,e.s(["config",0,{api:{bodyParser:!1}},"default",()=>n]),r()}catch(e){r(e)}},!1),569389,e=>e.a(async(t,r)=>{try{var s=e.i(926747),a=e.i(190406),i=e.i(244898),o=e.i(262950),n=e.i(530986),c=e.i(7031),u=e.i(181927),p=e.i(846432),d=t([n]);[n]=d.then?(await d)():d;let E=(0,o.hoist)(n,"default"),_=(0,o.hoist)(n,"config"),m=new i.PagesAPIRouteModule({definition:{kind:a.RouteKind.PAGES_API,page:"/api/stripe/webhook",pathname:"/api/stripe/webhook",bundlePath:"",filename:""},userland:n,distDir:".next-build",relativeProjectDir:""});async function l(e,t,r){m.isDev&&(0,p.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let a="/api/stripe/webhook";a=a.replace(/\/index$/,"")||"/";let i=await m.prepare(e,t,{srcPage:a});if(!i){t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve());return}let{query:o,params:n,prerenderManifest:d,routerServerContext:l}=i;try{let r=e.method||"GET",s=(0,c.getTracer)(),i=s.getActiveScopeSpan(),p=m.instrumentationOnRequestError.bind(m),E=async i=>m.render(e,t,{query:{...o,...n},params:n,allowedRevalidateHeaderKeys:[],multiZoneDraftMode:!1,trustHostHeader:!1,previewProps:d.preview,propagateError:!1,dev:m.isDev,page:"/api/stripe/webhook",internalRevalidate:null==l?void 0:l.revalidate,onError:(...t)=>p(e,...t)}).finally(()=>{if(!i)return;i.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let e=s.getRootSpanAttributes();if(!e)return;if(e.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${e.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let o=e.get("next.route");if(o){let e=`${r} ${o}`;i.setAttributes({"next.route":o,"http.route":o,"next.span_name":e}),i.updateName(e)}else i.updateName(`${r} ${a}`)});i?await E(i):await s.withPropagatedContext(e.headers,()=>s.trace(u.BaseServerSpan.handleRequest,{spanName:`${r} ${a}`,kind:c.SpanKind.SERVER,attributes:{"http.method":r,"http.target":e.url}},E))}catch(e){if(m.isDev)throw e;(0,s.sendError)(t,500,"Internal Server Error")}finally{null==r.waitUntil||r.waitUntil.call(r,Promise.resolve())}}e.s(["config",0,_,"default",0,E,"handler",()=>l]),r()}catch(e){r(e)}},!1)];

//# sourceMappingURL=%5Broot-of-the-server%5D__c504cd06._.js.map