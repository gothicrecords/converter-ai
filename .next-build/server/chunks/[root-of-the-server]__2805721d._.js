module.exports=[264303,e=>{"use strict";e.s(["HTTP_METHODS",0,{GET:"GET",POST:"POST",PUT:"PUT",PATCH:"PATCH",DELETE:"DELETE"},"HTTP_STATUS",0,{OK:200,CREATED:201,NO_CONTENT:204,BAD_REQUEST:400,UNAUTHORIZED:401,FORBIDDEN:403,NOT_FOUND:404,METHOD_NOT_ALLOWED:405,CONFLICT:409,TOO_MANY_REQUESTS:429,INTERNAL_SERVER_ERROR:500,SERVICE_UNAVAILABLE:503}])},978548,e=>e.a(async(s,r)=>{try{var t=e.i(264303),a=e.i(515954),o=e.i(132692);e.i(829394);var n=s([o]);function i(e){return async(s,r)=>{try{await e(s,r)}catch(e){if(r.headersSent||r.writableEnded)return void console.error("Error after response was sent:",e);(0,a.handleApiError)(e,r,{method:s.method,url:s.url,path:s.path,query:s.query,user:s.user?.id})}}}function c(e){let s=Array.isArray(e)?e:[e];return e=>async(r,a)=>{if("OPTIONS"===r.method){a.setHeader("Allow",s.join(", ")),a.setHeader("Access-Control-Allow-Methods",s.join(", ")),a.setHeader("Access-Control-Allow-Headers","Content-Type, Authorization"),a.status(t.HTTP_STATUS.NO_CONTENT).end();return}let o=r.method?.toUpperCase();if(!s.map(e=>e.toUpperCase()).includes(o)){a.setHeader("Allow",s.join(", "));let e={success:!1,error:`Method ${r.method} not allowed. Allowed methods: ${s.join(", ")}`,code:"METHOD_NOT_ALLOWED"};a.status(t.HTTP_STATUS.METHOD_NOT_ALLOWED).json(e);return}return e(r,a)}}function u(e){return async(s,r)=>{try{let t=s.headers.authorization;if(!t)throw new a.AuthenticationError;let n=t.replace("Bearer ",""),i=await (0,o.getSession)(n);if(!i)throw new a.AuthenticationError("Invalid or expired session");return s.user={id:i.user_id,email:i.email,name:i.name,images_processed:i.images_processed,tools_used:i.tools_used,has_discount:i.has_discount,plan:i.plan},e(s,r)}catch(e){return(0,a.handleApiError)(e,r)}}}function l(...e){return s=>e.reduceRight((e,s)=>s(e),s)}[o]=n.then?(await n)():n,e.s(["apiHandler",()=>i,"composeMiddleware",()=>l,"requireAuth",()=>u,"requireMethod",()=>c]),r()}catch(e){r(e)}},!1),986287,e=>{"use strict";var s=e.i(264303);function r(e,t=null,a=s.HTTP_STATUS.OK){let o={success:!0};return null!==t&&("object"!=typeof t||Array.isArray(t)?o.data=t:Object.assign(o,t)),e.status(a).json(o)}function t(e,r,a=null){let o=a||r.statusCode||s.HTTP_STATUS.INTERNAL_SERVER_ERROR,n={success:!1,error:r.message||"Internal server error",code:r.code||"INTERNAL_ERROR"};return r.details&&(n.details=r.details),e.status(o).json(n)}e.s(["sendError",()=>t,"sendSuccess",()=>r])},194131,(e,s,r)=>{s.exports=e.x("@supabase/supabase-js",()=>require("@supabase/supabase-js"))},829394,e=>{"use strict";var s=e.i(194131);let r="https://ckctyvebrkcemcgllpbc.supabase.co";(0,s.createClient)(r,"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNrY3R5dmVicWtjZW1jZ2xscGJjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzNDYzMzksImV4cCI6MjA3ODkyMjMzOX0.kGyjcR9D8vLD5xYsEvHA5qAQ08OvoOC4mgajSmnh0jM"),e.s(["getServiceSupabase",0,()=>{let e=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e)throw Error("Missing SUPABASE_SERVICE_ROLE_KEY environment variable");return(0,s.createClient)(r,e)}])},515954,e=>{"use strict";class s extends Error{constructor(e,s=500,r=null,t=null,a=null){super(e),this.name=this.constructor.name,this.statusCode=s,this.code=r,this.details=t,this.originalError=a,this.timestamp=new Date().toISOString(),this.requestId=null,Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=Error().stack}toJSON(){return{name:this.name,message:this.message,statusCode:this.statusCode,code:this.code,details:this.details,timestamp:this.timestamp,requestId:this.requestId,stack:this.stack}}}class r extends s{constructor(e,s=null){super(e,400,"VALIDATION_ERROR",s)}}class t extends s{constructor(e="Authentication required"){super(e,401,"AUTHENTICATION_ERROR")}}class a extends s{constructor(e){super(e,409,"CONFLICT")}}class o extends s{constructor(e,s=null){super(e,500,"FILE_SYSTEM_ERROR",null,s)}}class n extends s{constructor(e,s=null){super(e,503,"NETWORK_ERROR",null,s)}}class i extends s{constructor(e="Request timeout",s=null){super(e,408,"TIMEOUT_ERROR",s?{timeoutMs:s}:null)}}class c extends s{constructor(e,s=null){super(`File too large. Maximum size is ${function(e){if(0===e)return"0 Bytes";let s=Math.floor(Math.log(e)/Math.log(1024));return Math.round(e/Math.pow(1024,s)*100)/100+" "+["Bytes","KB","MB","GB"][s]}(e)}`,413,"FILE_TOO_LARGE",{maxSize:e,actualSize:s})}}class u extends s{constructor(e=null){super(e?`Invalid file type. Allowed types: ${e.join(", ")}`:"Invalid file type",400,"INVALID_FILE_TYPE",{allowedTypes:e})}}class l extends s{constructor(e,s=null){super(e,500,"PROCESSING_ERROR",null,s)}}async function d(r,t={}){let a={timestamp:new Date().toISOString(),error:r instanceof s?r.toJSON():{name:r.name,message:r.message,stack:r.stack},context:t,environment:"production"};r instanceof s&&r.statusCode<500?console.warn("Client Error:",JSON.stringify(a,null,2)):console.error("Server Error:",JSON.stringify(a,null,2));try{let{default:s}=await e.A(139867),{log:a}=await e.A(970795);await s.trackError(r,t),a.error("Error logged",r,t)}catch(e){console.warn("Error tracker not available:",e.message)}return process.env.ERROR_TRACKING_ENABLED,a}function E(e,s=!1,r=!0){let t={error:e.message||"Internal server error",code:e.code||"INTERNAL_ERROR"};return r&&e.details&&(t.details=e.details),(s||0)&&(t.stack=e.stack),e.requestId&&(t.requestId=e.requestId),e.timestamp&&(t.timestamp=e.timestamp),t}async function p(e,t,a={}){return(await d(e,a),t.headersSent)?void 0:e instanceof s?t.status(e.statusCode).json(E(e,!1,!0)):"ValidationError"===e.name||"CastError"===e.name?t.status(400).json(E(new r(e.message,e.errors),!1)):"ECONNREFUSED"===e.code||"ETIMEDOUT"===e.code?t.status(503).json(E(new n("Database connection failed",e),!1)):"ENOENT"===e.code||"EACCES"===e.code||"EMFILE"===e.code?t.status(500).json(E(new o("File system operation failed",e),!1)):e.message&&(e.message.includes("timeout")||e.message.includes("ETIMEDOUT"))?t.status(408).json(E(new i("Request timeout",e.timeout),!1)):"LIMIT_FILE_SIZE"===e.code||e.message?.includes("too large")?t.status(413).json(E(new c,!1)):void t.status(500).json(E(new s("Internal server error",500,"INTERNAL_ERROR",null,e),!1))}e.s(["AuthenticationError",()=>t,"ConflictError",()=>a,"FileSystemError",()=>o,"FileTooLargeError",()=>c,"InvalidFileTypeError",()=>u,"ProcessingError",()=>l,"TimeoutError",()=>i,"ValidationError",()=>r,"handleApiError",()=>p])},196115,e=>{"use strict";let s,r={app:{name:process.env.APP_NAME||"Tool Suite",env:"production",port:parseInt(process.env.PORT||"3000",10),url:(s=process.env.APP_URL||"http://localhost:3000").startsWith("http://")?s.replace("http://","https://"):s},database:{url:process.env.DATABASE_URL,pool:{max:parseInt(process.env.DB_POOL_MAX||"20",10),idleTimeout:parseInt(process.env.DB_IDLE_TIMEOUT||"30000",10),connectionTimeout:parseInt(process.env.DB_CONNECTION_TIMEOUT||"5000",10)}},supabase:{url:"https://ckctyvebrkcemcgllpbc.supabase.co",anonKey:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNrY3R5dmVicWtjZW1jZ2xscGJjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzNDYzMzksImV4cCI6MjA3ODkyMjMzOX0.kGyjcR9D8vLD5xYsEvHA5qAQ08OvoOC4mgajSmnh0jM",serviceRoleKey:process.env.SUPABASE_SERVICE_ROLE_KEY},stripe:{secretKey:process.env.STRIPE_SECRET_KEY,publishableKey:"pk_test_51SUZp0AYkkHFHNFuDK9bY1iN8xNUFPeBVZTSLgTBq5SxSo7bBeyaMYSTaaLfJ2g5oxOCXOO1bAAefqa5I9StJwF9001XRLRFQf",webhookSecret:process.env.STRIPE_WEBHOOK_SECRET,productId:process.env.STRIPE_PRODUCT_ID||"prod_TTkHuBeh8iAAht"},cloudinary:{cloudName:process.env.CLOUDINARY_CLOUD_NAME,apiKey:process.env.CLOUDINARY_API_KEY,apiSecret:process.env.CLOUDINARY_API_SECRET},openai:{apiKey:process.env.OPENAI_API_KEY},upload:{maxFileSize:parseInt(process.env.MAX_FILE_SIZE||"52428800",10),allowedMimeTypes:{image:["image/jpeg","image/png","image/webp","image/gif","image/svg+xml"],document:["application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document"],video:["video/mp4","video/webm","video/ogg"],audio:["audio/mpeg","audio/wav","audio/ogg"]},tempDir:process.env.TEMP_DIR||"/tmp"},session:{cookieName:"megapixelai_session",maxAge:6048e5,secret:process.env.SESSION_SECRET||"change-me-in-production"},security:{bcryptRounds:parseInt(process.env.BCRYPT_ROUNDS||"10",10),rateLimit:{windowMs:parseInt(process.env.RATE_LIMIT_WINDOW||"900000",10),max:parseInt(process.env.RATE_LIMIT_MAX||"100",10)}},analytics:{gaTrackingId:process.env.NEXT_PUBLIC_GA_TRACKING_ID},oauth:{google:{clientId:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET},facebook:{appId:process.env.FACEBOOK_APP_ID,appSecret:process.env.FACEBOOK_APP_SECRET},redirectBaseUrl:"production"===process.env.VERCEL_ENV?process.env.APP_URL||"https://megapixelsuite.com":process.env.APP_URL||(process.env.VERCEL_URL?`https://${process.env.VERCEL_URL}`:"http://localhost:3000")}};if("production"===r.app.env){let e="true"===process.env.STRICT_CONFIG;try{let e=[{key:"database.url",value:r.database.url},{key:"supabase.url",value:r.supabase.url},{key:"supabase.anonKey",value:r.supabase.anonKey}].filter(({value:e})=>!e);if(e.length>0)throw Error(`Missing required configuration: ${e.map(({key:e})=>e).join(", ")}`)}catch(s){if(e)throw s;console.error("[Config Warning] Missing required configuration:",s.message)}}e.s(["config",0,r])},230056,e=>e.a(async(s,r)=>{try{let s=await e.y("pg");e.n(s),r()}catch(e){r(e)}},!0),132692,e=>e.a(async(s,r)=>{try{var t=e.i(230056),a=e.i(196115),o=s([t]);[t]=o.then?(await o)():o;let{Pool:R}=t.default;if(!a.config.database.url)throw Error("DATABASE_URL environment variable is not set");let O=new R({connectionString:a.config.database.url,ssl:{rejectUnauthorized:!1},max:a.config.database.pool.max,idleTimeoutMillis:a.config.database.pool.idleTimeout,connectionTimeoutMillis:a.config.database.pool.connectionTimeout,keepAlive:!0,keepAliveInitialDelayMillis:1e4});async function n(e,s=[]){let r=Date.now();try{let t=await O.query(e,s),a=Date.now()-r;return a>1e3&&console.warn(`Slow query (${a}ms): ${e.substring(0,100)}`),t.rows}catch(e){throw console.error("Database query error:",e),e}}async function i(e){return(await n("SELECT * FROM users WHERE email = $1 LIMIT 1",[e]))[0]}async function c(e,s,r){return(await n(`INSERT INTO users (email, name, password_hash)
     VALUES ($1, $2, $3)
     RETURNING id, email, name, created_at, images_processed, tools_used, has_discount, plan`,[e,s,r]))[0]}async function u(e,s){return(await n("SELECT * FROM users WHERE auth_provider = $1 AND provider_id = $2 LIMIT 1",[e,s]))[0]}async function l({email:e,name:s,provider:r,providerId:t,providerEmail:a,avatarUrl:o}){try{let i=await n(`INSERT INTO users (email, name, auth_provider, provider_id, provider_email, avatar_url, password_hash)
       VALUES ($1, $2, $3, $4, $5, $6, NULL)
       RETURNING id, email, name, created_at, images_processed, tools_used, has_discount, plan, auth_provider, avatar_url`,[e,s,r,t,a||e,o]);if(!i||0===i.length)throw Error("Failed to create OAuth user: no data returned");return i[0]}catch(s){if(console.error("Error creating OAuth user:",{error:s.message,code:s.code,detail:s.detail,email:e,provider:r}),s.message&&s.message.includes("column")&&s.message.includes("does not exist"))throw Error("Database schema error: OAuth fields missing. Please run the migration: migrations/add-oauth-fields.sql");throw s}}async function d(e,{provider:s,providerId:r,providerEmail:t,avatarUrl:a}){return(await n(`UPDATE users
     SET auth_provider = $2,
         provider_id = $3,
         provider_email = $4,
         avatar_url = COALESCE($5, avatar_url),
         updated_at = NOW()
     WHERE id = $1
     RETURNING id, email, name, created_at, images_processed, tools_used, has_discount, plan, auth_provider, avatar_url`,[e,s,r,t,a]))[0]}async function E(e,s,r){return(await n(`INSERT INTO user_sessions (user_id, session_token, expires_at)
     VALUES ($1, $2, $3)
     RETURNING *`,[e,s,r]))[0]}async function p(e){return(await n(`SELECT s.*, u.email, u.name, u.images_processed, u.tools_used, u.has_discount, u.plan
     FROM user_sessions s
     JOIN users u ON s.user_id = u.id
     WHERE s.session_token = $1
     AND s.expires_at > NOW()
     LIMIT 1`,[e]))[0]}async function _(e){await n("DELETE FROM user_sessions WHERE session_token = $1",[e])}async function m(e,s){return(await n(`UPDATE users
     SET stripe_customer_id = $2,
         updated_at = NOW()
     WHERE id = $1
     RETURNING *`,[e,s]))[0]}async function T(e,s,r,t){return(await n(`UPDATE users
     SET stripe_subscription_id = $2,
         stripe_subscription_status = $3,
         subscription_expires_at = $4,
         plan = CASE WHEN $3 = 'active' THEN 'pro' ELSE 'free' END,
         updated_at = NOW()
     WHERE id = $1
     RETURNING *`,[e,s,r,t]))[0]}async function I(e){return(await n("SELECT * FROM users WHERE stripe_customer_id = $1 LIMIT 1",[e]))[0]}O.on("error",e=>{console.error("Unexpected database pool error",e)}),e.s(["createOAuthUser",()=>l,"createSession",()=>E,"createUser",()=>c,"deleteSession",()=>_,"getSession",()=>p,"getUser",()=>i,"getUserByProvider",()=>u,"getUserByStripeCustomerId",()=>I,"updateUserProvider",()=>d,"updateUserStripeCustomer",()=>m,"updateUserSubscription",()=>T]),r()}catch(e){r(e)}},!1)];

//# sourceMappingURL=%5Broot-of-the-server%5D__2805721d._.js.map