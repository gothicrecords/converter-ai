module.exports=[70406,(e,t,a)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},93635,e=>e.a(async(t,a)=>{try{let t=await e.y("formidable");e.n(t),a()}catch(e){a(e)}},!0),15954,e=>{"use strict";class t extends Error{constructor(e,t=500,a=null,r=null,s=null){super(e),this.name=this.constructor.name,this.statusCode=t,this.code=a,this.details=r,this.originalError=s,this.timestamp=new Date().toISOString(),this.requestId=null,Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=Error().stack}toJSON(){return{name:this.name,message:this.message,statusCode:this.statusCode,code:this.code,details:this.details,timestamp:this.timestamp,requestId:this.requestId,stack:this.stack}}}class a extends t{constructor(e,t=null){super(e,400,"VALIDATION_ERROR",t)}}class r extends t{constructor(e="Authentication required"){super(e,401,"AUTHENTICATION_ERROR")}}class s extends t{constructor(e){super(e,409,"CONFLICT")}}class i extends t{constructor(e,t=null){super(e,500,"FILE_SYSTEM_ERROR",null,t)}}class n extends t{constructor(e,t=null){super(e,503,"NETWORK_ERROR",null,t)}}class o extends t{constructor(e="Request timeout",t=null){super(e,408,"TIMEOUT_ERROR",t?{timeoutMs:t}:null)}}class l extends t{constructor(e,t=null){super(`File too large. Maximum size is ${function(e){if(0===e)return"0 Bytes";let t=Math.floor(Math.log(e)/Math.log(1024));return Math.round(e/Math.pow(1024,t)*100)/100+" "+["Bytes","KB","MB","GB"][t]}(e)}`,413,"FILE_TOO_LARGE",{maxSize:e,actualSize:t})}}class u extends t{constructor(e=null){super(e?`Invalid file type. Allowed types: ${e.join(", ")}`:"Invalid file type",400,"INVALID_FILE_TYPE",{allowedTypes:e})}}class c extends t{constructor(e,t=null){super(e,500,"PROCESSING_ERROR",null,t)}}async function d(a,r={}){let s={timestamp:new Date().toISOString(),error:a instanceof t?a.toJSON():{name:a.name,message:a.message,stack:a.stack},context:r,environment:"production"};a instanceof t&&a.statusCode<500?console.warn("Client Error:",JSON.stringify(s,null,2)):console.error("Server Error:",JSON.stringify(s,null,2));try{let{default:t}=await e.A(39867),{log:s}=await e.A(70795);await t.trackError(a,r),s.error("Error logged",a,r)}catch(e){console.warn("Error tracker not available:",e.message)}return process.env.ERROR_TRACKING_ENABLED,s}function p(e,t=!1,a=!0){let r={error:e.message||"Internal server error",code:e.code||"INTERNAL_ERROR"};return a&&e.details&&(r.details=e.details),(t||0)&&(r.stack=e.stack),e.requestId&&(r.requestId=e.requestId),e.timestamp&&(r.timestamp=e.timestamp),r}async function h(e,r,s={}){return(await d(e,s),r.headersSent)?void 0:e instanceof t?r.status(e.statusCode).json(p(e,!1,!0)):"ValidationError"===e.name||"CastError"===e.name?r.status(400).json(p(new a(e.message,e.errors),!1)):"ECONNREFUSED"===e.code||"ETIMEDOUT"===e.code?r.status(503).json(p(new n("Database connection failed",e),!1)):"ENOENT"===e.code||"EACCES"===e.code||"EMFILE"===e.code?r.status(500).json(p(new i("File system operation failed",e),!1)):e.message&&(e.message.includes("timeout")||e.message.includes("ETIMEDOUT"))?r.status(408).json(p(new o("Request timeout",e.timeout),!1)):"LIMIT_FILE_SIZE"===e.code||e.message?.includes("too large")?r.status(413).json(p(new l,!1)):void r.status(500).json(p(new t("Internal server error",500,"INTERNAL_ERROR",null,e),!1))}e.s(["AuthenticationError",()=>r,"ConflictError",()=>s,"FileSystemError",()=>i,"FileTooLargeError",()=>l,"InvalidFileTypeError",()=>u,"ProcessingError",()=>c,"TimeoutError",()=>o,"ValidationError",()=>a,"handleApiError",()=>h])},71815,(e,t,a)=>{t.exports=e.x("sharp",()=>require("sharp"))},24868,(e,t,a)=>{t.exports=e.x("fs/promises",()=>require("fs/promises"))},44509,e=>{"use strict";var t=e.i(71815);let a=class{constructor(){this.maxDimension=7680}async denoise(e){return e.blur(.3).sharpen({sigma:.5,m1:.4,m2:.2})}async multiPassUpscale(e,a,r,s=3){let i=await e.metadata(),n=i.width,o=i.height,l=e,u=Math.pow(Math.max(a/n,r/o),1/s);for(let e=0;e<s;e++){let i=Math.min(Math.round(n*u),a),c=Math.min(Math.round(o*u),r),d=t.default.kernel.lanczos3;d=0===e||e===s-1?t.default.kernel.lanczos3:t.default.kernel.lanczos2,l=l.resize(i,c,{kernel:d,fit:"fill",withoutEnlargement:!1});let p=.3+e/s*.4;if(l=l.sharpen({sigma:.4+p,m1:.3+e/s*.2,m2:.15+e/s*.15}),e<s-1){let e=await l.toBuffer();l=(0,t.default)(e,{sequentialRead:!0})}n=i,o=c}return l}async applyFinalEnhancement(e,t="high"){let a=e;return(a=(a=a.linear(1.02,-2.56)).sharpen({sigma:1.2,m1:.7,m2:.4})).png({quality:100,compressionLevel:6,adaptiveFiltering:!0})}async upscale(e,a=4,r=7680){try{let s=(0,t.default)(e,{sequentialRead:!0}).rotate(),i=await s.metadata(),n=i.width||0,o=i.height||0;if(0===n||0===o)throw Error("Dimensioni immagine non valide");let l=Math.round(n*a),u=Math.round(o*a);if(l>r||u>r){let e=r/Math.max(l,u);l=Math.round(l*e),u=Math.round(u*e)}let c=s;n*o/1e6<2&&(c=await this.denoise(c));let d=Math.max(l/n,u/o),p=2;return d>3?p=4:d>2&&(p=3),c=await this.multiPassUpscale(c,l,u,p),c=await this.applyFinalEnhancement(c,"high"),await c.jpeg({quality:98,chromaSubsampling:"4:4:4",mozjpeg:!0,trellisQuantisation:!0,overshootDeringing:!0,optimiseScans:!0}).toBuffer()}catch(e){throw console.error("Errore upscaling avanzato:",e),Error(`Upscaling fallito: ${e.message}`)}}async upscaleTo4K(e){let a=(0,t.default)(e,{sequentialRead:!0}).rotate(),r=await a.metadata(),s=Math.max(r.width||0,r.height||0);return this.upscale(e,3840/s,3840)}async upscaleTo8K(e){let a=(0,t.default)(e,{sequentialRead:!0}).rotate(),r=await a.metadata(),s=Math.max(r.width||0,r.height||0);return this.upscale(e,7680/s,7680)}};e.s(["default",0,a])},69616,e=>{"use strict";var t=e.i(71815),a=e.i(44509);async function r(e,s=2){try{let r=new a.default,i=await (0,t.default)(e,{sequentialRead:!0}).metadata(),n=((i.width||0)*(i.height||0)/1e6<1?await r.upscaleTo4K(e):await r.upscale(e,s,7680)).toString("base64");return`data:image/jpeg;base64,${n}`}catch(e){throw console.error("Upscale fallito:",e),Error(`Upscale failed: ${e?.message||e}`)}}e.s(["default",()=>r])},4571,e=>e.a(async(t,a)=>{try{var r=e.i(93635),s=e.i(24868),i=e.i(69616),n=e.i(15954),o=t([r]);async function l(e,t){if("POST"!==e.method)return t.setHeader("Allow","POST"),t.status(405).json({error:"Method not allowed",code:"METHOD_NOT_ALLOWED"});let a=(0,r.default)({multiples:!1,maxFileSize:0x3200000,keepExtensions:!0}),o=null;try{let r,l,{files:u}=await Promise.race([new Promise((t,r)=>{a.parse(e,(e,a,s)=>{if(e)return"LIMIT_FILE_SIZE"===e.code?r(new n.FileTooLargeError(0x3200000)):r(new n.ValidationError("File upload failed: "+e.message,e));t({fields:a,files:s})})}),new Promise((e,t)=>setTimeout(()=>t(new n.TimeoutError("Request timeout",12e4)),12e4))]),c=u?.image??u?.file??null;if(Array.isArray(c)&&(c=c[0]),!c)throw new n.ValidationError("No file uploaded");if(!c.mimetype?.startsWith("image/"))throw new n.InvalidFileTypeError(["image/jpeg","image/png","image/webp","image/gif"]);if(c.size>0x3200000)throw new n.FileTooLargeError(0x3200000,c.size);if(!(o=c.filepath||c.path))throw new n.ValidationError("Uploaded file path missing");try{r=await s.default.readFile(o)}catch(e){throw new n.FileSystemError("Failed to read uploaded file",e)}if(!r||0===r.length)throw new n.ValidationError("File is empty or corrupted");try{l=await (0,i.default)(r)}catch(e){throw new n.ProcessingError("Failed to upscale image",e)}if(o)try{await s.default.unlink(o),o=null}catch(e){console.warn("Failed to cleanup temp file:",e)}return t.status(200).json({url:l})}catch(a){if(o)try{await s.default.unlink(o)}catch(e){console.warn("Failed to cleanup temp file on error:",e)}(0,n.handleApiError)(a,t,{method:e.method,url:e.url,endpoint:"/api/upscale"})}}[r]=o.then?(await o)():o,e.s(["config",0,{api:{bodyParser:!1}},"default",()=>l]),a()}catch(e){a(e)}},!1),49606,e=>e.a(async(t,a)=>{try{var r=e.i(26747),s=e.i(90406),i=e.i(44898),n=e.i(62950),o=e.i(4571),l=e.i(7031),u=e.i(81927),c=e.i(46432),d=t([o]);[o]=d.then?(await d)():d;let h=(0,n.hoist)(o,"default"),m=(0,n.hoist)(o,"config"),E=new i.PagesAPIRouteModule({definition:{kind:s.RouteKind.PAGES_API,page:"/api/upscale",pathname:"/api/upscale",bundlePath:"",filename:""},userland:o,distDir:".next-build",relativeProjectDir:""});async function p(e,t,a){E.isDev&&(0,c.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let s="/api/upscale";s=s.replace(/\/index$/,"")||"/";let i=await E.prepare(e,t,{srcPage:s});if(!i){t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve());return}let{query:n,params:o,prerenderManifest:d,routerServerContext:p}=i;try{let a=e.method||"GET",r=(0,l.getTracer)(),i=r.getActiveScopeSpan(),c=E.instrumentationOnRequestError.bind(E),h=async i=>E.render(e,t,{query:{...n,...o},params:o,allowedRevalidateHeaderKeys:[],multiZoneDraftMode:!1,trustHostHeader:!1,previewProps:d.preview,propagateError:!1,dev:E.isDev,page:"/api/upscale",internalRevalidate:null==p?void 0:p.revalidate,onError:(...t)=>c(e,...t)}).finally(()=>{if(!i)return;i.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let e=r.getRootSpanAttributes();if(!e)return;if(e.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${e.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=e.get("next.route");if(n){let e=`${a} ${n}`;i.setAttributes({"next.route":n,"http.route":n,"next.span_name":e}),i.updateName(e)}else i.updateName(`${a} ${s}`)});i?await h(i):await r.withPropagatedContext(e.headers,()=>r.trace(u.BaseServerSpan.handleRequest,{spanName:`${a} ${s}`,kind:l.SpanKind.SERVER,attributes:{"http.method":a,"http.target":e.url}},h))}catch(e){if(E.isDev)throw e;(0,r.sendError)(t,500,"Internal Server Error")}finally{null==a.waitUntil||a.waitUntil.call(a,Promise.resolve())}}e.s(["config",0,m,"default",0,h,"handler",()=>p]),a()}catch(e){a(e)}},!1),39867,e=>{e.v(t=>Promise.all(["server/chunks/[root-of-the-server]__fecf867a._.js"].map(t=>e.l(t))).then(()=>t(45255)))},70795,e=>{e.v(t=>Promise.all(["server/chunks/[root-of-the-server]__bc724f60._.js"].map(t=>e.l(t))).then(()=>t(28112)))}];

//# sourceMappingURL=%5Broot-of-the-server%5D__43ddc6a8._.js.map