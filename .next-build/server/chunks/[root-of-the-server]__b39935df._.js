module.exports=[515954,e=>{"use strict";class t extends Error{constructor(e,t=500,r=null,s=null,a=null){super(e),this.name=this.constructor.name,this.statusCode=t,this.code=r,this.details=s,this.originalError=a,this.timestamp=new Date().toISOString(),this.requestId=null,Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=Error().stack}toJSON(){return{name:this.name,message:this.message,statusCode:this.statusCode,code:this.code,details:this.details,timestamp:this.timestamp,requestId:this.requestId,stack:this.stack}}}class r extends t{constructor(e,t=null){super(e,400,"VALIDATION_ERROR",t)}}class s extends t{constructor(e="Authentication required"){super(e,401,"AUTHENTICATION_ERROR")}}class a extends t{constructor(e){super(e,409,"CONFLICT")}}class o extends t{constructor(e,t=null){super(e,500,"FILE_SYSTEM_ERROR",null,t)}}class i extends t{constructor(e,t=null){super(e,503,"NETWORK_ERROR",null,t)}}class n extends t{constructor(e="Request timeout",t=null){super(e,408,"TIMEOUT_ERROR",t?{timeoutMs:t}:null)}}class c extends t{constructor(e,t=null){super(`File too large. Maximum size is ${function(e){if(0===e)return"0 Bytes";let t=Math.floor(Math.log(e)/Math.log(1024));return Math.round(e/Math.pow(1024,t)*100)/100+" "+["Bytes","KB","MB","GB"][t]}(e)}`,413,"FILE_TOO_LARGE",{maxSize:e,actualSize:t})}}class l extends t{constructor(e=null){super(e?`Invalid file type. Allowed types: ${e.join(", ")}`:"Invalid file type",400,"INVALID_FILE_TYPE",{allowedTypes:e})}}class u extends t{constructor(e,t=null){super(e,500,"PROCESSING_ERROR",null,t)}}async function d(r,s={}){let a={timestamp:new Date().toISOString(),error:r instanceof t?r.toJSON():{name:r.name,message:r.message,stack:r.stack},context:s,environment:"production"};r instanceof t&&r.statusCode<500?console.warn("Client Error:",JSON.stringify(a,null,2)):console.error("Server Error:",JSON.stringify(a,null,2));try{let{default:t}=await e.A(139867),{log:a}=await e.A(970795);await t.trackError(r,s),a.error("Error logged",r,s)}catch(e){console.warn("Error tracker not available:",e.message)}return process.env.ERROR_TRACKING_ENABLED,a}function p(e,t=!1,r=!0){let s={error:e.message||"Internal server error",code:e.code||"INTERNAL_ERROR"};return r&&e.details&&(s.details=e.details),(t||0)&&(s.stack=e.stack),e.requestId&&(s.requestId=e.requestId),e.timestamp&&(s.timestamp=e.timestamp),s}async function E(e,s,a={}){return(await d(e,a),s.headersSent)?void 0:(s.setHeader("Access-Control-Allow-Origin","*"),s.setHeader("Access-Control-Allow-Methods","POST, OPTIONS"),s.setHeader("Access-Control-Allow-Headers","Content-Type"),s.setHeader("Access-Control-Max-Age","86400"),e instanceof t)?s.status(e.statusCode).json(p(e,!1,!0)):"ValidationError"===e.name||"CastError"===e.name?s.status(400).json(p(new r(e.message,e.errors),!1)):"ECONNREFUSED"===e.code||"ETIMEDOUT"===e.code?s.status(503).json(p(new i("Database connection failed",e),!1)):"ENOENT"===e.code||"EACCES"===e.code||"EMFILE"===e.code?s.status(500).json(p(new o("File system operation failed",e),!1)):e.message&&(e.message.includes("timeout")||e.message.includes("ETIMEDOUT"))?s.status(408).json(p(new n("Request timeout",e.timeout),!1)):"LIMIT_FILE_SIZE"===e.code||e.message?.includes("too large")?s.status(413).json(p(new c,!1)):void s.status(500).json(p(new t("Internal server error",500,"INTERNAL_ERROR",null,e),!1))}e.s(["AuthenticationError",()=>s,"ConflictError",()=>a,"FileSystemError",()=>o,"FileTooLargeError",()=>c,"InvalidFileTypeError",()=>l,"ProcessingError",()=>u,"TimeoutError",()=>n,"ValidationError",()=>r,"handleApiError",()=>E])},196115,e=>{"use strict";let t,r={app:{name:process.env.APP_NAME||"Tool Suite",env:"production",port:parseInt(process.env.PORT||"3000",10),url:(t=process.env.APP_URL||"http://localhost:3000").startsWith("http://")?t.replace("http://","https://"):t},database:{url:process.env.DATABASE_URL,pool:{max:parseInt(process.env.DB_POOL_MAX||"20",10),idleTimeout:parseInt(process.env.DB_IDLE_TIMEOUT||"30000",10),connectionTimeout:parseInt(process.env.DB_CONNECTION_TIMEOUT||"5000",10)}},supabase:{url:"https://ckctyvebrkcemcgllpbc.supabase.co",anonKey:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNrY3R5dmVicWtjZW1jZ2xscGJjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzNDYzMzksImV4cCI6MjA3ODkyMjMzOX0.kGyjcR9D8vLD5xYsEvHA5qAQ08OvoOC4mgajSmnh0jM",serviceRoleKey:process.env.SUPABASE_SERVICE_ROLE_KEY},stripe:{secretKey:process.env.STRIPE_SECRET_KEY,publishableKey:"pk_test_51SUZp0AYkkHFHNFuDK9bY1iN8xNUFPeBVZTSLgTBq5SxSo7bBeyaMYSTaaLfJ2g5oxOCXOO1bAAefqa5I9StJwF9001XRLRFQf",webhookSecret:process.env.STRIPE_WEBHOOK_SECRET,productId:process.env.STRIPE_PRODUCT_ID||"prod_TTkHuBeh8iAAht"},cloudinary:{cloudName:process.env.CLOUDINARY_CLOUD_NAME,apiKey:process.env.CLOUDINARY_API_KEY,apiSecret:process.env.CLOUDINARY_API_SECRET},openai:{apiKey:process.env.OPENAI_API_KEY},upload:{maxFileSize:parseInt(process.env.MAX_FILE_SIZE||"52428800",10),allowedMimeTypes:{image:["image/jpeg","image/png","image/webp","image/gif","image/svg+xml"],document:["application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document"],video:["video/mp4","video/webm","video/ogg"],audio:["audio/mpeg","audio/wav","audio/ogg"]},tempDir:process.env.TEMP_DIR||"/tmp"},session:{cookieName:"megapixelai_session",maxAge:6048e5,secret:process.env.SESSION_SECRET||"change-me-in-production"},security:{bcryptRounds:parseInt(process.env.BCRYPT_ROUNDS||"10",10),rateLimit:{windowMs:parseInt(process.env.RATE_LIMIT_WINDOW||"900000",10),max:parseInt(process.env.RATE_LIMIT_MAX||"100",10)}},analytics:{gaTrackingId:process.env.NEXT_PUBLIC_GA_TRACKING_ID},oauth:{google:{clientId:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET},facebook:{appId:process.env.FACEBOOK_APP_ID,appSecret:process.env.FACEBOOK_APP_SECRET},redirectBaseUrl:"production"===process.env.VERCEL_ENV?process.env.APP_URL||"https://megapixelsuite.com":process.env.APP_URL||(process.env.VERCEL_URL?`https://${process.env.VERCEL_URL}`:"http://localhost:3000")}};if("production"===r.app.env){let e="true"===process.env.STRICT_CONFIG;try{let e=[{key:"database.url",value:r.database.url},{key:"supabase.url",value:r.supabase.url},{key:"supabase.anonKey",value:r.supabase.anonKey}].filter(({value:e})=>!e);if(e.length>0)throw Error(`Missing required configuration: ${e.map(({key:e})=>e).join(", ")}`)}catch(t){if(e)throw t;console.error("[Config Warning] Missing required configuration:",t.message)}}e.s(["config",0,r])},230056,e=>e.a(async(t,r)=>{try{let t=await e.y("pg");e.n(t),r()}catch(e){r(e)}},!0),132692,e=>e.a(async(t,r)=>{try{var s=e.i(230056),a=e.i(196115),o=t([s]);[s]=o.then?(await o)():o;let{Pool:g}=s.default;if(!a.config.database.url)throw Error("DATABASE_URL environment variable is not set");let w=new g({connectionString:a.config.database.url,ssl:{rejectUnauthorized:!1},max:a.config.database.pool.max,idleTimeoutMillis:a.config.database.pool.idleTimeout,connectionTimeoutMillis:a.config.database.pool.connectionTimeout,keepAlive:!0,keepAliveInitialDelayMillis:1e4});async function i(e,t=[]){let r=Date.now();try{let s=await w.query(e,t),a=Date.now()-r;return a>1e3&&console.warn(`Slow query (${a}ms): ${e.substring(0,100)}`),s.rows}catch(e){throw console.error("Database query error:",e),e}}async function n(e){return(await i("SELECT * FROM users WHERE email = $1 LIMIT 1",[e]))[0]}async function c(e,t,r){return(await i(`INSERT INTO users (email, name, password_hash)
     VALUES ($1, $2, $3)
     RETURNING id, email, name, created_at, images_processed, tools_used, has_discount, plan`,[e,t,r]))[0]}async function l(e,t){return(await i("SELECT * FROM users WHERE auth_provider = $1 AND provider_id = $2 LIMIT 1",[e,t]))[0]}async function u({email:e,name:t,provider:r,providerId:s,providerEmail:a,avatarUrl:o}){try{let n=await i(`INSERT INTO users (email, name, auth_provider, provider_id, provider_email, avatar_url, password_hash)
       VALUES ($1, $2, $3, $4, $5, $6, NULL)
       RETURNING id, email, name, created_at, images_processed, tools_used, has_discount, plan, auth_provider, avatar_url`,[e,t,r,s,a||e,o]);if(!n||0===n.length)throw Error("Failed to create OAuth user: no data returned");return n[0]}catch(t){if(console.error("Error creating OAuth user:",{error:t.message,code:t.code,detail:t.detail,email:e,provider:r}),t.message&&t.message.includes("column")&&t.message.includes("does not exist"))throw Error("Database schema error: OAuth fields missing. Please run the migration: migrations/add-oauth-fields.sql");throw t}}async function d(e,{provider:t,providerId:r,providerEmail:s,avatarUrl:a}){return(await i(`UPDATE users
     SET auth_provider = $2,
         provider_id = $3,
         provider_email = $4,
         avatar_url = COALESCE($5, avatar_url),
         updated_at = NOW()
     WHERE id = $1
     RETURNING id, email, name, created_at, images_processed, tools_used, has_discount, plan, auth_provider, avatar_url`,[e,t,r,s,a]))[0]}async function p(e,t,r){return(await i(`INSERT INTO user_sessions (user_id, session_token, expires_at)
     VALUES ($1, $2, $3)
     RETURNING *`,[e,t,r]))[0]}async function E(e){return(await i(`SELECT s.*, u.email, u.name, u.images_processed, u.tools_used, u.has_discount, u.plan
     FROM user_sessions s
     JOIN users u ON s.user_id = u.id
     WHERE s.session_token = $1
     AND s.expires_at > NOW()
     LIMIT 1`,[e]))[0]}async function m(e){await i("DELETE FROM user_sessions WHERE session_token = $1",[e])}async function _(e,t){return(await i(`UPDATE users
     SET stripe_customer_id = $2,
         updated_at = NOW()
     WHERE id = $1
     RETURNING *`,[e,t]))[0]}async function I(e,t,r,s){return(await i(`UPDATE users
     SET stripe_subscription_id = $2,
         stripe_subscription_status = $3,
         subscription_expires_at = $4,
         plan = CASE WHEN $3 = 'active' THEN 'pro' ELSE 'free' END,
         updated_at = NOW()
     WHERE id = $1
     RETURNING *`,[e,t,r,s]))[0]}async function h(e){return(await i("SELECT * FROM users WHERE stripe_customer_id = $1 LIMIT 1",[e]))[0]}w.on("error",e=>{console.error("Unexpected database pool error",e)}),e.s(["createOAuthUser",()=>u,"createSession",()=>p,"createUser",()=>c,"deleteSession",()=>m,"getSession",()=>E,"getUser",()=>n,"getUserByProvider",()=>l,"getUserByStripeCustomerId",()=>h,"updateUserProvider",()=>d,"updateUserStripeCustomer",()=>_,"updateUserSubscription",()=>I]),r()}catch(e){r(e)}},!1),254799,(e,t,r)=>{t.exports=e.x("crypto",()=>require("crypto"))},829229,e=>e.a(async(t,r)=>{try{let t=await e.y("bcryptjs");e.n(t),r()}catch(e){r(e)}},!0),250305,e=>{"use strict";var t=e.i(515954);function r(e){if(!e||"string"!=typeof e)throw new t.ValidationError("Email is required");if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e))throw new t.ValidationError("Invalid email format");return e.toLowerCase().trim()}function s(e,r=6){if(!e||"string"!=typeof e)throw new t.ValidationError("Password is required");if(e.length<r)throw new t.ValidationError(`Password must be at least ${r} characters`);return e}function a(e,r="Name"){if(!e||"string"!=typeof e)throw new t.ValidationError(`${r} is required`);let s=e.trim();if(s.length<2)throw new t.ValidationError(`${r} must be at least 2 characters`);if(s.length>100)throw new t.ValidationError(`${r} must be less than 100 characters`);return s}e.s(["validateEmail",()=>r,"validateName",()=>a,"validatePassword",()=>s])},43712,e=>e.a(async(t,r)=>{try{var s=e.i(829229),a=e.i(254799),o=e.i(132692),i=e.i(515954),n=e.i(250305),c=e.i(196115),l=t([s,o]);async function u({name:e,email:t,password:r}){let a=(0,n.validateName)(e),l=(0,n.validateEmail)(t),u=(0,n.validatePassword)(r,6);if(await (0,o.getUser)(l))throw new i.ConflictError("Email already registered");let d=await s.default.hash(u,c.config.security.bcryptRounds),E=await (0,o.createUser)(l,a,d),{sessionToken:m,expiresAt:I}=await p(E.id);return{user:_(E),sessionToken:m,expiresAt:I}}async function d({email:e,password:t}){let r=(0,n.validateEmail)(e);if(!t)throw new i.ValidationError("Password is required");let a=await (0,o.getUser)(r);if(!a||!await s.default.compare(t,a.password_hash))throw new i.AuthenticationError("Invalid email or password");let{sessionToken:c,expiresAt:l}=await p(a.id);return{user:_(a),sessionToken:c,expiresAt:l}}async function p(e){let t=a.default.randomBytes(32).toString("hex"),r=new Date(Date.now()+c.config.session.maxAge);return await (0,o.createSession)(e,t,r),{sessionToken:t,expiresAt:r}}async function E(e){e&&await (0,o.deleteSession)(e)}async function m({provider:e,providerId:t,email:r,name:s,avatarUrl:a}){let i,c=(0,n.validateEmail)(r);try{i=(0,n.validateName)(s||r.split("@")[0])}catch(t){let e=r.split("@")[0];i=e.length>=2?e:`user_${Date.now()}`,console.warn("Name validation failed for OAuth user, using fallback:",i)}let l=await (0,o.getUserByProvider)(e,t);if(l){let{sessionToken:e,expiresAt:t}=await p(l.id);return{user:_(l),sessionToken:e,expiresAt:t}}let u=await (0,o.getUser)(c);if(u){let r=await (0,o.updateUserProvider)(u.id,{provider:e,providerId:t,providerEmail:c,avatarUrl:a}),{sessionToken:s,expiresAt:i}=await p(r.id);return{user:_(r),sessionToken:s,expiresAt:i}}let d=await (0,o.createOAuthUser)({email:c,name:i,provider:e,providerId:t,providerEmail:c,avatarUrl:a}),{sessionToken:E,expiresAt:m}=await p(d.id);return{user:_(d),sessionToken:E,expiresAt:m}}function _(e){let{password_hash:t,...r}=e;return r}[s,o]=l.then?(await l)():l,e.s(["authenticateUser",()=>d,"createUserSession",()=>p,"logoutUser",()=>E,"registerOrLoginOAuthUser",()=>m,"registerUser",()=>u]),r()}catch(e){r(e)}},!1)];

//# sourceMappingURL=%5Broot-of-the-server%5D__b39935df._.js.map