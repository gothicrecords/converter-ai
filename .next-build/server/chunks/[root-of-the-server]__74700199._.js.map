{"version":3,"sources":["../../../errors/index.js"],"sourcesContent":["/**\r\n * Centralized error handling\r\n * Provides consistent error responses and error classes\r\n */\r\n\r\nexport class AppError extends Error {\r\n  constructor(message, statusCode = 500, code = null, details = null, originalError = null) {\r\n    super(message);\r\n    this.name = this.constructor.name;\r\n    this.statusCode = statusCode;\r\n    this.code = code;\r\n    this.details = details;\r\n    this.originalError = originalError;\r\n    this.timestamp = new Date().toISOString();\r\n    this.requestId = null; // Can be set by middleware\r\n    \r\n    // Capture stack trace\r\n    if (Error.captureStackTrace) {\r\n      Error.captureStackTrace(this, this.constructor);\r\n    } else {\r\n      this.stack = (new Error()).stack;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Convert error to plain object for logging\r\n   */\r\n  toJSON() {\r\n    return {\r\n      name: this.name,\r\n      message: this.message,\r\n      statusCode: this.statusCode,\r\n      code: this.code,\r\n      details: this.details,\r\n      timestamp: this.timestamp,\r\n      requestId: this.requestId,\r\n      stack: this.stack,\r\n    };\r\n  }\r\n}\r\n\r\nexport class ValidationError extends AppError {\r\n  constructor(message, details = null) {\r\n    super(message, 400, 'VALIDATION_ERROR', details);\r\n  }\r\n}\r\n\r\nexport class AuthenticationError extends AppError {\r\n  constructor(message = 'Authentication required') {\r\n    super(message, 401, 'AUTHENTICATION_ERROR');\r\n  }\r\n}\r\n\r\nexport class AuthorizationError extends AppError {\r\n  constructor(message = 'Insufficient permissions') {\r\n    super(message, 403, 'AUTHORIZATION_ERROR');\r\n  }\r\n}\r\n\r\nexport class NotFoundError extends AppError {\r\n  constructor(resource = 'Resource') {\r\n    super(`${resource} not found`, 404, 'NOT_FOUND');\r\n  }\r\n}\r\n\r\nexport class ConflictError extends AppError {\r\n  constructor(message) {\r\n    super(message, 409, 'CONFLICT');\r\n  }\r\n}\r\n\r\nexport class RateLimitError extends AppError {\r\n  constructor(message = 'Too many requests', retryAfter = null) {\r\n    super(message, 429, 'RATE_LIMIT_EXCEEDED', retryAfter ? { retryAfter } : null);\r\n  }\r\n}\r\n\r\nexport class DatabaseError extends AppError {\r\n  constructor(message, originalError = null) {\r\n    super(message, 500, 'DATABASE_ERROR', null, originalError);\r\n  }\r\n}\r\n\r\nexport class FileSystemError extends AppError {\r\n  constructor(message, originalError = null) {\r\n    super(message, 500, 'FILE_SYSTEM_ERROR', null, originalError);\r\n  }\r\n}\r\n\r\nexport class NetworkError extends AppError {\r\n  constructor(message, originalError = null) {\r\n    super(message, 503, 'NETWORK_ERROR', null, originalError);\r\n  }\r\n}\r\n\r\nexport class TimeoutError extends AppError {\r\n  constructor(message = 'Request timeout', timeoutMs = null) {\r\n    super(message, 408, 'TIMEOUT_ERROR', timeoutMs ? { timeoutMs } : null);\r\n  }\r\n}\r\n\r\nexport class FileTooLargeError extends AppError {\r\n  constructor(maxSize, actualSize = null) {\r\n    const message = `File too large. Maximum size is ${formatFileSize(maxSize)}`;\r\n    super(message, 413, 'FILE_TOO_LARGE', { maxSize, actualSize });\r\n  }\r\n}\r\n\r\nexport class InvalidFileTypeError extends AppError {\r\n  constructor(allowedTypes = null) {\r\n    const message = allowedTypes \r\n      ? `Invalid file type. Allowed types: ${allowedTypes.join(', ')}`\r\n      : 'Invalid file type';\r\n    super(message, 400, 'INVALID_FILE_TYPE', { allowedTypes });\r\n  }\r\n}\r\n\r\nexport class ProcessingError extends AppError {\r\n  constructor(message, originalError = null) {\r\n    super(message, 500, 'PROCESSING_ERROR', null, originalError);\r\n  }\r\n}\r\n\r\n/**\r\n * Format file size for human-readable display\r\n */\r\nfunction formatFileSize(bytes) {\r\n  if (bytes === 0) return '0 Bytes';\r\n  const k = 1024;\r\n  const sizes = ['Bytes', 'KB', 'MB', 'GB'];\r\n  const i = Math.floor(Math.log(bytes) / Math.log(k));\r\n  return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];\r\n}\r\n\r\n/**\r\n * Enhanced error logger with advanced tracking\r\n */\r\nasync function logError(error, context = {}) {\r\n  const errorInfo = {\r\n    timestamp: new Date().toISOString(),\r\n    error: error instanceof AppError ? error.toJSON() : {\r\n      name: error.name,\r\n      message: error.message,\r\n      stack: error.stack,\r\n    },\r\n    context,\r\n    environment: process.env.NODE_ENV,\r\n  };\r\n\r\n  // Log to console with appropriate level\r\n  if (error instanceof AppError && error.statusCode < 500) {\r\n    // Client errors (4xx) - log as warning\r\n    console.warn('Client Error:', JSON.stringify(errorInfo, null, 2));\r\n  } else {\r\n    // Server errors (5xx) - log as error\r\n    console.error('Server Error:', JSON.stringify(errorInfo, null, 2));\r\n  }\r\n\r\n  // Track error with advanced error tracker\r\n  try {\r\n    const { default: errorTracker } = await import('../lib/errorTracker.js');\r\n    const { log } = await import('../lib/logger.js');\r\n    await errorTracker.trackError(error, context);\r\n    log.error('Error logged', error, context);\r\n  } catch (importError) {\r\n    // Error tracker not available, continue with basic logging\r\n    console.warn('Error tracker not available:', importError.message);\r\n  }\r\n\r\n  // In production, you might want to send to error tracking service\r\n  // Example: Sentry, LogRocket, etc.\r\n  if (process.env.NODE_ENV === 'production' && process.env.ERROR_TRACKING_ENABLED === 'true') {\r\n    // TODO: Integrate with error tracking service\r\n    // trackError(errorInfo);\r\n  }\r\n\r\n  return errorInfo;\r\n}\r\n\r\n/**\r\n * Format error response for API\r\n */\r\nexport function formatErrorResponse(error, includeStack = false, includeDetails = true) {\r\n  const isDevelopment = process.env.NODE_ENV === 'development';\r\n  \r\n  const response = {\r\n    error: error.message || 'Internal server error',\r\n    code: error.code || 'INTERNAL_ERROR',\r\n  };\r\n\r\n  // Include details if available and allowed\r\n  if (includeDetails && error.details) {\r\n    response.details = error.details;\r\n  }\r\n\r\n  // Include stack trace only in development\r\n  if (includeStack || isDevelopment) {\r\n    response.stack = error.stack;\r\n  }\r\n\r\n  // Include request ID if available\r\n  if (error.requestId) {\r\n    response.requestId = error.requestId;\r\n  }\r\n\r\n  // Include timestamp\r\n  if (error.timestamp) {\r\n    response.timestamp = error.timestamp;\r\n  }\r\n\r\n  return response;\r\n}\r\n\r\n/**\r\n * Handle errors in API routes with improved error resolution\r\n */\r\nexport async function handleApiError(error, res, context = {}) {\r\n  // Log the error with context\r\n  await logError(error, context);\r\n\r\n  // If response already sent, just log\r\n  if (res.headersSent) {\r\n    return;\r\n  }\r\n\r\n  // Handle known error types\r\n  if (error instanceof AppError) {\r\n    return res.status(error.statusCode).json(\r\n      formatErrorResponse(error, false, true)\r\n    );\r\n  }\r\n\r\n  // Handle specific error types from libraries and Node.js\r\n  if (error.name === 'ValidationError' || error.name === 'CastError') {\r\n    return res.status(400).json(\r\n      formatErrorResponse(new ValidationError(error.message, error.errors), false)\r\n    );\r\n  }\r\n\r\n  // Handle database connection errors\r\n  if (error.code === 'ECONNREFUSED' || error.code === 'ETIMEDOUT') {\r\n    return res.status(503).json(\r\n      formatErrorResponse(\r\n        new NetworkError('Database connection failed', error),\r\n        false\r\n      )\r\n    );\r\n  }\r\n\r\n  // Handle file system errors\r\n  if (error.code === 'ENOENT' || error.code === 'EACCES' || error.code === 'EMFILE') {\r\n    return res.status(500).json(\r\n      formatErrorResponse(\r\n        new FileSystemError('File system operation failed', error),\r\n        false\r\n      )\r\n    );\r\n  }\r\n\r\n  // Handle timeout errors\r\n  if (error.message && (error.message.includes('timeout') || error.message.includes('ETIMEDOUT'))) {\r\n    return res.status(408).json(\r\n      formatErrorResponse(\r\n        new TimeoutError('Request timeout', error.timeout),\r\n        false\r\n      )\r\n    );\r\n  }\r\n\r\n  // Handle file size errors\r\n  if (error.code === 'LIMIT_FILE_SIZE' || error.message?.includes('too large')) {\r\n    return res.status(413).json(\r\n      formatErrorResponse(\r\n        new FileTooLargeError(),\r\n        false\r\n      )\r\n    );\r\n  }\r\n\r\n  // Default to 500 with safe error message\r\n  const isDevelopment = process.env.NODE_ENV === 'development';\r\n  const safeMessage = isDevelopment \r\n    ? error.message || 'Internal server error'\r\n    : 'Internal server error';\r\n  \r\n  res.status(500).json(\r\n    formatErrorResponse(\r\n      new AppError(safeMessage, 500, 'INTERNAL_ERROR', null, error),\r\n      isDevelopment\r\n    )\r\n  );\r\n}\r\n\r\n/**\r\n * Create error handler wrapper for async route handlers\r\n */\r\nexport function asyncHandler(handler) {\r\n  return async (req, res, next) => {\r\n    try {\r\n      await handler(req, res, next);\r\n    } catch (error) {\r\n      handleApiError(error, res, {\r\n        method: req.method,\r\n        url: req.url,\r\n        path: req.path,\r\n        query: req.query,\r\n        user: req.user?.id,\r\n      });\r\n    }\r\n  };\r\n}\r\n\r\n/**\r\n * Retry logic for operations that might fail temporarily\r\n */\r\nexport async function retryOperation(operation, maxRetries = 3, delay = 1000) {\r\n  let lastError;\r\n  \r\n  for (let attempt = 1; attempt <= maxRetries; attempt++) {\r\n    try {\r\n      return await operation();\r\n    } catch (error) {\r\n      lastError = error;\r\n      \r\n      // Don't retry on certain errors\r\n      if (error instanceof ValidationError || \r\n          error instanceof AuthenticationError ||\r\n          error instanceof AuthorizationError) {\r\n        throw error;\r\n      }\r\n      \r\n      // If last attempt, throw error\r\n      if (attempt === maxRetries) {\r\n        break;\r\n      }\r\n      \r\n      // Wait before retrying (exponential backoff)\r\n      const waitTime = delay * Math.pow(2, attempt - 1);\r\n      await new Promise(resolve => setTimeout(resolve, waitTime));\r\n    }\r\n  }\r\n  \r\n  throw lastError;\r\n}\r\n\r\n"],"names":[],"mappings":"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"}