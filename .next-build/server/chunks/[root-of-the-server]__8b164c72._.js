module.exports=[638246,(e,t,r)=>{t.exports=e.x("bottleneck",()=>require("bottleneck"))},236112,e=>{"use strict";let t=new(e.i(638246)).default({reservoir:50,reservoirRefreshAmount:50,reservoirRefreshInterval:6e4,maxConcurrent:3,minTime:200}),r=new class{constructor(){this.queue=[],this.processing=!1,this.maxRetries=3,this.baseDelay=1e3}async add(e,t={}){let{priority:r=5,maxRetries:a=this.maxRetries,retryDelay:i=this.baseDelay,id:o=`req_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}=t;return new Promise((t,n)=>{let s={id:o,operation:e,priority:r,maxRetries:a,retryDelay:i,attempts:0,resolve:t,reject:n,timestamp:Date.now()};this.queue.push(s),this.queue.sort((e,t)=>t.priority-e.priority),this.processing||this.processQueue()})}async processQueue(){if(!this.processing&&0!==this.queue.length){for(this.processing=!0;this.queue.length>0;){let e=this.queue.shift();try{let r=await t.schedule(async()=>await this.executeWithRetry(e));e.resolve(r)}catch(t){e.reject(t)}}this.processing=!1}}async executeWithRetry(e){let t;for(let r=1;r<=e.maxRetries;r++)try{return e.attempts=r,await e.operation()}catch(a){if(t=a,this.isRateLimitError(a)){let t=this.extractRetryAfter(a)||e.retryDelay*Math.pow(2,r-1)*2;if(r<e.maxRetries){await this.delay(t);continue}}else{if(!this.isRetryableError(a))throw a;if(r<e.maxRetries){let t=e.retryDelay*Math.pow(2,r-1);await this.delay(t);continue}}if(r===e.maxRetries)break}throw console.error(`[OpenAI Queue] Richiesta ${e.id} fallita dopo ${e.attempts} tentativi:`,t.message),t}isRateLimitError(e){if(!e)return!1;let t=e.message||"";return 429===(e.status||e.statusCode||0)||t.includes("rate limit")||t.includes("rate_limit")||t.includes("Limite")||t.includes("too many requests")||t.includes("quota")||t.includes("Quota")}extractRetryAfter(e){return e.headers&&e.headers["retry-after"]?1e3*parseInt(e.headers["retry-after"]):e.retryAfter?1e3*e.retryAfter:null}isRetryableError(e){if(!e)return!1;let t=e.status||e.statusCode||0,r=e.message||"";return!([400,401,403].includes(t)||r.includes("invalid")||r.includes("Invalid"))&&([408,429,500,502,503,504].includes(t)||r.includes("timeout")||r.includes("network")||r.includes("ECONNRESET")||r.includes("ETIMEDOUT"))}delay(e){return new Promise(t=>setTimeout(t,e))}getStats(){return{queueLength:this.queue.length,processing:this.processing,limiterStats:{running:t.running(),done:t.done(),queued:t.queued()}}}clear(){this.queue=[],this.processing=!1}};e.s(["default",0,r])},987739,e=>e.a(async(t,r)=>{try{var a=e.i(293635),i=e.i(522734),o=e.i(814747),n=e.i(446786),s=e.i(829211),l=e.i(294543),u=e.i(74538),d=e.i(236493),c=e.i(871815),m=e.i(277390),p=e.i(236112),f=e.i(314613),h=e.i(975111),g=t([a,u,m]);[a,u,m]=g.then?(await g)():g;let x=new u.default({apiKey:process.env.OPENAI_API_KEY});async function y(t,r,a){let n=o.default.extname(a).toLowerCase();if("application/pdf"===r||".pdf"===n){let r="";try{let e=i.default.readFileSync(t),a=await (0,m.default)(e);r=a&&a.text?a.text.trim():"",a?.numpages}catch(e){console.error("[PDF Extract] Stack:",e.stack),r=""}if(!r||r.trim().length<10)try{let r=i.default.readFileSync(t),n=[],s=null;try{s=await (0,c.default)(r,{density:300,pages:1}).png().toBuffer()}catch(t){try{s=await (0,c.default)(r,{density:300,page:0}).png().toBuffer()}catch(t){try{s=await (0,c.default)(r,{density:300}).png().toBuffer()}catch(t){console.error("[PDF Extract] Tutti i tentativi Sharp falliti"),console.error("[PDF Extract] Errore finale:",t.message);try{let{extractTextFromPdfWithOpenAI:t}=await e.A(425775),n=(await e.A(707480)).tmpdir(),s=o.default.join(n,`temp_${Date.now()}_${a}`);try{i.default.writeFileSync(s,r);let e=await p.default.add(async()=>await t(s),{priority:7,maxRetries:3,id:`extract_${Date.now()}`});if(e&&e.trim().length>0)return e.trim();throw Error("OpenAI non ha estratto testo dal PDF")}finally{try{i.default.existsSync(s)&&i.default.unlinkSync(s)}catch(e){console.warn("Errore pulizia file temporaneo:",e)}}}catch(t){console.error("[OpenAI] Estrazione testo fallita:",t.message);let e=t.message&&(t.message.includes("rate")||t.message.includes("Limite")||t.message.includes("429"));try{let{data:{text:e}}=await d.default.recognize(r,"ita+eng",{logger:e=>{e.status}});if(e&&e.trim().length>0)return e.trim();throw Error("OCR diretto non ha estratto testo")}catch(a){console.error("[OCR] OCR diretto fallito:",a.message);let t="",r=[];throw e?(t="OpenAI ha raggiunto il limite di richieste. ",r=["Attendi 1-2 minuti e riprova","Prova con un PDF che contiene testo nativo (non solo immagini scansionate)","Converti il PDF in DOCX o TXT usando un altro tool prima di tradurlo","Prova a estrarre il testo manualmente e incollalo come file TXT"]):(t="Impossibile estrarre testo dal PDF. ",r=["Il PDF potrebbe essere protetto o corrotto","Il PDF potrebbe contenere solo immagini senza testo estraibile","Prova a convertire il PDF in DOCX o TXT usando un altro tool","Prova con un PDF diverso che contiene testo nativo"]),t+="\n\nCosa puoi fare:\n",r.forEach((e,r)=>{t+=`${r+1}. ${e}
`}),t+="\nMetodi tentati: pdf-parse, conversione Sharp, estrazione OpenAI, OCR diretto.",Error(t)}}}}}if(s)try{let e=await (0,c.default)(s).greyscale().normalize().sharpen().toBuffer(),{data:{text:t}}=await d.default.recognize(e,"ita+eng",{logger:e=>{e.status}});if(t&&t.trim().length>0)n.push(t.trim());else throw Error("OCR non ha estratto testo dall'immagine")}catch(e){throw console.error("[OCR] Errore processando immagine:",e.message),Error(`Errore durante l'OCR: ${e.message}`)}else throw Error("Impossibile ottenere immagine dal PDF");if(n.length>0)return n.join("\n\n");throw Error("Nessun testo estratto dalle immagini del PDF")}catch(e){throw console.error("[OCR] Errore OCR:",e.message),Error(`Errore durante l'estrazione del testo: ${e.message}`)}return r}if("application/vnd.openxmlformats-officedocument.wordprocessingml.document"===r||".docx"===n)return(await s.default.extractRawText({path:t})).value;if("application/msword"===r||".doc"===n)throw Error("I file .doc non sono supportati. Converti in .docx o .pdf");if("text/plain"===r||".txt"===n)return i.default.readFileSync(t,"utf-8");if("text/markdown"===r||".md"===n)return i.default.readFileSync(t,"utf-8");else throw Error("Formato file non supportato")}async function w(e,t,r){try{let a={it:"Italiano",en:"Inglese",es:"Spagnolo",fr:"Francese",de:"Tedesco",pt:"Portoghese",ru:"Russo",ja:"Giapponese",zh:"Cinese",ar:"Arabo"}[t]||t,i=r?`Traduci il seguente testo in ${a} mantenendo ESATTAMENTE la stessa formattazione, struttura, interruzioni di riga e spaziatura. Non aggiungere commenti o spiegazioni, restituisci solo il testo tradotto:

${e}`:`Traduci il seguente testo in ${a}. Restituisci solo la traduzione senza commenti:

${e}`;return await p.default.add(async()=>(await x.chat.completions.create({model:"gpt-4o-mini",messages:[{role:"system",content:"Sei un traduttore professionale. Traduci il testo mantenendo il tono e lo stile originale."},{role:"user",content:i}],temperature:.3})).choices[0].message.content,{priority:8,maxRetries:3,id:`translate_${Date.now()}_${t}`})}catch(e){if(console.error("Errore traduzione con OpenAI:",e),e.message&&(e.message.includes("rate")||e.message.includes("Limite")||e.message.includes("429")))throw Error("OpenAI ha raggiunto il limite di richieste. La richiesta è stata messa in coda e verrà riprovata automaticamente. Riprova tra qualche minuto.");throw Error(`Errore durante la traduzione del testo: ${e.message||"Errore sconosciuto"}`)}}async function E(e,t,r,a,n){let s=o.default.extname(a).toLowerCase();if(".pdf"===s){let e=new l.default,a=o.default.join(o.default.dirname(r),`translated_${Date.now()}.pdf`),n=i.default.createWriteStream(a);return e.pipe(n),e.fontSize(12),t.split("\n\n").forEach((t,r)=>{r>0&&e.moveDown(),e.text(t,{align:"left",continued:!1})}),e.end(),await new Promise((e,t)=>{n.on("finish",e),n.on("error",t)}),i.default.readFileSync(a)}if(".docx"===s){let e=o.default.join(o.default.dirname(r),`translated_${Date.now()}.txt`);return i.default.writeFileSync(e,t,"utf-8"),i.default.readFileSync(e)}{let e=o.default.join(o.default.dirname(r),`translated_${Date.now()}${s}`);return i.default.writeFileSync(e,t,"utf-8"),i.default.readFileSync(e)}}async function v(e,t){if("OPTIONS"===e.method){t.setHeader("Access-Control-Allow-Origin","*"),t.setHeader("Access-Control-Allow-Methods","POST, OPTIONS"),t.setHeader("Access-Control-Allow-Headers","Content-Type"),t.status(200).end();return}if("POST"!==e.method)return t.status(405).json({error:"Method not allowed"});process.env.VERCEL||n.default.tmpdir();let r=process.env.VERCEL?"/tmp":o.default.join(process.cwd(),"uploads");process.env.VERCEL||i.default.existsSync(r)||i.default.mkdirSync(r,{recursive:!0});let s=(0,a.default)({uploadDir:r,keepExtensions:!0,maxFileSize:0x3200000});try{let[a,n]=await new Promise((t,r)=>{s.parse(e,(e,a,i)=>{e?r(e):t([a,i])})}),l=Array.isArray(n.document)?n.document[0]:n.document,u=Array.isArray(a.targetLanguage)?a.targetLanguage[0]:a.targetLanguage||"en",d=Array.isArray(a.preserveFormatting)?"true"===a.preserveFormatting[0]:"true"===a.preserveFormatting;if(!l)return t.status(400).json({error:"Nessun documento caricato"});let c=(0,h.getUserId)(e),m=(0,h.getUserPlan)(e),p="traduzione-documenti-ai",g=(0,h.getUsageStats)(c,p),v={size:l.size,length:0},x=(0,f.canUseTool)(p,m,g,v);if(!x.allowed)return t.status(403).json({error:x.reason,limitType:x.limitType,current:x.current,max:x.max,upgradeMessage:(0,f.getUpgradeMessage)(p,m),requiresPro:!0});let R=await y(l.filepath,l.mimetype,l.originalFilename);if(!R||0===R.trim().length)return t.status(400).json({error:"Impossibile estrarre testo dal documento"});v.length=R.length;let S=(0,f.canUseTool)(p,m,g,v);if(!S.allowed)return t.status(403).json({error:S.reason,limitType:S.limitType,current:S.current,max:S.max,upgradeMessage:(0,f.getUpgradeMessage)(p,m),requiresPro:!0});let P=await w(R,u,d),A=await E(R,P,l.filepath,l.originalFilename,u),D=o.default.extname(l.originalFilename).toLowerCase(),T="application/octet-stream",F=`translated_${u}_${l.originalFilename}`;".pdf"===D?T="application/pdf":".docx"===D?T="application/vnd.openxmlformats-officedocument.wordprocessingml.document":".txt"===D?T="text/plain":".md"===D&&(T="text/markdown");try{i.default.unlinkSync(l.filepath),(process.env.VERCEL?[]:i.default.existsSync(r)?i.default.readdirSync(r).filter(e=>e.startsWith("translated_")):[]).forEach(e=>{try{i.default.unlinkSync(o.default.join(r,e))}catch(e){}})}catch(e){console.error("Errore cleanup:",e)}(0,h.incrementUsage)(c,p),t.setHeader("Content-Type",T),t.setHeader("Content-Disposition",`attachment; filename=${F}`),t.status(200).send(A)}catch(r){console.error("Errore API Traduzione Documenti:",r),console.error("Stack trace:",r.stack),console.error("Error details:",{message:r.message,name:r.name,code:r.code});let e="Errore durante la traduzione del documento. Riprova con un file diverso.";r.message?e=r.message:"ENOENT"===r.code?e="File non trovato. Assicurati di aver caricato un file valido.":"LIMIT_FILE_SIZE"===r.code&&(e="File troppo grande. Dimensione massima: 50MB."),t.status(500).json({error:e,details:void 0})}}e.s(["config",0,{api:{bodyParser:!1}},"default",()=>v]),r()}catch(e){r(e)}},!1),316881,e=>e.a(async(t,r)=>{try{var a=e.i(926747),i=e.i(190406),o=e.i(244898),n=e.i(262950),s=e.i(987739),l=e.i(7031),u=e.i(181927),d=e.i(846432),c=t([s]);[s]=c.then?(await c)():c;let p=(0,n.hoist)(s,"default"),f=(0,n.hoist)(s,"config"),h=new o.PagesAPIRouteModule({definition:{kind:i.RouteKind.PAGES_API,page:"/api/tools/translate-document",pathname:"/api/tools/translate-document",bundlePath:"",filename:""},userland:s,distDir:".next-build",relativeProjectDir:""});async function m(e,t,r){h.isDev&&(0,d.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let i="/api/tools/translate-document";i=i.replace(/\/index$/,"")||"/";let o=await h.prepare(e,t,{srcPage:i});if(!o){t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve());return}let{query:n,params:s,prerenderManifest:c,routerServerContext:m}=o;try{let r=e.method||"GET",a=(0,l.getTracer)(),o=a.getActiveScopeSpan(),d=h.instrumentationOnRequestError.bind(h),p=async o=>h.render(e,t,{query:{...n,...s},params:s,allowedRevalidateHeaderKeys:[],multiZoneDraftMode:!1,trustHostHeader:!1,previewProps:c.preview,propagateError:!1,dev:h.isDev,page:"/api/tools/translate-document",internalRevalidate:null==m?void 0:m.revalidate,onError:(...t)=>d(e,...t)}).finally(()=>{if(!o)return;o.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let e=a.getRootSpanAttributes();if(!e)return;if(e.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${e.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=e.get("next.route");if(n){let e=`${r} ${n}`;o.setAttributes({"next.route":n,"http.route":n,"next.span_name":e}),o.updateName(e)}else o.updateName(`${r} ${i}`)});o?await p(o):await a.withPropagatedContext(e.headers,()=>a.trace(u.BaseServerSpan.handleRequest,{spanName:`${r} ${i}`,kind:l.SpanKind.SERVER,attributes:{"http.method":r,"http.target":e.url}},p))}catch(e){if(h.isDev)throw e;(0,a.sendError)(t,500,"Internal Server Error")}finally{null==r.waitUntil||r.waitUntil.call(r,Promise.resolve())}}e.s(["config",0,f,"default",0,p,"handler",()=>m]),r()}catch(e){r(e)}},!1)];

//# sourceMappingURL=%5Broot-of-the-server%5D__8b164c72._.js.map