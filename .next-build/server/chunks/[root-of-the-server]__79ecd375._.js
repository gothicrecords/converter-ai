module.exports=[70406,(e,t,a)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},71815,(e,t,a)=>{t.exports=e.x("sharp",()=>require("sharp"))},44509,e=>{"use strict";var t=e.i(71815);let a=class{constructor(){this.maxDimension=7680}async denoise(e){return e.blur(.3).sharpen({sigma:.5,m1:.4,m2:.2})}async multiPassUpscale(e,a,r,i=3){let n=await e.metadata(),s=n.width,l=n.height,o=e,u=Math.pow(Math.max(a/s,r/l),1/i);for(let e=0;e<i;e++){let n=Math.min(Math.round(s*u),a),d=Math.min(Math.round(l*u),r),h=t.default.kernel.lanczos3;h=0===e||e===i-1?t.default.kernel.lanczos3:t.default.kernel.lanczos2,o=o.resize(n,d,{kernel:h,fit:"fill",withoutEnlargement:!1});let c=.3+e/i*.4;if(o=o.sharpen({sigma:.4+c,m1:.3+e/i*.2,m2:.15+e/i*.15}),e<i-1){let e=await o.toBuffer();o=(0,t.default)(e,{sequentialRead:!0})}s=n,l=d}return o}async applyFinalEnhancement(e,t="high"){let a=e;return(a=(a=a.linear(1.02,-2.56)).sharpen({sigma:1.2,m1:.7,m2:.4})).png({quality:100,compressionLevel:6,adaptiveFiltering:!0})}async upscale(e,a=4,r=7680){try{let i=(0,t.default)(e,{sequentialRead:!0}).rotate(),n=await i.metadata(),s=n.width||0,l=n.height||0;if(0===s||0===l)throw Error("Dimensioni immagine non valide");let o=Math.round(s*a),u=Math.round(l*a);if(o>r||u>r){let e=r/Math.max(o,u);o=Math.round(o*e),u=Math.round(u*e)}let d=i;s*l/1e6<2&&(d=await this.denoise(d));let h=Math.max(o/s,u/l),c=2;return h>3?c=4:h>2&&(c=3),d=await this.multiPassUpscale(d,o,u,c),d=await this.applyFinalEnhancement(d,"high"),await d.jpeg({quality:98,chromaSubsampling:"4:4:4",mozjpeg:!0,trellisQuantisation:!0,overshootDeringing:!0,optimiseScans:!0}).toBuffer()}catch(e){throw console.error("Errore upscaling avanzato:",e),Error(`Upscaling fallito: ${e.message}`)}}async upscaleTo4K(e){let a=(0,t.default)(e,{sequentialRead:!0}).rotate(),r=await a.metadata(),i=Math.max(r.width||0,r.height||0);return this.upscale(e,3840/i,3840)}async upscaleTo8K(e){let a=(0,t.default)(e,{sequentialRead:!0}).rotate(),r=await a.metadata(),i=Math.max(r.width||0,r.height||0);return this.upscale(e,7680/i,7680)}};e.s(["default",0,a])},29614,e=>{"use strict";var t=e.i(26747),a=e.i(90406),r=e.i(44898),i=e.i(62950),n=e.i(71815);let s=class{constructor(){this.seed=null}hashString(e){let t=0;for(let a=0;a<e.length;a++)t=(t<<5)-t+e.charCodeAt(a),t&=t;return Math.abs(t)}random(e){let t=1e4*Math.sin(e);return t-Math.floor(t)}extractKeywords(e){let t=e.toLowerCase(),a={colors:[],style:"abstract",theme:"nature",mood:"calm"};for(let[e,r]of Object.entries({rosso:[255,0,0],red:[255,0,0],blu:[0,0,255],blue:[0,0,255],verde:[0,255,0],green:[0,255,0],giallo:[255,255,0],yellow:[255,255,0],viola:[128,0,128],purple:[128,0,128],arancione:[255,165,0],orange:[255,165,0],rosa:[255,192,203],pink:[255,192,203],nero:[0,0,0],black:[0,0,0],bianco:[255,255,255],white:[255,255,255],grigio:[128,128,128],gray:[128,128,128],grey:[128,128,128]}))t.includes(e)&&a.colors.push(r);return t.includes("realistic")||t.includes("realistico")||t.includes("foto")?a.style="realistic":t.includes("abstract")||t.includes("astratto")?a.style="abstract":t.includes("artistic")||t.includes("artistico")?a.style="artistic":(t.includes("minimal")||t.includes("minimalista"))&&(a.style="minimal"),t.includes("natura")||t.includes("nature")||t.includes("paesaggio")||t.includes("landscape")?a.theme="nature":t.includes("città")||t.includes("city")||t.includes("urban")?a.theme="urban":t.includes("spazio")||t.includes("space")||t.includes("cosmo")?a.theme="space":(t.includes("oceano")||t.includes("ocean")||t.includes("mare")||t.includes("sea"))&&(a.theme="ocean"),t.includes("calm")||t.includes("calmo")||t.includes("sereno")?a.mood="calm":t.includes("energetic")||t.includes("energico")||t.includes("vibrante")?a.mood="energetic":(t.includes("dark")||t.includes("scuro")||t.includes("oscuro"))&&(a.mood="dark"),a}noise2D(e,t,a){let r=Math.floor(e)+57*Math.floor(t);return(0x7fffffff&(a+(r<<13^r))*9301+49297)/0x80000000*2-1}smoothstep(e,t,a){let r=Math.max(0,Math.min(1,(a-e)/(t-e)));return r*r*(3-2*r)}async createComplexGradient(e,t,a,r){let i=Buffer.alloc(e*t*3);for(let n=0;n<t;n++)for(let s=0;s<e;s++){let l=(n*e+s)*3,o=s/e,u=n/t,d=o-.5,h=u-.5,c=Math.sqrt(d*d+h*h),m=Math.atan2(h,d),p=[128,128,128];if(a.length>0){let e=[];for(let t=0;t<a.length;t++){let a=Math.abs(Math.sin(m*(t+1)+5*c));e.push(a)}let t=e.reduce((e,t)=>e+t,0)||1;p=[e.reduce((e,t,r)=>e+a[r][0]*t,0)/t,e.reduce((e,t,r)=>e+a[r][1]*t,0)/t,e.reduce((e,t,r)=>e+a[r][2]*t,0)/t]}else{let e=(m/Math.PI+1)*.5,t=.5+.5*c,a=.3+(1-1.5*c)*.4;p=this.hslToRgb(360*e,100*t,100*a)}let g=p[0],f=p[1],M=p[2];for(let e=0;e<3;e++){let t=r+1e4*e,a=Math.pow(2,e),i=1/(e+1),n=o*a*10,s=u*a*10,l=(this.noise2D(n,s,t)+Math.sin(c*a*Math.PI*4)*i+Math.sin(m*a*3)*i*.5)*30;g+=l,f+=.9*l,M+=.8*l}i[l]=Math.max(0,Math.min(255,g)),i[l+1]=Math.max(0,Math.min(255,f)),i[l+2]=Math.max(0,Math.min(255,M))}return(0,n.default)(i,{raw:{width:e,height:t,channels:3}})}async addPatterns(e,t,a){let{width:r,height:i}=await e.metadata(),s=Buffer.alloc(r*i*4);for(let e=0;e<i;e++)for(let i=0;i<r;i++){let n=(e*r+i)*4,l=0;l=("nature"===t.theme?Math.sin(i/50*Math.PI)*Math.cos(e/50*Math.PI)*.1:"space"===t.theme?.2*(Math.sin(i/20)*Math.sin(e/20)>.8):"ocean"===t.theme?.15*Math.sin(i/30+e/30):(Math.sin(i/40)+Math.cos(e/40))*.1)+(this.random(a+i+e)-.5)*.05,s[n]=255,s[n+1]=255,s[n+2]=255,s[n+3]=Math.floor((l+.5)*50)}let l=(0,n.default)(s,{raw:{width:r,height:i,channels:4}});return e.composite([{input:await l.toBuffer(),blend:"overlay"}])}async applyAdvancedEffects(e,t,a){let r=e;return r=r.sharpen({sigma:.8+.7*a,m1:.6+.3*a,m2:.3+.2*a}),r="energetic"===t.mood?r.modulate({brightness:1.15,saturation:1.4,hue:0}).linear(1.1,-12.8):"calm"===t.mood?r.modulate({brightness:.98,saturation:.85,hue:0}).linear(.98,0):"dark"===t.mood?r.modulate({brightness:.65,saturation:1.2,hue:0}).linear(1.15,-19.2):r.modulate({brightness:1.02,saturation:1.1,hue:0}).linear(1.05,-6.4),"realistic"===t.style?r=r.gamma(1.15).linear(1.08,-10.24):"artistic"===t.style&&(r=r.gamma(.95).modulate({brightness:1.05,saturation:1.25,hue:0})),r=(r=r.blur(.2)).sharpen({sigma:.5+.3*a,m1:.4,m2:.2})}async generate(e,t,a,r=1,i=!0){this.seed=this.hashString(e);let n=this.extractKeywords(e),s=n.colors;if(0===s.length){let e=360*this.random(this.seed);s=[this.hslToRgb(e,70,50),this.hslToRgb((e+60)%360,70,60),this.hslToRgb((e+120)%360,70,40)]}let l=await this.createComplexGradient(t,a,s,this.seed);return l=await this.addPatterns(l,n,this.seed),l=await this.applyAdvancedEffects(l,n,r),await l.jpeg({quality:95,chromaSubsampling:"4:4:4",mozjpeg:!0}).toBuffer()}hslToRgb(e,t,a){let r,i,n;if(e/=360,t/=100,a/=100,0===t)r=i=n=a;else{let s=(e,t,a)=>(a<0&&(a+=1),a>1&&(a-=1),a<1/6)?e+(t-e)*6*a:a<.5?t:a<2/3?e+(t-e)*(2/3-a)*6:e,l=a<.5?a*(1+t):a+t-a*t,o=2*a-l;r=s(o,l,e+1/3),i=s(o,l,e),n=s(o,l,e-1/3)}return[Math.round(255*r),Math.round(255*i),Math.round(255*n)]}};var l=e.i(44509);async function o(e,t){if("POST"!==e.method)return t.status(405).json({error:"Method not allowed"});try{let{prompt:a,aspect:r="1:1",detail:i=1,realism:n=!0}=e.body||{};if(!a||"string"!=typeof a)return t.status(400).json({error:"Il prompt è richiesto e deve essere una stringa."});let o={"1:1":[1,1],"16:9":[16,9],"9:16":[9,16],"4:3":[4,3],"3:4":[3,4]},u=o[r]||o["1:1"],d=u[0],h=u[1],c=Math.round(d>=h?2048:2048*d/h),m=Math.round(h>d?2048:2048*h/d),p=new s,g=await p.generate(a,c,m,i,n),f=new l.default,M=await f.upscaleTo4K(g);t.setHeader("Content-Type","image/jpeg"),t.setHeader("Content-Length",M.byteLength),t.setHeader("Cache-Control","no-cache, no-store, must-revalidate"),t.setHeader("Pragma","no-cache"),t.setHeader("Expires","0"),t.status(200).send(M)}catch(e){console.error("Errore API Generate Image:",e),t.status(500).json({error:e.message||"Errore interno del server durante la generazione dell'immagine."})}}e.s(["default",()=>o],74239);var u=e.i(74239),d=e.i(7031),h=e.i(81927),c=e.i(46432);let m=(0,i.hoist)(u,"default"),p=(0,i.hoist)(u,"config"),g=new r.PagesAPIRouteModule({definition:{kind:a.RouteKind.PAGES_API,page:"/api/tools/generate-image",pathname:"/api/tools/generate-image",bundlePath:"",filename:""},userland:u,distDir:".next-build",relativeProjectDir:""});async function f(e,a,r){g.isDev&&(0,c.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let i="/api/tools/generate-image";i=i.replace(/\/index$/,"")||"/";let n=await g.prepare(e,a,{srcPage:i});if(!n){a.statusCode=400,a.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve());return}let{query:s,params:l,prerenderManifest:o,routerServerContext:u}=n;try{let t=e.method||"GET",r=(0,d.getTracer)(),n=r.getActiveScopeSpan(),c=g.instrumentationOnRequestError.bind(g),m=async n=>g.render(e,a,{query:{...s,...l},params:l,allowedRevalidateHeaderKeys:[],multiZoneDraftMode:!1,trustHostHeader:!1,previewProps:o.preview,propagateError:!1,dev:g.isDev,page:"/api/tools/generate-image",internalRevalidate:null==u?void 0:u.revalidate,onError:(...t)=>c(e,...t)}).finally(()=>{if(!n)return;n.setAttributes({"http.status_code":a.statusCode,"next.rsc":!1});let e=r.getRootSpanAttributes();if(!e)return;if(e.get("next.span_type")!==h.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${e.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let s=e.get("next.route");if(s){let e=`${t} ${s}`;n.setAttributes({"next.route":s,"http.route":s,"next.span_name":e}),n.updateName(e)}else n.updateName(`${t} ${i}`)});n?await m(n):await r.withPropagatedContext(e.headers,()=>r.trace(h.BaseServerSpan.handleRequest,{spanName:`${t} ${i}`,kind:d.SpanKind.SERVER,attributes:{"http.method":t,"http.target":e.url}},m))}catch(e){if(g.isDev)throw e;(0,t.sendError)(a,500,"Internal Server Error")}finally{null==r.waitUntil||r.waitUntil.call(r,Promise.resolve())}}e.s(["config",0,p,"default",0,m,"handler",()=>f],29614)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__79ecd375._.js.map