module.exports=[270406,(e,t,i)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},829211,(e,t,i)=>{t.exports=e.x("mammoth",()=>require("mammoth"))},74538,e=>e.a(async(t,i)=>{try{let t=await e.y("openai");e.n(t),i()}catch(e){i(e)}},!0),267370,e=>e.a(async(t,i)=>{try{var n=e.i(74538),r=t([n]);[n]=r.then?(await r)():r;let E=new n.default({apiKey:process.env.OPENAI_API_KEY});async function o(e){if(!process.env.OPENAI_API_KEY)throw Error("OPENAI_API_KEY is not configured. Please set it in your environment variables.");try{return(await E.embeddings.create({model:"text-embedding-3-small",input:e.substring(0,8e3)})).data[0].embedding}catch(e){throw console.error("Error generating embedding:",e),Error(`Failed to generate embedding: ${e.message}`)}}async function a(e){if(!process.env.OPENAI_API_KEY)throw Error("OPENAI_API_KEY is not configured. Please set it in your environment variables.");if(!Array.isArray(e)||0===e.length)return[];try{return(await E.embeddings.create({model:"text-embedding-3-small",input:e.map(e=>(e||"").toString().substring(0,8e3))})).data.map(e=>e.embedding)}catch(e){throw console.error("Error generating batch embeddings:",e),Error(`Failed to generate batch embeddings: ${e.message}`)}}async function s(e,t={}){if(!process.env.OPENAI_API_KEY)throw Error("OPENAI_API_KEY is not configured. Please set it in your environment variables.");try{return(await E.chat.completions.create({model:t.model||"gpt-4o-mini",messages:e,temperature:t.temperature||.7,max_tokens:t.max_tokens||1e3,top_p:t.top_p||1,frequency_penalty:t.frequency_penalty||0,presence_penalty:t.presence_penalty||0})).choices[0].message.content}catch(e){if(console.error("Error in chat completion:",e),401===e.status)throw Error("Chiave API OpenAI non valida. Verifica la configurazione.");if(429===e.status)throw Error("Limite di rate raggiunto. Riprova tra qualche secondo.");if(500===e.status)throw Error("Errore del server OpenAI. Riprova piÃ¹ tardi.");throw Error(`Errore nella comunicazione con OpenAI: ${e.message}`)}}async function l(e,t=200){let i=[{role:"system",content:"You are a helpful assistant that creates concise summaries."},{role:"user",content:`Summarize the following text in ${t} words or less:

${e}`}];return await s(i,{temperature:.5,max_tokens:300})}async function c(e,t=5){let i=[{role:"system",content:"You are a helpful assistant that generates relevant tags for documents. Return only comma-separated tags, no explanations."},{role:"user",content:`Generate ${t} relevant tags for this document:

${e.substring(0,2e3)}`}];return(await s(i,{temperature:.3,max_tokens:100})).split(",").map(e=>e.trim().toLowerCase()).filter(e=>e.length>0).slice(0,t)}async function u(e){let t=["contract","invoice","report","presentation","spreadsheet","image","code","email","article","other"],i=[{role:"system",content:`You are a document classifier. Classify the document into one or more of these categories: ${t.join(", ")}. Return only category names, comma-separated.`},{role:"user",content:`Classify this document:

${e.substring(0,1e3)}`}];return(await s(i,{temperature:.2,max_tokens:50})).split(",").map(e=>e.trim().toLowerCase()).filter(e=>t.includes(e))}async function m(e,t,i="Cosa contiene questa immagine? Descrivi tutto ciÃ² che vedi."){if(!process.env.OPENAI_API_KEY)throw Error("OPENAI_API_KEY is not configured. Please set it in your environment variables.");try{let n=e.toString("base64");return(await E.chat.completions.create({model:"gpt-4o",messages:[{role:"system",content:"Sei un assistente AI esperto nell'analisi di immagini. Descrivi in dettaglio tutto ciÃ² che vedi nell'immagine, inclusi testo, oggetti, persone, scene, colori e qualsiasi altro dettaglio rilevante. Rispondi sempre in italiano."},{role:"user",content:[{type:"text",text:i},{type:"image_url",image_url:{url:`data:${t};base64,${n}`,detail:"high"}}]}],max_tokens:2e3,temperature:.2})).choices[0].message.content}catch(e){if(console.error("Error in vision API:",e),401===e.status)throw Error("Chiave API OpenAI non valida. Verifica la configurazione.");if(429===e.status)throw Error("Limite di rate raggiunto. Riprova tra qualche secondo.");if(400===e.status&&e.message?.includes("image"))throw Error("Formato immagine non supportato o immagine troppo grande.");throw Error(`Errore nell'analisi dell'immagine: ${e.message}`)}}async function d(t){if(!process.env.OPENAI_API_KEY)throw Error("OPENAI_API_KEY is not configured. Please set it in your environment variables.");let i=await e.A(323970),n=null;try{n=await E.files.create({file:i.createReadStream(t),purpose:"user_data"});let e=((await E.responses.create({model:"gpt-4o",input:[{role:"user",content:[{type:"input_text",text:"Estrai tutto il testo e le informazioni rilevanti da questo documento. Rispondi SOLO con il testo estratto, senza commenti."},{type:"input_file",file_id:n.id}]}],max_output_tokens:8e3,temperature:.1})).output_text||"").toString().trim();if(!e)throw Error("Nessun testo estratto dal PDF");return e}catch(e){if(console.error("Error in PDF text extraction (Responses API):",e),401===e.status)throw Error("Chiave API OpenAI non valida. Verifica la configurazione.");if(429===e.status)throw Error("Limite di rate raggiunto. Riprova tra qualche secondo.");if(400===e.status)throw Error("Errore nell'analisi del PDF con Responses API. Il file potrebbe essere troppo grande o danneggiato.");throw Error(`Errore nell'estrazione del testo PDF: ${e.message}`)}finally{try{n&&n.id&&(E.files?.delete?await E.files.delete(n.id):E.files?.del&&await E.files.del(n.id))}catch(e){console.warn("Errore rimozione file da OpenAI (ignorato):",e?.message||e)}}}async function p(e,t={}){if(!process.env.OPENAI_API_KEY)throw Error("OPENAI_API_KEY is not configured. Please set it in your environment variables.");try{let i=t.size||"1024x1024",n=t.quality||"standard",r=t.style||"vivid",o=await E.images.generate({model:"dall-e-3",prompt:e,size:i,quality:n,style:r,n:1}),a=o.data[0]?.url;if(!a)throw Error("Nessuna immagine generata da DALL-E");return a}catch(e){if(console.error("Error getting image URL from DALL-E:",e),console.error("Error details:",{status:e.status,statusText:e.statusText,message:e.message,code:e.code,response:e.response?.data||e.response}),401===e.status)throw Error("Chiave API OpenAI non valida. Verifica la configurazione.");if(429===e.status)throw Error("Limite di rate raggiunto. Riprova tra qualche secondo.");if(400===e.status){let t=e.message||e.response?.data?.error?.message||"Prompt non valido o contenuto non consentito";throw Error(`Errore nella generazione: ${t}`)}else if("ENOTFOUND"===e.code||"ECONNREFUSED"===e.code)throw Error("Errore di connessione con OpenAI. Verifica la tua connessione internet.");throw Error(`Errore nella generazione dell'immagine: ${e.message||"Errore sconosciuto"}`)}}async function g(e,t={}){if(!process.env.OPENAI_API_KEY)throw Error("OPENAI_API_KEY is not configured. Please set it in your environment variables.");try{let i=await p(e,t),n=await fetch(i);if(!n.ok){let e=await n.text().catch(()=>"Unknown error");throw Error(`Errore nel download dell'immagine generata: ${n.status} ${n.statusText}. ${e}`)}let r=await n.arrayBuffer();return Buffer.from(r)}catch(e){throw e}}async function f(e,t,i=null){if(!process.env.OPENAI_API_KEY)throw Error("OPENAI_API_KEY is not configured. Please set it in your environment variables.");try{let n=await m(e,t,i||"Descrivi in dettaglio questa immagine, includendo tutti i dettagli visivi, colori, composizione, stile e qualitÃ . La descrizione sarÃ  usata per creare una versione migliorata ad alta risoluzione."),r=`Crea una versione migliorata e ad alta risoluzione di questa immagine: ${n}. Mantieni fedelt\xe0 ai dettagli originali ma migliora la qualit\xe0, la nitidezza e la risoluzione.`;return await g(r,{size:"1792x1024",quality:"hd",style:"natural"})}catch(e){throw console.error("Error upscaling image with DALL-E:",e),Error(`Errore nel miglioramento dell'immagine: ${e.message}`)}}async function h(t,i){if(!process.env.OPENAI_API_KEY)throw Error("OPENAI_API_KEY is not configured. Please set it in your environment variables.");try{let n=`Analyze this image and identify specific quality issues that need improvement. Focus on:
1. Noise level (low/medium/high)
2. Sharpness (blurry/sharp)
3. Color accuracy (washed out/vibrant)
4. Artifacts (compression artifacts, pixelation)
5. Overall quality issues

Respond with a JSON object: {"noise": "low|medium|high", "sharpness": "blurry|moderate|sharp", "color": "washed|normal|vibrant", "artifacts": "none|minor|major", "recommendations": "brief description"}`,r=await m(t,i,n),o={noise:"medium",sharpness:"moderate",color:"normal",artifacts:"none"};try{let e=r.match(/\{[\s\S]*\}/);if(e){let t=JSON.parse(e[0]);o={...o,...t}}}catch(e){console.warn("Could not parse AI analysis, using defaults")}let a=(0,(await e.A(752039)).default)(t,{sequentialRead:!0});return("high"===o.noise||"medium"===o.noise)&&(a=a.median("high"===o.noise?3:2)),"blurry"===o.sharpness?a=a.sharpen({sigma:2,m1:1,m2:.5,x1:3,y2:3,y3:3}):"moderate"===o.sharpness&&(a=a.sharpen({sigma:1,m1:.7,m2:.4})),"washed"===o.color&&(a=a.modulate({saturation:1.15,brightness:1.05}).linear(1.05,-6.4)),a="major"===o.artifacts||"minor"===o.artifacts?a.png({quality:100,compressionLevel:6,adaptiveFiltering:!0}):"image/jpeg"===i||"image/jpg"===i?a.jpeg({quality:98,mozjpeg:!0,trellisQuantisation:!0,overshootDeringing:!0}):a.png({quality:100,compressionLevel:6}),await a.toBuffer()}catch(e){return console.error("Error enhancing image quality with AI:",e),t}}e.s(["analyzeImageWithVision",()=>m,"chatCompletion",()=>s,"classifyDocument",()=>u,"enhanceImageQualityWithAI",()=>h,"extractTextFromPdfWithOpenAI",()=>d,"generateEmbedding",()=>o,"generateEmbeddingsBatch",()=>a,"generateImageWithDALLE",()=>g,"generateSummary",()=>l,"generateTags",()=>c,"getImageUrlFromDALLE",()=>p,"upscaleImageWithDALLE",()=>f]),i()}catch(e){i(e)}},!1),516969,(e,t,i)=>{t.exports=e.x("xlsx",()=>require("xlsx"))},162069,e=>e.a(async(t,i)=>{try{var n=e.i(829211),r=e.i(516969),o=e.i(267370),a=t([o]);[o]=a.then?(await a)():a;let f=new Map;async function s(t,i,o,a=null){try{let s="",l={filename:o,mimeType:i,pages:0,wordCount:0};if("application/pdf"===i||o.toLowerCase().endsWith(".pdf")){let{extractTextFromPdfWithOpenAI:i}=await e.A(425775),n=await e.A(323970),r=await e.A(589793),a=(await e.A(707480)).tmpdir(),c=r.join(a,`temp_${Date.now()}_${o}`);try{if(n.writeFileSync(c,t),s=((s=await i(c))||"").toString().trim(),l.analysisMethod="openai-file-upload",!s||0===s.length)throw Error("Nessun testo estratto dal PDF tramite OpenAI")}finally{try{n.existsSync(c)&&n.unlinkSync(c)}catch(e){console.warn("Errore pulizia file temporaneo:",e)}}}else if(i.includes("wordprocessingml")||o.toLowerCase().endsWith(".docx"))s=(s=(await n.default.extractRawText({buffer:t})).value).replace(/\s+/g," ").trim();else if(i.includes("spreadsheet")||o.toLowerCase().match(/\.(xlsx|xls|csv)$/i)){let e=r.read(t,{type:"buffer"}),i=e.SheetNames,n=[];for(let t of i){let i=e.Sheets[t];for(let e of r.utils.sheet_to_json(i,{header:1,defval:""}))if(Array.isArray(e)){let i=e.filter(e=>e&&e.toString().trim()).join(" ");i.trim()&&n.push(`[${t}] ${i}`)}}s=n.join("\n")}else if(i.startsWith("text/")||o.toLowerCase().endsWith(".txt"))s=t.toString("utf-8");else if(i.startsWith("image/")||o.toLowerCase().match(/\.(png|jpg|jpeg|gif|webp|bmp|tif|tiff|heic|heif)$/i))try{let{analyzeImageWithVision:n}=await e.A(425775);try{s=await n(t,i,"Analizza questa immagine in dettaglio. Descrivi tutto ciÃ² che vedi, incluso qualsiasi testo presente, oggetti, persone, scene, colori e dettagli rilevanti. Se c'Ã¨ del testo, trascrivilo accuratamente."),l.analysisMethod="openai-vision"}catch(r){let i=(await e.A(735943)).default,n=a||t;try{s=(await i.recognize(n,"ita+eng",{logger:e=>{e.status}})).data.text.trim(),l.analysisMethod="ocr-tesseract"}catch(t){let e=await i.createWorker("ita+eng",1,{logger:e=>{e.status}});try{s=(await e.recognize(n)).data.text.trim(),l.analysisMethod="ocr-tesseract-worker"}finally{await e.terminate()}}}if(!s||0===s.length)throw Error("Nessun contenuto estratto dall'immagine. L'immagine potrebbe essere vuota o non contenere testo leggibile.")}catch(e){throw console.error("Errore analisi immagine completo:",e),Error(`Errore nell'analisi dell'immagine: ${e.message}`)}else throw Error(`Tipo di file non supportato: ${i}`);if(!s||0===s.trim().length)throw Error("Nessun testo estratto dal documento");return l.wordCount=s.split(/\s+/).length,{text:s,metadata:l}}catch(e){throw console.error("Errore estrazione testo:",e),Error(`Errore nell'estrazione del testo: ${e.message}`)}}async function l(t,i=1e3,n=200){let r=t.split(/[.!?]+\s+/).filter(e=>e.trim().length>10),o=[],a="",s=0;for(let e of r){let r=e.length;s+r>i&&a.trim()?(o.push({text:a.trim(),startIndex:t.indexOf(a.trim()),endIndex:t.indexOf(a.trim())+a.length}),s=(a=a.split(/\s+/).slice(-Math.floor(n/10)).join(" ")+" "+e+" ").length):(a+=e+". ",s+=r+2)}a.trim()&&o.push({text:a.trim(),startIndex:t.indexOf(a.trim()),endIndex:t.length});let c=o.length>0?o:[{text:t.trim(),startIndex:0,endIndex:t.length}],{generateEmbeddingsBatch:u}=await e.A(425775);try{for(let e=0;e<c.length;e+=16){let t=c.slice(e,e+16);(await u(t.map(e=>e.text))).forEach((e,i)=>{t[i].embedding=e})}}catch(i){console.warn("Batch embeddings failed, falling back to per-chunk:",i.message);let{generateEmbedding:t}=await e.A(425775);for(let e of c)try{e.embedding=await t(e.text)}catch(t){console.warn("Errore generazione embedding per chunk:",t.message),e.embedding=null}}return c}async function c(t,i,n,r=5){if(!i||0===i.length)return[];let{generateEmbedding:o}=await e.A(425775),a=null;try{a=await o(n)}catch(e){console.warn("Errore generazione embedding query, uso TF-IDF:",e)}return i.map((e,t)=>{let i=0;i=a&&e.embedding?function(e,t){if(!e||!t||e.length!==t.length)return 0;let i=e.reduce((e,i,n)=>e+i*t[n],0),n=Math.sqrt(e.reduce((e,t)=>e+t*t,0)),r=Math.sqrt(t.reduce((e,t)=>e+t*t,0));return i/(n*r)}(a,e.embedding):function(e,t){let i=e.toLowerCase().split(/\W+/).filter(e=>e.length>2),n=t.toLowerCase().split(/\W+/).filter(e=>e.length>2);if(0===n.length)return 0;let r=0,o={};return i.forEach(e=>{o[e]=(o[e]||0)+1}),n.forEach(e=>{let t=o[e]||0;if(t>0){let e=t/i.length,n=Math.log(i.length/(t+1))+1;r+=e*n}}),r/n.length}(e.text,n)/10;let r=e.text.toLowerCase(),o=n.toLowerCase(),s=0;r.includes(o)&&(s=.1);let l=n.toLowerCase().split(/\W+/).filter(e=>e.length>2),c=l.filter(e=>r.includes(e)).length/l.length*.05,u=i+s+c;return{...e,score:u,index:t}}).sort((e,t)=>t.score-e.score).slice(0,r).filter(e=>e.score>=0)}async function u(e,t,i,n="",r={}){if(!t||0===t.length)return{answer:"Non ho trovato informazioni rilevanti nel documento per rispondere alla tua domanda. Prova a formulare la domanda in modo diverso o carica un documento piÃ¹ pertinente.",confidence:0,sources:[]};let a=t.map((e,t)=>`[Sezione ${t+1}]
${e.text}`).join("\n\n---\n\n"),s=Math.min(10*t[0].score,1);try{let i="";n&&n.trim()&&(i=`

**CONTESTO DELLA CONVERSAZIONE PRECEDENTE:**
${n}

Usa questo contesto per capire meglio la domanda e fornire una risposta coerente con la conversazione.`);let l=[{role:"system",content:`Sei un assistente AI esperto nell'analisi di documenti. Segui un ragionamento interno SILENTE (non mostrarlo) con i passi: 1) Identifica concetti chiave 2) Seleziona parti rilevanti 3) Sintetizza relazioni 4) Verifica contraddizioni o assenze 5) Struttura risposta finale. Poi produci SOLO l'output formattato.

OBIETTIVI:
1. Analisi accurata delle sezioni fornite
2. Risposta logica e coerente basata esclusivamente sul contenuto
3. Struttura chiara e professionale in italiano
4. Citazione delle fonti/Sezioni rilevanti
5. Nessuna invenzione: se manca l'informazione, dichiaralo e suggerisci cosa servirebbe

FORMATTA LA RISPOSTA CON LE SEZIONI (usa markdown semplice):
**Risposta**: sintesi principale diretta alla domanda.
**Dettagli**: approfondisci punti chiave organizzati.
**Fonti**: elenco puntato con sezione e breve estratto.
**Limiti**: cosa non \xe8 presente o ambiguo.
**Suggerimenti**: eventuali passi successivi o chiarimenti da richiedere.

Regole:
- Non includere il ragionamento interno.
- Non scusarti a meno che il contenuto sia realmente assente.
- Mantieni tono professionale, conciso ma completo.`},{role:"user",content:`Analizza il seguente contenuto estratto dal documento e rispondi alla domanda dell'utente in modo completo e accurato.

**CONTENUTO DEL DOCUMENTO:**
${a}${i}

**DOMANDA DELL'UTENTE:**
${e}

**ISTRUZIONI:**
- Rispondi basandoti SOLO sul contenuto fornito sopra
- Se la risposta richiede informazioni non presenti, dillo chiaramente
- Cita o fai riferimento alle sezioni rilevanti quando possibile
- Fornisci una risposta completa e ben strutturata
- Considera il contesto della conversazione se fornito per una risposta pi\xf9 pertinente`}],c=await (0,o.chatCompletion)(l,{model:"gpt-4o-mini",temperature:.2,max_tokens:1200,top_p:.9,frequency_penalty:.1,presence_penalty:.1});return c=c.trim(),/mi dispiace|non posso/i.test(c)&&c.length<120&&(c=`**Risposta**: Informazioni limitate nel testo fornito.
**Dettagli**:
${t.slice(0,3).map(e=>"- "+e.text.substring(0,200).replace(/\n+/g," ")+(e.text.length>200?"...":"")).join("\n")}
**Fonti**:
${t.map((e,t)=>`- Sezione ${t+1} (score ${e.score.toFixed(3)})`).join("\n")}
**Limiti**: Il documento sembra contenere testo estremamente breve o generico.
**Suggerimenti**: Carica un documento pi\xf9 esteso oppure specifica meglio la domanda.`),{answer:c,confidence:s,sources:t.map(e=>({filename:r?.originalFilename||r?.filename||"Documento",text:e.text.substring(0,150)+"...",score:e.score.toFixed(3)}))}}catch(i){console.error("Errore nella generazione della risposta con OpenAI:",i);let e=t[0].text;return{answer:`Basandomi sul documento:

${e}

${t.length>1?"\nInformazioni aggiuntive:\n"+t.slice(1,3).map((e,t)=>`â€¢ ${e.text.substring(0,200)}...`).join("\n"):""}`,confidence:s,sources:t.map(e=>({filename:r?.originalFilename||r?.filename||"Documento",text:e.text.substring(0,150)+"...",score:e.score.toFixed(3)}))}}}async function m(e,t,i={}){let n=await l(t),r={text:t,chunks:n,metadata:{...i,filename:i.filename||i.originalFilename||"Unknown",storedAt:new Date().toISOString(),chunkCount:n.length}};return f.set(e,r),{fileId:e,chunkCount:n.length,wordCount:t.split(/\s+/).length}}async function d(e,t=null){let i=t&&t.length>0?t.map(e=>{let t=f.get(e);return{id:e,data:t}}).filter(e=>e.data):Array.from(f.entries()).map(([e,t])=>({id:e,data:t}));if(0===i.length)return[];let n=[];for(let{id:t,data:r}of i){if(!r||!r.chunks||!r.chunks.length)continue;let i=await c(r.text,r.chunks,e,5);i.length>0&&n.push({fileId:t,filename:r.metadata?.originalFilename||r.metadata?.filename||"Unknown",results:i,topScore:i[0].score})}return n.sort((e,t)=>t.topScore-e.topScore)}async function p(e,t,i=""){var n;if(!t||0===t.length)return{answer:"Non ho trovato informazioni rilevanti nei documenti caricati. Prova a formulare la domanda in modo diverso o carica documenti piÃ¹ pertinenti.",confidence:0,sources:[]};let r=t.flatMap(e=>e.results.map(t=>({...t,filename:e.filename,fileId:e.fileId}))).sort((e,t)=>t.score-e.score).slice(0,5);if(0===r.length)return{answer:"Non ho trovato informazioni sufficienti per rispondere.",confidence:0,sources:[]};let a=r[0],s=(n=a.fileId,f.get(n));if(1===t.length)return await u(e,r,s.text,i,s.metadata||{});{let n=Math.min(10*a.score,1);try{let a=r.map((e,t)=>`[Documento: "${e.filename}" - Sezione ${t+1}]
${e.text}`).join("\n\n---\n\n"),s="";i&&i.trim()&&(s=`

**CONTESTO DELLA CONVERSAZIONE PRECEDENTE:**
${i}

Usa questo contesto per capire meglio la domanda e fornire una risposta coerente con la conversazione.`);let l=[{role:"system",content:`Sei un assistente AI esperto nell'analisi di documenti multipli. Usa ragionamento interno SILENTE (non mostrarlo) seguendo: 1) Mappa concetti per documento 2) Trova sovrapposizioni/contrasti 3) Sintetizza 4) Valuta completezza 5) Struttura output. Non mostrare i passi.

FORMATTA OUTPUT:
**Risposta** (sintesi diretta alla domanda)
**Analisi** (integrazione logica tra documenti, relazioni, eventuali differenze)
**Fonti** (elenco: Documento â€“ breve estratto pertinente)
**Limiti** (informazioni mancanti, contraddizioni non risolte)
**Suggerimenti** (cosa potrebbe aiutare o prossimi passi)

Regole:
- Non inventare contenuto
- Non scusarti salvo assenza totale di informazioni
- Cita il nome del documento per ogni informazione specifica
- Indica contraddizioni se presenti.`},{role:"user",content:`Analizza il contenuto estratto da ${t.length} documenti diversi e rispondi alla domanda dell'utente sintetizzando le informazioni rilevanti.

**CONTENUTO DAI DOCUMENTI:**
${a}${s}

**DOMANDA DELL'UTENTE:**
${e}

**ISTRUZIONI:**
- Combina informazioni da tutti i documenti rilevanti
- Cita sempre il nome del documento quando fai riferimento a informazioni specifiche
- Se ci sono informazioni correlate in pi\xf9 documenti, integrale in modo coerente
- Fornisci una risposta completa che risponda alla domanda utilizzando tutte le fonti pertinenti
- Considera il contesto della conversazione se fornito per una risposta pi\xf9 pertinente`}],c=await (0,o.chatCompletion)(l,{model:"gpt-4o-mini",temperature:.2,max_tokens:1500,top_p:.9,frequency_penalty:.1,presence_penalty:.1});if(c=c.trim(),/mi dispiace|non posso/i.test(c)&&c.length<140){let e=r.slice(0,5).map((e,t)=>`- ${e.filename} [score ${e.score.toFixed(3)}]: ${e.text.substring(0,160).replace(/\n+/g," ")}${e.text.length>160?"...":""}`).join("\n");c=`**Risposta**: Informazioni limitate ma estratte dai documenti.
**Analisi**: I contenuti disponibili sono molto brevi; non emergono argomentazioni complesse.
**Fonti**:
${e}
**Limiti**: Poca profondit\xe0; serve testo aggiuntivo.
**Suggerimenti**: Carica versioni pi\xf9 complete dei documenti o specifica una domanda pi\xf9 dettagliata.`}return{answer:c,confidence:n,sources:r.slice(0,3).map(e=>({filename:e.filename,text:e.text.substring(0,100)+"...",score:e.score.toFixed(3)}))}}catch(n){console.error("Errore nella generazione della risposta multi-documento con OpenAI:",n);let e=`Basandomi sui ${t.length} documenti caricati:

`;if(e+=`**Dal documento "${a.filename}":**
${a.text}

`,r.length>1){let t=r.slice(1,3).filter(e=>e.fileId!==a.fileId);t.length>0&&(e+=`**Informazioni correlate da altri documenti:**
`,t.forEach((t,i)=>{e+=`
[${i+1}] Da "${t.filename}":
${t.text.substring(0,200)}...
`}))}let i=Math.min(10*a.score,1);return{answer:e.trim(),confidence:i,sources:r.slice(0,3).map(e=>({filename:e.filename,text:e.text.substring(0,100)+"...",score:e.score.toFixed(3)}))}}}}function g(){let e=Array.from(f.values());return{totalDocuments:f.size,totalWords:e.reduce((e,t)=>e+(t.text.split(/\s+/).length||0),0),totalChunks:e.reduce((e,t)=>e+(t.chunks?.length||0),0),documents:Array.from(f.entries()).map(([e,t])=>({fileId:e,index:Array.from(f.keys()).indexOf(e),filename:t.metadata?.filename||t.metadata?.originalFilename||"Unknown",wordCount:t.text.split(/\s+/).length,chunkCount:t.chunks?.length||0,storedAt:t.metadata?.storedAt}))}}e.s(["extractTextFromDocument",()=>s,"generateMultiDocumentAnswer",()=>p,"getDocumentStats",()=>g,"searchAllDocuments",()=>d,"storeDocument",()=>m]),i()}catch(e){i(e)}},!1),898044,e=>e.a(async(t,i)=>{try{var n=e.i(162069),r=t([n]);async function o(e,t){if("OPTIONS"===e.method){t.setHeader("Access-Control-Allow-Origin","*"),t.setHeader("Access-Control-Allow-Methods","POST, OPTIONS"),t.setHeader("Access-Control-Allow-Headers","Content-Type"),t.status(200).end();return}if("POST"!==e.method)return t.status(405).json({error:"Method not allowed"});try{let{message:i,fileIds:r=[],conversationHistory:o=[]}=e.body;if(!i||!i.trim())return t.status(400).json({error:"Message is required",details:"Please provide a non-empty message"});let a=(0,n.getDocumentStats)(),s=r&&Array.isArray(r)&&r.length>0?r.filter(e=>e&&"string"==typeof e):null;if(0===a.totalDocuments){let e=i.toLowerCase(),n="";return n=e.includes("come funziona")||e.includes("how does")?"Benvenuto in **Documenti AI**! ðŸš€\n\n**Come funziona:**\n1. Carica uno o piÃ¹ documenti (PDF, DOCX, XLSX, TXT)\n2. Fai domande sul contenuto\n3. Ricevi risposte intelligenti basate sui tuoi file\n\n**Cosa posso fare:**\n- Analizzare documenti e trovare informazioni specifiche\n- Rispondere a domande sul contenuto\n- Eseguire ricerche semantiche nei tuoi file\n- Sintetizzare informazioni da piÃ¹ documenti\n\n**Carica un documento per iniziare!**":e.includes("formato")||e.includes("format")?"**Formati supportati:**\n\nâœ… PDF - Documenti PDF\nâœ… DOCX - Documenti Word\nâœ… XLSX/XLS/CSV - Fogli di calcolo Excel\nâœ… TXT - File di testo\n\nTutti i formati vengono analizzati completamente per permetterti di fare domande intelligenti sul contenuto.":e.includes("cosa puoi fare")||e.includes("what can")?"**Cosa posso fare con i tuoi documenti:**\n\nðŸ“Š **Analisi intelligente** - Estraggo e organizzo tutto il contenuto\nðŸ” **Ricerca semantica** - Trovo informazioni anche con parole chiave diverse\nðŸ’¬ **Chat intelligente** - Rispondo a domande specifiche sul contenuto\nðŸ“ **Sintesi** - Riassumo informazioni da piÃ¹ documenti\nðŸ”— **Citazioni** - Mostro esattamente da dove provengono le risposte\n\n**Carica un documento e prova!**":e.includes("ciao")||e.includes("hello")||e.includes("hi")?"Ciao! ðŸ‘‹\n\nSono il tuo assistente AI per l'analisi documenti. Posso aiutarti a:\n- Analizzare documenti PDF, DOCX, Excel e file di testo\n- Trovare informazioni specifiche nel contenuto\n- Rispondere a domande sui tuoi file\n- Eseguire ricerche semantiche intelligenti\n\n**Carica un documento per iniziare!** Usa il pulsante + per caricare i tuoi file.":`Ho ricevuto il tuo messaggio: "${i}"

**Per rispondere alle tue domande sui documenti:**
1. Carica uno o pi\xf9 documenti usando il pulsante + in basso
2. Fai domande sul contenuto
3. Ricevi risposte precise basate sui tuoi file

**Formati supportati:** PDF, DOCX, XLSX, TXT
**Tutto completamente gratuito e illimitato!**`,t.status(200).json({success:!0,message:n,timestamp:new Date().toISOString(),noDocuments:!0,stats:a})}let l=await (0,n.searchAllDocuments)(i,s);if(l.length,0===l.length)return t.status(200).json({success:!0,message:`Non ho trovato informazioni rilevanti nei documenti caricati per rispondere a: "${i}"

**Suggerimenti:**
- Prova a formulare la domanda in modo diverso
- Usa parole chiave pi\xf9 specifiche
- Verifica che i documenti caricati contengano le informazioni richieste

**Documenti caricati:** ${a.totalDocuments}
**Sezioni totali:** ${a.totalChunks}`,timestamp:new Date().toISOString(),noResults:!0,stats:a});let c=o.filter(e=>e.role&&e.content).slice(-3).map(e=>`${"user"===e.role?"Utente":"Assistente"}: ${e.content}`).join("\n\n"),u=await (0,n.generateMultiDocumentAnswer)(i,l,c),m=u.answer;return u.sources&&u.sources.length>0&&(m+=`

ðŸ“š **Documenti consultati:**

`,u.sources.forEach((e,t)=>{let i=parseFloat(e.score),n=(100*i).toFixed(0);m+=`"${e.filename}" (rilevanza: ${n}%)
`})),m+=`

ðŸ’¡ Ho cercato in ${a.totalDocuments} document${a.totalDocuments>1?"i":"o"} con ${a.totalChunks} sezioni totali.`,t.status(200).json({success:!0,message:m,timestamp:new Date().toISOString(),confidence:u.confidence,sources:u.sources||[],documentsUsed:l.map(e=>({fileId:e.fileId,filename:e.filename,topScore:e.topScore})),stats:a})}catch(e){return console.error("Chat API Error:",e),t.status(500).json({error:"Errore durante l'elaborazione",details:e.message,timestamp:new Date().toISOString()})}}[n]=r.then?(await r)():r,e.s(["default",()=>o]),i()}catch(e){i(e)}},!1),15379,e=>e.a(async(t,i)=>{try{var n=e.i(926747),r=e.i(190406),o=e.i(244898),a=e.i(262950),s=e.i(898044),l=e.i(7031),c=e.i(181927),u=e.i(846432),m=t([s]);[s]=m.then?(await m)():m;let p=(0,a.hoist)(s,"default"),g=(0,a.hoist)(s,"config"),f=new o.PagesAPIRouteModule({definition:{kind:r.RouteKind.PAGES_API,page:"/api/chat/message",pathname:"/api/chat/message",bundlePath:"",filename:""},userland:s,distDir:".next-build",relativeProjectDir:""});async function d(e,t,i){f.isDev&&(0,u.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let r="/api/chat/message";r=r.replace(/\/index$/,"")||"/";let o=await f.prepare(e,t,{srcPage:r});if(!o){t.statusCode=400,t.end("Bad Request"),null==i.waitUntil||i.waitUntil.call(i,Promise.resolve());return}let{query:a,params:s,prerenderManifest:m,routerServerContext:d}=o;try{let i=e.method||"GET",n=(0,l.getTracer)(),o=n.getActiveScopeSpan(),u=f.instrumentationOnRequestError.bind(f),p=async o=>f.render(e,t,{query:{...a,...s},params:s,allowedRevalidateHeaderKeys:[],multiZoneDraftMode:!1,trustHostHeader:!1,previewProps:m.preview,propagateError:!1,dev:f.isDev,page:"/api/chat/message",internalRevalidate:null==d?void 0:d.revalidate,onError:(...t)=>u(e,...t)}).finally(()=>{if(!o)return;o.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let e=n.getRootSpanAttributes();if(!e)return;if(e.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${e.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=e.get("next.route");if(a){let e=`${i} ${a}`;o.setAttributes({"next.route":a,"http.route":a,"next.span_name":e}),o.updateName(e)}else o.updateName(`${i} ${r}`)});o?await p(o):await n.withPropagatedContext(e.headers,()=>n.trace(c.BaseServerSpan.handleRequest,{spanName:`${i} ${r}`,kind:l.SpanKind.SERVER,attributes:{"http.method":i,"http.target":e.url}},p))}catch(e){if(f.isDev)throw e;(0,n.sendError)(t,500,"Internal Server Error")}finally{null==i.waitUntil||i.waitUntil.call(i,Promise.resolve())}}e.s(["config",0,g,"default",0,p,"handler",()=>d]),i()}catch(e){i(e)}},!1),323970,e=>{e.v(t=>Promise.all(["server/chunks/[externals]_fs_54ffce70._.js"].map(t=>e.l(t))).then(()=>t(522734)))},752039,e=>{e.v(t=>Promise.all(["server/chunks/[externals]_sharp_4f623ccc._.js"].map(t=>e.l(t))).then(()=>t(871815)))},425775,e=>{e.v(e=>Promise.resolve().then(()=>e(267370)))},735943,e=>{e.v(t=>Promise.all(["server/chunks/[externals]_tesseract_463eb979.js"].map(t=>e.l(t))).then(()=>t(236493)))},589793,e=>{e.v(t=>Promise.all(["server/chunks/[externals]_path_e30b8067._.js"].map(t=>e.l(t))).then(()=>t(814747)))},707480,e=>{e.v(t=>Promise.all(["server/chunks/[externals]_os_066ffa03._.js"].map(t=>e.l(t))).then(()=>t(446786)))}];

//# sourceMappingURL=%5Broot-of-the-server%5D__ff6fcf44._.js.map