module.exports=[270406,(e,t,r)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},74538,e=>e.a(async(t,r)=>{try{let t=await e.y("openai");e.n(t),r()}catch(e){r(e)}},!0),267370,e=>e.a(async(t,r)=>{try{var a=e.i(74538),i=t([a]);[a]=i.then?(await i)():i;let E=new a.default({apiKey:process.env.OPENAI_API_KEY});async function o(e){if(!process.env.OPENAI_API_KEY)throw Error("OPENAI_API_KEY is not configured. Please set it in your environment variables.");try{return(await E.embeddings.create({model:"text-embedding-3-small",input:e.substring(0,8e3)})).data[0].embedding}catch(e){throw console.error("Error generating embedding:",e),Error(`Failed to generate embedding: ${e.message}`)}}async function n(e){if(!process.env.OPENAI_API_KEY)throw Error("OPENAI_API_KEY is not configured. Please set it in your environment variables.");if(!Array.isArray(e)||0===e.length)return[];try{return(await E.embeddings.create({model:"text-embedding-3-small",input:e.map(e=>(e||"").toString().substring(0,8e3))})).data.map(e=>e.embedding)}catch(e){throw console.error("Error generating batch embeddings:",e),Error(`Failed to generate batch embeddings: ${e.message}`)}}async function s(e,t={}){if(!process.env.OPENAI_API_KEY)throw Error("OPENAI_API_KEY is not configured. Please set it in your environment variables.");try{return(await E.chat.completions.create({model:t.model||"gpt-4o-mini",messages:e,temperature:t.temperature||.7,max_tokens:t.max_tokens||1e3,top_p:t.top_p||1,frequency_penalty:t.frequency_penalty||0,presence_penalty:t.presence_penalty||0})).choices[0].message.content}catch(e){if(console.error("Error in chat completion:",e),401===e.status)throw Error("Chiave API OpenAI non valida. Verifica la configurazione.");if(429===e.status)throw Error("Limite di rate raggiunto. Riprova tra qualche secondo.");if(500===e.status)throw Error("Errore del server OpenAI. Riprova più tardi.");throw Error(`Errore nella comunicazione con OpenAI: ${e.message}`)}}async function l(e,t=200){let r=[{role:"system",content:"You are a helpful assistant that creates concise summaries."},{role:"user",content:`Summarize the following text in ${t} words or less:

${e}`}];return await s(r,{temperature:.5,max_tokens:300})}async function c(e,t=5){let r=[{role:"system",content:"You are a helpful assistant that generates relevant tags for documents. Return only comma-separated tags, no explanations."},{role:"user",content:`Generate ${t} relevant tags for this document:

${e.substring(0,2e3)}`}];return(await s(r,{temperature:.3,max_tokens:100})).split(",").map(e=>e.trim().toLowerCase()).filter(e=>e.length>0).slice(0,t)}async function u(e){let t=["contract","invoice","report","presentation","spreadsheet","image","code","email","article","other"],r=[{role:"system",content:`You are a document classifier. Classify the document into one or more of these categories: ${t.join(", ")}. Return only category names, comma-separated.`},{role:"user",content:`Classify this document:

${e.substring(0,1e3)}`}];return(await s(r,{temperature:.2,max_tokens:50})).split(",").map(e=>e.trim().toLowerCase()).filter(e=>t.includes(e))}async function d(e,t,r="Cosa contiene questa immagine? Descrivi tutto ciò che vedi."){if(!process.env.OPENAI_API_KEY)throw Error("OPENAI_API_KEY is not configured. Please set it in your environment variables.");try{let a=e.toString("base64");return(await E.chat.completions.create({model:"gpt-4o",messages:[{role:"system",content:"Sei un assistente AI esperto nell'analisi di immagini. Descrivi in dettaglio tutto ciò che vedi nell'immagine, inclusi testo, oggetti, persone, scene, colori e qualsiasi altro dettaglio rilevante. Rispondi sempre in italiano."},{role:"user",content:[{type:"text",text:r},{type:"image_url",image_url:{url:`data:${t};base64,${a}`,detail:"high"}}]}],max_tokens:2e3,temperature:.2})).choices[0].message.content}catch(e){if(console.error("Error in vision API:",e),401===e.status)throw Error("Chiave API OpenAI non valida. Verifica la configurazione.");if(429===e.status)throw Error("Limite di rate raggiunto. Riprova tra qualche secondo.");if(400===e.status&&e.message?.includes("image"))throw Error("Formato immagine non supportato o immagine troppo grande.");throw Error(`Errore nell'analisi dell'immagine: ${e.message}`)}}async function m(t){if(!process.env.OPENAI_API_KEY)throw Error("OPENAI_API_KEY is not configured. Please set it in your environment variables.");let r=await e.A(323970),a=null;try{a=await E.files.create({file:r.createReadStream(t),purpose:"user_data"});let e=((await E.responses.create({model:"gpt-4o",input:[{role:"user",content:[{type:"input_text",text:"Estrai tutto il testo e le informazioni rilevanti da questo documento. Rispondi SOLO con il testo estratto, senza commenti."},{type:"input_file",file_id:a.id}]}],max_output_tokens:8e3,temperature:.1})).output_text||"").toString().trim();if(!e)throw Error("Nessun testo estratto dal PDF");return e}catch(e){if(console.error("Error in PDF text extraction (Responses API):",e),401===e.status)throw Error("Chiave API OpenAI non valida. Verifica la configurazione.");if(429===e.status)throw Error("Limite di rate raggiunto. Riprova tra qualche secondo.");if(400===e.status)throw Error("Errore nell'analisi del PDF con Responses API. Il file potrebbe essere troppo grande o danneggiato.");throw Error(`Errore nell'estrazione del testo PDF: ${e.message}`)}finally{try{a&&a.id&&(E.files?.delete?await E.files.delete(a.id):E.files?.del&&await E.files.del(a.id))}catch(e){console.warn("Errore rimozione file da OpenAI (ignorato):",e?.message||e)}}}async function g(e,t={}){if(!process.env.OPENAI_API_KEY)throw Error("OPENAI_API_KEY is not configured. Please set it in your environment variables.");try{let r=t.size||"1024x1024",a=t.quality||"standard",i=t.style||"vivid",o=await E.images.generate({model:"dall-e-3",prompt:e,size:r,quality:a,style:i,n:1}),n=o.data[0]?.url;if(!n)throw Error("Nessuna immagine generata da DALL-E");return n}catch(e){if(console.error("Error getting image URL from DALL-E:",e),console.error("Error details:",{status:e.status,statusText:e.statusText,message:e.message,code:e.code,response:e.response?.data||e.response}),401===e.status)throw Error("Chiave API OpenAI non valida. Verifica la configurazione.");if(429===e.status)throw Error("Limite di rate raggiunto. Riprova tra qualche secondo.");if(400===e.status){let t=e.message||e.response?.data?.error?.message||"Prompt non valido o contenuto non consentito";throw Error(`Errore nella generazione: ${t}`)}else if("ENOTFOUND"===e.code||"ECONNREFUSED"===e.code)throw Error("Errore di connessione con OpenAI. Verifica la tua connessione internet.");throw Error(`Errore nella generazione dell'immagine: ${e.message||"Errore sconosciuto"}`)}}async function p(e,t={}){if(!process.env.OPENAI_API_KEY)throw Error("OPENAI_API_KEY is not configured. Please set it in your environment variables.");try{let r=await g(e,t),a=await fetch(r);if(!a.ok){let e=await a.text().catch(()=>"Unknown error");throw Error(`Errore nel download dell'immagine generata: ${a.status} ${a.statusText}. ${e}`)}let i=await a.arrayBuffer();return Buffer.from(i)}catch(e){throw e}}async function h(e,t,r=null){if(!process.env.OPENAI_API_KEY)throw Error("OPENAI_API_KEY is not configured. Please set it in your environment variables.");try{let a=await d(e,t,r||"Descrivi in dettaglio questa immagine, includendo tutti i dettagli visivi, colori, composizione, stile e qualità. La descrizione sarà usata per creare una versione migliorata ad alta risoluzione."),i=`Crea una versione migliorata e ad alta risoluzione di questa immagine: ${a}. Mantieni fedelt\xe0 ai dettagli originali ma migliora la qualit\xe0, la nitidezza e la risoluzione.`;return await p(i,{size:"1792x1024",quality:"hd",style:"natural"})}catch(e){throw console.error("Error upscaling image with DALL-E:",e),Error(`Errore nel miglioramento dell'immagine: ${e.message}`)}}async function f(t,r){if(!process.env.OPENAI_API_KEY)throw Error("OPENAI_API_KEY is not configured. Please set it in your environment variables.");try{let a=`Analyze this image and identify specific quality issues that need improvement. Focus on:
1. Noise level (low/medium/high)
2. Sharpness (blurry/sharp)
3. Color accuracy (washed out/vibrant)
4. Artifacts (compression artifacts, pixelation)
5. Overall quality issues

Respond with a JSON object: {"noise": "low|medium|high", "sharpness": "blurry|moderate|sharp", "color": "washed|normal|vibrant", "artifacts": "none|minor|major", "recommendations": "brief description"}`,i=await d(t,r,a),o={noise:"medium",sharpness:"moderate",color:"normal",artifacts:"none"};try{let e=i.match(/\{[\s\S]*\}/);if(e){let t=JSON.parse(e[0]);o={...o,...t}}}catch(e){console.warn("Could not parse AI analysis, using defaults")}let n=(0,(await e.A(752039)).default)(t,{sequentialRead:!0});return("high"===o.noise||"medium"===o.noise)&&(n=n.median("high"===o.noise?3:2)),"blurry"===o.sharpness?n=n.sharpen({sigma:2,m1:1,m2:.5,x1:3,y2:3,y3:3}):"moderate"===o.sharpness&&(n=n.sharpen({sigma:1,m1:.7,m2:.4})),"washed"===o.color&&(n=n.modulate({saturation:1.15,brightness:1.05}).linear(1.05,-6.4)),n="major"===o.artifacts||"minor"===o.artifacts?n.png({quality:100,compressionLevel:6,adaptiveFiltering:!0}):"image/jpeg"===r||"image/jpg"===r?n.jpeg({quality:98,mozjpeg:!0,trellisQuantisation:!0,overshootDeringing:!0}):n.png({quality:100,compressionLevel:6}),await n.toBuffer()}catch(e){return console.error("Error enhancing image quality with AI:",e),t}}e.s(["analyzeImageWithVision",()=>d,"chatCompletion",()=>s,"classifyDocument",()=>u,"enhanceImageQualityWithAI",()=>f,"extractTextFromPdfWithOpenAI",()=>m,"generateEmbedding",()=>o,"generateEmbeddingsBatch",()=>n,"generateImageWithDALLE",()=>p,"generateSummary",()=>l,"generateTags",()=>c,"getImageUrlFromDALLE",()=>g,"upscaleImageWithDALLE",()=>h]),r()}catch(e){r(e)}},!1),874239,e=>e.a(async(t,r)=>{try{var a=e.i(267370),i=t([a]);async function o(e,t){if("OPTIONS"===e.method){t.setHeader("Access-Control-Allow-Origin","*"),t.setHeader("Access-Control-Allow-Methods","POST, OPTIONS"),t.setHeader("Access-Control-Allow-Headers","Content-Type"),t.status(200).end();return}if("POST"!==e.method)return t.status(405).json({error:"Method not allowed"});try{let{prompt:r,aspect:i="1:1",quality:o,style:n,detail:s,realism:l}=e.body||{};if(!r||"string"!=typeof r)return t.status(400).json({error:"Il prompt è richiesto e deve essere una stringa."});let c={"1:1":"1024x1024","16:9":"1792x1024","9:16":"1024x1792","4:3":"1792x1024","3:4":"1024x1792"},u=c[i]||c["1:1"],d=await (0,a.getImageUrlFromDALLE)(r,{size:u,quality:o||(s&&s>.8?"hd":"standard"),style:n||(l?"natural":"vivid")});t.setHeader("Content-Type","image/png"),t.setHeader("Cache-Control","no-cache, no-store, must-revalidate"),t.setHeader("Pragma","no-cache"),t.setHeader("Expires","0");let m=await fetch(d);if(!m.ok)throw Error(`Errore nel download dell'immagine: ${m.status}`);if(m.body){t.status(200);let e=m.body.getReader();try{for(;;){let{done:r,value:a}=await e.read();if(r){t.end();break}t.headersSent||t.writeHead(200,{"Content-Type":"image/png","Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0"}),t.write(Buffer.from(a))}}catch(e){throw console.error("Streaming error:",e),t.headersSent?t.end():t.status(500).json({error:"Errore durante lo streaming dell'immagine"}),e}}else{let e=await m.arrayBuffer();t.setHeader("Content-Length",e.byteLength),t.status(200).send(Buffer.from(e))}}catch(e){console.error("Errore API Generate Image:",e),t.headersSent||t.status(500).json({error:e.message||"Errore interno del server durante la generazione dell'immagine."})}}[a]=i.then?(await i)():i,e.s(["default",()=>o]),r()}catch(e){r(e)}},!1),329614,e=>e.a(async(t,r)=>{try{var a=e.i(926747),i=e.i(190406),o=e.i(244898),n=e.i(262950),s=e.i(874239),l=e.i(7031),c=e.i(181927),u=e.i(846432),d=t([s]);[s]=d.then?(await d)():d;let g=(0,n.hoist)(s,"default"),p=(0,n.hoist)(s,"config"),h=new o.PagesAPIRouteModule({definition:{kind:i.RouteKind.PAGES_API,page:"/api/tools/generate-image",pathname:"/api/tools/generate-image",bundlePath:"",filename:""},userland:s,distDir:".next-build",relativeProjectDir:""});async function m(e,t,r){h.isDev&&(0,u.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let i="/api/tools/generate-image";i=i.replace(/\/index$/,"")||"/";let o=await h.prepare(e,t,{srcPage:i});if(!o){t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve());return}let{query:n,params:s,prerenderManifest:d,routerServerContext:m}=o;try{let r=e.method||"GET",a=(0,l.getTracer)(),o=a.getActiveScopeSpan(),u=h.instrumentationOnRequestError.bind(h),g=async o=>h.render(e,t,{query:{...n,...s},params:s,allowedRevalidateHeaderKeys:[],multiZoneDraftMode:!1,trustHostHeader:!1,previewProps:d.preview,propagateError:!1,dev:h.isDev,page:"/api/tools/generate-image",internalRevalidate:null==m?void 0:m.revalidate,onError:(...t)=>u(e,...t)}).finally(()=>{if(!o)return;o.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let e=a.getRootSpanAttributes();if(!e)return;if(e.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${e.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=e.get("next.route");if(n){let e=`${r} ${n}`;o.setAttributes({"next.route":n,"http.route":n,"next.span_name":e}),o.updateName(e)}else o.updateName(`${r} ${i}`)});o?await g(o):await a.withPropagatedContext(e.headers,()=>a.trace(c.BaseServerSpan.handleRequest,{spanName:`${r} ${i}`,kind:l.SpanKind.SERVER,attributes:{"http.method":r,"http.target":e.url}},g))}catch(e){if(h.isDev)throw e;(0,a.sendError)(t,500,"Internal Server Error")}finally{null==r.waitUntil||r.waitUntil.call(r,Promise.resolve())}}e.s(["config",0,p,"default",0,g,"handler",()=>m]),r()}catch(e){r(e)}},!1),323970,e=>{e.v(t=>Promise.all(["server/chunks/[externals]_fs_54ffce70._.js"].map(t=>e.l(t))).then(()=>t(522734)))},752039,e=>{e.v(t=>Promise.all(["server/chunks/[externals]_sharp_4f623ccc._.js"].map(t=>e.l(t))).then(()=>t(871815)))}];

//# sourceMappingURL=%5Broot-of-the-server%5D__e05055f5._.js.map