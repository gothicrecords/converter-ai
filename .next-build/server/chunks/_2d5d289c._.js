module.exports=[869616,e=>{"use strict";var t=e.i(871815);let a=class{constructor(){this.maxDimension=7680}async stage1_DenoiseDeblur(e){let t=e;return(t=(t=(t=t.median(3)).sharpen({sigma:.3,m1:.5,m2:.3})).blur(.5)).sharpen({sigma:.2,m1:.3,m2:.15})}async stage2_SuperResolution(e,a,r,i){let n=e,s=r,l=i,o=Math.ceil(Math.log2(a));for(let e=0;e<o;e++){let r=Math.min(2,a/Math.pow(2,e)),i=Math.round(s*r),u=Math.round(l*r);if(n=n.resize(i,u,{kernel:t.default.kernel.lanczos3,fit:"fill",withoutEnlargement:!1}),e<o-1&&(n=n.sharpen({sigma:.4,m1:.5,m2:.3})),e<o-1){let e=await n.toBuffer();n=(0,t.default)(e,{sequentialRead:!0})}s=i,l=u}return n}async stage3_FineDetail(e){let t=e;return(t=(t=t.sharpen({sigma:1,m1:.7,m2:.4,x1:2,y2:2,y3:2})).normalise()).sharpen({sigma:.5,m1:.8,m2:.5})}async edgeAwareEnhancement(e){let t=e;return(t=(t=(t=t.sharpen({sigma:1.2,m1:.9,m2:.6,x1:2,y2:2,y3:2})).linear(1.06,-7.68)).normalise()).sharpen({sigma:.8,m1:.7,m2:.5})}async highFrequencyInjector(e){let t=e;return(t=(t=(t=t.sharpen({sigma:.8,m1:1,m2:.6,x1:3,y2:3,y3:3})).normalise()).sharpen({sigma:.5,m1:.8,m2:.5})).modulate({brightness:1.03,saturation:1.05})}async colorSpaceEnhancement(e){let t=e;return(t=(t=t.normalise()).linear(1.05,-6.4)).modulate({saturation:1.1,brightness:1.02,hue:0})}async textureAwareProcessing(e){let t=e;return(t=t.sharpen({sigma:.6,m1:.7,m2:.4})).normalise()}async detectDegradation(e){let t=await e.metadata(),a=t.width||0,r=t.height||0;t.hasAlpha;let i=t.format||"";return a<1e3&&r<1e3?"low_res":"jpeg"===i&&a*r>5e5&&a*r<2e6?"compression":a*r<5e5?"noise":"blur"}async upscale(e,a=4,r=7680){try{let i=(0,t.default)(e,{sequentialRead:!0}).rotate(),n=await i.metadata(),s=n.width||0,l=n.height||0;if(0===s||0===l)throw Error("Dimensioni immagine non valide");let o=Math.round(s*a),u=Math.round(l*a);if(o>r||u>r){let e=r/Math.max(o,u);o=Math.round(o*e),u=Math.round(u*e)}await this.detectDegradation(i);let d=await this.stage1_DenoiseDeblur(i),c=Math.max(o/s,u/l);return d=await this.stage2_SuperResolution(d,c,s,l),d=await this.stage3_FineDetail(d),d=await this.edgeAwareEnhancement(d),d=await this.highFrequencyInjector(d),d=await this.colorSpaceEnhancement(d),d=await this.textureAwareProcessing(d),await d.jpeg({quality:98,chromaSubsampling:"4:4:4",mozjpeg:!0,trellisQuantisation:!0,overshootDeringing:!0,optimiseScans:!0,progressive:!0}).toBuffer()}catch(e){throw console.error("[MSR] Errore upscaling:",e),Error(`MSR Upscaling fallito: ${e.message}`)}}async upscaleTo4K(e){let a=(0,t.default)(e,{sequentialRead:!0}).rotate(),r=await a.metadata(),i=Math.max(r.width||0,r.height||0);return this.upscale(e,3840/i,3840)}};async function r(e,i=4){try{let r,i=new a,n=await (0,t.default)(e,{sequentialRead:!0}).metadata(),s=n.width||0,l=n.height||0,o=Math.max(s,l);if(o<1920)r=await i.upscaleTo4K(e);else if(o<3840)r=await i.upscale(e,3840/o,3840);else{let t=Math.max(2,Math.min(4,7680/o));r=await i.upscale(e,t,7680)}let u=r.toString("base64");return`data:image/jpeg;base64,${u}`}catch(e){throw console.error("Upscale fallito:",e),Error(`Upscale failed: ${e?.message||e}`)}}e.s(["default",()=>r],869616)},404571,e=>e.a(async(t,a)=>{try{var r=e.i(293635),i=e.i(924868),n=e.i(869616),s=e.i(267370),l=e.i(515954),o=e.i(314613),u=e.i(975111),d=t([r,s]);async function c(e,t){if("OPTIONS"===e.method){t.setHeader("Access-Control-Allow-Origin","*"),t.setHeader("Access-Control-Allow-Methods","POST, OPTIONS"),t.setHeader("Access-Control-Allow-Headers","Content-Type"),t.status(200).end();return}if("POST"!==e.method)return t.setHeader("Allow","POST"),t.status(405).json({error:"Method not allowed",code:"METHOD_NOT_ALLOWED"});let a=process.env.VERCEL?"/tmp":os.tmpdir(),d=(0,r.default)({multiples:!1,maxFileSize:0x3200000,keepExtensions:!0,uploadDir:a}),c=null;try{let a,r,{files:m}=await Promise.race([new Promise((t,a)=>{d.parse(e,(e,r,i)=>{if(e)return"LIMIT_FILE_SIZE"===e.code?a(new l.FileTooLargeError(0x3200000)):a(new l.ValidationError("File upload failed: "+e.message,e));t({fields:r,files:i})})}),new Promise((e,t)=>setTimeout(()=>t(new l.TimeoutError("Request timeout",12e4)),12e4))]),p=m?.image??m?.file??null;if(Array.isArray(p)&&(p=p[0]),!p)throw new l.ValidationError("No file uploaded");if(!p.mimetype?.startsWith("image/"))throw new l.InvalidFileTypeError(["image/jpeg","image/png","image/webp","image/gif"]);if(p.size>0x3200000)throw new l.FileTooLargeError(0x3200000,p.size);let h=(0,u.getUserId)(e),g=(0,u.getUserPlan)(e),w="upscaler-ai",f=(0,u.getUsageStats)(h,w),y={size:p.size},E=(0,o.canUseTool)(w,g,f,y);if(!E.allowed){if(c)try{await i.default.unlink(c)}catch(e){console.warn("Failed to cleanup temp file:",e)}return t.status(403).json({error:E.reason,limitType:E.limitType,current:E.current,max:E.max,upgradeMessage:(0,o.getUpgradeMessage)(w,g),requiresPro:!0})}if(!(c=p.filepath||p.path))throw new l.ValidationError("Uploaded file path missing");try{a=await i.default.readFile(c)}catch(e){throw new l.FileSystemError("Failed to read uploaded file",e)}if(!a||0===a.length)throw new l.ValidationError("File is empty or corrupted");try{if(r=await (0,n.default)(a),process.env.OPENAI_API_KEY)try{let e=(await (0,s.enhanceImageQualityWithAI)(a,p.mimetype)).toString("base64");r=`data:${p.mimetype||"image/jpeg"};base64,${e}`}catch(e){console.warn("AI enhancement failed, using upscaled result:",e.message)}if((0,u.incrementUsage)(h,w),c)try{await i.default.unlink(c),c=null}catch(e){console.warn("Failed to cleanup temp file:",e)}return t.status(200).json({url:r})}catch(e){throw new l.ProcessingError("Failed to upscale image",e)}}catch(a){if(c)try{await i.default.unlink(c)}catch(e){console.warn("Failed to cleanup temp file on error:",e)}(0,l.handleApiError)(a,t,{method:e.method,url:e.url,endpoint:"/api/upscale"})}}[r,s]=d.then?(await d)():d,e.s(["config",0,{api:{bodyParser:!1}},"default",()=>c]),a()}catch(e){a(e)}},!1),949606,e=>e.a(async(t,a)=>{try{var r=e.i(926747),i=e.i(190406),n=e.i(244898),s=e.i(262950),l=e.i(404571),o=e.i(7031),u=e.i(181927),d=e.i(846432),c=t([l]);[l]=c.then?(await c)():c;let p=(0,s.hoist)(l,"default"),h=(0,s.hoist)(l,"config"),g=new n.PagesAPIRouteModule({definition:{kind:i.RouteKind.PAGES_API,page:"/api/upscale",pathname:"/api/upscale",bundlePath:"",filename:""},userland:l,distDir:".next-build",relativeProjectDir:""});async function m(e,t,a){g.isDev&&(0,d.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let i="/api/upscale";i=i.replace(/\/index$/,"")||"/";let n=await g.prepare(e,t,{srcPage:i});if(!n){t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve());return}let{query:s,params:l,prerenderManifest:c,routerServerContext:m}=n;try{let a=e.method||"GET",r=(0,o.getTracer)(),n=r.getActiveScopeSpan(),d=g.instrumentationOnRequestError.bind(g),p=async n=>g.render(e,t,{query:{...s,...l},params:l,allowedRevalidateHeaderKeys:[],multiZoneDraftMode:!1,trustHostHeader:!1,previewProps:c.preview,propagateError:!1,dev:g.isDev,page:"/api/upscale",internalRevalidate:null==m?void 0:m.revalidate,onError:(...t)=>d(e,...t)}).finally(()=>{if(!n)return;n.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let e=r.getRootSpanAttributes();if(!e)return;if(e.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${e.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let s=e.get("next.route");if(s){let e=`${a} ${s}`;n.setAttributes({"next.route":s,"http.route":s,"next.span_name":e}),n.updateName(e)}else n.updateName(`${a} ${i}`)});n?await p(n):await r.withPropagatedContext(e.headers,()=>r.trace(u.BaseServerSpan.handleRequest,{spanName:`${a} ${i}`,kind:o.SpanKind.SERVER,attributes:{"http.method":a,"http.target":e.url}},p))}catch(e){if(g.isDev)throw e;(0,r.sendError)(t,500,"Internal Server Error")}finally{null==a.waitUntil||a.waitUntil.call(a,Promise.resolve())}}e.s(["config",0,h,"default",0,p,"handler",()=>m]),a()}catch(e){a(e)}},!1)];

//# sourceMappingURL=_2d5d289c._.js.map