module.exports=[70406,(e,t,a)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},30056,e=>e.a(async(t,a)=>{try{let t=await e.y("pg");e.n(t),a()}catch(e){a(e)}},!0),96115,e=>{"use strict";let t={app:{name:process.env.APP_NAME||"Tool Suite",env:"production",port:parseInt(process.env.PORT||"3000",10),url:process.env.APP_URL||"http://localhost:3000"},database:{url:process.env.DATABASE_URL,pool:{max:parseInt(process.env.DB_POOL_MAX||"20",10),idleTimeout:parseInt(process.env.DB_IDLE_TIMEOUT||"30000",10),connectionTimeout:parseInt(process.env.DB_CONNECTION_TIMEOUT||"5000",10)}},supabase:{url:"https://ckctyvebrkcemcgllpbc.supabase.co",anonKey:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNrY3R5dmVicWtjZW1jZ2xscGJjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzNDYzMzksImV4cCI6MjA3ODkyMjMzOX0.kGyjcR9D8vLD5xYsEvHA5qAQ08OvoOC4mgajSmnh0jM",serviceRoleKey:process.env.SUPABASE_SERVICE_ROLE_KEY},stripe:{secretKey:process.env.STRIPE_SECRET_KEY,publishableKey:"pk_test_51SUZp0AYkkHFHNFuDK9bY1iN8xNUFPeBVZTSLgTBq5SxSo7bBeyaMYSTaaLfJ2g5oxOCXOO1bAAefqa5I9StJwF9001XRLRFQf",webhookSecret:process.env.STRIPE_WEBHOOK_SECRET},cloudinary:{cloudName:process.env.CLOUDINARY_CLOUD_NAME,apiKey:process.env.CLOUDINARY_API_KEY,apiSecret:process.env.CLOUDINARY_API_SECRET},openai:{apiKey:process.env.OPENAI_API_KEY},upload:{maxFileSize:parseInt(process.env.MAX_FILE_SIZE||"52428800",10),allowedMimeTypes:{image:["image/jpeg","image/png","image/webp","image/gif","image/svg+xml"],document:["application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document"],video:["video/mp4","video/webm","video/ogg"],audio:["audio/mpeg","audio/wav","audio/ogg"]},tempDir:process.env.TEMP_DIR||"/tmp"},session:{cookieName:"megapixelai_session",maxAge:6048e5,secret:process.env.SESSION_SECRET||"change-me-in-production"},security:{bcryptRounds:parseInt(process.env.BCRYPT_ROUNDS||"10",10),rateLimit:{windowMs:parseInt(process.env.RATE_LIMIT_WINDOW||"900000",10),max:parseInt(process.env.RATE_LIMIT_MAX||"100",10)}},analytics:{gaTrackingId:process.env.NEXT_PUBLIC_GA_TRACKING_ID},oauth:{google:{clientId:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET},facebook:{appId:process.env.FACEBOOK_APP_ID,appSecret:process.env.FACEBOOK_APP_SECRET},redirectBaseUrl:process.env.APP_URL||"http://localhost:3000"}};"production"===t.app.env&&function(){let e=[{key:"database.url",value:t.database.url},{key:"supabase.url",value:t.supabase.url},{key:"supabase.anonKey",value:t.supabase.anonKey}].filter(({value:e})=>!e);if(e.length>0)throw Error(`Missing required configuration: ${e.map(({key:e})=>e).join(", ")}`)}(),e.s(["config",0,t])},32692,e=>e.a(async(t,a)=>{try{var r=e.i(30056),s=e.i(96115),i=t([r]);[r]=i.then?(await i)():i;let{Pool:h}=r.default;if(!s.config.database.url)throw Error("DATABASE_URL environment variable is not set");let S=new h({connectionString:s.config.database.url,ssl:{rejectUnauthorized:!1},max:s.config.database.pool.max,idleTimeoutMillis:s.config.database.pool.idleTimeout,connectionTimeoutMillis:s.config.database.pool.connectionTimeout,keepAlive:!0,keepAliveInitialDelayMillis:1e4});async function o(e,t=[]){let a=Date.now();try{let r=await S.query(e,t),s=Date.now()-a;return s>1e3&&console.warn(`Slow query (${s}ms): ${e.substring(0,100)}`),r.rows}catch(e){throw console.error("Database query error:",e),e}}async function n(e){return(await o("SELECT * FROM users WHERE email = $1 LIMIT 1",[e]))[0]}async function c(e,t,a){return(await o(`INSERT INTO users (email, name, password_hash)
     VALUES ($1, $2, $3)
     RETURNING id, email, name, created_at, images_processed, tools_used, has_discount, plan`,[e,t,a]))[0]}async function u(e,t){return(await o("SELECT * FROM users WHERE auth_provider = $1 AND provider_id = $2 LIMIT 1",[e,t]))[0]}async function p({email:e,name:t,provider:a,providerId:r,providerEmail:s,avatarUrl:i}){return(await o(`INSERT INTO users (email, name, auth_provider, provider_id, provider_email, avatar_url, password_hash)
     VALUES ($1, $2, $3, $4, $5, $6, NULL)
     RETURNING id, email, name, created_at, images_processed, tools_used, has_discount, plan, auth_provider, avatar_url`,[e,t,a,r,s||e,i]))[0]}async function d(e,{provider:t,providerId:a,providerEmail:r,avatarUrl:s}){return(await o(`UPDATE users
     SET auth_provider = $2,
         provider_id = $3,
         provider_email = $4,
         avatar_url = COALESCE($5, avatar_url),
         updated_at = NOW()
     WHERE id = $1
     RETURNING id, email, name, created_at, images_processed, tools_used, has_discount, plan, auth_provider, avatar_url`,[e,t,a,r,s]))[0]}async function l(e,t,a){return(await o(`INSERT INTO user_sessions (user_id, session_token, expires_at)
     VALUES ($1, $2, $3)
     RETURNING *`,[e,t,a]))[0]}async function E(e){return(await o(`SELECT s.*, u.email, u.name, u.images_processed, u.tools_used, u.has_discount, u.plan
     FROM user_sessions s
     JOIN users u ON s.user_id = u.id
     WHERE s.session_token = $1
     AND s.expires_at > NOW()
     LIMIT 1`,[e]))[0]}async function _(e){await o("DELETE FROM user_sessions WHERE session_token = $1",[e])}async function m(e,t){return(await o(`UPDATE users
     SET stripe_customer_id = $2,
         updated_at = NOW()
     WHERE id = $1
     RETURNING *`,[e,t]))[0]}async function v(e,t,a,r){return(await o(`UPDATE users
     SET stripe_subscription_id = $2,
         stripe_subscription_status = $3,
         subscription_expires_at = $4,
         plan = CASE WHEN $3 = 'active' THEN 'pro' ELSE 'free' END,
         updated_at = NOW()
     WHERE id = $1
     RETURNING *`,[e,t,a,r]))[0]}async function I(e){return(await o("SELECT * FROM users WHERE stripe_customer_id = $1 LIMIT 1",[e]))[0]}S.on("error",e=>{console.error("Unexpected database pool error",e)}),e.s(["createOAuthUser",()=>p,"createSession",()=>l,"createUser",()=>c,"deleteSession",()=>_,"getSession",()=>E,"getUser",()=>n,"getUserByProvider",()=>u,"getUserByStripeCustomerId",()=>I,"updateUserProvider",()=>d,"updateUserStripeCustomer",()=>m,"updateUserSubscription",()=>v]),a()}catch(e){a(e)}},!1),78830,e=>e.a(async(t,a)=>{try{let t=await e.y("stripe");e.n(t),a()}catch(e){a(e)}},!0),66382,e=>e.a(async(t,a)=>{try{var r=e.i(78830),s=t([r]);[r]=s.then?(await s)():s;let i=new r.default(process.env.STRIPE_SECRET_KEY,{apiVersion:"2023-10-16"});e.s(["default",0,i]),a()}catch(e){a(e)}},!1),50751,(e,t,a)=>{t.exports=e.x("micro",()=>require("micro"))},30986,e=>e.a(async(t,a)=>{try{var r=e.i(66382),s=e.i(50751),i=e.i(32692),o=t([r,i]);async function n(e,t){let a;if("POST"!==e.method)return t.status(405).json({error:"Method not allowed"});let o=e.headers["stripe-signature"],n=process.env.STRIPE_WEBHOOK_SECRET;try{let t=await (0,s.buffer)(e);a=r.default.webhooks.constructEvent(t,o,n)}catch(e){return console.error("Webhook signature verification failed:",e.message),t.status(400).send(`Webhook Error: ${e.message}`)}try{switch(a.type){case"checkout.session.completed":{let e=a.data.object,t=e.metadata.userId,s=e.customer,o=e.subscription;if(t&&s&&await (0,i.updateUserStripeCustomer)(t,s),t&&o){let e=await r.default.subscriptions.retrieve(o);await (0,i.updateUserSubscription)(t,o,e.status,new Date(1e3*e.current_period_end))}break}case"customer.subscription.updated":{let e=a.data.object,t=e.customer,r=await (0,i.getUserByStripeCustomerId)(t);r&&await (0,i.updateUserSubscription)(r.id,e.id,e.status,new Date(1e3*e.current_period_end));break}case"customer.subscription.deleted":{let e=a.data.object.customer,t=await (0,i.getUserByStripeCustomerId)(e);t&&await (0,i.updateUserSubscription)(t.id,null,"canceled",null);break}case"invoice.payment_failed":{let e=a.data.object.customer,t=await (0,i.getUserByStripeCustomerId)(e);t&&console.error("Payment failed for user:",t.id)}}t.status(200).json({received:!0})}catch(e){console.error("Webhook handler error:",e),t.status(500).json({error:"Webhook handler failed"})}}[r,i]=o.then?(await o)():o,e.s(["config",0,{api:{bodyParser:!1}},"default",()=>n]),a()}catch(e){a(e)}},!1),69389,e=>e.a(async(t,a)=>{try{var r=e.i(26747),s=e.i(90406),i=e.i(44898),o=e.i(62950),n=e.i(30986),c=e.i(7031),u=e.i(81927),p=e.i(46432),d=t([n]);[n]=d.then?(await d)():d;let E=(0,o.hoist)(n,"default"),_=(0,o.hoist)(n,"config"),m=new i.PagesAPIRouteModule({definition:{kind:s.RouteKind.PAGES_API,page:"/api/stripe/webhook",pathname:"/api/stripe/webhook",bundlePath:"",filename:""},userland:n,distDir:".next-build",relativeProjectDir:""});async function l(e,t,a){m.isDev&&(0,p.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let s="/api/stripe/webhook";s=s.replace(/\/index$/,"")||"/";let i=await m.prepare(e,t,{srcPage:s});if(!i){t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve());return}let{query:o,params:n,prerenderManifest:d,routerServerContext:l}=i;try{let a=e.method||"GET",r=(0,c.getTracer)(),i=r.getActiveScopeSpan(),p=m.instrumentationOnRequestError.bind(m),E=async i=>m.render(e,t,{query:{...o,...n},params:n,allowedRevalidateHeaderKeys:[],multiZoneDraftMode:!1,trustHostHeader:!1,previewProps:d.preview,propagateError:!1,dev:m.isDev,page:"/api/stripe/webhook",internalRevalidate:null==l?void 0:l.revalidate,onError:(...t)=>p(e,...t)}).finally(()=>{if(!i)return;i.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let e=r.getRootSpanAttributes();if(!e)return;if(e.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${e.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let o=e.get("next.route");if(o){let e=`${a} ${o}`;i.setAttributes({"next.route":o,"http.route":o,"next.span_name":e}),i.updateName(e)}else i.updateName(`${a} ${s}`)});i?await E(i):await r.withPropagatedContext(e.headers,()=>r.trace(u.BaseServerSpan.handleRequest,{spanName:`${a} ${s}`,kind:c.SpanKind.SERVER,attributes:{"http.method":a,"http.target":e.url}},E))}catch(e){if(m.isDev)throw e;(0,r.sendError)(t,500,"Internal Server Error")}finally{null==a.waitUntil||a.waitUntil.call(a,Promise.resolve())}}e.s(["config",0,_,"default",0,E,"handler",()=>l]),a()}catch(e){a(e)}},!1)];

//# sourceMappingURL=%5Broot-of-the-server%5D__da40ca68._.js.map