module.exports=[270406,(e,r,t)=>{r.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},992095,e=>e.a(async(r,t)=>{try{var o=e.i(196115),n=e.i(43712),a=r([n]);async function i(e,r){if("GET"!==e.method)return r.status(405).redirect(`/login?error=${encodeURIComponent("Method not allowed")}`);try{let t,a,i,{code:l,state:s,error:c}=e.query;if(c)return console.error("Google OAuth error:",c),r.redirect(`/login?error=${encodeURIComponent("OAuth authentication failed")}`);if(!l||!s)return console.error("Missing code or state in OAuth callback"),r.redirect(`/login?error=${encodeURIComponent("Invalid OAuth response")}`);let d=(e.headers.cookie?.split(";").reduce((e,r)=>{let[t,o]=r.trim().split("=");return e[t]=decodeURIComponent(o||""),e},{})||{}).oauth_state;if(!d||d!==s)return console.error("Invalid state token:",{cookieState:d,state:s}),r.redirect(`/login?error=${encodeURIComponent("Invalid state token")}`);r.setHeader("Set-Cookie","oauth_state=; HttpOnly; SameSite=Lax; Path=/; Max-Age=0");let{clientId:u,clientSecret:p}=o.config.oauth.google||{};if(!u||!p)return console.error("Google OAuth not configured"),r.redirect(`/login?error=${encodeURIComponent("OAuth not configured")}`);let h=`${o.config.oauth.redirectBaseUrl}/api/auth/oauth/google/callback`;try{t=await fetch("https://oauth2.googleapis.com/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({code:l,client_id:u,client_secret:p,redirect_uri:h,grant_type:"authorization_code"})})}catch(e){return console.error("Failed to fetch token from Google:",e),r.redirect(`/login?error=${encodeURIComponent("Failed to connect to Google")}`)}if(!t.ok){let e=await t.json().catch(()=>({error:"Unknown error"}));return console.error("Google token exchange error:",e),r.redirect(`/login?error=${encodeURIComponent("Failed to exchange token")}`)}let g=await t.json(),{access_token:m}=g;if(!m)return console.error("No access token in response:",g),r.redirect(`/login?error=${encodeURIComponent("No access token received")}`);try{a=await fetch("https://www.googleapis.com/oauth2/v2/userinfo",{headers:{Authorization:`Bearer ${m}`}})}catch(e){return console.error("Failed to fetch user info from Google:",e),r.redirect(`/login?error=${encodeURIComponent("Failed to get user info")}`)}if(!a.ok){let e=await a.text();return console.error("Google user info error:",e),r.redirect(`/login?error=${encodeURIComponent("Failed to get user info")}`)}let f=await a.json(),{id:v,email:w,name:U,picture:k}=f;if(!w)return console.error("No email in user info:",f),r.redirect(`/login?error=${encodeURIComponent("Email not provided by Google")}`);if(!v)return console.error("No provider ID in user info:",f),r.redirect(`/login?error=${encodeURIComponent("User ID not provided by Google")}`);try{i=await (0,n.registerOrLoginOAuthUser)({provider:"google",providerId:String(v),email:w,name:U||w.split("@")[0],avatarUrl:k||null})}catch(e){return console.error("Error in registerOrLoginOAuthUser:",{error:e.message,stack:e.stack,name:e.name}),r.redirect(`/login?error=${encodeURIComponent(`Failed to create user: ${e.message||"Unknown error"}`)}`)}if(!i||!i.user)return console.error("Invalid result from registerOrLoginOAuthUser:",i),r.redirect(`/login?error=${encodeURIComponent("Failed to authenticate")}`);let y=i.sessionToken;if(!y){console.error("No session token in result, creating manually:",i);try{y=(await (0,n.createUserSession)(i.user.id)).sessionToken}catch(e){return console.error("Error creating session manually:",e),r.redirect(`/login?error=${encodeURIComponent("Failed to create session")}`)}}if(!y)return console.error("No session token available after all attempts"),r.redirect(`/login?error=${encodeURIComponent("Failed to create session")}`);return r.setHeader("Set-Cookie",`megapixelai_session=${y}; HttpOnly; SameSite=Lax; Path=/; Max-Age=604800`),r.redirect("/dashboard?welcome=true")}catch(e){return console.error("Google OAuth callback unexpected error:",e),r.redirect(`/login?error=${encodeURIComponent("Authentication error")}`)}}[n]=a.then?(await a)():a,e.s(["default",()=>i]),t()}catch(e){t(e)}},!1),770538,e=>e.a(async(r,t)=>{try{var o=e.i(926747),n=e.i(190406),a=e.i(244898),i=e.i(262950),l=e.i(992095),s=e.i(7031),c=e.i(181927),d=e.i(846432),u=r([l]);[l]=u.then?(await u)():u;let h=(0,i.hoist)(l,"default"),g=(0,i.hoist)(l,"config"),m=new a.PagesAPIRouteModule({definition:{kind:n.RouteKind.PAGES_API,page:"/api/auth/oauth/google/callback",pathname:"/api/auth/oauth/google/callback",bundlePath:"",filename:""},userland:l,distDir:".next-build",relativeProjectDir:""});async function p(e,r,t){m.isDev&&(0,d.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let n="/api/auth/oauth/google/callback";n=n.replace(/\/index$/,"")||"/";let a=await m.prepare(e,r,{srcPage:n});if(!a){r.statusCode=400,r.end("Bad Request"),null==t.waitUntil||t.waitUntil.call(t,Promise.resolve());return}let{query:i,params:l,prerenderManifest:u,routerServerContext:p}=a;try{let t=e.method||"GET",o=(0,s.getTracer)(),a=o.getActiveScopeSpan(),d=m.instrumentationOnRequestError.bind(m),h=async a=>m.render(e,r,{query:{...i,...l},params:l,allowedRevalidateHeaderKeys:[],multiZoneDraftMode:!1,trustHostHeader:!1,previewProps:u.preview,propagateError:!1,dev:m.isDev,page:"/api/auth/oauth/google/callback",internalRevalidate:null==p?void 0:p.revalidate,onError:(...r)=>d(e,...r)}).finally(()=>{if(!a)return;a.setAttributes({"http.status_code":r.statusCode,"next.rsc":!1});let e=o.getRootSpanAttributes();if(!e)return;if(e.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${e.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let i=e.get("next.route");if(i){let e=`${t} ${i}`;a.setAttributes({"next.route":i,"http.route":i,"next.span_name":e}),a.updateName(e)}else a.updateName(`${t} ${n}`)});a?await h(a):await o.withPropagatedContext(e.headers,()=>o.trace(c.BaseServerSpan.handleRequest,{spanName:`${t} ${n}`,kind:s.SpanKind.SERVER,attributes:{"http.method":t,"http.target":e.url}},h))}catch(e){if(m.isDev)throw e;(0,o.sendError)(r,500,"Internal Server Error")}finally{null==t.waitUntil||t.waitUntil.call(t,Promise.resolve())}}e.s(["config",0,g,"default",0,h,"handler",()=>p]),t()}catch(e){t(e)}},!1),139867,e=>{e.v(r=>Promise.all(["server/chunks/[root-of-the-server]__f3c1913e._.js"].map(r=>e.l(r))).then(()=>r(545255)))},970795,e=>{e.v(r=>Promise.all(["server/chunks/[root-of-the-server]__bc724f60._.js"].map(r=>e.l(r))).then(()=>r(328112)))}];

//# sourceMappingURL=%5Broot-of-the-server%5D__9fd0a660._.js.map