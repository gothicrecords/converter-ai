module.exports=[814747,(e,t,r)=>{t.exports=e.x("path",()=>require("path"))},270406,(e,t,r)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},522734,(e,t,r)=>{t.exports=e.x("fs",()=>require("fs"))},293635,e=>e.a(async(t,r)=>{try{let t=await e.y("formidable");e.n(t),r()}catch(e){r(e)}},!0),446786,(e,t,r)=>{t.exports=e.x("os",()=>require("os"))},829211,(e,t,r)=>{t.exports=e.x("mammoth",()=>require("mammoth"))},74538,e=>e.a(async(t,r)=>{try{let t=await e.y("openai");e.n(t),r()}catch(e){r(e)}},!0),267370,e=>e.a(async(t,r)=>{try{var i=e.i(74538),a=t([i]);[i]=a.then?(await a)():a;let E=new i.default({apiKey:process.env.OPENAI_API_KEY});async function n(e){if(!process.env.OPENAI_API_KEY)throw Error("OPENAI_API_KEY is not configured. Please set it in your environment variables.");try{return(await E.embeddings.create({model:"text-embedding-3-small",input:e.substring(0,8e3)})).data[0].embedding}catch(e){throw console.error("Error generating embedding:",e),Error(`Failed to generate embedding: ${e.message}`)}}async function o(e){if(!process.env.OPENAI_API_KEY)throw Error("OPENAI_API_KEY is not configured. Please set it in your environment variables.");if(!Array.isArray(e)||0===e.length)return[];try{return(await E.embeddings.create({model:"text-embedding-3-small",input:e.map(e=>(e||"").toString().substring(0,8e3))})).data.map(e=>e.embedding)}catch(e){throw console.error("Error generating batch embeddings:",e),Error(`Failed to generate batch embeddings: ${e.message}`)}}async function s(e,t={}){if(!process.env.OPENAI_API_KEY)throw Error("OPENAI_API_KEY is not configured. Please set it in your environment variables.");try{return(await E.chat.completions.create({model:t.model||"gpt-4o-mini",messages:e,temperature:t.temperature||.7,max_tokens:t.max_tokens||1e3,top_p:t.top_p||1,frequency_penalty:t.frequency_penalty||0,presence_penalty:t.presence_penalty||0})).choices[0].message.content}catch(e){if(console.error("Error in chat completion:",e),401===e.status)throw Error("Chiave API OpenAI non valida. Verifica la configurazione.");if(429===e.status)throw Error("Limite di rate raggiunto. Riprova tra qualche secondo.");if(500===e.status)throw Error("Errore del server OpenAI. Riprova più tardi.");throw Error(`Errore nella comunicazione con OpenAI: ${e.message}`)}}async function l(e,t=200){let r=[{role:"system",content:"You are a helpful assistant that creates concise summaries."},{role:"user",content:`Summarize the following text in ${t} words or less:

${e}`}];return await s(r,{temperature:.5,max_tokens:300})}async function c(e,t=5){let r=[{role:"system",content:"You are a helpful assistant that generates relevant tags for documents. Return only comma-separated tags, no explanations."},{role:"user",content:`Generate ${t} relevant tags for this document:

${e.substring(0,2e3)}`}];return(await s(r,{temperature:.3,max_tokens:100})).split(",").map(e=>e.trim().toLowerCase()).filter(e=>e.length>0).slice(0,t)}async function u(e){let t=["contract","invoice","report","presentation","spreadsheet","image","code","email","article","other"],r=[{role:"system",content:`You are a document classifier. Classify the document into one or more of these categories: ${t.join(", ")}. Return only category names, comma-separated.`},{role:"user",content:`Classify this document:

${e.substring(0,1e3)}`}];return(await s(r,{temperature:.2,max_tokens:50})).split(",").map(e=>e.trim().toLowerCase()).filter(e=>t.includes(e))}async function m(e,t,r="Cosa contiene questa immagine? Descrivi tutto ciò che vedi."){if(!process.env.OPENAI_API_KEY)throw Error("OPENAI_API_KEY is not configured. Please set it in your environment variables.");try{let i=e.toString("base64");return(await E.chat.completions.create({model:"gpt-4o",messages:[{role:"system",content:"Sei un assistente AI esperto nell'analisi di immagini. Descrivi in dettaglio tutto ciò che vedi nell'immagine, inclusi testo, oggetti, persone, scene, colori e qualsiasi altro dettaglio rilevante. Rispondi sempre in italiano."},{role:"user",content:[{type:"text",text:r},{type:"image_url",image_url:{url:`data:${t};base64,${i}`,detail:"high"}}]}],max_tokens:2e3,temperature:.2})).choices[0].message.content}catch(e){if(console.error("Error in vision API:",e),401===e.status)throw Error("Chiave API OpenAI non valida. Verifica la configurazione.");if(429===e.status)throw Error("Limite di rate raggiunto. Riprova tra qualche secondo.");if(400===e.status&&e.message?.includes("image"))throw Error("Formato immagine non supportato o immagine troppo grande.");throw Error(`Errore nell'analisi dell'immagine: ${e.message}`)}}async function d(t){if(!process.env.OPENAI_API_KEY)throw Error("OPENAI_API_KEY is not configured. Please set it in your environment variables.");let r=await e.A(323970),i=null;try{i=await E.files.create({file:r.createReadStream(t),purpose:"user_data"});let e=((await E.responses.create({model:"gpt-4o",input:[{role:"user",content:[{type:"input_text",text:"Estrai tutto il testo e le informazioni rilevanti da questo documento. Rispondi SOLO con il testo estratto, senza commenti."},{type:"input_file",file_id:i.id}]}],max_output_tokens:8e3,temperature:.1})).output_text||"").toString().trim();if(!e)throw Error("Nessun testo estratto dal PDF");return e}catch(e){if(console.error("Error in PDF text extraction (Responses API):",e),401===e.status)throw Error("Chiave API OpenAI non valida. Verifica la configurazione.");if(429===e.status)throw Error("Limite di rate raggiunto. Riprova tra qualche secondo.");if(400===e.status)throw Error("Errore nell'analisi del PDF con Responses API. Il file potrebbe essere troppo grande o danneggiato.");throw Error(`Errore nell'estrazione del testo PDF: ${e.message}`)}finally{try{i&&i.id&&(E.files?.delete?await E.files.delete(i.id):E.files?.del&&await E.files.del(i.id))}catch(e){console.warn("Errore rimozione file da OpenAI (ignorato):",e?.message||e)}}}async function p(e,t={}){if(!process.env.OPENAI_API_KEY)throw Error("OPENAI_API_KEY is not configured. Please set it in your environment variables.");try{let r=t.size||"1024x1024",i=t.quality||"standard",a=t.style||"vivid",n=await E.images.generate({model:"dall-e-3",prompt:e,size:r,quality:i,style:a,n:1}),o=n.data[0]?.url;if(!o)throw Error("Nessuna immagine generata da DALL-E");return o}catch(e){if(console.error("Error getting image URL from DALL-E:",e),console.error("Error details:",{status:e.status,statusText:e.statusText,message:e.message,code:e.code,response:e.response?.data||e.response}),401===e.status)throw Error("Chiave API OpenAI non valida. Verifica la configurazione.");if(429===e.status)throw Error("Limite di rate raggiunto. Riprova tra qualche secondo.");if(400===e.status){let t=e.message||e.response?.data?.error?.message||"Prompt non valido o contenuto non consentito";throw Error(`Errore nella generazione: ${t}`)}else if("ENOTFOUND"===e.code||"ECONNREFUSED"===e.code)throw Error("Errore di connessione con OpenAI. Verifica la tua connessione internet.");throw Error(`Errore nella generazione dell'immagine: ${e.message||"Errore sconosciuto"}`)}}async function g(e,t={}){if(!process.env.OPENAI_API_KEY)throw Error("OPENAI_API_KEY is not configured. Please set it in your environment variables.");try{let r=await p(e,t),i=await fetch(r);if(!i.ok){let e=await i.text().catch(()=>"Unknown error");throw Error(`Errore nel download dell'immagine generata: ${i.status} ${i.statusText}. ${e}`)}let a=await i.arrayBuffer();return Buffer.from(a)}catch(e){throw e}}async function f(e,t,r=null){if(!process.env.OPENAI_API_KEY)throw Error("OPENAI_API_KEY is not configured. Please set it in your environment variables.");try{let i=await m(e,t,r||"Descrivi in dettaglio questa immagine, includendo tutti i dettagli visivi, colori, composizione, stile e qualità. La descrizione sarà usata per creare una versione migliorata ad alta risoluzione."),a=`Crea una versione migliorata e ad alta risoluzione di questa immagine: ${i}. Mantieni fedelt\xe0 ai dettagli originali ma migliora la qualit\xe0, la nitidezza e la risoluzione.`;return await g(a,{size:"1792x1024",quality:"hd",style:"natural"})}catch(e){throw console.error("Error upscaling image with DALL-E:",e),Error(`Errore nel miglioramento dell'immagine: ${e.message}`)}}async function h(t,r){if(!process.env.OPENAI_API_KEY)throw Error("OPENAI_API_KEY is not configured. Please set it in your environment variables.");try{let i=`Analyze this image and identify specific quality issues that need improvement. Focus on:
1. Noise level (low/medium/high)
2. Sharpness (blurry/sharp)
3. Color accuracy (washed out/vibrant)
4. Artifacts (compression artifacts, pixelation)
5. Overall quality issues

Respond with a JSON object: {"noise": "low|medium|high", "sharpness": "blurry|moderate|sharp", "color": "washed|normal|vibrant", "artifacts": "none|minor|major", "recommendations": "brief description"}`,a=await m(t,r,i),n={noise:"medium",sharpness:"moderate",color:"normal",artifacts:"none"};try{let e=a.match(/\{[\s\S]*\}/);if(e){let t=JSON.parse(e[0]);n={...n,...t}}}catch(e){console.warn("Could not parse AI analysis, using defaults")}let o=(0,(await e.A(752039)).default)(t,{sequentialRead:!0});return("high"===n.noise||"medium"===n.noise)&&(o=o.median("high"===n.noise?3:2)),"blurry"===n.sharpness?o=o.sharpen({sigma:2,m1:1,m2:.5,x1:3,y2:3,y3:3}):"moderate"===n.sharpness&&(o=o.sharpen({sigma:1,m1:.7,m2:.4})),"washed"===n.color&&(o=o.modulate({saturation:1.15,brightness:1.05}).linear(1.05,-6.4)),o="major"===n.artifacts||"minor"===n.artifacts?o.png({quality:100,compressionLevel:6,adaptiveFiltering:!0}):"image/jpeg"===r||"image/jpg"===r?o.jpeg({quality:98,mozjpeg:!0,trellisQuantisation:!0,overshootDeringing:!0}):o.png({quality:100,compressionLevel:6}),await o.toBuffer()}catch(e){return console.error("Error enhancing image quality with AI:",e),t}}e.s(["analyzeImageWithVision",()=>m,"chatCompletion",()=>s,"classifyDocument",()=>u,"enhanceImageQualityWithAI",()=>h,"extractTextFromPdfWithOpenAI",()=>d,"generateEmbedding",()=>n,"generateEmbeddingsBatch",()=>o,"generateImageWithDALLE",()=>g,"generateSummary",()=>l,"generateTags",()=>c,"getImageUrlFromDALLE",()=>p,"upscaleImageWithDALLE",()=>f]),r()}catch(e){r(e)}},!1),516969,(e,t,r)=>{t.exports=e.x("xlsx",()=>require("xlsx"))},162069,e=>e.a(async(t,r)=>{try{var i=e.i(829211),a=e.i(516969),n=e.i(267370),o=t([n]);[n]=o.then?(await o)():o;let f=new Map;async function s(t,r,n,o=null){try{let s="",l={filename:n,mimeType:r,pages:0,wordCount:0};if("application/pdf"===r||n.toLowerCase().endsWith(".pdf")){let{extractTextFromPdfWithOpenAI:r}=await e.A(425775),i=await e.A(323970),a=await e.A(589793),o=(await e.A(707480)).tmpdir(),c=a.join(o,`temp_${Date.now()}_${n}`);try{if(i.writeFileSync(c,t),s=((s=await r(c))||"").toString().trim(),l.analysisMethod="openai-file-upload",!s||0===s.length)throw Error("Nessun testo estratto dal PDF tramite OpenAI")}finally{try{i.existsSync(c)&&i.unlinkSync(c)}catch(e){console.warn("Errore pulizia file temporaneo:",e)}}}else if(r.includes("wordprocessingml")||n.toLowerCase().endsWith(".docx"))s=(s=(await i.default.extractRawText({buffer:t})).value).replace(/\s+/g," ").trim();else if(r.includes("spreadsheet")||n.toLowerCase().match(/\.(xlsx|xls|csv)$/i)){let e=a.read(t,{type:"buffer"}),r=e.SheetNames,i=[];for(let t of r){let r=e.Sheets[t];for(let e of a.utils.sheet_to_json(r,{header:1,defval:""}))if(Array.isArray(e)){let r=e.filter(e=>e&&e.toString().trim()).join(" ");r.trim()&&i.push(`[${t}] ${r}`)}}s=i.join("\n")}else if(r.startsWith("text/")||n.toLowerCase().endsWith(".txt"))s=t.toString("utf-8");else if(r.startsWith("image/")||n.toLowerCase().match(/\.(png|jpg|jpeg|gif|webp|bmp|tif|tiff|heic|heif)$/i))try{let{analyzeImageWithVision:i}=await e.A(425775);try{s=await i(t,r,"Analizza questa immagine in dettaglio. Descrivi tutto ciò che vedi, incluso qualsiasi testo presente, oggetti, persone, scene, colori e dettagli rilevanti. Se c'è del testo, trascrivilo accuratamente."),l.analysisMethod="openai-vision"}catch(a){let r=(await e.A(735943)).default,i=o||t;try{s=(await r.recognize(i,"ita+eng",{logger:e=>{e.status}})).data.text.trim(),l.analysisMethod="ocr-tesseract"}catch(t){let e=await r.createWorker("ita+eng",1,{logger:e=>{e.status}});try{s=(await e.recognize(i)).data.text.trim(),l.analysisMethod="ocr-tesseract-worker"}finally{await e.terminate()}}}if(!s||0===s.length)throw Error("Nessun contenuto estratto dall'immagine. L'immagine potrebbe essere vuota o non contenere testo leggibile.")}catch(e){throw console.error("Errore analisi immagine completo:",e),Error(`Errore nell'analisi dell'immagine: ${e.message}`)}else throw Error(`Tipo di file non supportato: ${r}`);if(!s||0===s.trim().length)throw Error("Nessun testo estratto dal documento");return l.wordCount=s.split(/\s+/).length,{text:s,metadata:l}}catch(e){throw console.error("Errore estrazione testo:",e),Error(`Errore nell'estrazione del testo: ${e.message}`)}}async function l(t,r=1e3,i=200){let a=t.split(/[.!?]+\s+/).filter(e=>e.trim().length>10),n=[],o="",s=0;for(let e of a){let a=e.length;s+a>r&&o.trim()?(n.push({text:o.trim(),startIndex:t.indexOf(o.trim()),endIndex:t.indexOf(o.trim())+o.length}),s=(o=o.split(/\s+/).slice(-Math.floor(i/10)).join(" ")+" "+e+" ").length):(o+=e+". ",s+=a+2)}o.trim()&&n.push({text:o.trim(),startIndex:t.indexOf(o.trim()),endIndex:t.length});let c=n.length>0?n:[{text:t.trim(),startIndex:0,endIndex:t.length}],{generateEmbeddingsBatch:u}=await e.A(425775);try{for(let e=0;e<c.length;e+=16){let t=c.slice(e,e+16);(await u(t.map(e=>e.text))).forEach((e,r)=>{t[r].embedding=e})}}catch(r){console.warn("Batch embeddings failed, falling back to per-chunk:",r.message);let{generateEmbedding:t}=await e.A(425775);for(let e of c)try{e.embedding=await t(e.text)}catch(t){console.warn("Errore generazione embedding per chunk:",t.message),e.embedding=null}}return c}async function c(t,r,i,a=5){if(!r||0===r.length)return[];let{generateEmbedding:n}=await e.A(425775),o=null;try{o=await n(i)}catch(e){console.warn("Errore generazione embedding query, uso TF-IDF:",e)}return r.map((e,t)=>{let r=0;r=o&&e.embedding?function(e,t){if(!e||!t||e.length!==t.length)return 0;let r=e.reduce((e,r,i)=>e+r*t[i],0),i=Math.sqrt(e.reduce((e,t)=>e+t*t,0)),a=Math.sqrt(t.reduce((e,t)=>e+t*t,0));return r/(i*a)}(o,e.embedding):function(e,t){let r=e.toLowerCase().split(/\W+/).filter(e=>e.length>2),i=t.toLowerCase().split(/\W+/).filter(e=>e.length>2);if(0===i.length)return 0;let a=0,n={};return r.forEach(e=>{n[e]=(n[e]||0)+1}),i.forEach(e=>{let t=n[e]||0;if(t>0){let e=t/r.length,i=Math.log(r.length/(t+1))+1;a+=e*i}}),a/i.length}(e.text,i)/10;let a=e.text.toLowerCase(),n=i.toLowerCase(),s=0;a.includes(n)&&(s=.1);let l=i.toLowerCase().split(/\W+/).filter(e=>e.length>2),c=l.filter(e=>a.includes(e)).length/l.length*.05,u=r+s+c;return{...e,score:u,index:t}}).sort((e,t)=>t.score-e.score).slice(0,a).filter(e=>e.score>=0)}async function u(e,t,r,i="",a={}){if(!t||0===t.length)return{answer:"Non ho trovato informazioni rilevanti nel documento per rispondere alla tua domanda. Prova a formulare la domanda in modo diverso o carica un documento più pertinente.",confidence:0,sources:[]};let o=t.map((e,t)=>`[Sezione ${t+1}]
${e.text}`).join("\n\n---\n\n"),s=Math.min(10*t[0].score,1);try{let r="";i&&i.trim()&&(r=`

**CONTESTO DELLA CONVERSAZIONE PRECEDENTE:**
${i}

Usa questo contesto per capire meglio la domanda e fornire una risposta coerente con la conversazione.`);let l=[{role:"system",content:`Sei un assistente AI esperto nell'analisi di documenti. Segui un ragionamento interno SILENTE (non mostrarlo) con i passi: 1) Identifica concetti chiave 2) Seleziona parti rilevanti 3) Sintetizza relazioni 4) Verifica contraddizioni o assenze 5) Struttura risposta finale. Poi produci SOLO l'output formattato.

OBIETTIVI:
1. Analisi accurata delle sezioni fornite
2. Risposta logica e coerente basata esclusivamente sul contenuto
3. Struttura chiara e professionale in italiano
4. Citazione delle fonti/Sezioni rilevanti
5. Nessuna invenzione: se manca l'informazione, dichiaralo e suggerisci cosa servirebbe

FORMATTA LA RISPOSTA CON LE SEZIONI (usa markdown semplice):
**Risposta**: sintesi principale diretta alla domanda.
**Dettagli**: approfondisci punti chiave organizzati.
**Fonti**: elenco puntato con sezione e breve estratto.
**Limiti**: cosa non \xe8 presente o ambiguo.
**Suggerimenti**: eventuali passi successivi o chiarimenti da richiedere.

Regole:
- Non includere il ragionamento interno.
- Non scusarti a meno che il contenuto sia realmente assente.
- Mantieni tono professionale, conciso ma completo.`},{role:"user",content:`Analizza il seguente contenuto estratto dal documento e rispondi alla domanda dell'utente in modo completo e accurato.

**CONTENUTO DEL DOCUMENTO:**
${o}${r}

**DOMANDA DELL'UTENTE:**
${e}

**ISTRUZIONI:**
- Rispondi basandoti SOLO sul contenuto fornito sopra
- Se la risposta richiede informazioni non presenti, dillo chiaramente
- Cita o fai riferimento alle sezioni rilevanti quando possibile
- Fornisci una risposta completa e ben strutturata
- Considera il contesto della conversazione se fornito per una risposta pi\xf9 pertinente`}],c=await (0,n.chatCompletion)(l,{model:"gpt-4o-mini",temperature:.2,max_tokens:1200,top_p:.9,frequency_penalty:.1,presence_penalty:.1});return c=c.trim(),/mi dispiace|non posso/i.test(c)&&c.length<120&&(c=`**Risposta**: Informazioni limitate nel testo fornito.
**Dettagli**:
${t.slice(0,3).map(e=>"- "+e.text.substring(0,200).replace(/\n+/g," ")+(e.text.length>200?"...":"")).join("\n")}
**Fonti**:
${t.map((e,t)=>`- Sezione ${t+1} (score ${e.score.toFixed(3)})`).join("\n")}
**Limiti**: Il documento sembra contenere testo estremamente breve o generico.
**Suggerimenti**: Carica un documento pi\xf9 esteso oppure specifica meglio la domanda.`),{answer:c,confidence:s,sources:t.map(e=>({filename:a?.originalFilename||a?.filename||"Documento",text:e.text.substring(0,150)+"...",score:e.score.toFixed(3)}))}}catch(r){console.error("Errore nella generazione della risposta con OpenAI:",r);let e=t[0].text;return{answer:`Basandomi sul documento:

${e}

${t.length>1?"\nInformazioni aggiuntive:\n"+t.slice(1,3).map((e,t)=>`• ${e.text.substring(0,200)}...`).join("\n"):""}`,confidence:s,sources:t.map(e=>({filename:a?.originalFilename||a?.filename||"Documento",text:e.text.substring(0,150)+"...",score:e.score.toFixed(3)}))}}}async function m(e,t,r={}){let i=await l(t),a={text:t,chunks:i,metadata:{...r,filename:r.filename||r.originalFilename||"Unknown",storedAt:new Date().toISOString(),chunkCount:i.length}};return f.set(e,a),{fileId:e,chunkCount:i.length,wordCount:t.split(/\s+/).length}}async function d(e,t=null){let r=t&&t.length>0?t.map(e=>{let t=f.get(e);return{id:e,data:t}}).filter(e=>e.data):Array.from(f.entries()).map(([e,t])=>({id:e,data:t}));if(0===r.length)return[];let i=[];for(let{id:t,data:a}of r){if(!a||!a.chunks||!a.chunks.length)continue;let r=await c(a.text,a.chunks,e,5);r.length>0&&i.push({fileId:t,filename:a.metadata?.originalFilename||a.metadata?.filename||"Unknown",results:r,topScore:r[0].score})}return i.sort((e,t)=>t.topScore-e.topScore)}async function p(e,t,r=""){var i;if(!t||0===t.length)return{answer:"Non ho trovato informazioni rilevanti nei documenti caricati. Prova a formulare la domanda in modo diverso o carica documenti più pertinenti.",confidence:0,sources:[]};let a=t.flatMap(e=>e.results.map(t=>({...t,filename:e.filename,fileId:e.fileId}))).sort((e,t)=>t.score-e.score).slice(0,5);if(0===a.length)return{answer:"Non ho trovato informazioni sufficienti per rispondere.",confidence:0,sources:[]};let o=a[0],s=(i=o.fileId,f.get(i));if(1===t.length)return await u(e,a,s.text,r,s.metadata||{});{let i=Math.min(10*o.score,1);try{let o=a.map((e,t)=>`[Documento: "${e.filename}" - Sezione ${t+1}]
${e.text}`).join("\n\n---\n\n"),s="";r&&r.trim()&&(s=`

**CONTESTO DELLA CONVERSAZIONE PRECEDENTE:**
${r}

Usa questo contesto per capire meglio la domanda e fornire una risposta coerente con la conversazione.`);let l=[{role:"system",content:`Sei un assistente AI esperto nell'analisi di documenti multipli. Usa ragionamento interno SILENTE (non mostrarlo) seguendo: 1) Mappa concetti per documento 2) Trova sovrapposizioni/contrasti 3) Sintetizza 4) Valuta completezza 5) Struttura output. Non mostrare i passi.

FORMATTA OUTPUT:
**Risposta** (sintesi diretta alla domanda)
**Analisi** (integrazione logica tra documenti, relazioni, eventuali differenze)
**Fonti** (elenco: Documento – breve estratto pertinente)
**Limiti** (informazioni mancanti, contraddizioni non risolte)
**Suggerimenti** (cosa potrebbe aiutare o prossimi passi)

Regole:
- Non inventare contenuto
- Non scusarti salvo assenza totale di informazioni
- Cita il nome del documento per ogni informazione specifica
- Indica contraddizioni se presenti.`},{role:"user",content:`Analizza il contenuto estratto da ${t.length} documenti diversi e rispondi alla domanda dell'utente sintetizzando le informazioni rilevanti.

**CONTENUTO DAI DOCUMENTI:**
${o}${s}

**DOMANDA DELL'UTENTE:**
${e}

**ISTRUZIONI:**
- Combina informazioni da tutti i documenti rilevanti
- Cita sempre il nome del documento quando fai riferimento a informazioni specifiche
- Se ci sono informazioni correlate in pi\xf9 documenti, integrale in modo coerente
- Fornisci una risposta completa che risponda alla domanda utilizzando tutte le fonti pertinenti
- Considera il contesto della conversazione se fornito per una risposta pi\xf9 pertinente`}],c=await (0,n.chatCompletion)(l,{model:"gpt-4o-mini",temperature:.2,max_tokens:1500,top_p:.9,frequency_penalty:.1,presence_penalty:.1});if(c=c.trim(),/mi dispiace|non posso/i.test(c)&&c.length<140){let e=a.slice(0,5).map((e,t)=>`- ${e.filename} [score ${e.score.toFixed(3)}]: ${e.text.substring(0,160).replace(/\n+/g," ")}${e.text.length>160?"...":""}`).join("\n");c=`**Risposta**: Informazioni limitate ma estratte dai documenti.
**Analisi**: I contenuti disponibili sono molto brevi; non emergono argomentazioni complesse.
**Fonti**:
${e}
**Limiti**: Poca profondit\xe0; serve testo aggiuntivo.
**Suggerimenti**: Carica versioni pi\xf9 complete dei documenti o specifica una domanda pi\xf9 dettagliata.`}return{answer:c,confidence:i,sources:a.slice(0,3).map(e=>({filename:e.filename,text:e.text.substring(0,100)+"...",score:e.score.toFixed(3)}))}}catch(i){console.error("Errore nella generazione della risposta multi-documento con OpenAI:",i);let e=`Basandomi sui ${t.length} documenti caricati:

`;if(e+=`**Dal documento "${o.filename}":**
${o.text}

`,a.length>1){let t=a.slice(1,3).filter(e=>e.fileId!==o.fileId);t.length>0&&(e+=`**Informazioni correlate da altri documenti:**
`,t.forEach((t,r)=>{e+=`
[${r+1}] Da "${t.filename}":
${t.text.substring(0,200)}...
`}))}let r=Math.min(10*o.score,1);return{answer:e.trim(),confidence:r,sources:a.slice(0,3).map(e=>({filename:e.filename,text:e.text.substring(0,100)+"...",score:e.score.toFixed(3)}))}}}}function g(){let e=Array.from(f.values());return{totalDocuments:f.size,totalWords:e.reduce((e,t)=>e+(t.text.split(/\s+/).length||0),0),totalChunks:e.reduce((e,t)=>e+(t.chunks?.length||0),0),documents:Array.from(f.entries()).map(([e,t])=>({fileId:e,index:Array.from(f.keys()).indexOf(e),filename:t.metadata?.filename||t.metadata?.originalFilename||"Unknown",wordCount:t.text.split(/\s+/).length,chunkCount:t.chunks?.length||0,storedAt:t.metadata?.storedAt}))}}e.s(["extractTextFromDocument",()=>s,"generateMultiDocumentAnswer",()=>p,"getDocumentStats",()=>g,"searchAllDocuments",()=>d,"storeDocument",()=>m]),r()}catch(e){r(e)}},!1),696351,e=>e.a(async(t,r)=>{try{let t=await e.y("uuid");e.n(t),r()}catch(e){r(e)}},!0),681321,e=>e.a(async(t,r)=>{try{var i=e.i(293635),a=e.i(522734),n=e.i(814747),o=e.i(446786),s=e.i(162069),l=e.i(696351),c=t([i,s,l]);async function u(e,t){if("POST"!==e.method)return t.status(405).json({error:"Method not allowed"});try{let r=!!process.env.VERCEL,c=r?Number(process.env.VERCEL_MAX_MB||25):200,u=r?Number(process.env.VERCEL_MAX_FILES||5):10;process.env.VERCEL||o.default.tmpdir();let m=process.env.VERCEL?"/tmp":n.default.join(process.cwd(),"uploads","chat");process.env.VERCEL||a.default.existsSync(m)||a.default.mkdirSync(m,{recursive:!0});let d=(0,i.default)({uploadDir:m,keepExtensions:!0,maxFileSize:1024*c*1024,multiples:!0}),[p,g]=await new Promise((t,r)=>{d.parse(e,(e,i,a)=>{e?r(e):t([i,a])})}),f=Array.isArray(g.files)?g.files:[g.files].filter(Boolean);if(!f||0===f.length)return t.status(400).json({error:"Nessun file caricato"});if(f.length>u)return t.status(400).json({error:`Numero massimo di file per analisi superato: ${f.length} > ${u}`,details:r?`Limite Vercel: ${u} file per richiesta (riduci o usa caricamento diretto su storage).`:`Carica al massimo ${u} file per volta.`,limit:u});for(let e of f){let i=e.size||(e.filepath&&a.default.existsSync(e.filepath)?a.default.statSync(e.filepath).size:0);if(i>1024*c*1024)return t.status(413).json({error:`File troppo grande: ${(i/1048576).toFixed(1)}MB > ${c}MB`,details:r?`Le funzioni serverless Vercel hanno un limite di payload. Usa file pi\xf9 piccoli, carica direttamente su storage (Vercel Blob/S3) o esegui in ambiente non serverless.`:"Riduci la dimensione del file o carica meno contenuti.",limitMB:c})}let h=async e=>{try{let t,r,i=a.default.readFileSync(e.filepath),n=e.originalFilename||e.newFilename,o=e.mimetype||"application/octet-stream";try{let a=await (0,s.extractTextFromDocument)(i,o,n,e.filepath);t=a.text,r=a.metadata||{}}catch(e){return console.error(`Error extracting text from ${n}:`,e),{filename:n,success:!1,error:`Errore estrazione testo: ${e.message}`}}if(!t||0===t.trim().length)return console.warn(`No text extracted from ${n}`),{filename:n,success:!1,error:"Nessun testo estratto dal documento"};let c=(0,l.v4)(),u=await (0,s.storeDocument)(c,t,{...r,originalFilename:n,filename:n,mimeType:o,uploadedAt:new Date().toISOString(),size:i.length});try{a.default.unlinkSync(e.filepath)}catch(e){console.warn("Errore eliminazione file temporaneo:",e)}return{fileId:c,filename:n,success:!0,wordCount:u.wordCount,chunkCount:u.chunkCount,pages:r.pages||0,size:i.length}}catch(t){return console.error("Errore processamento file:",t),{filename:e.originalFilename||e.newFilename,success:!1,error:t.message||"Errore durante il processamento"}}},E=r?1:3,w=[];for(let e=0;e<f.length;e+=E){let t=f.slice(e,e+E),r=await Promise.all(t.map(h));w.push(...r)}let y=w.filter(e=>e.success).length;return t.status(200).json({success:y>0,files:w,message:`${y} file analizzati con successo`})}catch(e){return console.error("Upload error:",e),t.status(500).json({error:"Errore durante il caricamento",details:e.message})}}[i,s,l]=c.then?(await c)():c,e.s(["config",0,{api:{bodyParser:!1}},"default",()=>u]),r()}catch(e){r(e)}},!1),399194,e=>e.a(async(t,r)=>{try{var i=e.i(926747),a=e.i(190406),n=e.i(244898),o=e.i(262950),s=e.i(681321),l=e.i(7031),c=e.i(181927),u=e.i(846432),m=t([s]);[s]=m.then?(await m)():m;let p=(0,o.hoist)(s,"default"),g=(0,o.hoist)(s,"config"),f=new n.PagesAPIRouteModule({definition:{kind:a.RouteKind.PAGES_API,page:"/api/chat/upload-document",pathname:"/api/chat/upload-document",bundlePath:"",filename:""},userland:s,distDir:".next-build",relativeProjectDir:""});async function d(e,t,r){f.isDev&&(0,u.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let a="/api/chat/upload-document";a=a.replace(/\/index$/,"")||"/";let n=await f.prepare(e,t,{srcPage:a});if(!n){t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve());return}let{query:o,params:s,prerenderManifest:m,routerServerContext:d}=n;try{let r=e.method||"GET",i=(0,l.getTracer)(),n=i.getActiveScopeSpan(),u=f.instrumentationOnRequestError.bind(f),p=async n=>f.render(e,t,{query:{...o,...s},params:s,allowedRevalidateHeaderKeys:[],multiZoneDraftMode:!1,trustHostHeader:!1,previewProps:m.preview,propagateError:!1,dev:f.isDev,page:"/api/chat/upload-document",internalRevalidate:null==d?void 0:d.revalidate,onError:(...t)=>u(e,...t)}).finally(()=>{if(!n)return;n.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let e=i.getRootSpanAttributes();if(!e)return;if(e.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${e.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let o=e.get("next.route");if(o){let e=`${r} ${o}`;n.setAttributes({"next.route":o,"http.route":o,"next.span_name":e}),n.updateName(e)}else n.updateName(`${r} ${a}`)});n?await p(n):await i.withPropagatedContext(e.headers,()=>i.trace(c.BaseServerSpan.handleRequest,{spanName:`${r} ${a}`,kind:l.SpanKind.SERVER,attributes:{"http.method":r,"http.target":e.url}},p))}catch(e){if(f.isDev)throw e;(0,i.sendError)(t,500,"Internal Server Error")}finally{null==r.waitUntil||r.waitUntil.call(r,Promise.resolve())}}e.s(["config",0,g,"default",0,p,"handler",()=>d]),r()}catch(e){r(e)}},!1),323970,e=>{e.v(e=>Promise.resolve().then(()=>e(522734)))},752039,e=>{e.v(t=>Promise.all(["server/chunks/[externals]_sharp_4f623ccc._.js"].map(t=>e.l(t))).then(()=>t(871815)))},425775,e=>{e.v(e=>Promise.resolve().then(()=>e(267370)))},735943,e=>{e.v(t=>Promise.all(["server/chunks/[externals]_tesseract_463eb979.js"].map(t=>e.l(t))).then(()=>t(236493)))},589793,e=>{e.v(e=>Promise.resolve().then(()=>e(814747)))},707480,e=>{e.v(e=>Promise.resolve().then(()=>e(446786)))}];

//# sourceMappingURL=%5Broot-of-the-server%5D__3f7a6f59._.js.map