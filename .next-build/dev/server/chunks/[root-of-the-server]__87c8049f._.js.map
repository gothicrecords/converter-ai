{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 28, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/jurit/OneDrive/Desktop/sito%20upscale/lib/stripe.js"],"sourcesContent":["import Stripe from 'stripe';\r\n\r\n// Inizializza Stripe con la chiave segreta\r\nconst stripe = new Stripe(process.env.STRIPE_SECRET_KEY, {\r\n  apiVersion: '2023-10-16',\r\n});\r\n\r\nexport default stripe;\r\n"],"names":[],"mappings":";;;;AAAA;;;;;;AAEA,2CAA2C;AAC3C,MAAM,SAAS,IAAI,uHAAM,CAAC,QAAQ,GAAG,CAAC,iBAAiB,EAAE;IACvD,YAAY;AACd;uCAEe"}},
    {"offset": {"line": 50, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/jurit/OneDrive/Desktop/sito%20upscale/pages/api/stripe/create-checkout-session.js"],"sourcesContent":["import stripe from '../../../lib/stripe';\r\n\r\nexport default async function handler(req, res) {\r\n  console.log('[Stripe Checkout] Request received:', {\r\n    method: req.method,\r\n    url: req.url,\r\n    path: req.url,\r\n    hasBody: !!req.body\r\n  });\r\n\r\n  // Handle preflight OPTIONS request\r\n  if (req.method === 'OPTIONS') {\r\n    res.setHeader('Access-Control-Allow-Methods', 'POST');\r\n    res.setHeader('Access-Control-Allow-Headers', 'Content-Type');\r\n    return res.status(200).end();\r\n  }\r\n\r\n  if (req.method !== 'POST') {\r\n    console.log('[Stripe Checkout] Method not allowed:', req.method);\r\n    return res.status(405).json({ \r\n      success: false,\r\n      error: 'Method not allowed',\r\n      code: 'METHOD_NOT_ALLOWED'\r\n    });\r\n  }\r\n\r\n  try {\r\n    // Verifica che Stripe sia configurato\r\n    if (!stripe) {\r\n      console.error('Stripe non inizializzato');\r\n      return res.status(500).json({ \r\n        success: false,\r\n        error: 'Stripe non configurato correttamente',\r\n        code: 'STRIPE_NOT_CONFIGURED'\r\n      });\r\n    }\r\n\r\n    const { priceId, userId, userEmail } = req.body;\r\n\r\n    // Validazione input\r\n    if (!priceId) {\r\n      return res.status(400).json({ \r\n        success: false,\r\n        error: 'priceId è richiesto',\r\n        code: 'MISSING_PRICE_ID'\r\n      });\r\n    }\r\n\r\n    if (!userEmail) {\r\n      return res.status(400).json({ \r\n        success: false,\r\n        error: 'userEmail è richiesto',\r\n        code: 'MISSING_EMAIL'\r\n      });\r\n    }\r\n\r\n    // Verifica che NEXT_PUBLIC_URL sia configurato\r\n    const baseUrl = process.env.NEXT_PUBLIC_URL || process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3000';\r\n\r\n    // Verifica che il price ID esista in Stripe\r\n    let price;\r\n    try {\r\n      price = await stripe.prices.retrieve(priceId);\r\n      console.log('[Stripe Checkout] Price retrieved:', {\r\n        id: price.id,\r\n        active: price.active,\r\n        product: price.product\r\n      });\r\n      \r\n      if (!price.active) {\r\n        throw new Error(`Il price ID ${priceId} non è attivo in Stripe`);\r\n      }\r\n    } catch (priceError) {\r\n      console.error('[Stripe Checkout] Price retrieval error:', priceError);\r\n      if (priceError.type === 'StripeInvalidRequestError' && priceError.code === 'resource_missing') {\r\n        return res.status(400).json({\r\n          success: false,\r\n          error: `Price ID non valido: ${priceId}. Verifica che il price ID sia corretto e attivo nel tuo account Stripe.`,\r\n          code: 'INVALID_PRICE_ID',\r\n          details: process.env.NODE_ENV === 'development' ? priceError.message : undefined\r\n        });\r\n      }\r\n      throw priceError;\r\n    }\r\n\r\n    // Crea la sessione di checkout Stripe\r\n    const session = await stripe.checkout.sessions.create({\r\n      mode: 'subscription',\r\n      payment_method_types: ['card'],\r\n      line_items: [\r\n        {\r\n          price: priceId,\r\n          quantity: 1,\r\n        },\r\n      ],\r\n      success_url: `${baseUrl}/dashboard?success=true&session_id={CHECKOUT_SESSION_ID}`,\r\n      cancel_url: `${baseUrl}/pricing?canceled=true`,\r\n      customer_email: userEmail,\r\n      metadata: {\r\n        userId: userId || 'unknown',\r\n      },\r\n      allow_promotion_codes: true,\r\n      billing_address_collection: 'required',\r\n      subscription_data: {\r\n        metadata: {\r\n          userId: userId || 'unknown',\r\n        },\r\n      },\r\n    });\r\n\r\n    if (!session || !session.url) {\r\n      throw new Error('Stripe non ha restituito un URL di checkout valido');\r\n    }\r\n\r\n    res.status(200).json({ \r\n      success: true,\r\n      url: session.url \r\n    });\r\n  } catch (error) {\r\n    console.error('[Stripe Checkout] Error:', {\r\n      message: error.message,\r\n      type: error.type,\r\n      code: error.code,\r\n      statusCode: error.statusCode\r\n    });\r\n\r\n    // Gestione errori specifici di Stripe\r\n    if (error.type === 'StripeInvalidRequestError') {\r\n      if (error.code === 'resource_missing') {\r\n        return res.status(400).json({\r\n          success: false,\r\n          error: `Risorsa Stripe non trovata: ${error.message}`,\r\n          code: 'STRIPE_RESOURCE_MISSING',\r\n          details: process.env.NODE_ENV === 'development' ? {\r\n            message: error.message,\r\n            code: error.code,\r\n            param: error.param\r\n          } : undefined\r\n        });\r\n      }\r\n      \r\n      return res.status(400).json({\r\n        success: false,\r\n        error: `Errore nella richiesta a Stripe: ${error.message}`,\r\n        code: 'STRIPE_INVALID_REQUEST',\r\n        details: process.env.NODE_ENV === 'development' ? {\r\n          message: error.message,\r\n          code: error.code,\r\n          param: error.param\r\n        } : undefined\r\n      });\r\n    }\r\n\r\n    res.status(500).json({ \r\n      success: false,\r\n      error: error.message || 'Errore durante la creazione della sessione di checkout',\r\n      code: 'CHECKOUT_ERROR',\r\n      details: process.env.NODE_ENV === 'development' ? {\r\n        message: error.message,\r\n        stack: error.stack,\r\n        type: error.type,\r\n        code: error.code\r\n      } : undefined\r\n    });\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}