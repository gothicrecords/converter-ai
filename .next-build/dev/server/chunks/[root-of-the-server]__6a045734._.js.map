{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 38, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/jurit/OneDrive/Desktop/sito%20upscale/utils/advancedUpscaler.js"],"sourcesContent":["import sharp from 'sharp';\r\n\r\n/**\r\n * Upscaler avanzato per immagini 4K/8K\r\n * Usa tecniche multi-pass, denoising e sharpening avanzato\r\n */\r\nclass AdvancedUpscaler {\r\n    constructor() {\r\n        this.maxDimension = 7680; // 8K\r\n    }\r\n\r\n    // Denoising avanzato prima dell'upscaling\r\n    async denoise(image) {\r\n        // Applica leggero blur per ridurre noise, poi sharpening mirato\r\n        return image\r\n            .blur(0.3) // Leggero blur per noise\r\n            .sharpen({\r\n                sigma: 0.5,\r\n                m1: 0.4,\r\n                m2: 0.2\r\n            });\r\n    }\r\n\r\n    // Upscaling multi-pass per qualità massima\r\n    async multiPassUpscale(image, targetWidth, targetHeight, passes = 3) {\r\n        const metadata = await image.metadata();\r\n        let currentWidth = metadata.width;\r\n        let currentHeight = metadata.height;\r\n        \r\n        let currentImage = image;\r\n        \r\n        // Calcola fattore di scala per passaggio\r\n        const totalScale = Math.max(\r\n            targetWidth / currentWidth,\r\n            targetHeight / currentHeight\r\n        );\r\n        const scalePerPass = Math.pow(totalScale, 1 / passes);\r\n        \r\n        for (let pass = 0; pass < passes; pass++) {\r\n            const nextWidth = Math.min(\r\n                Math.round(currentWidth * scalePerPass),\r\n                targetWidth\r\n            );\r\n            const nextHeight = Math.min(\r\n                Math.round(currentHeight * scalePerPass),\r\n                targetHeight\r\n            );\r\n            \r\n            // Usa kernel diverso per ogni passaggio\r\n            let kernel = sharp.kernel.lanczos3;\r\n            if (pass === 0) {\r\n                kernel = sharp.kernel.lanczos3; // Primo passaggio: massima qualità\r\n            } else if (pass === passes - 1) {\r\n                kernel = sharp.kernel.lanczos3; // Ultimo passaggio: massima qualità\r\n            } else {\r\n                kernel = sharp.kernel.lanczos2; // Passaggi intermedi: bilanciato\r\n            }\r\n            \r\n            // Resize con kernel ottimizzato\r\n            currentImage = currentImage.resize(nextWidth, nextHeight, {\r\n                kernel,\r\n                fit: 'fill',\r\n                withoutEnlargement: false\r\n            });\r\n            \r\n            // Sharpening progressivo migliorato (più aggressivo negli ultimi passaggi)\r\n            const sharpenIntensity = 0.4 + (pass / passes) * 0.5;\r\n            const sharpenParams = {\r\n                sigma: 0.5 + sharpenIntensity,\r\n                m1: 0.4 + (pass / passes) * 0.3,\r\n                m2: 0.2 + (pass / passes) * 0.2\r\n            };\r\n            \r\n            // Negli ultimi passaggi, aggiungi parametri avanzati per dettagli ultra-fini\r\n            if (pass >= passes - 2) {\r\n                sharpenParams.x1 = 2;\r\n                sharpenParams.y2 = 2;\r\n                sharpenParams.y3 = 2;\r\n            }\r\n            \r\n            currentImage = currentImage.sharpen(sharpenParams);\r\n            \r\n            // Converti a buffer per il prossimo passaggio\r\n            if (pass < passes - 1) {\r\n                const buffer = await currentImage.toBuffer();\r\n                currentImage = sharp(buffer, { sequentialRead: true });\r\n            }\r\n            \r\n            currentWidth = nextWidth;\r\n            currentHeight = nextHeight;\r\n        }\r\n        \r\n        return currentImage;\r\n    }\r\n\r\n    // Micro-ricostruzione pixel: edge enhancement e detail recovery\r\n    async microPixelReconstruction(image) {\r\n        let reconstructed = image;\r\n        \r\n        // Step 1: Edge detection e enhancement per ricostruire bordi netti\r\n        // Usa unsharp mask avanzato per migliorare i bordi\r\n        reconstructed = reconstructed.sharpen({\r\n            sigma: 0.5,\r\n            m1: 1.2,\r\n            m2: 0.8,\r\n            x1: 1,\r\n            y2: 1,\r\n            y3: 1\r\n        });\r\n        \r\n        // Step 2: Detail recovery usando contrasto locale\r\n        // Aumenta il contrasto locale per recuperare dettagli persi\r\n        reconstructed = reconstructed.normalise();\r\n        \r\n        // Step 3: Micro-sharpening per pixel-level detail\r\n        reconstructed = reconstructed.sharpen({\r\n            sigma: 0.3,\r\n            m1: 0.9,\r\n            m2: 0.5\r\n        });\r\n        \r\n        return reconstructed;\r\n    }\r\n    \r\n    // Miglioramento luce avanzato: exposure, brightness, contrast\r\n    async enhanceLighting(image) {\r\n        let enhanced = image;\r\n        \r\n        // Step 1: Auto-exposure adjustment\r\n        // Normalizza l'esposizione per bilanciare luci e ombre\r\n        enhanced = enhanced.normalise();\r\n        \r\n        // Step 2: Brightness adjustment intelligente\r\n        // Aumenta leggermente la luminosità senza sovraesporre\r\n        enhanced = enhanced.modulate({\r\n            brightness: 1.05,\r\n            saturation: 1.1,\r\n            hue: 0\r\n        });\r\n        \r\n        // Step 3: Contrast enhancement per profondità\r\n        // Aumenta il contrasto per dare profondità all'immagine\r\n        enhanced = enhanced.linear(1.08, -(128 * 0.08));\r\n        \r\n        // Step 4: Shadow/highlight recovery\r\n        // Usa gamma correction per recuperare dettagli in ombre e luci\r\n        enhanced = enhanced.gamma(1.1);\r\n        \r\n        return enhanced;\r\n    }\r\n    \r\n    // Applica enhancement finale per massima qualità 4K\r\n    async applyFinalEnhancement(image, quality = 'high') {\r\n        let enhanced = image;\r\n        \r\n        // Step 1: Miglioramento luce (exposure, brightness, contrast)\r\n        enhanced = await this.enhanceLighting(enhanced);\r\n        \r\n        // Step 2: Micro-ricostruzione pixel per dettagli ultra-fini\r\n        enhanced = await this.microPixelReconstruction(enhanced);\r\n        \r\n        // Step 3: Sharpening avanzato multi-pass per dettagli ultra-definiti\r\n        // Primo passaggio: sharpening generale\r\n        enhanced = enhanced.sharpen({\r\n            sigma: 1.5,\r\n            m1: 0.8,\r\n            m2: 0.5,\r\n            x1: 2,\r\n            y2: 2,\r\n            y3: 2\r\n        });\r\n        \r\n        // Step 4: Enhancement locale per dettagli fini\r\n        // Usa unsharp mask per migliorare la nitidezza\r\n        enhanced = enhanced.sharpen({\r\n            sigma: 0.8,\r\n            m1: 1.0,\r\n            m2: 0.6,\r\n            x1: 3,\r\n            y2: 3,\r\n            y3: 3\r\n        });\r\n        \r\n        // Step 5: Rimozione artefatti e compressione ottimale\r\n        // Usa JPEG con qualità massima per preservare dettagli\r\n        enhanced = enhanced.jpeg({\r\n            quality: 98,\r\n            chromaSubsampling: '4:4:4', // No chroma subsampling per massima qualità\r\n            mozjpeg: true,\r\n            trellisQuantisation: true,\r\n            overshootDeringing: true,\r\n            optimiseScans: true,\r\n            progressive: true\r\n        });\r\n        \r\n        return enhanced;\r\n    }\r\n\r\n    // Upscale principale con pipeline completa\r\n    async upscale(buffer, targetScale = 4, maxDimension = 7680) {\r\n        try {\r\n            const input = sharp(buffer, { sequentialRead: true }).rotate();\r\n            const metadata = await input.metadata();\r\n            \r\n            const originalWidth = metadata.width || 0;\r\n            const originalHeight = metadata.height || 0;\r\n            \r\n            if (originalWidth === 0 || originalHeight === 0) {\r\n                throw new Error('Dimensioni immagine non valide');\r\n            }\r\n            \r\n            // Calcola dimensioni target\r\n            let targetWidth = Math.round(originalWidth * targetScale);\r\n            let targetHeight = Math.round(originalHeight * targetScale);\r\n            \r\n            // Limita a maxDimension\r\n            if (targetWidth > maxDimension || targetHeight > maxDimension) {\r\n                const scale = maxDimension / Math.max(targetWidth, targetHeight);\r\n                targetWidth = Math.round(targetWidth * scale);\r\n                targetHeight = Math.round(targetHeight * scale);\r\n            }\r\n            \r\n            console.log(`Upscaling: ${originalWidth}x${originalHeight} -> ${targetWidth}x${targetHeight}`);\r\n            \r\n            // Step 1: Denoising migliorato (applicato più spesso per immagini di qualità inferiore)\r\n            let processed = input;\r\n            const mp = (originalWidth * originalHeight) / 1e6;\r\n            // Applica denoising per immagini piccole o se la risoluzione è bassa\r\n            if (mp < 3 || Math.max(originalWidth, originalHeight) < 2000) {\r\n                processed = await this.denoise(processed);\r\n            }\r\n            \r\n            // Step 2: Multi-pass upscaling\r\n            const scaleFactor = Math.max(\r\n                targetWidth / originalWidth,\r\n                targetHeight / originalHeight\r\n            );\r\n            \r\n            // Determina numero di passaggi basato su scala (più passaggi = migliore qualità)\r\n            let passes = 3; // Default aumentato da 2 a 3\r\n            if (scaleFactor > 4) {\r\n                passes = 6; // Per upscaling molto grandi, usa più passaggi\r\n            } else if (scaleFactor > 3) {\r\n                passes = 5;\r\n            } else if (scaleFactor > 2) {\r\n                passes = 4;\r\n            }\r\n            \r\n            processed = await this.multiPassUpscale(\r\n                processed,\r\n                targetWidth,\r\n                targetHeight,\r\n                passes\r\n            );\r\n            \r\n            // Step 3: Enhancement finale (converte già a JPEG)\r\n            processed = await this.applyFinalEnhancement(processed, 'high');\r\n            \r\n            // L'enhancement finale restituisce già un'immagine processata, converti a buffer\r\n            const outputBuffer = await processed.toBuffer();\r\n            \r\n            console.log(`Upscale completato: ${(outputBuffer.length / 1024 / 1024).toFixed(2)} MB`);\r\n            \r\n            return outputBuffer;\r\n            \r\n        } catch (error) {\r\n            console.error('Errore upscaling avanzato:', error);\r\n            throw new Error(`Upscaling fallito: ${error.message}`);\r\n        }\r\n    }\r\n\r\n    // Upscale a 4K (3840x2160 o lato lungo 3840)\r\n    async upscaleTo4K(buffer) {\r\n        const input = sharp(buffer, { sequentialRead: true }).rotate();\r\n        const metadata = await input.metadata();\r\n        \r\n        const originalWidth = metadata.width || 0;\r\n        const originalHeight = metadata.height || 0;\r\n        \r\n        // Calcola dimensioni 4K mantenendo aspect ratio\r\n        const longSide = Math.max(originalWidth, originalHeight);\r\n        const scale = 3840 / longSide;\r\n        \r\n        const targetWidth = Math.round(originalWidth * scale);\r\n        const targetHeight = Math.round(originalHeight * scale);\r\n        \r\n        return this.upscale(buffer, scale, 3840);\r\n    }\r\n\r\n    // Upscale a 8K (7680x4320 o lato lungo 7680)\r\n    async upscaleTo8K(buffer) {\r\n        const input = sharp(buffer, { sequentialRead: true }).rotate();\r\n        const metadata = await input.metadata();\r\n        \r\n        const originalWidth = metadata.width || 0;\r\n        const originalHeight = metadata.height || 0;\r\n        \r\n        // Calcola dimensioni 8K mantenendo aspect ratio\r\n        const longSide = Math.max(originalWidth, originalHeight);\r\n        const scale = 7680 / longSide;\r\n        \r\n        const targetWidth = Math.round(originalWidth * scale);\r\n        const targetHeight = Math.round(originalHeight * scale);\r\n        \r\n        return this.upscale(buffer, scale, 7680);\r\n    }\r\n}\r\n\r\nexport default AdvancedUpscaler;\r\n\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 287, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/jurit/OneDrive/Desktop/sito%20upscale/utils/msrUpscaler.js"],"sourcesContent":["import sharp from 'sharp';\r\n\r\n/**\r\n * Multi-Stage Super Resolution (MSR) Upscaler\r\n * Implementa una pipeline multi-stadio per upscaling di alta qualità\r\n */\r\nclass MSRUpscaler {\r\n    constructor() {\r\n        this.maxDimension = 7680; // 8K\r\n    }\r\n\r\n    /**\r\n     * Stage 1: Denoising + Deblurring\r\n     * Rimuove rumore e sfocatura prima dell'upscaling\r\n     */\r\n    async stage1_DenoiseDeblur(image) {\r\n        let processed = image;\r\n        \r\n        // Step 1: Denoising con median filter (preserva i bordi)\r\n        processed = processed.median(3);\r\n        \r\n        // Step 2: Deblurring con unsharp mask leggero\r\n        processed = processed.sharpen({\r\n            sigma: 0.3,\r\n            m1: 0.5,\r\n            m2: 0.3\r\n        });\r\n        \r\n        // Step 3: Bilateral-like filtering (simulato con blur selettivo)\r\n        // Sharp non ha convolve diretto, usiamo un approccio alternativo\r\n        // Applica un blur molto leggero seguito da sharpening per preservare i bordi\r\n        processed = processed.blur(0.5);\r\n        processed = processed.sharpen({\r\n            sigma: 0.2,\r\n            m1: 0.3,\r\n            m2: 0.15\r\n        });\r\n        \r\n        return processed;\r\n    }\r\n\r\n    /**\r\n     * Stage 2: Super Resolution x2 o x4\r\n     * Upscaling progressivo con kernel ottimizzati\r\n     */\r\n    async stage2_SuperResolution(image, targetScale, originalWidth, originalHeight) {\r\n        let currentImage = image;\r\n        let currentWidth = originalWidth;\r\n        let currentHeight = originalHeight;\r\n        \r\n        // Calcola il numero di passaggi necessari (ogni passaggio max 2x)\r\n        const totalPasses = Math.ceil(Math.log2(targetScale));\r\n        \r\n        for (let pass = 0; pass < totalPasses; pass++) {\r\n            const scaleThisPass = Math.min(2, targetScale / (Math.pow(2, pass)));\r\n            const nextWidth = Math.round(currentWidth * scaleThisPass);\r\n            const nextHeight = Math.round(currentHeight * scaleThisPass);\r\n            \r\n            // Usa Lanczos3 per massima qualità\r\n            currentImage = currentImage.resize(nextWidth, nextHeight, {\r\n                kernel: sharp.kernel.lanczos3,\r\n                fit: 'fill',\r\n                withoutEnlargement: false\r\n            });\r\n            \r\n            // Sharpening leggero dopo ogni passaggio\r\n            if (pass < totalPasses - 1) {\r\n                currentImage = currentImage.sharpen({\r\n                    sigma: 0.4,\r\n                    m1: 0.5,\r\n                    m2: 0.3\r\n                });\r\n            }\r\n            \r\n            // Converti a buffer per il prossimo passaggio\r\n            if (pass < totalPasses - 1) {\r\n                const buffer = await currentImage.toBuffer();\r\n                currentImage = sharp(buffer, { sequentialRead: true });\r\n            }\r\n            \r\n            currentWidth = nextWidth;\r\n            currentHeight = nextHeight;\r\n        }\r\n        \r\n        return currentImage;\r\n    }\r\n\r\n    /**\r\n     * Stage 3: Fine Detail + Intelligent Sharpening (non lineare)\r\n     * Enhancement intelligente che evita artefatti\r\n     */\r\n    async stage3_FineDetail(image) {\r\n        let enhanced = image;\r\n        \r\n        // Step 1: Edge-preserving sharpening\r\n        // Usa unsharp mask con parametri conservativi\r\n        enhanced = enhanced.sharpen({\r\n            sigma: 1.0,\r\n            m1: 0.7,\r\n            m2: 0.4,\r\n            x1: 2,\r\n            y2: 2,\r\n            y3: 2\r\n        });\r\n        \r\n        // Step 2: Detail enhancement non lineare\r\n        // Applica contrasto locale per migliorare i dettagli senza artefatti\r\n        enhanced = enhanced.normalise();\r\n        \r\n        // Step 3: Micro-sharpening per dettagli fini\r\n        enhanced = enhanced.sharpen({\r\n            sigma: 0.5,\r\n            m1: 0.8,\r\n            m2: 0.5\r\n        });\r\n        \r\n        return enhanced;\r\n    }\r\n\r\n    /**\r\n     * Edge-Aware Enhancement\r\n     * Riconosce e migliora bordi e contorni usando tecniche edge-preserving\r\n     */\r\n    async edgeAwareEnhancement(image) {\r\n        let enhanced = image;\r\n        \r\n        // Step 1: Edge-preserving sharpening\r\n        // Usa unsharp mask avanzato che preserva i bordi\r\n        enhanced = enhanced.sharpen({\r\n            sigma: 1.2,\r\n            m1: 0.9,\r\n            m2: 0.6,\r\n            x1: 2,\r\n            y2: 2,\r\n            y3: 2\r\n        });\r\n        \r\n        // Step 2: Contrast enhancement per bordi più netti\r\n        // Aumenta il contrasto locale per evidenziare i bordi\r\n        enhanced = enhanced.linear(1.06, -(128 * 0.06));\r\n        \r\n        // Step 3: Normalizzazione per migliorare la definizione dei bordi\r\n        enhanced = enhanced.normalise();\r\n        \r\n        // Step 4: Sharpening mirato per bordi ultra-netti\r\n        enhanced = enhanced.sharpen({\r\n            sigma: 0.8,\r\n            m1: 0.7,\r\n            m2: 0.5\r\n        });\r\n        \r\n        return enhanced;\r\n    }\r\n\r\n    /**\r\n     * High-Frequency Detail Injector\r\n     * Estrae e potenzia le alte frequenze (dettagli fini)\r\n     */\r\n    async highFrequencyInjector(image) {\r\n        let enhanced = image;\r\n        \r\n        // Step 1: Estrai alte frequenze usando sharpening avanzato\r\n        // Usa unsharp mask per evidenziare i dettagli fini\r\n        enhanced = enhanced.sharpen({\r\n            sigma: 0.8,\r\n            m1: 1.0,\r\n            m2: 0.6,\r\n            x1: 3,\r\n            y2: 3,\r\n            y3: 3\r\n        });\r\n        \r\n        // Step 2: Potenzia le alte frequenze con contrasto locale\r\n        enhanced = enhanced.normalise();\r\n        \r\n        // Step 3: Enhancement mirato per dettagli ultra-fini\r\n        enhanced = enhanced.sharpen({\r\n            sigma: 0.5,\r\n            m1: 0.8,\r\n            m2: 0.5\r\n        });\r\n        \r\n        // Step 4: Leggero boost di luminosità e saturazione\r\n        enhanced = enhanced.modulate({\r\n            brightness: 1.03,\r\n            saturation: 1.05\r\n        });\r\n        \r\n        return enhanced;\r\n    }\r\n\r\n    /**\r\n     * Color Space Enhancement\r\n     * Lavora in spazi colore ottimizzati per migliorare nitidezza\r\n     */\r\n    async colorSpaceEnhancement(image) {\r\n        let enhanced = image;\r\n        \r\n        // Step 1: Converti a LAB per lavorare sulla luminanza separatamente\r\n        // Sharp non supporta LAB direttamente, quindi usiamo RGB con canali separati\r\n        // Ma possiamo migliorare la luminanza con normalizzazione\r\n        \r\n        // Step 2: Normalizza la luminanza per migliorare i dettagli\r\n        enhanced = enhanced.normalise();\r\n        \r\n        // Step 3: Aumenta il contrasto nella luminanza\r\n        enhanced = enhanced.linear(1.05, -(128 * 0.05));\r\n        \r\n        // Step 4: Migliora la saturazione per colori più vividi\r\n        enhanced = enhanced.modulate({\r\n            saturation: 1.1,\r\n            brightness: 1.02,\r\n            hue: 0\r\n        });\r\n        \r\n        return enhanced;\r\n    }\r\n\r\n    /**\r\n     * Texture-Aware Processing\r\n     * Applica filtri diversi in base al tipo di texture\r\n     */\r\n    async textureAwareProcessing(image) {\r\n        let enhanced = image;\r\n        \r\n        // Per ora usiamo un approccio generale\r\n        // In futuro si può integrare segmentazione semantica\r\n        \r\n        // Step 1: Enhancement generale per texture\r\n        enhanced = enhanced.sharpen({\r\n            sigma: 0.6,\r\n            m1: 0.7,\r\n            m2: 0.4\r\n        });\r\n        \r\n        // Step 2: Contrasto locale per texture più definite\r\n        enhanced = enhanced.normalise();\r\n        \r\n        return enhanced;\r\n    }\r\n\r\n    /**\r\n     * Blind Degradation Modeling\r\n     * Rileva il tipo di degradazione e applica il trattamento appropriato\r\n     */\r\n    async detectDegradation(image) {\r\n        // Analizza l'immagine per determinare il tipo di degradazione\r\n        // Usiamo euristiche basate sui metadati\r\n        \r\n        const metadata = await image.metadata();\r\n        \r\n        // Estrai informazioni base\r\n        const width = metadata.width || 0;\r\n        const height = metadata.height || 0;\r\n        const hasAlpha = metadata.hasAlpha || false;\r\n        const format = metadata.format || '';\r\n        \r\n        // Determina il tipo di degradazione basandosi su caratteristiche dell'immagine\r\n        let degradationType = 'unknown';\r\n        \r\n        // Bassa risoluzione\r\n        if (width < 1000 && height < 1000) {\r\n            degradationType = 'low_res';\r\n        }\r\n        // Compressione JPEG (spesso ha dimensioni file piccole rispetto alla risoluzione)\r\n        else if (format === 'jpeg' && width * height > 500000 && width * height < 2000000) {\r\n            degradationType = 'compression';\r\n        }\r\n        // Rumore (immagini scure o con molti dettagli)\r\n        else if (width * height < 500000) {\r\n            degradationType = 'noise';\r\n        }\r\n        // Sfocatura (immagini più grandi ma con dettagli persi)\r\n        else {\r\n            degradationType = 'blur';\r\n        }\r\n        \r\n        return degradationType;\r\n    }\r\n\r\n    /**\r\n     * Pipeline principale MSR\r\n     */\r\n    async upscale(buffer, targetScale = 4, maxDimension = 7680) {\r\n        try {\r\n            const input = sharp(buffer, { sequentialRead: true }).rotate();\r\n            const metadata = await input.metadata();\r\n            \r\n            const originalWidth = metadata.width || 0;\r\n            const originalHeight = metadata.height || 0;\r\n            \r\n            if (originalWidth === 0 || originalHeight === 0) {\r\n                throw new Error('Dimensioni immagine non valide');\r\n            }\r\n            \r\n            // Calcola dimensioni target\r\n            let targetWidth = Math.round(originalWidth * targetScale);\r\n            let targetHeight = Math.round(originalHeight * targetScale);\r\n            \r\n            // Limita a maxDimension\r\n            if (targetWidth > maxDimension || targetHeight > maxDimension) {\r\n                const scale = maxDimension / Math.max(targetWidth, targetHeight);\r\n                targetWidth = Math.round(targetWidth * scale);\r\n                targetHeight = Math.round(targetHeight * scale);\r\n            }\r\n            \r\n            console.log(`[MSR] Upscaling: ${originalWidth}x${originalHeight} -> ${targetWidth}x${targetHeight}`);\r\n            \r\n            // Rileva tipo di degradazione\r\n            const degradationType = await this.detectDegradation(input);\r\n            console.log(`[MSR] Detected degradation type: ${degradationType}`);\r\n            \r\n            // Stage 1: Denoising + Deblurring\r\n            console.log('[MSR] Stage 1: Denoising + Deblurring...');\r\n            let processed = await this.stage1_DenoiseDeblur(input);\r\n            \r\n            // Stage 2: Super Resolution\r\n            const actualScale = Math.max(targetWidth / originalWidth, targetHeight / originalHeight);\r\n            console.log(`[MSR] Stage 2: Super Resolution (${actualScale.toFixed(2)}x)...`);\r\n            processed = await this.stage2_SuperResolution(processed, actualScale, originalWidth, originalHeight);\r\n            \r\n            // Stage 3: Fine Detail + Intelligent Sharpening\r\n            console.log('[MSR] Stage 3: Fine Detail Enhancement...');\r\n            processed = await this.stage3_FineDetail(processed);\r\n            \r\n            // Edge-Aware Enhancement\r\n            console.log('[MSR] Edge-Aware Enhancement...');\r\n            processed = await this.edgeAwareEnhancement(processed);\r\n            \r\n            // High-Frequency Detail Injector\r\n            console.log('[MSR] High-Frequency Detail Injection...');\r\n            processed = await this.highFrequencyInjector(processed);\r\n            \r\n            // Color Space Enhancement\r\n            console.log('[MSR] Color Space Enhancement...');\r\n            processed = await this.colorSpaceEnhancement(processed);\r\n            \r\n            // Texture-Aware Processing\r\n            console.log('[MSR] Texture-Aware Processing...');\r\n            processed = await this.textureAwareProcessing(processed);\r\n            \r\n            // Output finale con qualità massima\r\n            const outputBuffer = await processed\r\n                .jpeg({\r\n                    quality: 98,\r\n                    chromaSubsampling: '4:4:4',\r\n                    mozjpeg: true,\r\n                    trellisQuantisation: true,\r\n                    overshootDeringing: true,\r\n                    optimiseScans: true,\r\n                    progressive: true\r\n                })\r\n                .toBuffer();\r\n            \r\n            console.log(`[MSR] Upscale completato: ${(outputBuffer.length / 1024 / 1024).toFixed(2)} MB`);\r\n            \r\n            return outputBuffer;\r\n            \r\n        } catch (error) {\r\n            console.error('[MSR] Errore upscaling:', error);\r\n            throw new Error(`MSR Upscaling fallito: ${error.message}`);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Upscale a 4K usando MSR\r\n     */\r\n    async upscaleTo4K(buffer) {\r\n        const input = sharp(buffer, { sequentialRead: true }).rotate();\r\n        const metadata = await input.metadata();\r\n        \r\n        const originalWidth = metadata.width || 0;\r\n        const originalHeight = metadata.height || 0;\r\n        const longSide = Math.max(originalWidth, originalHeight);\r\n        const scale = 3840 / longSide;\r\n        \r\n        return this.upscale(buffer, scale, 3840);\r\n    }\r\n}\r\n\r\nexport default MSRUpscaler;\r\n\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 594, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/jurit/OneDrive/Desktop/sito%20upscale/utils/upscale.js"],"sourcesContent":["import sharp from 'sharp';\r\nimport AdvancedUpscaler from './advancedUpscaler.js';\r\nimport MSRUpscaler from './msrUpscaler.js';\r\n\r\n/**\r\n * Upscale immagine usando Multi-Stage Super Resolution (MSR)\r\n * Implementa tecniche avanzate: edge-aware, high-frequency injection, texture synthesis\r\n */\r\nexport default async function upscaleImage(fileBuffer, targetScale = 4) {\r\n  try {\r\n    // Usa MSR Upscaler per risultati di qualità superiore\r\n    const msrUpscaler = new MSRUpscaler();\r\n    \r\n    // Usa upscaler avanzato per qualità 4K/8K\r\n    // Cerca sempre di raggiungere almeno 4K quando possibile\r\n    const metadata = await sharp(fileBuffer, { sequentialRead: true }).metadata();\r\n    const originalWidth = metadata.width || 0;\r\n    const originalHeight = metadata.height || 0;\r\n    const mp = (originalWidth * originalHeight) / 1e6;\r\n    \r\n    // Calcola il lato lungo\r\n    const longSide = Math.max(originalWidth, originalHeight);\r\n    \r\n    let upscaled;\r\n    \r\n    // Strategia MSR: sempre upscale a 4K se possibile, altrimenti almeno 4x\r\n    if (longSide < 1920) {\r\n      // Immagine piccola/HD: upscale a 4K (3840px lato lungo)\r\n      console.log(`[MSR] Upscaling small image (${originalWidth}x${originalHeight}) to 4K`);\r\n      upscaled = await msrUpscaler.upscaleTo4K(fileBuffer);\r\n    } else if (longSide < 3840) {\r\n      // Immagine HD/FHD: upscale a 4K o almeno 2x fino a 4K\r\n      const scaleTo4K = 3840 / longSide;\r\n      console.log(`[MSR] Upscaling HD image (${originalWidth}x${originalHeight}) to 4K (scale: ${scaleTo4K.toFixed(2)}x)`);\r\n      upscaled = await msrUpscaler.upscale(fileBuffer, scaleTo4K, 3840);\r\n    } else {\r\n      // Immagine già grande: upscale almeno 2x o fino a 8K se possibile\r\n      const scale = Math.max(2, Math.min(4, 7680 / longSide));\r\n      console.log(`[MSR] Upscaling large image (${originalWidth}x${originalHeight}) by ${scale.toFixed(2)}x`);\r\n      upscaled = await msrUpscaler.upscale(fileBuffer, scale, 7680);\r\n    }\r\n    \r\n    // Ritorna data URL (completamente locale, nessuna API esterna)\r\n    const base64 = upscaled.toString('base64');\r\n    return `data:image/jpeg;base64,${base64}`;\r\n  } catch (e) {\r\n    console.error('Upscale fallito:', e);\r\n    throw new Error(`Upscale failed: ${e?.message || e}`);\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAMe,eAAe,aAAa,UAAU,EAAE,cAAc,CAAC;IACpE,IAAI;QACF,sDAAsD;QACtD,MAAM,cAAc,IAAI,wHAAW;QAEnC,0CAA0C;QAC1C,yDAAyD;QACzD,MAAM,WAAW,MAAM,IAAA,8GAAK,EAAC,YAAY;YAAE,gBAAgB;QAAK,GAAG,QAAQ;QAC3E,MAAM,gBAAgB,SAAS,KAAK,IAAI;QACxC,MAAM,iBAAiB,SAAS,MAAM,IAAI;QAC1C,MAAM,KAAK,AAAC,gBAAgB,iBAAkB;QAE9C,wBAAwB;QACxB,MAAM,WAAW,KAAK,GAAG,CAAC,eAAe;QAEzC,IAAI;QAEJ,wEAAwE;QACxE,IAAI,WAAW,MAAM;YACnB,wDAAwD;YACxD,QAAQ,GAAG,CAAC,CAAC,6BAA6B,EAAE,cAAc,CAAC,EAAE,eAAe,OAAO,CAAC;YACpF,WAAW,MAAM,YAAY,WAAW,CAAC;QAC3C,OAAO,IAAI,WAAW,MAAM;YAC1B,sDAAsD;YACtD,MAAM,YAAY,OAAO;YACzB,QAAQ,GAAG,CAAC,CAAC,0BAA0B,EAAE,cAAc,CAAC,EAAE,eAAe,gBAAgB,EAAE,UAAU,OAAO,CAAC,GAAG,EAAE,CAAC;YACnH,WAAW,MAAM,YAAY,OAAO,CAAC,YAAY,WAAW;QAC9D,OAAO;YACL,kEAAkE;YAClE,MAAM,QAAQ,KAAK,GAAG,CAAC,GAAG,KAAK,GAAG,CAAC,GAAG,OAAO;YAC7C,QAAQ,GAAG,CAAC,CAAC,6BAA6B,EAAE,cAAc,CAAC,EAAE,eAAe,KAAK,EAAE,MAAM,OAAO,CAAC,GAAG,CAAC,CAAC;YACtG,WAAW,MAAM,YAAY,OAAO,CAAC,YAAY,OAAO;QAC1D;QAEA,+DAA+D;QAC/D,MAAM,SAAS,SAAS,QAAQ,CAAC;QACjC,OAAO,CAAC,uBAAuB,EAAE,QAAQ;IAC3C,EAAE,OAAO,GAAG;QACV,QAAQ,KAAK,CAAC,oBAAoB;QAClC,MAAM,IAAI,MAAM,CAAC,gBAAgB,EAAE,GAAG,WAAW,GAAG;IACtD;AACF"}},
    {"offset": {"line": 659, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/jurit/OneDrive/Desktop/sito%20upscale/lib/openai.js"],"sourcesContent":["// OpenAI API integration with official SDK\r\nimport OpenAI from 'openai';\r\n\r\nconst openai = new OpenAI({\r\n  apiKey: process.env.OPENAI_API_KEY,\r\n});\r\n\r\n// Generate embeddings for text\r\nexport async function generateEmbedding(text) {\r\n  if (!process.env.OPENAI_API_KEY) {\r\n    throw new Error('OPENAI_API_KEY is not configured. Please set it in your environment variables.');\r\n  }\r\n\r\n  try {\r\n    const response = await openai.embeddings.create({\r\n      model: 'text-embedding-3-small',\r\n      input: text.substring(0, 8000), // Limit input size\r\n    });\r\n\r\n    return response.data[0].embedding;\r\n  } catch (error) {\r\n    console.error('Error generating embedding:', error);\r\n    throw new Error(`Failed to generate embedding: ${error.message}`);\r\n  }\r\n}\r\n\r\n// Generate embeddings in batch for an array of texts\r\nexport async function generateEmbeddingsBatch(texts) {\r\n  if (!process.env.OPENAI_API_KEY) {\r\n    throw new Error('OPENAI_API_KEY is not configured. Please set it in your environment variables.');\r\n  }\r\n\r\n  if (!Array.isArray(texts) || texts.length === 0) return [];\r\n\r\n  try {\r\n    const response = await openai.embeddings.create({\r\n      model: 'text-embedding-3-small',\r\n      input: texts.map(t => (t || '').toString().substring(0, 8000)),\r\n    });\r\n\r\n    return response.data.map(d => d.embedding);\r\n  } catch (error) {\r\n    console.error('Error generating batch embeddings:', error);\r\n    throw new Error(`Failed to generate batch embeddings: ${error.message}`);\r\n  }\r\n}\r\n\r\n// Chat completion using OpenAI GPT models\r\nexport async function chatCompletion(messages, options = {}) {\r\n  if (!process.env.OPENAI_API_KEY) {\r\n    throw new Error('OPENAI_API_KEY is not configured. Please set it in your environment variables.');\r\n  }\r\n\r\n  try {\r\n    const response = await openai.chat.completions.create({\r\n      model: options.model || 'gpt-4o-mini', // Fast and affordable\r\n      messages: messages,\r\n      temperature: options.temperature || 0.7,\r\n      max_tokens: options.max_tokens || 1000,\r\n      top_p: options.top_p || 1,\r\n      frequency_penalty: options.frequency_penalty || 0,\r\n      presence_penalty: options.presence_penalty || 0,\r\n    });\r\n\r\n    return response.choices[0].message.content;\r\n  } catch (error) {\r\n    console.error('Error in chat completion:', error);\r\n    \r\n    // Handle specific OpenAI errors\r\n    if (error.status === 401) {\r\n      throw new Error('Chiave API OpenAI non valida. Verifica la configurazione.');\r\n    } else if (error.status === 429) {\r\n      throw new Error('Limite di rate raggiunto. Riprova tra qualche secondo.');\r\n    } else if (error.status === 500) {\r\n      throw new Error('Errore del server OpenAI. Riprova più tardi.');\r\n    }\r\n    \r\n    throw new Error(`Errore nella comunicazione con OpenAI: ${error.message}`);\r\n  }\r\n}\r\n\r\n// Generate summary\r\nexport async function generateSummary(text, maxLength = 200) {\r\n  const messages = [\r\n    {\r\n      role: 'system',\r\n      content: 'You are a helpful assistant that creates concise summaries.',\r\n    },\r\n    {\r\n      role: 'user',\r\n      content: `Summarize the following text in ${maxLength} words or less:\\n\\n${text}`,\r\n    },\r\n  ];\r\n\r\n  return await chatCompletion(messages, { temperature: 0.5, max_tokens: 300 });\r\n}\r\n\r\n// Generate tags\r\nexport async function generateTags(text, count = 5) {\r\n  const messages = [\r\n    {\r\n      role: 'system',\r\n      content: 'You are a helpful assistant that generates relevant tags for documents. Return only comma-separated tags, no explanations.',\r\n    },\r\n    {\r\n      role: 'user',\r\n      content: `Generate ${count} relevant tags for this document:\\n\\n${text.substring(0, 2000)}`,\r\n    },\r\n  ];\r\n\r\n  const response = await chatCompletion(messages, { temperature: 0.3, max_tokens: 100 });\r\n  \r\n  return response\r\n    .split(',')\r\n    .map(tag => tag.trim().toLowerCase())\r\n    .filter(tag => tag.length > 0)\r\n    .slice(0, count);\r\n}\r\n\r\n// Classify document\r\nexport async function classifyDocument(text) {\r\n  const categories = [\r\n    'contract', 'invoice', 'report', 'presentation', \r\n    'spreadsheet', 'image', 'code', 'email', 'article', 'other'\r\n  ];\r\n\r\n  const messages = [\r\n    {\r\n      role: 'system',\r\n      content: `You are a document classifier. Classify the document into one or more of these categories: ${categories.join(', ')}. Return only category names, comma-separated.`,\r\n    },\r\n    {\r\n      role: 'user',\r\n      content: `Classify this document:\\n\\n${text.substring(0, 1000)}`,\r\n    },\r\n  ];\r\n\r\n  const response = await chatCompletion(messages, { temperature: 0.2, max_tokens: 50 });\r\n  \r\n  return response\r\n    .split(',')\r\n    .map(cat => cat.trim().toLowerCase())\r\n    .filter(cat => categories.includes(cat));\r\n}\r\n\r\n// Vision API - Analizza immagini come ChatGPT\r\nexport async function analyzeImageWithVision(imageBuffer, imageMimeType, query = 'Cosa contiene questa immagine? Descrivi tutto ciò che vedi.') {\r\n  if (!process.env.OPENAI_API_KEY) {\r\n    throw new Error('OPENAI_API_KEY is not configured. Please set it in your environment variables.');\r\n  }\r\n\r\n  try {\r\n    // Converti il buffer in base64\r\n    const base64Image = imageBuffer.toString('base64');\r\n    \r\n    const response = await openai.chat.completions.create({\r\n      model: 'gpt-4o', // GPT-4o supporta vision\r\n      messages: [\r\n        {\r\n          role: 'system',\r\n          content: 'Sei un assistente AI esperto nell\\'analisi di immagini. Descrivi in dettaglio tutto ciò che vedi nell\\'immagine, inclusi testo, oggetti, persone, scene, colori e qualsiasi altro dettaglio rilevante. Rispondi sempre in italiano.'\r\n        },\r\n        {\r\n          role: 'user',\r\n          content: [\r\n            {\r\n              type: 'text',\r\n              text: query\r\n            },\r\n            {\r\n              type: 'image_url',\r\n              image_url: {\r\n                url: `data:${imageMimeType};base64,${base64Image}`,\r\n                detail: 'high'\r\n              }\r\n            }\r\n          ]\r\n        }\r\n      ],\r\n      max_tokens: 2000,\r\n      temperature: 0.2\r\n    });\r\n\r\n    return response.choices[0].message.content;\r\n  } catch (error) {\r\n    console.error('Error in vision API:', error);\r\n    \r\n    if (error.status === 401) {\r\n      throw new Error('Chiave API OpenAI non valida. Verifica la configurazione.');\r\n    } else if (error.status === 429) {\r\n      throw new Error('Limite di rate raggiunto. Riprova tra qualche secondo.');\r\n    } else if (error.status === 400 && error.message?.includes('image')) {\r\n      throw new Error('Formato immagine non supportato o immagine troppo grande.');\r\n    }\r\n    \r\n    throw new Error(`Errore nell'analisi dell'immagine: ${error.message}`);\r\n  }\r\n}\r\n\r\n// Estrazione testo da PDF con OpenAI Responses API (gpt-4o) usando input_file\r\n// Ritorna SOLO la stringa di testo estratto (no IDs, no oggetti)\r\nexport async function extractTextFromPdfWithOpenAI(filePath) {\r\n  if (!process.env.OPENAI_API_KEY) {\r\n    throw new Error('OPENAI_API_KEY is not configured. Please set it in your environment variables.');\r\n  }\r\n\r\n  const fs = await import('fs');\r\n  \r\n  let uploadedFile = null;\r\n  try {\r\n    console.log('Caricamento PDF su OpenAI (Responses API):', filePath);\r\n    \r\n    // 1) Carica il file su OpenAI come user_data\r\n    uploadedFile = await openai.files.create({\r\n      file: fs.createReadStream(filePath),\r\n      purpose: 'user_data'\r\n    });\r\n\r\n    console.log('File caricato su OpenAI:', uploadedFile.id);\r\n\r\n    // 2) Richiesta al modello GPT-4o per estrazione testo dal file caricato\r\n    const response = await openai.responses.create({\r\n      model: 'gpt-4o',\r\n      input: [\r\n        {\r\n          role: 'user',\r\n          content: [\r\n            { type: 'input_text', text: 'Estrai tutto il testo e le informazioni rilevanti da questo documento. Rispondi SOLO con il testo estratto, senza commenti.' },\r\n            { type: 'input_file', file_id: uploadedFile.id }\r\n          ]\r\n        }\r\n      ],\r\n      max_output_tokens: 8000,\r\n      temperature: 0.1\r\n    });\r\n\r\n    // 3) Prendi solo testo\r\n    const extractedText = (response.output_text || '').toString().trim();\r\n    console.log(`Testo estratto da PDF: ${extractedText.length} caratteri`);\r\n    \r\n    if (!extractedText) {\r\n      throw new Error('Nessun testo estratto dal PDF');\r\n    }\r\n\r\n    return extractedText;\r\n\r\n  } catch (error) {\r\n    console.error('Error in PDF text extraction (Responses API):', error);\r\n    \r\n    if (error.status === 401) {\r\n      throw new Error('Chiave API OpenAI non valida. Verifica la configurazione.');\r\n    } else if (error.status === 429) {\r\n      throw new Error('Limite di rate raggiunto. Riprova tra qualche secondo.');\r\n    } else if (error.status === 400) {\r\n      throw new Error('Errore nell\\'analisi del PDF con Responses API. Il file potrebbe essere troppo grande o danneggiato.');\r\n    }\r\n    \r\n    throw new Error(`Errore nell'estrazione del testo PDF: ${error.message}`);\r\n  } finally {\r\n    // 4) Prova a rimuovere il file caricato (se l'SDK lo supporta)\r\n    try {\r\n      if (uploadedFile && uploadedFile.id) {\r\n        if (openai.files?.delete) {\r\n          await openai.files.delete(uploadedFile.id);\r\n        } else if (openai.files?.del) {\r\n          await openai.files.del(uploadedFile.id);\r\n        }\r\n        console.log('File rimosso da OpenAI:', uploadedFile.id);\r\n      }\r\n    } catch (delError) {\r\n      console.warn('Errore rimozione file da OpenAI (ignorato):', delError?.message || delError);\r\n    }\r\n  }\r\n}\r\n\r\n// DALL-E 3 - Get image URL only (faster, for streaming)\r\nexport async function getImageUrlFromDALLE(prompt, options = {}) {\r\n  if (!process.env.OPENAI_API_KEY) {\r\n    throw new Error('OPENAI_API_KEY is not configured. Please set it in your environment variables.');\r\n  }\r\n\r\n  try {\r\n    const size = options.size || '1024x1024';\r\n    const quality = options.quality || 'standard';\r\n    const style = options.style || 'vivid';\r\n\r\n    const response = await openai.images.generate({\r\n      model: 'dall-e-3',\r\n      prompt: prompt,\r\n      size: size,\r\n      quality: quality,\r\n      style: style,\r\n      n: 1,\r\n    });\r\n\r\n    const imageUrl = response.data[0]?.url;\r\n    if (!imageUrl) {\r\n      throw new Error('Nessuna immagine generata da DALL-E');\r\n    }\r\n\r\n    return imageUrl;\r\n  } catch (error) {\r\n    console.error('Error getting image URL from DALL-E:', error);\r\n    console.error('Error details:', {\r\n      status: error.status,\r\n      statusText: error.statusText,\r\n      message: error.message,\r\n      code: error.code,\r\n      response: error.response?.data || error.response\r\n    });\r\n    \r\n    if (error.status === 401) {\r\n      throw new Error('Chiave API OpenAI non valida. Verifica la configurazione.');\r\n    } else if (error.status === 429) {\r\n      throw new Error('Limite di rate raggiunto. Riprova tra qualche secondo.');\r\n    } else if (error.status === 400) {\r\n      const errorMessage = error.message || error.response?.data?.error?.message || 'Prompt non valido o contenuto non consentito';\r\n      throw new Error(`Errore nella generazione: ${errorMessage}`);\r\n    } else if (error.code === 'ENOTFOUND' || error.code === 'ECONNREFUSED') {\r\n      throw new Error('Errore di connessione con OpenAI. Verifica la tua connessione internet.');\r\n    }\r\n    \r\n    throw new Error(`Errore nella generazione dell'immagine: ${error.message || 'Errore sconosciuto'}`);\r\n  }\r\n}\r\n\r\n// DALL-E 3 - Generazione immagini (download completo, per backward compatibility)\r\nexport async function generateImageWithDALLE(prompt, options = {}) {\r\n  if (!process.env.OPENAI_API_KEY) {\r\n    throw new Error('OPENAI_API_KEY is not configured. Please set it in your environment variables.');\r\n  }\r\n\r\n  try {\r\n    const imageUrl = await getImageUrlFromDALLE(prompt, options);\r\n\r\n    // Download the image and return as buffer\r\n    const imageResponse = await fetch(imageUrl);\r\n    if (!imageResponse.ok) {\r\n      const errorText = await imageResponse.text().catch(() => 'Unknown error');\r\n      throw new Error(`Errore nel download dell'immagine generata: ${imageResponse.status} ${imageResponse.statusText}. ${errorText}`);\r\n    }\r\n\r\n    const arrayBuffer = await imageResponse.arrayBuffer();\r\n    return Buffer.from(arrayBuffer);\r\n  } catch (error) {\r\n    // Re-throw errors from getImageUrlFromDALLE\r\n    throw error;\r\n  }\r\n}\r\n\r\n// DALL-E 3 - Upscale/Miglioramento immagine usando variante\r\nexport async function upscaleImageWithDALLE(imageBuffer, imageMimeType, enhancementPrompt = null) {\r\n  if (!process.env.OPENAI_API_KEY) {\r\n    throw new Error('OPENAI_API_KEY is not configured. Please set it in your environment variables.');\r\n  }\r\n\r\n  try {\r\n    // 1. Analizza l'immagine con Vision API per creare un prompt descrittivo\r\n    const analysisPrompt = enhancementPrompt || 'Descrivi in dettaglio questa immagine, includendo tutti i dettagli visivi, colori, composizione, stile e qualità. La descrizione sarà usata per creare una versione migliorata ad alta risoluzione.';\r\n    \r\n    const imageDescription = await analyzeImageWithVision(\r\n      imageBuffer, \r\n      imageMimeType, \r\n      analysisPrompt\r\n    );\r\n\r\n    // 2. Crea un prompt per DALL-E che migliora l'immagine\r\n    const enhancementPromptText = `Crea una versione migliorata e ad alta risoluzione di questa immagine: ${imageDescription}. Mantieni fedeltà ai dettagli originali ma migliora la qualità, la nitidezza e la risoluzione.`;\r\n\r\n    // 3. Genera immagine migliorata con DALL-E 3 in alta risoluzione\r\n    const enhancedImageBuffer = await generateImageWithDALLE(enhancementPromptText, {\r\n      size: '1792x1024', // Formato landscape per alta risoluzione\r\n      quality: 'hd',\r\n      style: 'natural'\r\n    });\r\n\r\n    return enhancedImageBuffer;\r\n  } catch (error) {\r\n    console.error('Error upscaling image with DALL-E:', error);\r\n    throw new Error(`Errore nel miglioramento dell'immagine: ${error.message}`);\r\n  }\r\n}\r\n\r\n// Enhance existing image quality using AI analysis + sharp processing\r\nexport async function enhanceImageQualityWithAI(imageBuffer, imageMimeType) {\r\n  if (!process.env.OPENAI_API_KEY) {\r\n    throw new Error('OPENAI_API_KEY is not configured. Please set it in your environment variables.');\r\n  }\r\n\r\n  try {\r\n    // Use Vision API to analyze image quality issues\r\n    const analysisPrompt = `Analyze this image and identify specific quality issues that need improvement. Focus on:\r\n1. Noise level (low/medium/high)\r\n2. Sharpness (blurry/sharp)\r\n3. Color accuracy (washed out/vibrant)\r\n4. Artifacts (compression artifacts, pixelation)\r\n5. Overall quality issues\r\n\r\nRespond with a JSON object: {\"noise\": \"low|medium|high\", \"sharpness\": \"blurry|moderate|sharp\", \"color\": \"washed|normal|vibrant\", \"artifacts\": \"none|minor|major\", \"recommendations\": \"brief description\"}`;\r\n    \r\n    const analysisResult = await analyzeImageWithVision(\r\n      imageBuffer, \r\n      imageMimeType, \r\n      analysisPrompt\r\n    );\r\n\r\n    // Parse analysis result\r\n    let analysis = {\r\n      noise: 'medium',\r\n      sharpness: 'moderate',\r\n      color: 'normal',\r\n      artifacts: 'none'\r\n    };\r\n\r\n    try {\r\n      // Try to parse JSON from analysis\r\n      const jsonMatch = analysisResult.match(/\\{[\\s\\S]*\\}/);\r\n      if (jsonMatch) {\r\n        const parsed = JSON.parse(jsonMatch[0]);\r\n        analysis = { ...analysis, ...parsed };\r\n      }\r\n    } catch (parseError) {\r\n      console.warn('Could not parse AI analysis, using defaults');\r\n    }\r\n\r\n    // Apply targeted enhancements using sharp based on AI analysis\r\n    const sharp = (await import('sharp')).default;\r\n    let enhanced = sharp(imageBuffer, { sequentialRead: true });\r\n\r\n    // Apply denoising if needed\r\n    if (analysis.noise === 'high' || analysis.noise === 'medium') {\r\n      enhanced = enhanced.median(analysis.noise === 'high' ? 3 : 2);\r\n    }\r\n\r\n    // Apply sharpening based on analysis\r\n    if (analysis.sharpness === 'blurry') {\r\n      enhanced = enhanced.sharpen({\r\n        sigma: 2.0,\r\n        m1: 1.0,\r\n        m2: 0.5,\r\n        x1: 3,\r\n        y2: 3,\r\n        y3: 3\r\n      });\r\n    } else if (analysis.sharpness === 'moderate') {\r\n      enhanced = enhanced.sharpen({\r\n        sigma: 1.0,\r\n        m1: 0.7,\r\n        m2: 0.4\r\n      });\r\n    }\r\n\r\n    // Enhance color if needed\r\n    if (analysis.color === 'washed') {\r\n      enhanced = enhanced.modulate({\r\n        saturation: 1.15,\r\n        brightness: 1.05\r\n      }).linear(1.05, -(128 * 0.05)); // Slight contrast boost\r\n    }\r\n\r\n    // Remove compression artifacts\r\n    if (analysis.artifacts === 'major' || analysis.artifacts === 'minor') {\r\n      enhanced = enhanced.png({\r\n        quality: 100,\r\n        compressionLevel: 6,\r\n        adaptiveFiltering: true\r\n      });\r\n    } else {\r\n      // Keep original format but with high quality\r\n      if (imageMimeType === 'image/jpeg' || imageMimeType === 'image/jpg') {\r\n        enhanced = enhanced.jpeg({\r\n          quality: 98,\r\n          mozjpeg: true,\r\n          trellisQuantisation: true,\r\n          overshootDeringing: true\r\n        });\r\n      } else {\r\n        enhanced = enhanced.png({\r\n          quality: 100,\r\n          compressionLevel: 6\r\n        });\r\n      }\r\n    }\r\n\r\n    const enhancedBuffer = await enhanced.toBuffer();\r\n    return enhancedBuffer;\r\n  } catch (error) {\r\n    console.error('Error enhancing image quality with AI:', error);\r\n    // Return original buffer if enhancement fails\r\n    return imageBuffer;\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1119, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/jurit/OneDrive/Desktop/sito%20upscale/errors/index.js"],"sourcesContent":["/**\r\n * Centralized error handling\r\n * Provides consistent error responses and error classes\r\n */\r\n\r\nexport class AppError extends Error {\r\n  constructor(message, statusCode = 500, code = null, details = null, originalError = null) {\r\n    super(message);\r\n    this.name = this.constructor.name;\r\n    this.statusCode = statusCode;\r\n    this.code = code;\r\n    this.details = details;\r\n    this.originalError = originalError;\r\n    this.timestamp = new Date().toISOString();\r\n    this.requestId = null; // Can be set by middleware\r\n    \r\n    // Capture stack trace\r\n    if (Error.captureStackTrace) {\r\n      Error.captureStackTrace(this, this.constructor);\r\n    } else {\r\n      this.stack = (new Error()).stack;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Convert error to plain object for logging\r\n   */\r\n  toJSON() {\r\n    return {\r\n      name: this.name,\r\n      message: this.message,\r\n      statusCode: this.statusCode,\r\n      code: this.code,\r\n      details: this.details,\r\n      timestamp: this.timestamp,\r\n      requestId: this.requestId,\r\n      stack: this.stack,\r\n    };\r\n  }\r\n}\r\n\r\nexport class ValidationError extends AppError {\r\n  constructor(message, details = null) {\r\n    super(message, 400, 'VALIDATION_ERROR', details);\r\n  }\r\n}\r\n\r\nexport class AuthenticationError extends AppError {\r\n  constructor(message = 'Authentication required') {\r\n    super(message, 401, 'AUTHENTICATION_ERROR');\r\n  }\r\n}\r\n\r\nexport class AuthorizationError extends AppError {\r\n  constructor(message = 'Insufficient permissions') {\r\n    super(message, 403, 'AUTHORIZATION_ERROR');\r\n  }\r\n}\r\n\r\nexport class NotFoundError extends AppError {\r\n  constructor(resource = 'Resource') {\r\n    super(`${resource} not found`, 404, 'NOT_FOUND');\r\n  }\r\n}\r\n\r\nexport class ConflictError extends AppError {\r\n  constructor(message) {\r\n    super(message, 409, 'CONFLICT');\r\n  }\r\n}\r\n\r\nexport class RateLimitError extends AppError {\r\n  constructor(message = 'Too many requests', retryAfter = null) {\r\n    super(message, 429, 'RATE_LIMIT_EXCEEDED', retryAfter ? { retryAfter } : null);\r\n  }\r\n}\r\n\r\nexport class DatabaseError extends AppError {\r\n  constructor(message, originalError = null) {\r\n    super(message, 500, 'DATABASE_ERROR', null, originalError);\r\n  }\r\n}\r\n\r\nexport class FileSystemError extends AppError {\r\n  constructor(message, originalError = null) {\r\n    super(message, 500, 'FILE_SYSTEM_ERROR', null, originalError);\r\n  }\r\n}\r\n\r\nexport class NetworkError extends AppError {\r\n  constructor(message, originalError = null) {\r\n    super(message, 503, 'NETWORK_ERROR', null, originalError);\r\n  }\r\n}\r\n\r\nexport class TimeoutError extends AppError {\r\n  constructor(message = 'Request timeout', timeoutMs = null) {\r\n    super(message, 408, 'TIMEOUT_ERROR', timeoutMs ? { timeoutMs } : null);\r\n  }\r\n}\r\n\r\nexport class FileTooLargeError extends AppError {\r\n  constructor(maxSize, actualSize = null) {\r\n    const message = `File too large. Maximum size is ${formatFileSize(maxSize)}`;\r\n    super(message, 413, 'FILE_TOO_LARGE', { maxSize, actualSize });\r\n  }\r\n}\r\n\r\nexport class InvalidFileTypeError extends AppError {\r\n  constructor(allowedTypes = null) {\r\n    const message = allowedTypes \r\n      ? `Invalid file type. Allowed types: ${allowedTypes.join(', ')}`\r\n      : 'Invalid file type';\r\n    super(message, 400, 'INVALID_FILE_TYPE', { allowedTypes });\r\n  }\r\n}\r\n\r\nexport class ProcessingError extends AppError {\r\n  constructor(message, originalError = null) {\r\n    super(message, 500, 'PROCESSING_ERROR', null, originalError);\r\n  }\r\n}\r\n\r\n/**\r\n * Format file size for human-readable display\r\n */\r\nfunction formatFileSize(bytes) {\r\n  if (bytes === 0) return '0 Bytes';\r\n  const k = 1024;\r\n  const sizes = ['Bytes', 'KB', 'MB', 'GB'];\r\n  const i = Math.floor(Math.log(bytes) / Math.log(k));\r\n  return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];\r\n}\r\n\r\n/**\r\n * Enhanced error logger with advanced tracking\r\n */\r\nasync function logError(error, context = {}) {\r\n  const errorInfo = {\r\n    timestamp: new Date().toISOString(),\r\n    error: error instanceof AppError ? error.toJSON() : {\r\n      name: error.name,\r\n      message: error.message,\r\n      stack: error.stack,\r\n    },\r\n    context,\r\n    environment: process.env.NODE_ENV,\r\n  };\r\n\r\n  // Log to console with appropriate level\r\n  if (error instanceof AppError && error.statusCode < 500) {\r\n    // Client errors (4xx) - log as warning\r\n    console.warn('Client Error:', JSON.stringify(errorInfo, null, 2));\r\n  } else {\r\n    // Server errors (5xx) - log as error\r\n    console.error('Server Error:', JSON.stringify(errorInfo, null, 2));\r\n  }\r\n\r\n  // Track error with advanced error tracker\r\n  try {\r\n    const { default: errorTracker } = await import('../lib/errorTracker.js');\r\n    const { log } = await import('../lib/logger.js');\r\n    await errorTracker.trackError(error, context);\r\n    log.error('Error logged', error, context);\r\n  } catch (importError) {\r\n    // Error tracker not available, continue with basic logging\r\n    console.warn('Error tracker not available:', importError.message);\r\n  }\r\n\r\n  // In production, you might want to send to error tracking service\r\n  // Example: Sentry, LogRocket, etc.\r\n  if (process.env.NODE_ENV === 'production' && process.env.ERROR_TRACKING_ENABLED === 'true') {\r\n    // TODO: Integrate with error tracking service\r\n    // trackError(errorInfo);\r\n  }\r\n\r\n  return errorInfo;\r\n}\r\n\r\n/**\r\n * Format error response for API\r\n */\r\nexport function formatErrorResponse(error, includeStack = false, includeDetails = true) {\r\n  const isDevelopment = process.env.NODE_ENV === 'development';\r\n  \r\n  const response = {\r\n    error: error.message || 'Internal server error',\r\n    code: error.code || 'INTERNAL_ERROR',\r\n  };\r\n\r\n  // Include details if available and allowed\r\n  if (includeDetails && error.details) {\r\n    response.details = error.details;\r\n  }\r\n\r\n  // Include stack trace only in development\r\n  if (includeStack || isDevelopment) {\r\n    response.stack = error.stack;\r\n  }\r\n\r\n  // Include request ID if available\r\n  if (error.requestId) {\r\n    response.requestId = error.requestId;\r\n  }\r\n\r\n  // Include timestamp\r\n  if (error.timestamp) {\r\n    response.timestamp = error.timestamp;\r\n  }\r\n\r\n  return response;\r\n}\r\n\r\n/**\r\n * Handle errors in API routes with improved error resolution\r\n */\r\nexport async function handleApiError(error, res, context = {}) {\r\n  // Log the error with context\r\n  await logError(error, context);\r\n\r\n  // If response already sent, just log\r\n  if (res.headersSent) {\r\n    return;\r\n  }\r\n\r\n  // Handle known error types\r\n  if (error instanceof AppError) {\r\n    return res.status(error.statusCode).json(\r\n      formatErrorResponse(error, false, true)\r\n    );\r\n  }\r\n\r\n  // Handle specific error types from libraries and Node.js\r\n  if (error.name === 'ValidationError' || error.name === 'CastError') {\r\n    return res.status(400).json(\r\n      formatErrorResponse(new ValidationError(error.message, error.errors), false)\r\n    );\r\n  }\r\n\r\n  // Handle database connection errors\r\n  if (error.code === 'ECONNREFUSED' || error.code === 'ETIMEDOUT') {\r\n    return res.status(503).json(\r\n      formatErrorResponse(\r\n        new NetworkError('Database connection failed', error),\r\n        false\r\n      )\r\n    );\r\n  }\r\n\r\n  // Handle file system errors\r\n  if (error.code === 'ENOENT' || error.code === 'EACCES' || error.code === 'EMFILE') {\r\n    return res.status(500).json(\r\n      formatErrorResponse(\r\n        new FileSystemError('File system operation failed', error),\r\n        false\r\n      )\r\n    );\r\n  }\r\n\r\n  // Handle timeout errors\r\n  if (error.message && (error.message.includes('timeout') || error.message.includes('ETIMEDOUT'))) {\r\n    return res.status(408).json(\r\n      formatErrorResponse(\r\n        new TimeoutError('Request timeout', error.timeout),\r\n        false\r\n      )\r\n    );\r\n  }\r\n\r\n  // Handle file size errors\r\n  if (error.code === 'LIMIT_FILE_SIZE' || error.message?.includes('too large')) {\r\n    return res.status(413).json(\r\n      formatErrorResponse(\r\n        new FileTooLargeError(),\r\n        false\r\n      )\r\n    );\r\n  }\r\n\r\n  // Default to 500 with safe error message\r\n  const isDevelopment = process.env.NODE_ENV === 'development';\r\n  const safeMessage = isDevelopment \r\n    ? error.message || 'Internal server error'\r\n    : 'Internal server error';\r\n  \r\n  res.status(500).json(\r\n    formatErrorResponse(\r\n      new AppError(safeMessage, 500, 'INTERNAL_ERROR', null, error),\r\n      isDevelopment\r\n    )\r\n  );\r\n}\r\n\r\n/**\r\n * Create error handler wrapper for async route handlers\r\n */\r\nexport function asyncHandler(handler) {\r\n  return async (req, res, next) => {\r\n    try {\r\n      await handler(req, res, next);\r\n    } catch (error) {\r\n      handleApiError(error, res, {\r\n        method: req.method,\r\n        url: req.url,\r\n        path: req.path,\r\n        query: req.query,\r\n        user: req.user?.id,\r\n      });\r\n    }\r\n  };\r\n}\r\n\r\n/**\r\n * Retry logic for operations that might fail temporarily\r\n */\r\nexport async function retryOperation(operation, maxRetries = 3, delay = 1000) {\r\n  let lastError;\r\n  \r\n  for (let attempt = 1; attempt <= maxRetries; attempt++) {\r\n    try {\r\n      return await operation();\r\n    } catch (error) {\r\n      lastError = error;\r\n      \r\n      // Don't retry on certain errors\r\n      if (error instanceof ValidationError || \r\n          error instanceof AuthenticationError ||\r\n          error instanceof AuthorizationError) {\r\n        throw error;\r\n      }\r\n      \r\n      // If last attempt, throw error\r\n      if (attempt === maxRetries) {\r\n        break;\r\n      }\r\n      \r\n      // Wait before retrying (exponential backoff)\r\n      const waitTime = delay * Math.pow(2, attempt - 1);\r\n      await new Promise(resolve => setTimeout(resolve, waitTime));\r\n    }\r\n  }\r\n  \r\n  throw lastError;\r\n}\r\n\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1422, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/jurit/OneDrive/Desktop/sito%20upscale/lib/usage-limits.js"],"sourcesContent":["// Sistema di limiti d'uso per tool gratuiti e PRO\r\n// Piano gratuito senza registrazione: molto generoso per convincere a registrarsi\r\n\r\nexport const USAGE_LIMITS = {\r\n    // Piano gratuito SENZA registrazione (generoso ma limitato per incentivare registrazione)\r\n    GUEST: {\r\n        // Tool PRO - 5 utilizzi al giorno per tutti (generoso ma limitato)\r\n        'rimozione-sfondo-ai': {\r\n            daily: 5, // 5 immagini al giorno\r\n            monthly: 50, // 50 immagini al mese\r\n            fileSize: 5 * 1024 * 1024, // 5MB max\r\n        },\r\n        'generazione-immagini-ai': {\r\n            daily: 5, // 5 immagini al giorno\r\n            monthly: 50, // 50 immagini al mese\r\n        },\r\n        'clean-noise-ai': {\r\n            daily: 5, // 5 audio al giorno\r\n            monthly: 50, // 50 audio al mese\r\n            fileSize: 10 * 1024 * 1024, // 10MB max\r\n        },\r\n        'ocr-avanzato-ai': {\r\n            daily: 5, // 5 documenti al giorno\r\n            monthly: 50, // 50 documenti al mese\r\n            fileSize: 10 * 1024 * 1024, // 10MB max\r\n        },\r\n        'traduzione-documenti-ai': {\r\n            daily: 5, // 5 documenti al giorno\r\n            monthly: 50, // 50 documenti al mese\r\n            fileSize: 10 * 1024 * 1024, // 10MB max\r\n        },\r\n        'elabora-e-riassumi': {\r\n            daily: 5, // 5 testi al giorno\r\n            monthly: 50, // 50 testi al mese\r\n            maxLength: 5000, // 5000 caratteri max\r\n        },\r\n        'thumbnail-generator': {\r\n            daily: 5, // 5 thumbnail al giorno\r\n            monthly: 50, // 50 thumbnail al mese\r\n        },\r\n        'upscaler-ai': {\r\n            daily: 5, // 5 immagini al giorno\r\n            monthly: 50, // 50 immagini al mese\r\n            fileSize: 5 * 1024 * 1024, // 5MB max\r\n        },\r\n        // Tool gratuiti - limiti molto generosi\r\n        'trascrizione-audio': {\r\n            daily: 10, // 10 audio al giorno\r\n            monthly: 200, // 200 audio al mese\r\n            fileSize: 25 * 1024 * 1024, // 25MB max\r\n        },\r\n        'riassunto-testo': {\r\n            daily: 20, // 20 testi al giorno\r\n            monthly: 500, // 500 testi al mese\r\n            maxLength: 10000, // 10000 caratteri max\r\n        },\r\n        'traduci-testo': {\r\n            daily: 50, // 50 traduzioni al giorno\r\n            monthly: 1000, // 1000 traduzioni al mese\r\n            maxLength: 5000, // 5000 caratteri max\r\n        },\r\n        'correttore-grammaticale': {\r\n            daily: 30, // 30 testi al giorno\r\n            monthly: 500, // 500 testi al mese\r\n            maxLength: 5000, // 5000 caratteri max\r\n        },\r\n        'combina-splitta-pdf': {\r\n            daily: 20, // 20 operazioni al giorno\r\n            monthly: 300, // 300 operazioni al mese\r\n            fileSize: 50 * 1024 * 1024, // 50MB max\r\n        },\r\n    },\r\n    \r\n    // Piano gratuito CON registrazione (ancora più generoso)\r\n    FREE: {\r\n        'rimozione-sfondo-ai': {\r\n            daily: 50, // 50 immagini al giorno\r\n            monthly: 1000, // 1000 immagini al mese\r\n            fileSize: 10 * 1024 * 1024, // 10MB max\r\n        },\r\n        'generazione-immagini-ai': {\r\n            daily: 20, // 20 immagini al giorno\r\n            monthly: 300, // 300 immagini al mese\r\n        },\r\n        'clean-noise-ai': {\r\n            daily: 20, // 20 audio al giorno\r\n            monthly: 400, // 400 audio al mese\r\n            fileSize: 25 * 1024 * 1024, // 25MB max\r\n        },\r\n        'ocr-avanzato-ai': {\r\n            daily: 50, // 50 documenti al giorno\r\n            monthly: 1000, // 1000 documenti al mese\r\n            fileSize: 25 * 1024 * 1024, // 25MB max\r\n        },\r\n        'traduzione-documenti-ai': {\r\n            daily: 20, // 20 documenti al giorno\r\n            monthly: 400, // 400 documenti al mese\r\n            fileSize: 25 * 1024 * 1024, // 25MB max\r\n        },\r\n        'elabora-e-riassumi': {\r\n            daily: 50, // 50 testi al giorno\r\n            monthly: 1000, // 1000 testi al mese\r\n            maxLength: 20000, // 20000 caratteri max\r\n        },\r\n        'thumbnail-generator': {\r\n            daily: 50, // 50 thumbnail al giorno\r\n            monthly: 1000, // 1000 thumbnail al mese\r\n        },\r\n        'upscaler-ai': {\r\n            daily: 100, // 100 immagini al giorno\r\n            monthly: 2000, // 2000 immagini al mese\r\n            fileSize: 25 * 1024 * 1024, // 25MB max\r\n        },\r\n        'trascrizione-audio': {\r\n            daily: 50, // 50 audio al giorno\r\n            monthly: 1000, // 1000 audio al mese\r\n            fileSize: 50 * 1024 * 1024, // 50MB max\r\n        },\r\n        'riassunto-testo': {\r\n            daily: 100, // 100 testi al giorno\r\n            monthly: 2000, // 2000 testi al mese\r\n            maxLength: 50000, // 50000 caratteri max\r\n        },\r\n        'traduci-testo': {\r\n            daily: 200, // 200 traduzioni al giorno\r\n            monthly: 5000, // 5000 traduzioni al mese\r\n            maxLength: 20000, // 20000 caratteri max\r\n        },\r\n        'correttore-grammaticale': {\r\n            daily: 100, // 100 testi al giorno\r\n            monthly: 2000, // 2000 testi al mese\r\n            maxLength: 20000, // 20000 caratteri max\r\n        },\r\n        'combina-splitta-pdf': {\r\n            daily: 100, // 100 operazioni al giorno\r\n            monthly: 2000, // 2000 operazioni al mese\r\n            fileSize: 100 * 1024 * 1024, // 100MB max\r\n        },\r\n    },\r\n    \r\n    // Piano PRO (illimitato o limiti molto alti)\r\n    PRO: {\r\n        'rimozione-sfondo-ai': {\r\n            daily: -1, // Illimitato\r\n            monthly: -1, // Illimitato\r\n            fileSize: 50 * 1024 * 1024, // 50MB max\r\n        },\r\n        'generazione-immagini-ai': {\r\n            daily: 100, // 100 immagini al giorno\r\n            monthly: 2000, // 2000 immagini al mese\r\n        },\r\n        'clean-noise-ai': {\r\n            daily: -1, // Illimitato\r\n            monthly: -1, // Illimitato\r\n            fileSize: 100 * 1024 * 1024, // 100MB max\r\n        },\r\n        'ocr-avanzato-ai': {\r\n            daily: -1, // Illimitato\r\n            monthly: -1, // Illimitato\r\n            fileSize: 100 * 1024 * 1024, // 100MB max\r\n        },\r\n        'traduzione-documenti-ai': {\r\n            daily: -1, // Illimitato\r\n            monthly: -1, // Illimitato\r\n            fileSize: 100 * 1024 * 1024, // 100MB max\r\n        },\r\n        'elabora-e-riassumi': {\r\n            daily: -1, // Illimitato\r\n            monthly: -1, // Illimitato\r\n            maxLength: -1, // Illimitato\r\n        },\r\n        'thumbnail-generator': {\r\n            daily: -1, // Illimitato\r\n            monthly: -1, // Illimitato\r\n        },\r\n        'upscaler-ai': {\r\n            daily: -1, // Illimitato\r\n            monthly: -1, // Illimitato\r\n            fileSize: 100 * 1024 * 1024, // 100MB max\r\n        },\r\n        'trascrizione-audio': {\r\n            daily: -1, // Illimitato\r\n            monthly: -1, // Illimitato\r\n            fileSize: 200 * 1024 * 1024, // 200MB max\r\n        },\r\n        'riassunto-testo': {\r\n            daily: -1, // Illimitato\r\n            monthly: -1, // Illimitato\r\n            maxLength: -1, // Illimitato\r\n        },\r\n        'traduci-testo': {\r\n            daily: -1, // Illimitato\r\n            monthly: -1, // Illimitato\r\n            maxLength: -1, // Illimitato\r\n        },\r\n        'correttore-grammaticale': {\r\n            daily: -1, // Illimitato\r\n            monthly: -1, // Illimitato\r\n            maxLength: -1, // Illimitato\r\n        },\r\n        'combina-splitta-pdf': {\r\n            daily: -1, // Illimitato\r\n            monthly: -1, // Illimitato\r\n            fileSize: 500 * 1024 * 1024, // 500MB max\r\n        },\r\n    },\r\n};\r\n\r\n/**\r\n * Ottiene i limiti per un tool specifico in base al piano utente\r\n * @param {string} toolSlug - Slug del tool\r\n * @param {string} userPlan - Piano utente: 'GUEST', 'FREE', 'PRO'\r\n * @returns {Object|null} Limiti del tool o null se non trovato\r\n */\r\nexport function getToolLimits(toolSlug, userPlan = 'GUEST') {\r\n    const planLimits = USAGE_LIMITS[userPlan] || USAGE_LIMITS.GUEST;\r\n    return planLimits[toolSlug] || null;\r\n}\r\n\r\n/**\r\n * Verifica se un utente può usare un tool\r\n * @param {string} toolSlug - Slug del tool\r\n * @param {string} userPlan - Piano utente\r\n * @param {Object} usageStats - Statistiche uso corrente (daily, monthly)\r\n * @param {Object} fileInfo - Info file (size, length, etc.)\r\n * @returns {Object} { allowed: boolean, reason: string }\r\n */\r\nexport function canUseTool(toolSlug, userPlan = 'GUEST', usageStats = {}, fileInfo = {}) {\r\n    const limits = getToolLimits(toolSlug, userPlan);\r\n    \r\n    if (!limits) {\r\n        return { allowed: true, reason: 'Nessun limite configurato' };\r\n    }\r\n    \r\n    // Verifica limite giornaliero\r\n    if (limits.daily !== -1 && usageStats.daily >= limits.daily) {\r\n        return {\r\n            allowed: false,\r\n            reason: `Hai raggiunto il limite giornaliero di ${limits.daily} utilizzi. Riprova domani o passa a PRO per limiti più alti.`,\r\n            limitType: 'daily',\r\n            current: usageStats.daily,\r\n            max: limits.daily,\r\n        };\r\n    }\r\n    \r\n    // Verifica limite mensile\r\n    if (limits.monthly !== -1 && usageStats.monthly >= limits.monthly) {\r\n        return {\r\n            allowed: false,\r\n            reason: `Hai raggiunto il limite mensile di ${limits.monthly} utilizzi. Passa a PRO per limiti più alti.`,\r\n            limitType: 'monthly',\r\n            current: usageStats.monthly,\r\n            max: limits.monthly,\r\n        };\r\n    }\r\n    \r\n    // Verifica dimensione file\r\n    if (limits.fileSize && fileInfo.size && fileInfo.size > limits.fileSize) {\r\n        const maxMB = (limits.fileSize / (1024 * 1024)).toFixed(0);\r\n        return {\r\n            allowed: false,\r\n            reason: `File troppo grande. Dimensione massima: ${maxMB}MB. Passa a PRO per file più grandi.`,\r\n            limitType: 'fileSize',\r\n            current: fileInfo.size,\r\n            max: limits.fileSize,\r\n        };\r\n    }\r\n    \r\n    // Verifica lunghezza testo\r\n    if (limits.maxLength && fileInfo.length && fileInfo.length > limits.maxLength) {\r\n        return {\r\n            allowed: false,\r\n            reason: `Testo troppo lungo. Lunghezza massima: ${limits.maxLength} caratteri. Passa a PRO per testi più lunghi.`,\r\n            limitType: 'maxLength',\r\n            current: fileInfo.length,\r\n            max: limits.maxLength,\r\n        };\r\n    }\r\n    \r\n    return { allowed: true, reason: 'OK' };\r\n}\r\n\r\n/**\r\n * Ottiene il messaggio di upgrade per un tool\r\n * @param {string} toolSlug - Slug del tool\r\n * @param {string} currentPlan - Piano corrente\r\n * @returns {string} Messaggio di upgrade\r\n */\r\nexport function getUpgradeMessage(toolSlug, currentPlan = 'GUEST') {\r\n    const limits = getToolLimits(toolSlug, currentPlan);\r\n    const proLimits = getToolLimits(toolSlug, 'PRO');\r\n    \r\n    if (!limits || !proLimits) {\r\n        return 'Passa a PRO per funzionalità avanzate!';\r\n    }\r\n    \r\n    const messages = [];\r\n    \r\n    if (limits.daily !== -1 && proLimits.daily === -1) {\r\n        messages.push('utilizzi illimitati');\r\n    } else if (limits.daily < proLimits.daily) {\r\n        messages.push(`${proLimits.daily} utilizzi al giorno`);\r\n    }\r\n    \r\n    if (limits.fileSize && proLimits.fileSize && limits.fileSize < proLimits.fileSize) {\r\n        const maxMB = (proLimits.fileSize / (1024 * 1024)).toFixed(0);\r\n        messages.push(`file fino a ${maxMB}MB`);\r\n    }\r\n    \r\n    if (limits.maxLength && proLimits.maxLength === -1) {\r\n        messages.push('testi di lunghezza illimitata');\r\n    }\r\n    \r\n    if (messages.length === 0) {\r\n        return 'Passa a PRO per funzionalità avanzate!';\r\n    }\r\n    \r\n    return `Passa a PRO per ${messages.join(', ')} e molto altro!`;\r\n}\r\n\r\nexport default {\r\n    USAGE_LIMITS,\r\n    getToolLimits,\r\n    canUseTool,\r\n    getUpgradeMessage,\r\n};\r\n\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1730, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/jurit/OneDrive/Desktop/sito%20upscale/lib/usage-tracker.js"],"sourcesContent":["// Sistema di tracking degli usi per limiti gratuiti/PRO\r\n// Usa storage in-memory (in produzione si può usare database)\r\n\r\nconst usageStore = new Map(); // { userId: { toolSlug: { daily: count, monthly: count, lastReset: date } } }\r\n\r\n/**\r\n * Ottiene le statistiche di uso per un utente e tool\r\n * @param {string} userId - ID utente (o 'guest' per utenti non registrati)\r\n * @param {string} toolSlug - Slug del tool\r\n * @returns {Object} { daily: number, monthly: number }\r\n */\r\nexport function getUsageStats(userId = 'guest', toolSlug) {\r\n    const userKey = userId || 'guest';\r\n    \r\n    if (!usageStore.has(userKey)) {\r\n        usageStore.set(userKey, {});\r\n    }\r\n    \r\n    const userUsage = usageStore.get(userKey);\r\n    \r\n    if (!userUsage[toolSlug]) {\r\n        userUsage[toolSlug] = {\r\n            daily: 0,\r\n            monthly: 0,\r\n            lastDailyReset: new Date().toDateString(),\r\n            lastMonthlyReset: new Date().getMonth(),\r\n        };\r\n    }\r\n    \r\n    const toolUsage = userUsage[toolSlug];\r\n    const today = new Date().toDateString();\r\n    const thisMonth = new Date().getMonth();\r\n    \r\n    // Reset giornaliero se necessario\r\n    if (toolUsage.lastDailyReset !== today) {\r\n        toolUsage.daily = 0;\r\n        toolUsage.lastDailyReset = today;\r\n    }\r\n    \r\n    // Reset mensile se necessario\r\n    if (toolUsage.lastMonthlyReset !== thisMonth) {\r\n        toolUsage.monthly = 0;\r\n        toolUsage.lastMonthlyReset = thisMonth;\r\n    }\r\n    \r\n    return {\r\n        daily: toolUsage.daily || 0,\r\n        monthly: toolUsage.monthly || 0,\r\n    };\r\n}\r\n\r\n/**\r\n * Incrementa il contatore di uso per un tool\r\n * @param {string} userId - ID utente\r\n * @param {string} toolSlug - Slug del tool\r\n */\r\nexport function incrementUsage(userId = 'guest', toolSlug) {\r\n    const userKey = userId || 'guest';\r\n    \r\n    if (!usageStore.has(userKey)) {\r\n        usageStore.set(userKey, {});\r\n    }\r\n    \r\n    const userUsage = usageStore.get(userKey);\r\n    \r\n    if (!userUsage[toolSlug]) {\r\n        userUsage[toolSlug] = {\r\n            daily: 0,\r\n            monthly: 0,\r\n            lastDailyReset: new Date().toDateString(),\r\n            lastMonthlyReset: new Date().getMonth(),\r\n        };\r\n    }\r\n    \r\n    const toolUsage = userUsage[toolSlug];\r\n    const today = new Date().toDateString();\r\n    const thisMonth = new Date().getMonth();\r\n    \r\n    // Reset se necessario\r\n    if (toolUsage.lastDailyReset !== today) {\r\n        toolUsage.daily = 0;\r\n        toolUsage.lastDailyReset = today;\r\n    }\r\n    \r\n    if (toolUsage.lastMonthlyReset !== thisMonth) {\r\n        toolUsage.monthly = 0;\r\n        toolUsage.lastMonthlyReset = thisMonth;\r\n    }\r\n    \r\n    // Incrementa contatori\r\n    toolUsage.daily = (toolUsage.daily || 0) + 1;\r\n    toolUsage.monthly = (toolUsage.monthly || 0) + 1;\r\n}\r\n\r\n/**\r\n * Ottiene il piano utente (per ora semplificato, in produzione si legge dal database)\r\n * @param {Object} req - Request object (opzionale)\r\n * @returns {string} Piano utente: 'GUEST', 'FREE', 'PRO'\r\n */\r\nexport function getUserPlan(req = null) {\r\n    // TODO: In produzione, leggere dal database o dalla sessione\r\n    // Per ora ritorna sempre 'GUEST' (utente non registrato)\r\n    \r\n    if (req && req.headers && req.headers['x-user-id']) {\r\n        // Se c'è un user ID, potresti controllare il piano dal database\r\n        // Per ora assumiamo FREE se registrato\r\n        return 'FREE';\r\n    }\r\n    \r\n    return 'GUEST';\r\n}\r\n\r\n/**\r\n * Ottiene l'ID utente dalla richiesta\r\n * @param {Object} req - Request object\r\n * @returns {string} User ID o 'guest'\r\n */\r\nexport function getUserId(req = null) {\r\n    if (req && req.headers && req.headers['x-user-id']) {\r\n        return req.headers['x-user-id'];\r\n    }\r\n    \r\n    // In produzione, potresti usare session/cookie\r\n    return 'guest';\r\n}\r\n\r\nexport default {\r\n    getUsageStats,\r\n    incrementUsage,\r\n    getUserPlan,\r\n    getUserId,\r\n};\r\n\r\n"],"names":[],"mappings":"AAAA,wDAAwD;AACxD,8DAA8D;;;;;;;;;;;;;AAE9D,MAAM,aAAa,IAAI,OAAO,8EAA8E;AAQrG,SAAS,cAAc,SAAS,OAAO,EAAE,QAAQ;IACpD,MAAM,UAAU,UAAU;IAE1B,IAAI,CAAC,WAAW,GAAG,CAAC,UAAU;QAC1B,WAAW,GAAG,CAAC,SAAS,CAAC;IAC7B;IAEA,MAAM,YAAY,WAAW,GAAG,CAAC;IAEjC,IAAI,CAAC,SAAS,CAAC,SAAS,EAAE;QACtB,SAAS,CAAC,SAAS,GAAG;YAClB,OAAO;YACP,SAAS;YACT,gBAAgB,IAAI,OAAO,YAAY;YACvC,kBAAkB,IAAI,OAAO,QAAQ;QACzC;IACJ;IAEA,MAAM,YAAY,SAAS,CAAC,SAAS;IACrC,MAAM,QAAQ,IAAI,OAAO,YAAY;IACrC,MAAM,YAAY,IAAI,OAAO,QAAQ;IAErC,kCAAkC;IAClC,IAAI,UAAU,cAAc,KAAK,OAAO;QACpC,UAAU,KAAK,GAAG;QAClB,UAAU,cAAc,GAAG;IAC/B;IAEA,8BAA8B;IAC9B,IAAI,UAAU,gBAAgB,KAAK,WAAW;QAC1C,UAAU,OAAO,GAAG;QACpB,UAAU,gBAAgB,GAAG;IACjC;IAEA,OAAO;QACH,OAAO,UAAU,KAAK,IAAI;QAC1B,SAAS,UAAU,OAAO,IAAI;IAClC;AACJ;AAOO,SAAS,eAAe,SAAS,OAAO,EAAE,QAAQ;IACrD,MAAM,UAAU,UAAU;IAE1B,IAAI,CAAC,WAAW,GAAG,CAAC,UAAU;QAC1B,WAAW,GAAG,CAAC,SAAS,CAAC;IAC7B;IAEA,MAAM,YAAY,WAAW,GAAG,CAAC;IAEjC,IAAI,CAAC,SAAS,CAAC,SAAS,EAAE;QACtB,SAAS,CAAC,SAAS,GAAG;YAClB,OAAO;YACP,SAAS;YACT,gBAAgB,IAAI,OAAO,YAAY;YACvC,kBAAkB,IAAI,OAAO,QAAQ;QACzC;IACJ;IAEA,MAAM,YAAY,SAAS,CAAC,SAAS;IACrC,MAAM,QAAQ,IAAI,OAAO,YAAY;IACrC,MAAM,YAAY,IAAI,OAAO,QAAQ;IAErC,sBAAsB;IACtB,IAAI,UAAU,cAAc,KAAK,OAAO;QACpC,UAAU,KAAK,GAAG;QAClB,UAAU,cAAc,GAAG;IAC/B;IAEA,IAAI,UAAU,gBAAgB,KAAK,WAAW;QAC1C,UAAU,OAAO,GAAG;QACpB,UAAU,gBAAgB,GAAG;IACjC;IAEA,uBAAuB;IACvB,UAAU,KAAK,GAAG,CAAC,UAAU,KAAK,IAAI,CAAC,IAAI;IAC3C,UAAU,OAAO,GAAG,CAAC,UAAU,OAAO,IAAI,CAAC,IAAI;AACnD;AAOO,SAAS,YAAY,MAAM,IAAI;IAClC,6DAA6D;IAC7D,yDAAyD;IAEzD,IAAI,OAAO,IAAI,OAAO,IAAI,IAAI,OAAO,CAAC,YAAY,EAAE;QAChD,gEAAgE;QAChE,uCAAuC;QACvC,OAAO;IACX;IAEA,OAAO;AACX;AAOO,SAAS,UAAU,MAAM,IAAI;IAChC,IAAI,OAAO,IAAI,OAAO,IAAI,IAAI,OAAO,CAAC,YAAY,EAAE;QAChD,OAAO,IAAI,OAAO,CAAC,YAAY;IACnC;IAEA,+CAA+C;IAC/C,OAAO;AACX;uCAEe;IACX;IACA;IACA;IACA;AACJ"}},
    {"offset": {"line": 1836, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/jurit/OneDrive/Desktop/sito%20upscale/pages/api/upscale.js"],"sourcesContent":["import formidable from 'formidable';\r\nimport fs from 'fs/promises';\r\nimport upscaleImage from '../../utils/upscale.js';\r\nimport { enhanceImageQualityWithAI } from '../../lib/openai.js';\r\nimport { \r\n  handleApiError, \r\n  ValidationError, \r\n  FileTooLargeError, \r\n  InvalidFileTypeError,\r\n  TimeoutError,\r\n  ProcessingError,\r\n  FileSystemError\r\n} from '../../errors';\r\nimport { canUseTool, getUpgradeMessage } from '../../lib/usage-limits.js';\r\nimport { getUsageStats, incrementUsage, getUserPlan, getUserId } from '../../lib/usage-tracker.js';\r\n\r\nexport const config = {\r\n  api: {\r\n    bodyParser: false,\r\n  },\r\n};\r\n\r\nexport default async function handler(req, res) {\r\n  if (req.method !== 'POST') {\r\n    res.setHeader('Allow', 'POST');\r\n    return res.status(405).json({ error: 'Method not allowed', code: 'METHOD_NOT_ALLOWED' });\r\n  }\r\n\r\n  // Set timeout for long-running operations\r\n  const MAX_FILE_SIZE = 50 * 1024 * 1024; // 50MB\r\n  const TIMEOUT_MS = 120000; // 2 minutes\r\n\r\n  const form = formidable({ \r\n    multiples: false,\r\n    maxFileSize: MAX_FILE_SIZE,\r\n    keepExtensions: true,\r\n  });\r\n\r\n  let filePath = null;\r\n\r\n  try {\r\n    // Support both callback and promise styles robustly\r\n    const parsed = await Promise.race([\r\n      new Promise((resolve, reject) => {\r\n        form.parse(req, (err, fields, files) => {\r\n          if (err) {\r\n            // Handle formidable-specific errors\r\n            if (err.code === 'LIMIT_FILE_SIZE') {\r\n              return reject(new FileTooLargeError(MAX_FILE_SIZE));\r\n            }\r\n            return reject(new ValidationError('File upload failed: ' + err.message, err));\r\n          }\r\n          resolve({ fields, files });\r\n        });\r\n      }),\r\n      new Promise((_, reject) => \r\n        setTimeout(() => reject(new TimeoutError('Request timeout', TIMEOUT_MS)), TIMEOUT_MS)\r\n      )\r\n    ]);\r\n\r\n    const { files } = parsed;\r\n\r\n    // Accept 'image' or 'file' field names; normalize array/single\r\n    let file = files?.image ?? files?.file ?? null;\r\n    if (Array.isArray(file)) file = file[0];\r\n\r\n    if (!file) {\r\n      throw new ValidationError('No file uploaded');\r\n    }\r\n\r\n    // Validate file type\r\n    if (!file.mimetype?.startsWith('image/')) {\r\n      throw new InvalidFileTypeError(['image/jpeg', 'image/png', 'image/webp', 'image/gif']);\r\n    }\r\n\r\n    // Validate file size\r\n    if (file.size > MAX_FILE_SIZE) {\r\n      throw new FileTooLargeError(MAX_FILE_SIZE, file.size);\r\n    }\r\n\r\n    // Verifica limiti d'uso (tool PRO)\r\n    const userId = getUserId(req);\r\n    const userPlan = getUserPlan(req);\r\n    const toolSlug = 'upscaler-ai';\r\n    const usageStats = getUsageStats(userId, toolSlug);\r\n    const fileInfo = {\r\n      size: file.size,\r\n    };\r\n\r\n    const limitCheck = canUseTool(toolSlug, userPlan, usageStats, fileInfo);\r\n    \r\n    if (!limitCheck.allowed) {\r\n      // Cleanup file prima di ritornare errore\r\n      if (filePath) {\r\n        try { \r\n          await fs.unlink(filePath);\r\n        } catch (cleanupError) {\r\n          console.warn('Failed to cleanup temp file:', cleanupError);\r\n        }\r\n      }\r\n      \r\n      return res.status(403).json({\r\n        error: limitCheck.reason,\r\n        limitType: limitCheck.limitType,\r\n        current: limitCheck.current,\r\n        max: limitCheck.max,\r\n        upgradeMessage: getUpgradeMessage(toolSlug, userPlan),\r\n        requiresPro: true,\r\n      });\r\n    }\r\n\r\n    filePath = file.filepath || file.path; // v3 vs older\r\n    if (!filePath) {\r\n      throw new ValidationError('Uploaded file path missing');\r\n    }\r\n\r\n    let buffer;\r\n    try {\r\n      buffer = await fs.readFile(filePath);\r\n    } catch (readError) {\r\n      throw new FileSystemError('Failed to read uploaded file', readError);\r\n    }\r\n    \r\n    // Validate buffer is not empty\r\n    if (!buffer || buffer.length === 0) {\r\n      throw new ValidationError('File is empty or corrupted');\r\n    }\r\n\r\n    let upscaledUrl;\r\n    try {\r\n      // Use advanced local upscaler as primary method (improves existing image quality)\r\n      console.log('Using advanced local upscaler to enhance image quality');\r\n      upscaledUrl = await upscaleImage(buffer);\r\n      \r\n      // Optional: If OpenAI API key is available, use it for additional quality enhancement\r\n      // This analyzes the image and applies AI-based improvements\r\n      if (process.env.OPENAI_API_KEY) {\r\n        try {\r\n          console.log('Applying AI-based quality enhancement with OpenAI Vision...');\r\n          const enhancedBuffer = await enhanceImageQualityWithAI(buffer, file.mimetype);\r\n          \r\n          // Convert enhanced buffer to data URL\r\n          const base64 = enhancedBuffer.toString('base64');\r\n          upscaledUrl = `data:${file.mimetype || 'image/jpeg'};base64,${base64}`;\r\n          \r\n          console.log('AI enhancement applied successfully');\r\n        } catch (aiError) {\r\n          console.warn('AI enhancement failed, using upscaled result:', aiError.message);\r\n          // Continue with upscaled result if AI enhancement fails\r\n        }\r\n      }\r\n      \r\n      // Incrementa contatore uso (solo se la richiesta è andata a buon fine)\r\n      incrementUsage(userId, toolSlug);\r\n      \r\n      // Cleanup temp file\r\n      if (filePath) {\r\n        try { \r\n          await fs.unlink(filePath);\r\n          filePath = null;\r\n        } catch (cleanupError) {\r\n          console.warn('Failed to cleanup temp file:', cleanupError);\r\n        }\r\n      }\r\n      \r\n      return res.status(200).json({ url: upscaledUrl });\r\n    } catch (upscaleError) {\r\n      throw new ProcessingError('Failed to upscale image', upscaleError);\r\n    }\r\n\r\n  } catch (error) {\r\n    // Cleanup on error\r\n    if (filePath) {\r\n      try { \r\n        await fs.unlink(filePath);\r\n      } catch (cleanupError) {\r\n        console.warn('Failed to cleanup temp file on error:', cleanupError);\r\n      }\r\n    }\r\n\r\n    // Use centralized error handler\r\n    handleApiError(error, res, {\r\n      method: req.method,\r\n      url: req.url,\r\n      endpoint: '/api/upscale',\r\n    });\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}