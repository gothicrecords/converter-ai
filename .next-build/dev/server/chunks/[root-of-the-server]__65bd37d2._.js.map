{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/jurit/OneDrive/Desktop/sito%20upscale/pages/api/tools/compress-video.js"],"sourcesContent":["import formidable from 'formidable';\r\nimport fs from 'fs';\r\nimport path from 'path';\r\nimport ffmpegStatic from 'ffmpeg-static';\r\nimport ffmpeg from 'fluent-ffmpeg';\r\n\r\nexport const config = {\r\n    api: {\r\n        bodyParser: false,\r\n    },\r\n};\r\n\r\nexport default async function handler(req, res) {\r\n    if (req.method !== 'POST') {\r\n        return res.status(405).json({ error: 'Method not allowed' });\r\n    }\r\n\r\n    const uploadDir = path.join(process.cwd(), 'uploads');\r\n    if (!fs.existsSync(uploadDir)) {\r\n        fs.mkdirSync(uploadDir, { recursive: true });\r\n    }\r\n\r\n    const form = formidable({\r\n        uploadDir,\r\n        keepExtensions: true,\r\n        maxFileSize: 500 * 1024 * 1024, // 500MB\r\n    });\r\n\r\n    try {\r\n        const [fields, files] = await new Promise((resolve, reject) => {\r\n            form.parse(req, (err, fields, files) => {\r\n                if (err) reject(err);\r\n                else resolve([fields, files]);\r\n            });\r\n        });\r\n\r\n        const videoFile = Array.isArray(files.video) ? files.video[0] : files.video;\r\n        const quality = Array.isArray(fields.quality) ? fields.quality[0] : fields.quality || 'medium';\r\n\r\n        if (!videoFile) {\r\n            return res.status(400).json({ error: 'Nessun file video caricato' });\r\n        }\r\n\r\n        // Configurazione bitrate in base alla qualitÃ \r\n        const qualitySettings = {\r\n            low: { videoBitrate: '500k', audioBitrate: '64k' },\r\n            medium: { videoBitrate: '1000k', audioBitrate: '128k' },\r\n            high: { videoBitrate: '2000k', audioBitrate: '192k' },\r\n        };\r\n\r\n        const settings = qualitySettings[quality] || qualitySettings.medium;\r\n\r\n        // Configura ffmpeg\r\n        ffmpeg.setFfmpegPath(ffmpegStatic);\r\n\r\n        const inputPath = videoFile.filepath;\r\n        const outputPath = path.join(\r\n            path.dirname(inputPath),\r\n            `compressed_${Date.now()}.mp4`\r\n        );\r\n\r\n        // Esegui compressione\r\n        await new Promise((resolve, reject) => {\r\n            ffmpeg(inputPath)\r\n                .videoCodec('libx264')\r\n                .audioCodec('aac')\r\n                .videoBitrate(settings.videoBitrate)\r\n                .audioBitrate(settings.audioBitrate)\r\n                .outputOptions([\r\n                    '-movflags faststart',\r\n                    '-preset medium',\r\n                    '-crf 23'\r\n                ])\r\n                .output(outputPath)\r\n                .on('end', () => {\r\n                    console.log('Compressione completata');\r\n                    resolve();\r\n                })\r\n                .on('error', (err) => {\r\n                    console.error('Errore ffmpeg:', err);\r\n                    reject(err);\r\n                })\r\n                .on('progress', (progress) => {\r\n                    console.log('Progress:', progress.percent + '%');\r\n                })\r\n                .run();\r\n        });\r\n\r\n        // Leggi il file compresso\r\n        const compressedBuffer = fs.readFileSync(outputPath);\r\n\r\n        // Cleanup\r\n        try {\r\n            fs.unlinkSync(inputPath);\r\n            fs.unlinkSync(outputPath);\r\n        } catch (e) {\r\n            console.error('Errore cleanup:', e);\r\n        }\r\n\r\n        // Determina il tipo MIME\r\n        res.setHeader('Content-Type', 'video/mp4');\r\n        res.setHeader('Content-Disposition', `attachment; filename=compressed_${videoFile.originalFilename || 'video.mp4'}`);\r\n        res.status(200).send(compressedBuffer);\r\n\r\n    } catch (error) {\r\n        console.error('Errore API Compressione Video:', error);\r\n        res.status(500).json({ \r\n            error: error.message || 'Errore durante la compressione del video. Riprova con un file diverso.' \r\n        });\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}