{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 32, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/jurit/OneDrive/Desktop/sito%20upscale/utils/pdf.js"],"sourcesContent":["import { PDFDocument } from 'pdf-lib';\r\n\r\nexport async function imagesToPdf(imageBuffers) {\r\n  const pdfDoc = await PDFDocument.create();\r\n\r\n  for (const buf of imageBuffers) {\r\n    let embedded;\r\n    try {\r\n      embedded = await pdfDoc.embedJpg(buf);\r\n    } catch {\r\n      embedded = await pdfDoc.embedPng(buf);\r\n    }\r\n    const { width, height } = embedded.size();\r\n    const page = pdfDoc.addPage([width, height]);\r\n    page.drawImage(embedded, { x: 0, y: 0, width, height });\r\n  }\r\n\r\n  return await pdfDoc.save({ useObjectStreams: true });\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;;AAEO,eAAe,YAAY,YAAY;IAC5C,MAAM,SAAS,MAAM,4HAAW,CAAC,MAAM;IAEvC,KAAK,MAAM,OAAO,aAAc;QAC9B,IAAI;QACJ,IAAI;YACF,WAAW,MAAM,OAAO,QAAQ,CAAC;QACnC,EAAE,OAAM;YACN,WAAW,MAAM,OAAO,QAAQ,CAAC;QACnC;QACA,MAAM,EAAE,KAAK,EAAE,MAAM,EAAE,GAAG,SAAS,IAAI;QACvC,MAAM,OAAO,OAAO,OAAO,CAAC;YAAC;YAAO;SAAO;QAC3C,KAAK,SAAS,CAAC,UAAU;YAAE,GAAG;YAAG,GAAG;YAAG;YAAO;QAAO;IACvD;IAEA,OAAO,MAAM,OAAO,IAAI,CAAC;QAAE,kBAAkB;IAAK;AACpD"}},
    {"offset": {"line": 69, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/jurit/OneDrive/Desktop/sito%20upscale/pages/api/pdf/jpg-to-pdf.js"],"sourcesContent":["import formidable from 'formidable';\r\nimport { imagesToPdf } from '../../../utils/pdf.js';\r\n\r\nexport const config = { api: { bodyParser: false } };\r\n\r\nfunction fsReadFile(path) {\r\n  return new Promise((resolve, reject) => {\r\n    import('fs').then(({ readFile }) => readFile(path, (e, d) => (e ? reject(e) : resolve(d))));\r\n  });\r\n}\r\n\r\nexport default async function handler(req, res) {\r\n  // Handle CORS preflight\r\n  if (req.method === 'OPTIONS') {\r\n    res.status(200).end();\r\n    return;\r\n  }\r\n\r\n  if (req.method !== 'POST') return res.status(405).json({ error: 'Method not allowed' });\r\n  const form = formidable({ \r\n    multiples: true,\r\n    allowEmptyFiles: false // Non permettere file vuoti\r\n  });\r\n  try {\r\n    const { files } = await new Promise((resolve, reject) => {\r\n      form.parse(req, (err, fields, files) => {\r\n        if (err) {\r\n          // Gestisci errori specifici di formidable\r\n          if (err.message && err.message.includes('file size should be greater than 0')) {\r\n            return reject(new Error('Il file è vuoto. Carica un file valido.'));\r\n          }\r\n          if (err.message && err.message.includes('options.allowEmptyFiles')) {\r\n            return reject(new Error('Il file caricato è vuoto. Carica un file con contenuto.'));\r\n          }\r\n          return reject(err);\r\n        }\r\n        resolve({ fields, files });\r\n      });\r\n    });\r\n\r\n    const imgs = [];\r\n    const add = (f) => {\r\n      if (!f) return;\r\n      if (Array.isArray(f)) return f.forEach(add);\r\n      imgs.push(f);\r\n    };\r\n    add(files.image);\r\n    add(files.images);\r\n\r\n    if (!imgs.length) return res.status(400).json({ error: 'Nessuna immagine inviata' });\r\n    \r\n    // Valida che le immagini non siano vuote\r\n    for (const img of imgs) {\r\n      if (img.size === 0) {\r\n        return res.status(400).json({ error: 'Una o più immagini sono vuote. Carica file validi.' });\r\n      }\r\n    }\r\n\r\n    const buffers = await Promise.all(imgs.map((f) => fsReadFile(f.filepath)));\r\n    const pdfBytes = await imagesToPdf(buffers);\r\n    const base64 = Buffer.from(pdfBytes).toString('base64');\r\n    const dataUrl = `data:application/pdf;base64,${base64}`;\r\n    \r\n    // Restituisci anche il nome del file\r\n    const originalName = imgs[0]?.originalFilename || 'converted.pdf';\r\n    const resultName = originalName.replace(/\\.(jpg|jpeg|png|gif|webp)$/i, '.pdf') || 'converted.pdf';\r\n    \r\n    return res.status(200).json({ url: dataUrl, name: resultName });\r\n  } catch (e) {\r\n    console.error('jpg-to-pdf error', e);\r\n    return res.status(500).json({ error: 'Conversione fallita', details: e?.message || e });\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;;;AAAA;AACA;;;;;;;AAEO,MAAM,SAAS;IAAE,KAAK;QAAE,YAAY;IAAM;AAAE;AAEnD,SAAS,WAAW,IAAI;IACtB,OAAO,IAAI,QAAQ,CAAC,SAAS;QAC3B,6EAAa,IAAI,CAAC,CAAC,EAAE,QAAQ,EAAE,GAAK,SAAS,MAAM,CAAC,GAAG,IAAO,IAAI,OAAO,KAAK,QAAQ;IACxF;AACF;AAEe,eAAe,QAAQ,GAAG,EAAE,GAAG;IAC5C,wBAAwB;IACxB,IAAI,IAAI,MAAM,KAAK,WAAW;QAC5B,IAAI,MAAM,CAAC,KAAK,GAAG;QACnB;IACF;IAEA,IAAI,IAAI,MAAM,KAAK,QAAQ,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;QAAE,OAAO;IAAqB;IACrF,MAAM,OAAO,IAAA,+HAAU,EAAC;QACtB,WAAW;QACX,iBAAiB,MAAM,4BAA4B;IACrD;IACA,IAAI;QACF,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,IAAI,QAAQ,CAAC,SAAS;YAC5C,KAAK,KAAK,CAAC,KAAK,CAAC,KAAK,QAAQ;gBAC5B,IAAI,KAAK;oBACP,0CAA0C;oBAC1C,IAAI,IAAI,OAAO,IAAI,IAAI,OAAO,CAAC,QAAQ,CAAC,uCAAuC;wBAC7E,OAAO,OAAO,IAAI,MAAM;oBAC1B;oBACA,IAAI,IAAI,OAAO,IAAI,IAAI,OAAO,CAAC,QAAQ,CAAC,4BAA4B;wBAClE,OAAO,OAAO,IAAI,MAAM;oBAC1B;oBACA,OAAO,OAAO;gBAChB;gBACA,QAAQ;oBAAE;oBAAQ;gBAAM;YAC1B;QACF;QAEA,MAAM,OAAO,EAAE;QACf,MAAM,MAAM,CAAC;YACX,IAAI,CAAC,GAAG;YACR,IAAI,MAAM,OAAO,CAAC,IAAI,OAAO,EAAE,OAAO,CAAC;YACvC,KAAK,IAAI,CAAC;QACZ;QACA,IAAI,MAAM,KAAK;QACf,IAAI,MAAM,MAAM;QAEhB,IAAI,CAAC,KAAK,MAAM,EAAE,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAA2B;QAElF,yCAAyC;QACzC,KAAK,MAAM,OAAO,KAAM;YACtB,IAAI,IAAI,IAAI,KAAK,GAAG;gBAClB,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;oBAAE,OAAO;gBAAqD;YAC5F;QACF;QAEA,MAAM,UAAU,MAAM,QAAQ,GAAG,CAAC,KAAK,GAAG,CAAC,CAAC,IAAM,WAAW,EAAE,QAAQ;QACvE,MAAM,WAAW,MAAM,IAAA,oHAAW,EAAC;QACnC,MAAM,SAAS,OAAO,IAAI,CAAC,UAAU,QAAQ,CAAC;QAC9C,MAAM,UAAU,CAAC,4BAA4B,EAAE,QAAQ;QAEvD,qCAAqC;QACrC,MAAM,eAAe,IAAI,CAAC,EAAE,EAAE,oBAAoB;QAClD,MAAM,aAAa,aAAa,OAAO,CAAC,+BAA+B,WAAW;QAElF,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,KAAK;YAAS,MAAM;QAAW;IAC/D,EAAE,OAAO,GAAG;QACV,QAAQ,KAAK,CAAC,oBAAoB;QAClC,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;YAAuB,SAAS,GAAG,WAAW;QAAE;IACvF;AACF"}}]
}